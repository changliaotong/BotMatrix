<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test - å¯é…ç½®ç‰ˆæœ¬</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .config { background: #f0f0f0; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        input { padding: 5px; margin: 5px; width: 200px; }
        button { padding: 8px 15px; margin: 5px; cursor: pointer; }
        #log { background: #000; color: #0f0; padding: 10px; height: 300px; overflow-y: auto; font-family: monospace; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .error { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>WebSocketè¿æ¥æµ‹è¯• - å¯é…ç½®ç‰ˆæœ¬</h1>
    
    <div class="config">
        <h3>è¿æ¥é…ç½®</h3>
        <label>æœåŠ¡å™¨åœ°å€:</label>
        <input type="text" id="serverHost" value="localhost" placeholder="localhost æˆ– IPåœ°å€">
        <br>
        <label>WebSocketç«¯å£:</label>
        <input type="text" id="wsPort" value="3001" placeholder="3001">
        <br>
        <label>WebUIç«¯å£:</label>
        <input type="text" id="webuiPort" value="5000" placeholder="5000">
        <br>
        <button onclick="updateConnectionInfo()">æ›´æ–°è¿æ¥ä¿¡æ¯</button>
        <button onclick="testAllConnections()">æµ‹è¯•æ‰€æœ‰è¿æ¥</button>
        <button onclick="disconnectAll()">æ–­å¼€æ‰€æœ‰è¿æ¥</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <div id="connectionInfo" class="status">
        è¿æ¥åœ°å€: <span id="wsUrl">ws://localhost:3001</span> | 
        WebUI: <span id="webuiUrl">http://localhost:5000</span>
    </div>
    
    <div id="workerStatus" class="status disconnected">Worker: æœªè¿æ¥</div>
    <div id="botStatus" class="status disconnected">Bot: æœªè¿æ¥</div>
    
    <h3>è¿æ¥æ—¥å¿—</h3>
    <div id="log"></div>
    
    <script>
        let workerWs = null;
        let botWs = null;
        let serverHost = 'localhost';
        let wsPort = '3001';
        let webuiPort = '5000';
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += timestamp + ': ' + message + '<br>';
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateConnectionInfo() {
            serverHost = document.getElementById('serverHost').value || 'localhost';
            wsPort = document.getElementById('wsPort').value || '3001';
            webuiPort = document.getElementById('webuiPort').value || '5000';
            
            const wsUrl = `ws://${serverHost}:${wsPort}`;
            const webuiUrl = `http://${serverHost}:${webuiPort}`;
            
            document.getElementById('wsUrl').textContent = wsUrl;
            document.getElementById('webuiUrl').textContent = webuiUrl;
            
            log(`è¿æ¥ä¿¡æ¯å·²æ›´æ–°: WebSocket=${wsUrl}, WebUI=${webuiUrl}`);
        }
        
        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            element.className = 'status ' + status;
            element.textContent = message;
        }
        
        function connectWebSocket(url, role, onConnect, onDisconnect) {
            log(`æ­£åœ¨è¿æ¥ ${role}: ${url}`);
            
            const ws = new WebSocket(url);
            
            ws.onopen = function() {
                log(`âœ… ${role} è¿æ¥æˆåŠŸ`);
                updateStatus(role.toLowerCase() + 'Status', 'connected', `${role}: å·²è¿æ¥`);
                
                // å‘é€èº«ä»½éªŒè¯
                ws.send(JSON.stringify({
                    type: 'identify',
                    role: role,
                    id: 'test_' + role + '_' + Date.now()
                }));
                
                if (onConnect) onConnect();
            };
            
            ws.onmessage = function(event) {
                log(`ğŸ“¨ ${role} æ”¶åˆ°æ¶ˆæ¯: ${event.data}`);
            };
            
            ws.onerror = function(error) {
                log(`âŒ ${role} è¿æ¥é”™è¯¯: ${error}`);
                updateStatus(role.toLowerCase() + 'Status', 'error', `${role}: è¿æ¥é”™è¯¯`);
            };
            
            ws.onclose = function(event) {
                log(`ğŸ”Œ ${role} è¿æ¥å…³é—­: code=${event.code}, reason=${event.reason}`);
                updateStatus(role.toLowerCase() + 'Status', 'disconnected', `${role}: å·²æ–­å¼€`);
                
                if (onDisconnect) onDisconnect();
            };
            
            return ws;
        }
        
        function testAllConnections() {
            log('å¼€å§‹æµ‹è¯•æ‰€æœ‰è¿æ¥...');
            
            // æ–­å¼€ç°æœ‰è¿æ¥
            if (workerWs) {
                workerWs.close();
                workerWs = null;
            }
            if (botWs) {
                botWs.close();
                botWs = null;
            }
            
            updateConnectionInfo();
            
            const wsUrl = `ws://${serverHost}:${wsPort}`;
            
            // æµ‹è¯•Workerè¿æ¥
            workerWs = connectWebSocket(`${wsUrl}/ws/workers`, 'Worker');
            
            // 5ç§’åæµ‹è¯•Botè¿æ¥
            setTimeout(() => {
                botWs = connectWebSocket(`${wsUrl}/ws/bots`, 'Bot');
            }, 5000);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function disconnectAll() {
            log('æ­£åœ¨æ–­å¼€æ‰€æœ‰è¿æ¥...');
            
            if (workerWs) {
                workerWs.close();
                workerWs = null;
                log('Workerè¿æ¥å·²æ–­å¼€');
            } else {
                log('Workerè¿æ¥å·²ç»æ˜¯æ–­å¼€çŠ¶æ€');
            }
            
            if (botWs) {
                botWs.close();
                botWs = null;
                log('Botè¿æ¥å·²æ–­å¼€');
            } else {
                log('Botè¿æ¥å·²ç»æ˜¯æ–­å¼€çŠ¶æ€');
            }
            
            updateStatus('workerStatus', 'disconnected', 'Worker: å·²æ–­å¼€');
            updateStatus('botStatus', 'disconnected', 'Bot: å·²æ–­å¼€');
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.onload = function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡æµ‹è¯•è¿æ¥...');
            setTimeout(testAllConnections, 1000);
        };
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BotMatrix Manager v1.1.84</title>
    <!-- Use Staticfile CDN (Reliable in China) -->
    <link href="https://cdn.staticfile.org/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.staticfile.org/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css" rel="stylesheet">
    <script src="https://cdn.staticfile.org/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.staticfile.org/Chart.js/3.7.1/chart.min.js"></script>
    <script src="https://cdn.staticfile.org/three.js/0.141.0/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.141.0/examples/js/controls/OrbitControls.js"></script>
    <script src="locales.js"></script>
    
    <!-- Error handling for external scripts -->
    <script>
        // Ignore external script errors (like browser extensions)
        window.addEventListener('error', function(e) {
            // Check if error is from external script
            if (e.filename && (e.filename.includes('index.ts') || e.filename.includes('.js'))) {
                console.warn('Ignored external script error:', e.message, 'from', e.filename);
                e.preventDefault();
                return true;
            }
        });
        
        // Handle MutationObserver errors from external scripts
        const originalObserve = MutationObserver.prototype.observe;
        MutationObserver.prototype.observe = function(target, options) {
            try {
                if (!target || typeof target.querySelector !== 'function') {
                    console.warn('MutationObserver called with invalid target, ignoring');
                    return;
                }
                return originalObserve.call(this, target, options);
            } catch (e) {
                console.warn('MutationObserver error ignored:', e.message);
            }
        };
    </script>
    <style>
        :root {
            --bg-body: #f8f9fa;
            --bg-sidebar: #ffffff;
            --bg-card: #ffffff;
            --text-main: #212529;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --primary-color: #0d6efd;
            
            --bg-console: #f8f9fa;
            --text-console: #212529;
            --color-log-time: #0d6efd;
            --color-log-info: #198754;
            --color-log-error: #dc3545;
            --color-log-debug: #6c757d;
            
            --bg-list-item: #f8f9fa;
        }

        [data-theme="dark"] {
            --bg-body: #121212;
            --bg-sidebar: #1e1e1e;
            --bg-card: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #adb5bd;
            --border-color: #333333;
            --primary-color: #3d8bfd;

            --bg-console: #1e1e1e;
            --text-console: #d4d4d4;
            --color-log-time: #569cd6;
            --color-log-info: #4ec9b0;
            --color-log-error: #f44747;
            --color-log-debug: #dcdcaa;
            
            --bg-list-item: #2c2c2c;
        }

        /* Dark Mode Overrides */
        [data-theme="dark"] .dropdown-menu {
            background-color: var(--bg-card);
            border-color: var(--border-color);
        }
        [data-theme="dark"] .dropdown-item {
            color: var(--text-main);
        }
        [data-theme="dark"] .dropdown-item:hover {
            background-color: var(--bg-list-item);
            color: var(--text-main);
        }
        [data-theme="dark"] .list-group-item {
            background-color: var(--bg-card);
            color: var(--text-main);
            border-color: var(--border-color);
        }
        /* Fix TAB title background in dark mode */
        [data-theme="dark"] .nav-tabs .nav-link.active {
            background-color: var(--bg-card) !important;
            color: var(--text-main) !important;
            border-color: var(--border-color) var(--border-color) var(--bg-body);
        }
        [data-theme="dark"] .card-header {
            background-color: rgba(255, 255, 255, 0.05) !important;
            border-bottom-color: var(--border-color);
            color: var(--text-main);
        }
        [data-theme="dark"] .bg-white,
        [data-theme="dark"] .bg-light {
            background-color: var(--bg-card) !important;
            color: var(--text-main) !important;
        }

        /* Dark Mode Modal & Table */
        [data-theme="dark"] .modal-content {
            background-color: var(--bg-card);
            color: var(--text-main);
            border-color: var(--border-color);
        }
        [data-theme="dark"] .modal-header,
        [data-theme="dark"] .modal-footer {
            border-color: var(--border-color);
        }
        [data-theme="dark"] .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        [data-theme="dark"] .table-striped > tbody > tr:nth-of-type(odd) {
            --bs-table-accent-bg: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
        }
        [data-theme="dark"] .table-hover > tbody > tr:hover {
            --bs-table-hover-bg: rgba(255, 255, 255, 0.1);
            color: var(--text-main);
        }
        [data-theme="dark"] .table thead.table-light th {
            background-color: var(--bg-sidebar) !important;
            color: var(--text-main) !important;
            border-color: var(--border-color);
        }
        [data-theme="dark"] .table > :not(caption) > * > * {
            border-color: var(--border-color);
        }

        .time-display { display: flex; align-items: center; gap: 15px; }
        .time-item { display: flex; flex-direction: column; }
        .time-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 1px; }
        .time-value { font-size: 1rem; font-weight: 700; line-height: 1.1; font-family: 'Consolas', 'Monaco', monospace; }
        .uptime-value { color: #198754; }
        [data-theme="dark"] .uptime-value { color: #20c997; }
        .current-time-value { color: #0d6efd; }
        [data-theme="dark"] .current-time-value { color: #3d8bfd; }

        body { background-color: var(--bg-body); color: var(--text-main); font-family: system-ui, -apple-system, sans-serif; transition: background-color 0.3s, color 0.3s; }
        .sidebar { display: flex; flex-direction: column; height: 100vh; position: fixed; top: 0; left: 0; width: 250px; background-color: var(--bg-sidebar); border-right: 1px solid var(--border-color); padding-top: 20px; z-index: 1000; transition: background-color 0.3s, border-color 0.3s; }
        .card { background-color: var(--bg-card); border: 1px solid var(--border-color); margin-bottom: 24px; box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); border-radius: 0.75rem; transition: background-color 0.3s, border-color 0.3s; }
        .form-control, .form-select { background-color: var(--bg-card); color: var(--text-main); border-color: var(--border-color); }
        .form-control:focus, .form-select:focus { background-color: var(--bg-card); color: var(--text-main); border-color: var(--primary-color); }
        .dropdown-menu { background-color: var(--bg-card); border-color: var(--border-color); }
        .dropdown-item { color: var(--text-main); }
        .dropdown-item:hover { background-color: rgba(255, 255, 255, 0.1); color: var(--text-main); }
        .list-group-item { background-color: var(--bg-card); color: var(--text-main); border-color: var(--border-color); }

        /* Visualization Styles */
        #visualization-container {
            width: 100%;
            height: calc(100vh - 160px);
            background: radial-gradient(circle at center, #1a1a2e 0%, #0f0f1a 100%);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            border: 1px solid #30363d;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
        }
        #visualization-container:fullscreen {
            width: 100vw;
            height: 100vh;
            border-radius: 0;
            border: none;
        }
        #viz-nodes {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }
        .viz-node {
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #00ff41;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #00ff41;
            font-size: 0.7rem;
            z-index: 2;
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.3);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            backdrop-filter: blur(4px);
            pointer-events: auto;
            text-align: center;
        }
        .viz-node i {
            font-size: 1.4rem;
            margin-bottom: 2px;
            color: #00ff41;
        }
        .viz-node span {
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 0 5px;
            color: #00ff41;
            font-family: 'Courier New', Courier, monospace;
            text-shadow: 0 0 5px #00ff41;
        }
        .viz-node img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid #00ff41;
            margin-bottom: 2px;
        }
        .viz-node.nexus {
            width: 100px;
            height: 100px;
            background: rgba(0, 0, 0, 0.8);
            border-color: #00ff41;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.4);
            font-weight: bold;
        }
        .viz-node.worker {
            background: rgba(0, 0, 0, 0.7);
            border-color: #00ff41;
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.3);
        }
        .viz-node.user {
            width: 60px;
            height: 60px;
            background: rgba(0, 0, 0, 0.6);
            border-color: #00ff41;
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.2);
        }
        .viz-stats {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #00ff41;
            color: #00ff41;
            padding: 5px 10px;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            z-index: 10;
            pointer-events: none;
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
        }
        .viz-msg-hint {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00ff41;
            color: #00ff41;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            pointer-events: none;
            z-index: 5;
            white-space: nowrap;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            font-family: 'Courier New', Courier, monospace;
            animation: fadeUp 2s forwards;
        }
        @keyframes fadeUp {
            0% { opacity: 0; transform: translateY(0); }
            20% { opacity: 1; transform: translateY(-20px); }
            80% { opacity: 1; transform: translateY(-40px); }
            100% { opacity: 0; transform: translateY(-60px); }
        }
        #viz-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }
        .viz-label {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            pointer-events: none;
            white-space: nowrap;
            z-index: 3;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -120%);
        }
        .viz-particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #fff;
            border-radius: 50%;
            pointer-events: none;
            z-index: 2;
            box-shadow: 0 0 10px #fff;
        }
        .table { color: var(--text-main); border-color: var(--border-color); }
        .nav-link { color: var(--text-muted); }
        
        .sidebar a { color: var(--text-muted); padding: 12px 24px; display: block; text-decoration: none; border-left: 3px solid transparent; }
        .sidebar a:hover, .sidebar a.active { color: var(--primary-color); background-color: rgba(13, 110, 253, 0.1); border-left-color: var(--primary-color); font-weight: 500; }
        .nav-section-label {
            padding: 1rem 1.5rem 0.5rem;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-muted);
            letter-spacing: 0.05rem;
            opacity: 0.7;
        }
        .main-content { margin-left: 250px; padding: 25px; padding-top: 10px; }
        .metric-label { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .log-box { background-color: var(--bg-console); color: var(--text-console); font-family: monospace; padding: 15px; overflow-y: auto; border-radius: 0.5rem; font-size: 0.85rem; border: 1px solid var(--border-color); }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid var(--border-color); padding-bottom: 2px; }
        .log-time { color: var(--color-log-time); margin-right: 10px; }
        .log-level-INFO { color: var(--color-log-info); }
        .log-level-ERROR { color: var(--color-log-error); }
        .log-level-DEBUG { color: var(--color-log-debug); }

        /* Login Page Styles */
        .login-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: none; /* ä¿®æ”¹ï¼šåˆå§‹éšè—ï¼Œé˜²æ­¢é—ªç° */
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: all 0.5s ease;
            opacity: 1;
            visibility: visible;
        }
        [data-theme="dark"] .login-page {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        .login-card {
            background: white;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 1rem 3rem rgba(0,0,0,0.175);
            width: 100%;
            max-width: 450px;
            animation: slideUp 0.5s ease-out;
            position: relative;
            z-index: 10000;
        }
        [data-theme="dark"] .login-card {
            background: var(--bg-card);
            color: var(--text-main);
            border: 1px solid var(--border-color);
        }
        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .login-logo {
            width: 80px;
            height: 80px;
            background: var(--primary-color);
            color: white;
            border-radius: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin: 0 auto 1rem;
            box-shadow: 0 0.5rem 1rem rgba(13, 110, 253, 0.3);
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .login-page.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        /* Mobile Responsive */
        .mobile-nav { display: none; }
        .overlay { display: none; }



        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                box-shadow: 0 0 15px rgba(0,0,0,0.2);
            }
            .sidebar.show {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
                padding-top: 80px; /* Space for navbar */
                padding-left: 15px;
                padding-right: 15px;
            }
            .mobile-nav {
                display: flex;
                position: fixed;
                top: 0; left: 0; right: 0;
                height: 60px;
                background: #fff;
                border-bottom: 1px solid var(--border-color);
                z-index: 900;
                align-items: center;
                padding: 0 15px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            .overlay {
                display: none;
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 999;
            }
            .overlay.show {
            display: block;
        }

        /* Group Management Mobile */
        .group-manage-container {
            height: auto !important;
        }
        .group-manage-col {
            height: 70vh !important;
            margin-bottom: 20px;
        }
    }
    
    /* Stats Card Slides */
    #combined-stats-container {
        min-height: 48px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        overflow: hidden;
        position: relative;
    }
    .stats-slide {
        transition: all 0.5s ease-in-out;
        height: 100%;
        width: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        position: absolute;
        top: 0;
        left: 0;
    }
    .stats-slide:not(.active) {
        opacity: 0;
        pointer-events: none;
        transform: translateY(10px);
    }
    .stats-slide.active {
        opacity: 1;
        transform: translateY(0);
        position: relative;
    }

    /* Custom Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    @media (max-width: 1400px) {
        .stats-grid { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 992px) {
        .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 576px) {
        .stats-grid { grid-template-columns: 1fr; }
    }
    .icon-circle {
        width: 42px;
        height: 42px;
        border-radius: 50% !important; /* Force circle */
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        flex-shrink: 0;
    }
    .stat-card {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        height: 100%;
        transition: transform 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .stat-info {
        overflow: hidden;
        margin-left: 0.75rem;
    }
    .stat-label {
        font-size: 0.7rem;
        color: var(--text-muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 2px;
    }
    .stat-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-main);
        line-height: 1;
    }
    /* Message Flow Animation */
    @keyframes flowRight {
        0% { transform: translateX(-100%); opacity: 0; }
        50% { opacity: 1; }
        100% { transform: translateX(100%); opacity: 0; }
    }
    .message-flow-line {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
        animation: flowRight 2s infinite linear;
        pointer-events: none;
    }
    .stat-card {
        position: relative;
        overflow: hidden;
    }
    .stat-card.active-flow .message-flow-line {
        display: block;
    }
    .stat-card .message-flow-line {
        display: none;
    }
    .time-display {
        display: flex;
        flex-direction: column;
        justify-content: center;
        height: 100%;
    }
    .time-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 2px 0;
    }
    .time-label {
        font-size: 0.7rem;
        color: var(--text-muted);
        margin-right: 10px;
    }
    .time-value {
        font-family: 'Courier New', Courier, monospace;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-main);
    }
    
        /* Cloud Matrix Layout Adjustment */
        #tab-bots {
            height: calc(100vh - 35px);
            display: flex;
            flex-direction: column;
        }
        #tab-bots > .row {
            flex: 1;
            height: 100%;
        }
        #tab-bots .col-xl-7, #tab-bots .col-xl-5 {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        #tab-bots .card {
            flex: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border-radius: 0.75rem;
            overflow: hidden;
        }
        #tab-bots .card-body {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 1rem;
        }
        .bot-list-container, .worker-list-container {
             flex: 1;
             overflow-y: auto;
             background: rgba(0, 0, 0, 0.05);
             border: 1px solid var(--border-color);
             border-radius: 0.5rem;
             padding: 1rem !important;
             margin-bottom: 0 !important;
             margin-left: 0 !important;
             margin-right: 0 !important;
             min-height: 0;
         }
         [data-theme="dark"] .bot-list-container, [data-theme="dark"] .worker-list-container {
             background: rgba(0, 0, 0, 0.2);
         }
        /* Custom Scrollbar for list containers */
        .bot-list-container::-webkit-scrollbar, .worker-list-container::-webkit-scrollbar {
            width: 6px;
        }
        .bot-list-container::-webkit-scrollbar-track, .worker-list-container::-webkit-scrollbar-track {
            background: transparent;
        }
        .bot-list-container::-webkit-scrollbar-thumb, .worker-list-container::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }
        [data-theme="dark"] .bot-list-container::-webkit-scrollbar-thumb, [data-theme="dark"] .worker-list-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
        }
</style>
</head>
<body>


    <!-- Login Modal -->
    <div id="loginPage" class="login-page">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">
                    <i class="bi bi-robot"></i>
                </div>
                 <h3>BotMatrix</h3>
                <p class="text-muted" data-i18n="login_subtitle">ç»Ÿä¸€ç®¡ç†å¹³å°</p>
            </div>
            <form id="loginForm">
                <div class="mb-3">
                    <label class="form-label" data-i18n="username">ç”¨æˆ·å</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-person"></i></span>
                        <input type="text" class="form-control" id="loginUser" required data-i18n-placeholder="login_placeholder_user" placeholder="admin">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label" data-i18n="password">å¯†ç </label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-lock"></i></span>
                        <input type="password" class="form-control" id="loginPass" required data-i18n-placeholder="login_placeholder_pass" placeholder="******">
                    </div>
                </div>
                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <span id="loginBtnText" data-i18n="login_btn">ç™»å½•</span>
                        <span id="loginBtnLoading" class="spinner-border spinner-border-sm d-none"></span>
                    </button>
                </div>
            </form>
            <div id="loginError" class="alert alert-danger mt-3 d-none"></div>
            <div class="login-footer mt-4 text-center">
                <small class="text-muted">&copy; 2025 BotMatrix Team. All Rights Reserved.</small>
            </div>
        </div>
    </div>

    <!-- ç§»é™¤æ—§çš„ loginModal -->

    <!-- Mobile Nav -->
    <div class="mobile-nav">
        <button class="btn btn-outline-secondary me-3" onclick="toggleSidebar()">
            <i class="bi bi-list fs-4"></i>
        </button>
        <h5 class="m-0">BotMatrix <small class="text-muted fs-6">v1.1.84</small></h5>
    </div>
    
    <!-- Overlay -->
    <div class="overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Stats Modal -->
    <div class="modal fade" id="statsModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statsModalTitle" data-i18n="modal_stats_title">ç»Ÿè®¡è¯¦æƒ…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-light sticky-top" style="top: 0">
                            <tr>
                                <th scope="col" width="60">#</th>
                                <th scope="col" id="statsModalNameHeader" data-i18n="modal_col_name">åç§°</th>
                                <th scope="col" width="100" class="text-end" data-i18n="modal_col_count">æ•°é‡</th>
                            </tr>
                        </thead>
                        <tbody id="statsModalBody">
                            <!-- Data -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" data-i18n="modal_create_user_title">åˆ›å»ºæ–°ç”¨æˆ·</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createUserForm">
                        <div class="mb-3">
                            <label class="form-label" data-i18n="username">ç”¨æˆ·å</label>
                            <input type="text" class="form-control" id="new-username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" data-i18n="password">å¯†ç </label>
                            <input type="password" class="form-control" id="new-password" required>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="new-is-admin">
                            <label class="form-check-label" for="new-is-admin" data-i18n="is_admin_label">ç®¡ç†å‘˜æƒé™</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="cancel_btn">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="createUser()" data-i18n="confirm_create_btn">ç¡®è®¤åˆ›å»º</button>
                </div>
            </div>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="px-3 mb-4">
            <h4>ğŸš€ BotMatrix</h4>
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted" data-i18n="sidebar_subtitle">Enterprise Bot Manager</small>
                <span class="badge bg-secondary" style="font-size: 0.7em;">v1.1.84</span>
            </div>
        </div>
        
        <!-- Bot Selector Removed -->
        
        <nav class="nav flex-column">
            <div class="nav-section-label" data-i18n="menu_group_overview">æ€»è§ˆ</div>
            <a href="#dashboard" id="nav-dashboard" class="nav-link active" onclick="showTab('dashboard')"><i class="bi bi-speedometer2"></i> <span data-i18n="sidebar_dashboard">è¿è¡ŒçŠ¶æ€</span></a>
            
            <div class="nav-section-label" data-i18n="menu_group_management">ä¸šåŠ¡ç®¡ç†</div>
            <a href="#bots" id="nav-bots" class="nav-link" onclick="showTab('bots')"><i class="bi bi-robot"></i> <span data-i18n="sidebar_bots">äº‘ç«¯çŸ©é˜µ</span></a>
            <a href="#groups" id="nav-groups" class="nav-link" onclick="showTab('groups')"><i class="bi bi-people"></i> <span data-i18n="sidebar_groups">ç¾¤ç»„å¥½å‹</span></a>
            <a href="#routing" id="nav-routing" class="nav-link" onclick="showTab('routing')"><i class="bi bi-diagram-3"></i> <span data-i18n="sidebar_routing">è·¯ç”±ç®¡ç†</span></a>
            <a href="#visualization" id="nav-visualization" class="nav-link" onclick="showTab('visualization')"><i class="bi bi-broadcast"></i> <span data-i18n="sidebar_visualization">è½¬å‘å¯è§†åŒ–</span></a>
            
            <div class="nav-section-label" data-i18n="menu_group_infrastructure">åŸºç¡€è®¾æ–½</div>
            <a href="#docker" id="nav-docker" class="nav-link" onclick="showTab('docker')"><i class="bi bi-box"></i> <span data-i18n="sidebar_docker">Dockerç®¡ç†</span></a>
            <a href="#overmind" id="nav-overmind" class="nav-link" onclick="showTab('overmind')"><i class="bi bi-grid-3x3-gap"></i> <span data-i18n="sidebar_overmind">Overmind</span></a>
            
            <div class="nav-section-label" data-i18n="menu_group_system">ç³»ç»Ÿç»´æŠ¤</div>
            <a href="#monitor" id="nav-monitor" class="nav-link" onclick="showTab('monitor')"><i class="bi bi-display"></i> <span data-i18n="sidebar_monitor">ç³»ç»Ÿç›‘æ§</span></a>
            <a href="#logs" id="nav-logs" class="nav-link" onclick="showTab('logs')"><i class="bi bi-journal-text"></i> <span data-i18n="sidebar_logs">æ—¥å¿—ä¸­å¿ƒ</span></a>
            <a href="#debug" id="nav-debug" class="nav-link" onclick="showTab('debug')"><i class="bi bi-bug"></i> <span data-i18n="sidebar_debug">è°ƒè¯•æµ‹è¯•</span></a>
            <a href="#users" id="nav-users" class="nav-link admin-only" onclick="showTab('users')"><i class="bi bi-people-fill"></i> <span data-i18n="sidebar_users">ç”¨æˆ·ç®¡ç†</span></a>
            <a href="#settings" id="nav-settings" class="nav-link admin-only" onclick="showTab('settings')"><i class="bi bi-gear"></i> <span data-i18n="sidebar_settings">ç³»ç»Ÿè®¾ç½®</span></a>
        </nav>

        <div class="mt-auto p-3 border-top d-flex justify-content-around align-items-center flex-wrap">
             <button class="btn btn-outline-secondary rounded-circle theme-toggle-btn-sidebar mb-2" onclick="toggleTheme()" title="Toggle Theme" data-i18n-title="theme_toggle" style="width: 38px; height: 38px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-moon-stars"></i>
            </button>
            
            <div class="dropup mb-2">
                <button class="btn btn-outline-secondary rounded-circle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Language" style="width: 38px; height: 38px; display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-translate"></i>
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="setLanguage('zh-CN')">ç®€ä½“ä¸­æ–‡</a></li>
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="setLanguage('zh-TW')">ç¹é«”ä¸­æ–‡</a></li>
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="setLanguage('en')">English</a></li>
                </ul>
            </div>

            <a href="https://github.com/changliaotong/BotMatrix" target="_blank" class="btn btn-outline-secondary rounded-circle github-btn-sidebar mb-2" title="View on GitHub" style="width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; text-decoration: none; padding: 0;">
                <i class="bi bi-github"></i>
            </a>

            <button class="btn btn-outline-secondary rounded-circle mb-2" onclick="logout()" title="Logout" data-i18n-title="sidebar_logout" style="width: 38px; height: 38px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-box-arrow-right"></i>
            </button>
        </div>
    </div>

    <div class="main-content">
        <!-- Dashboard Tab -->
        <div id="tab-dashboard" class="tab-content" style="display: none;">
            <!-- Stats Grid -->
            <div class="stats-grid" id="dash-system-stats">
                <!-- 1. Bots -->
                <div class="stat-card">
                    <div class="icon-circle bg-primary bg-opacity-10 text-primary">
                        <i class="bi bi-robot"></i>
                    </div>
                    <div class="stat-info w-100">
                        <div class="stat-label" data-i18n="stat_bots">æœºå™¨äºº (åœ¨çº¿/ç¦»çº¿/æ€»æ•°)</div>
                        <div class="stat-value">
                            <span id="metric-bots">0</span>
                            <span class="text-muted fs-6 fw-normal">/</span>
                            <span id="metric-bots-offline" class="text-muted fs-6 fw-normal">0</span>
                            <span class="text-muted fs-6 fw-normal">/</span>
                            <span id="metric-bots-total" class="text-muted fs-6 fw-normal">0</span>
                        </div>
                    </div>
                </div>

                <!-- 1.1 Workers -->
                <div class="stat-card">
                    <div class="icon-circle bg-info bg-opacity-10 text-info">
                        <i class="bi bi-cpu"></i>
                    </div>
                    <div class="stat-info w-100">
                        <div class="stat-label" data-i18n="stat_workers">å¤„ç†ç«¯ (Workers)</div>
                        <div class="stat-value">
                            <span id="metric-workers">0</span>
                        </div>
                    </div>
                </div>

                <!-- 2. System Resources (CPU, Memory Merged) -->
                <div class="stat-card" title="ç³»ç»Ÿèµ„æºè¯¦æƒ…">
                    <div class="icon-circle bg-warning bg-opacity-10 text-warning">
                        <i class="bi bi-cpu-fill"></i>
                    </div>
                    <div class="stat-info w-100">
                        <div class="stat-label" id="metric-cpu-model" data-i18n="system_resource_details">ç³»ç»Ÿèµ„æº</div>
                        <div class="d-flex flex-column gap-1 mt-1">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold" style="font-size: 0.85rem;"><span data-i18n="cpu_label">CPU:</span> <span id="metric-cpu">0%</span></span>
                                <div class="progress flex-grow-1 mx-2" style="height: 4px; background-color: rgba(0,0,0,0.05);">
                                    <div id="metric-cpu-bar" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                                </div>
                                <span style="font-size: 0.7rem; color: var(--text-muted);"><span id="metric-cpu-cores">0</span><span data-i18n="cores_label">æ ¸</span></span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold" style="font-size: 0.85rem;"><span data-i18n="mem_label">å†…å­˜:</span> <span id="metric-mem">0 MB</span></span>
                                <div class="progress flex-grow-1 mx-2" style="height: 4px; background-color: rgba(0,0,0,0.05);">
                                    <div id="metric-mem-bar" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                                </div>
                                <span id="metric-mem-total" style="font-size: 0.7rem; color: var(--text-muted);">0 GB</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2.1 Operating System -->
                <div class="stat-card" style="display: none;">
                    <div class="icon-circle bg-secondary bg-opacity-10 text-secondary">
                        <i class="bi bi-window"></i>
                    </div>
                    <div class="stat-info w-100">
                        <div class="stat-label">æ“ä½œç³»ç»Ÿ</div>
                        <div class="d-flex flex-column" style="font-size: 0.75rem;">
                            <span id="metric-os-plat" class="fw-bold">...</span>
                            <span id="metric-os-ver" style="font-size: 0.65rem; color: var(--text-muted);">...</span>
                        </div>
                    </div>
                </div>

                <!-- 4. Combined Stats (Goroutines, Active, Messages) -->
                <div class="stat-card" id="combined-stats-card">
                    <div class="icon-circle bg-info bg-opacity-10 text-info" id="combined-stats-icon">
                        <i class="bi bi-activity"></i>
                    </div>
                    <div class="stat-info w-100" id="combined-stats-container">
                        <!-- Content will be rotated by JS -->
                        <div class="stats-slide active" id="slide-goroutines">
                            <div class="stat-label" data-i18n="stat_goroutines">Goroutines</div>
                            <div class="stat-value" id="metric-goroutines">0</div>
                        </div>
                        <div class="stats-slide" id="slide-active" style="display: none;">
                            <div class="stat-label" data-i18n="stat_active_groups_users">æ´»è·ƒ (ç¾¤ç»„ / ç”¨æˆ·)</div>
                            <div class="stat-value" style="font-size: 0.95rem;">
                                <span id="metric-groups-today">0</span><small class="text-muted">/</small><span id="metric-groups-total" class="text-muted fw-normal">0</span>
                                <span class="mx-1 text-muted">|</span>
                                <span id="metric-users-today">0</span><small class="text-muted">/</small><span id="metric-users-total" class="text-muted fw-normal">0</span>
                            </div>
                        </div>
                        <div class="stats-slide" id="slide-messages" style="display: none;">
                            <div class="stat-label" data-i18n="stat_messages">æ¶ˆæ¯ç»Ÿè®¡ (æ¥æ”¶/å‘é€)</div>
                            <div class="stat-value" style="font-size: 0.95rem;">
                                <span id="metric-msgs-total">0</span>
                                <span class="text-muted mx-1">/</span>
                                <span id="metric-sent-total" class="text-muted fw-normal">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4.1 Time Info -->
                <div class="stat-card">
                    <div class="icon-circle bg-primary bg-opacity-10 text-primary">
                        <i class="bi bi-clock"></i>
                    </div>
                    <div class="stat-info w-100">
                        <div class="time-display">
                            <div class="time-item">
                                <span class="time-label" data-i18n="time_uptime">è¿è¡Œæ—¶é•¿</span>
                                <span id="metric-uptime" class="time-value uptime-value">00:00:00</span>
                            </div>
                            <div class="time-item">
                                <span class="time-label" data-i18n="time_current">å½“å‰æ—¶é—´</span>
                                <span id="metric-current-time" class="time-value current-time-value">00:00:00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-md-8">
                     <!-- Charts Row -->
                     <div class="row g-3 mb-4" id="dash-charts-row">
                        <div class="col-md-4">
                            <div class="card h-100" style="cursor: pointer;" onclick="showSystemDetails('cpu')">
                                <div class="card-header py-2 small fw-bold d-flex justify-content-between align-items-center">
                                    <span data-i18n="chart_cpu_trend">CPU è¶‹åŠ¿</span>
                                    <i class="bi bi-arrows-angle-expand text-muted"></i>
                                </div>
                                <div class="card-body p-2" style="height: 200px; position: relative;">
                                    <canvas id="cpuChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100" style="cursor: pointer;" onclick="showSystemDetails('mem')">
                                <div class="card-header py-2 small fw-bold d-flex justify-content-between align-items-center">
                                    <span data-i18n="chart_mem_trend">å†…å­˜è¶‹åŠ¿</span>
                                    <i class="bi bi-arrows-angle-expand text-muted"></i>
                                </div>
                                <div class="card-body p-2" style="height: 200px; position: relative;">
                                    <canvas id="memChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100" style="cursor: pointer;" onclick="showSystemDetails('msg')">
                                <div class="card-header py-2 small fw-bold d-flex justify-content-between align-items-center">
                                    <span data-i18n="chart_msg_throughput">æ¶ˆæ¯åå (Msg/Min)</span>
                                    <i class="bi bi-arrows-angle-expand text-muted"></i>
                                </div>
                        <div class="card-body p-2" style="height: 200px; position: relative;">
                            <canvas id="msgChart"></canvas>
                        </div>
                            </div>
                        </div>
                     </div>
 
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span data-i18n="top_active_groups">ğŸ† ä»Šæ—¥æ´»è·ƒç¾¤ç»„</span>
                                    <div>
                                        <button class="btn btn-sm btn-link text-decoration-none p-0 me-2" onclick="showAllStats('Group')" data-i18n="more">æ›´å¤š</button>
                                        <span class="badge bg-primary rounded-pill">Top 5</span>
                                    </div>
                                </div>
                                <ul class="list-group list-group-flush" id="top-groups">
                                    <li class="list-group-item text-muted text-center" data-i18n="no_data">æš‚æ— æ•°æ®</li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span data-i18n="top_active_users">ğŸ—£ï¸ ä»Šæ—¥é¾™ç‹</span>
                                    <div>
                                        <button class="btn btn-sm btn-link text-decoration-none p-0 me-2" onclick="showAllStats('User')" data-i18n="more">æ›´å¤š</button>
                                        <span class="badge bg-warning text-dark rounded-pill">Top 5</span>
                                    </div>
                                </div>
                                <ul class="list-group list-group-flush" id="top-users">
                                    <li class="list-group-item text-muted text-center" data-i18n="no_data">æš‚æ— æ•°æ®</li>
                                </ul>
                            </div>
                        </div>
                    </div>
 
                    <div class="card mb-4" id="dash-process-card">
                        <div class="card-header" data-i18n="top_processes">
                            ğŸ”¥ é«˜å ç”¨è¿›ç¨‹ (Top 10)
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped mb-0">
                                <thead>
                                    <tr>
                                        <th data-i18n="col_pid">PID</th>
                                        <th data-i18n="col_process">è¿›ç¨‹å</th>
                                        <th data-i18n="col_cpu">CPU %</th>
                                        <th data-i18n="col_mem">å†…å­˜ (MB)</th>
                                    </tr>
                                </thead>
                                <tbody id="process-list">
                                    <tr><td colspan="4" class="text-center" data-i18n="loading">åŠ è½½ä¸­...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card mb-4" id="dash-actions-card">
                        <div class="card-header" data-i18n="quick_actions">
                            å¿«æ·æ“ä½œ
                        </div>
                        <div class="card-body">
                            <button class="btn btn-outline-primary me-2" onclick="callSystemAction('reload_plugins')">
                                <i class="bi bi-arrow-repeat"></i> <span data-i18n="action_reload_plugins">é‡è½½æ’ä»¶</span>
                            </button>
                            <button class="btn btn-outline-secondary me-2" onclick="callSystemAction('clean_logs')">
                                <i class="bi bi-trash"></i> <span data-i18n="action_clean_logs">æ¸…ç†æ—¥å¿—</span>
                            </button>
                        </div>
                    </div>
                </div>
 
                <div class="col-md-4">
                    <div class="card h-100" id="dash-logs-card" style="background-color: var(--bg-card); border-color: var(--border-color);">
                        <div class="card-header" data-i18n="recent_activity">
                            æœ€è¿‘æ´»åŠ¨
                        </div>
                        <div class="card-body d-flex flex-column">
                            <div id="recent-logs" class="log-box flex-grow-1"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Details View -->
        <div id="tab-view-system-details" class="content-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0"><i class="bi bi-graph-up"></i> <span data-i18n="system_resource_details">ç³»ç»Ÿèµ„æºè¯¦æƒ…</span></h4>
                <div>
                    <div class="btn-group me-2">
                        <button class="btn btn-outline-secondary btn-sm active" onclick="updateDetailTimeRange('1h')" data-i18n="time_1h">1å°æ—¶</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="updateDetailTimeRange('24h')" data-i18n="time_24h">24å°æ—¶</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="updateDetailTimeRange('7d')" data-i18n="time_7d">7å¤©</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="updateDetailTimeRange('30d')" data-i18n="time_30d">30å¤©</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="updateDetailTimeRange('1y')" data-i18n="time_1y">å…¨å¹´</button>
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="showTab('#dashboard')" data-i18n="back_to_dashboard">è¿”å›ä»ªè¡¨ç›˜</button>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <ul class="nav nav-tabs card-header-tabs" id="system-detail-tabs">
                                <li class="nav-item">
                                    <a class="nav-link active" href="#" onclick="switchDetailTab('cpu', event)" data-i18n="tab_cpu_load">CPU & è´Ÿè½½</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#" onclick="switchDetailTab('mem', event)" data-i18n="tab_mem_usage">å†…å­˜ä½¿ç”¨</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#" onclick="switchDetailTab('msg', event)" data-i18n="tab_msg_throughput">æ¶ˆæ¯åå</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#" onclick="switchDetailTab('disk', event)" data-i18n="tab_disk_io">ç£ç›˜ & I/O</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#" onclick="switchDetailTab('net', event)" data-i18n="tab_net_traffic">ç½‘ç»œæµé‡</a>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <!-- Large Chart Container -->
                            <div style="height: 400px; position: relative;">
                                <canvas id="detailChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hardware Info Grid -->
            <div class="row" id="hardware-info-grid">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Groups & Friends Tab -->
        <div id="tab-groups" class="tab-content" style="display: none;">
            <div class="d-flex justify-content-start align-items-center mb-3 gap-2">
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle d-flex align-items-center justify-content-start" type="button" id="global-bot-dropdown" data-bs-toggle="dropdown" aria-expanded="false" style="min-width: 220px;">
                     <i class="bi bi-robot me-2"></i>
                     <span id="global-bot-selected-content" class="text-truncate text-start" style="max-width: 160px;" data-i18n="select_bot_placeholder">é€‰æ‹©æœºå™¨äºº...</span>
                </button>
                <ul class="dropdown-menu shadow-lg" id="global-bot-list" aria-labelledby="global-bot-dropdown" style="max-height: 400px; overflow-y: auto; width: 320px;">
                    <!-- Items populated by JS -->
                </ul>
            </div>
            <input type="hidden" id="global-bot-selector" value="">
            
            <button class="btn btn-primary" onclick="refreshCurrentTabList()" title="åˆ·æ–°åˆ—è¡¨" data-i18n-title="refresh_list">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
    </div>

            <ul class="nav nav-tabs mb-3" id="relation-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="tab-groups-list-tab" data-bs-toggle="tab" data-bs-target="#tab-pane-groups" type="button" role="tab" aria-selected="true" data-i18n="group_list_title">ç¾¤ç»„åˆ—è¡¨</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tab-friends-list-tab" data-bs-toggle="tab" data-bs-target="#tab-pane-friends" type="button" role="tab" aria-selected="false" onclick="ensureFriendListLoaded()" data-i18n="friend_list_title">å¥½å‹åˆ—è¡¨</button>
                </li>
            </ul>
            
            <div class="tab-content" style="height: calc(100vh - 200px);">
                <!-- Groups Pane -->
                <div class="tab-pane fade show active h-100" id="tab-pane-groups" role="tabpanel">
                    <div class="row h-100">
                        <!-- Left: Group List -->
                        <div class="col-md-4 h-100 group-manage-col">
                            <div class="card h-100 d-flex flex-column">
                                <div class="card-header">
                                    <input type="text" class="form-control mb-2" id="group-search" placeholder="æœç´¢ç¾¤ç»„..." data-i18n="search_groups_placeholder" onkeyup="filterGroups()">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted"><span data-i18n="sort_by">æ’åº:</span></small>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-secondary active" onclick="sortGroups('name')" id="btn-sort-group-name" data-i18n="sort_name">åç§°</button>
                                            <button class="btn btn-outline-secondary" onclick="sortGroups('count')" id="btn-sort-group-count" data-i18n="sort_count">äººæ•°</button>
                                            <button class="btn btn-outline-secondary" onclick="sortGroups('msg_today')" id="btn-sort-group-msg_today" data-i18n="sort_today">ä»Šæ—¥</button>
                                            <button class="btn btn-outline-secondary" onclick="sortGroups('id')" id="btn-sort-group-id" data-i18n="sort_id">ID</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body p-0" style="overflow-y: auto;">
                                    <div class="list-group list-group-flush" id="group-list">
                                        <div class="text-center p-4 text-muted" data-i18n="select_bot_first">è¯·å…ˆé€‰æ‹©æœºå™¨äººå¹¶åˆ·æ–°</div>
                                    </div>
                                </div>
                                <div class="card-footer text-muted small" id="group-count">
                                    <span data-i18n="total_groups_count">å…± 0 ä¸ªç¾¤ç»„</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right: Group Details -->
                        <div class="col-md-8 h-100 group-manage-col">
                            <div class="card h-100" id="group-detail-empty">
                                <div class="card-body d-flex align-items-center justify-content-center text-muted">
                                    <div class="text-center">
                                        <i class="bi bi-chat-square-text fs-1"></i>
                                        <p class="mt-2" data-i18n="select_group_to_view">è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªç¾¤ç»„æŸ¥çœ‹è¯¦æƒ…</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card h-100 d-flex flex-column" id="group-detail-content" style="display: none !important;">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <img id="current-group-avatar" src="" class="rounded-circle me-2" style="width: 32px; height: 32px; display: none;">
                                        <div class="d-flex flex-column">
                                            <h5 class="mb-0" id="current-group-name" data-i18n="group_name_default">ç¾¤ç»„åç§°</h5>
                                            <small class="text-muted" id="current-group-stats" style="font-size: 0.75rem;" data-i18n="group_stats_default">ä»Šæ—¥: 0 / æ€»è®¡: 0</small>
                                        </div>
                                    </div>
                                    <span class="badge bg-secondary" id="current-group-id">123456</span>
                                </div>
                                
                                <!-- Chat/Members Area -->
                                <div class="card-body d-flex flex-column p-0" style="overflow: hidden;">
                                    <ul class="nav nav-tabs nav-justified" id="group-tabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="members-tab" data-bs-toggle="tab" data-bs-target="#members-view" type="button" data-i18n="tab_members">æˆå‘˜åˆ—è¡¨</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="actions-tab" data-bs-toggle="tab" data-bs-target="#actions-view" type="button" data-i18n="tab_actions">å¿«æ·æ“ä½œ</button>
                                        </li>
                                    </ul>
                                    
                                    <div class="tab-content flex-grow-1" style="overflow-y: auto;">
                                        <!-- Members View -->
                                        <div class="tab-pane fade show active p-0" id="members-view">
                                            <div class="p-2 border-bottom bg-light">
                                                <input type="text" class="form-control form-control-sm" id="member-search" placeholder="æœç´¢æˆå‘˜(æ˜µç§°/åç‰‡/ID)..." data-i18n="search_members_placeholder" onkeyup="renderMembers()">
                                            </div>
                                            <table class="table table-hover mb-0">
                                                <thead class="table-light sticky-top">
                                                    <tr>
                                                        <th style="cursor: pointer;" onclick="sortMembers('card')"><span data-i18n="col_member_name">æ˜µç§°/ç¾¤åç‰‡</span> <i class="bi bi-sort-alpha-down" id="sort-icon-card"></i></th>
                                                        <th style="cursor: pointer;" onclick="sortMembers('id')"><span data-i18n="col_member_id">QQ/WXID</span> <i class="bi" id="sort-icon-id"></i></th>
                                                        <th style="cursor: pointer;" onclick="sortMembers('role')"><span data-i18n="col_member_role">è§’è‰²</span> <i class="bi" id="sort-icon-role"></i></th>
                                                        <th style="cursor: pointer;" onclick="sortMembers('msg_today')"><span data-i18n="col_member_msg">ä»Šæ—¥/æ€»è®¡ (å…¨ç¾¤)</span> <i class="bi" id="sort-icon-msg_today"></i></th>
                                                        <th style="cursor: pointer;" onclick="sortMembers('time')"><span data-i18n="col_member_last_seen">æœ€åå‘è¨€</span> <i class="bi" id="sort-icon-time"></i></th>
                                                        <th data-i18n="col_action">æ“ä½œ</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="member-list-body">
                                                    <!-- Members here -->
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                        <!-- Actions View -->
                                        <div class="tab-pane fade p-3" id="actions-view">
                                            <div class="mb-3">
                                                <label class="form-label" data-i18n="send_group_msg">å‘é€ç¾¤æ¶ˆæ¯</label>
                                                <textarea class="form-control" id="group-msg-input" rows="4" placeholder="åœ¨æ­¤è¾“å…¥æ¶ˆæ¯å†…å®¹..." data-i18n="enter_msg_placeholder"></textarea>
                                                
                                                <div class="form-check mt-2">
                                                    <input class="form-check-input" type="checkbox" id="auto-recall-check" onchange="toggleAutoRecallInput()">
                                                    <label class="form-check-label" for="auto-recall-check" data-i18n="auto_recall_label">
                                                        å‘é€åè‡ªåŠ¨æ’¤å›
                                                    </label>
                                                </div>
                                                <div class="input-group input-group-sm mt-1 mb-2" id="auto-recall-input-group" style="display: none;">
                                                    <span class="input-group-text" data-i18n="recall_delay_label">å»¶è¿Ÿæ’¤å›(ç§’)</span>
                                                    <input type="number" class="form-control" id="auto-recall-delay" value="0" min="0" max="120" placeholder="0 = ç«‹å³æ’¤å›" data-i18n-placeholder="recall_delay_placeholder">
                                                    <span class="input-group-text text-muted" style="font-size: 0.8em;" data-i18n="recall_limit_hint">é¢‘é“é™120s</span>
                                                </div>

                                                <div class="d-flex gap-2 mt-2">
                                                    <button class="btn btn-primary" onclick="sendGroupMsg()">
                                                        <i class="bi bi-send"></i> <span data-i18n="btn_send">å‘é€</span>
                                                    </button>
                                                    <button class="btn btn-info text-white" onclick="sendSmartGroupMsg()">
                                                        <i class="bi bi-lightning-charge"></i> <span data-i18n="btn_smart_send">æ™ºèƒ½å‘é€ (WakeUp)</span>
                                                    </button>
                                                </div>
                                                <small class="text-muted d-block mt-1">æ™ºèƒ½å‘é€: å½“æœºå™¨äººæ— æ³•ç›´æ¥å›å¤æ—¶(å¦‚é¢‘é“æœºå™¨äººè¿‡æœŸ)ï¼Œä¼šå°è¯•å”¤é†’å…¶ä»–æœºå™¨äººååŠ©ã€‚</small>
                                            </div>
                                            <hr>
                                            <div class="mb-3">
                                                <label class="form-label" data-i18n="check_member_label">æŸ¥è¯¢ç¾¤æˆå‘˜</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="check-member-input" placeholder="è¾“å…¥ç”¨æˆ· ID (QQå·)" data-i18n-placeholder="check_member_placeholder">
                                                    <button class="btn btn-outline-primary" type="button" onclick="checkGroupMember()" data-i18n="btn_check">æŸ¥è¯¢</button>
                                                </div>
                                                <div id="check-member-result" class="form-text mt-1" style="min-height: 20px;"></div>
                                            </div>
                                            <hr>
                                            <div class="mb-3">
                                                <label class="form-label text-danger" data-i18n="danger_zone">å±é™©æ“ä½œ</label>
                                                <div>
                                                    <button class="btn btn-outline-danger btn-sm" onclick="leaveGroup()" data-i18n="btn_leave_group">é€€å‡ºè¯¥ç¾¤</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Friends Pane -->
                <div class="tab-pane fade h-100" id="tab-pane-friends" role="tabpanel">
                    <div class="row h-100">
                        <!-- Left: Friend List -->
                        <div class="col-md-4 h-100">
                            <div class="card h-100 d-flex flex-column">
                                <div class="card-header bg-white">
                                    <input type="text" class="form-control mb-2" id="friend-search" placeholder="æœç´¢å¥½å‹..." data-i18n="search_friends_placeholder" onkeyup="filterFriends()">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted"><span data-i18n="sort_by">æ’åº:</span></small>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-secondary active" onclick="sortFriends('name')" id="btn-sort-friend-name" data-i18n="sort_name">åç§°</button>
                                            <button class="btn btn-outline-secondary" onclick="sortFriends('id')" id="btn-sort-friend-id" data-i18n="sort_id">ID</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body p-0" style="overflow-y: auto;">
                                    <div class="list-group list-group-flush" id="friend-list">
                                        <div class="text-center p-4 text-muted" data-i18n="select_bot_first">è¯·å…ˆé€‰æ‹©æœºå™¨äººå¹¶åˆ·æ–°</div>
                                    </div>
                                </div>
                                <div class="card-footer text-muted small" id="friend-count">
                                    <span data-i18n="total_friends_count_default">å…± 0 ä¸ªå¥½å‹</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right: Friend Details -->
                        <div class="col-md-8 h-100">
                            <div class="card h-100" id="friend-detail-empty">
                                <div class="card-body d-flex align-items-center justify-content-center text-muted">
                                    <div class="text-center">
                                        <i class="bi bi-person fs-1"></i>
                                        <p class="mt-2" data-i18n="select_friend_to_view">è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªå¥½å‹æŸ¥çœ‹è¯¦æƒ…</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card h-100 d-flex flex-column" id="friend-detail-content" style="display: none !important;">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0" id="current-friend-name" data-i18n="friend_name_default">å¥½å‹åç§°</h5>
                                    <span class="badge bg-secondary" id="current-friend-id">123456</span>
                                </div>
                                
                                <div class="card-body p-3">
                                    <div class="mb-3">
                                        <label class="form-label" data-i18n="send_private_msg">å‘é€ç§èŠæ¶ˆæ¯</label>
                                        <textarea class="form-control" id="friend-msg-input" rows="4" placeholder="åœ¨æ­¤è¾“å…¥æ¶ˆæ¯å†…å®¹..." data-i18n-placeholder="input_message_content"></textarea>
                                        <button class="btn btn-primary mt-2" onclick="sendFriendMsg()">
                                            <i class="bi bi-send"></i> <span data-i18n="send">å‘é€</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bots Tab -->
        <div id="tab-bots" class="content-section" style="display:none;">
            <div class="row g-4">
                <!-- Left Column: Bots -->
                <div class="col-xl-7 col-lg-6">
                    <div class="card shadow-sm d-flex flex-column">
                        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center flex-shrink-0">
                            <h5 class="mb-0"><i class="bi bi-robot me-2"></i><span data-i18n="tab_access_bots">æ¥å…¥ç«¯ (Bots)</span> <span id="badge-bots" class="badge bg-secondary ms-1">0</span></h5>
                            <div class="d-flex gap-2">
                                <input type="text" class="form-control form-control-sm" placeholder="æœç´¢æœºå™¨äºº..." data-i18n-placeholder="search_bots_placeholder" style="width: 150px;" onkeyup="filterBots(this.value)">
                                <button class="btn btn-sm btn-outline-primary" onclick="fetchBots()" data-i18n="refresh">åˆ·æ–°</button>
                            </div>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex flex-wrap gap-2 mb-3 flex-shrink-0">
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary" onclick="sortBots('name')" id="btn-sort-bot-name" data-i18n="sort_name">åç§°</button>
                                    <button class="btn btn-outline-secondary" onclick="sortBots('id')" id="btn-sort-bot-id" data-i18n="sort_id">ID</button>
                                    <button class="btn btn-outline-secondary" onclick="sortBots('platform')" id="btn-sort-bot-platform" data-i18n="sort_protocol">åè®®</button>
                                    <button class="btn btn-outline-secondary" onclick="sortBots('count')" id="btn-sort-bot-count" data-i18n="sort_group_count">ç¾¤æ•°</button>
                                    <button class="btn btn-outline-secondary" onclick="sortBots('msg')" id="btn-sort-bot-msg" data-i18n="sort_messages">æ¶ˆæ¯</button>
                                    <button class="btn btn-outline-secondary" onclick="sortBots('time')" id="btn-sort-bot-time" data-i18n="sort_time">æ—¶é—´</button>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary active" id="btn-bot-view-detail" onclick="setBotViewMode('detail')" title="è¯¦ç»†æ¨¡å¼" data-i18n-title="view_mode_detail"><i class="bi bi-card-text"></i></button>
                                    <button class="btn btn-outline-secondary" id="btn-bot-view-compact" onclick="setBotViewMode('compact')" title="ç²¾ç®€æ¨¡å¼" data-i18n-title="view_mode_compact"><i class="bi bi-grid-fill"></i></button>
                                </div>
                            </div>
                            <div class="row g-3 bot-list-container" id="bot-list-container">
                                <!-- Bot Cards -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Workers -->
                <div class="col-xl-5 col-lg-6">
                    <div class="card shadow-sm d-flex flex-column">
                        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center flex-shrink-0">
                            <h5 class="mb-0"><i class="bi bi-cpu me-2"></i><span data-i18n="tab_process_workers">å¤„ç†ç«¯ (Workers)</span> <span id="badge-workers" class="badge bg-secondary ms-1">0</span></h5>
                            <div class="d-flex gap-2">
                                <input type="text" class="form-control form-control-sm" placeholder="æœç´¢Worker..." data-i18n-placeholder="search_workers_placeholder" style="width: 150px;" onkeyup="filterWorkers(this.value)">
                                <button class="btn btn-sm btn-outline-primary" onclick="fetchWorkers()" data-i18n="refresh">åˆ·æ–°</button>
                            </div>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex flex-wrap gap-2 mb-3 flex-shrink-0">
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary" onclick="sortWorkers('addr')" id="btn-sort-worker-addr" data-i18n="sort_address">åœ°å€</button>
                                    <button class="btn btn-outline-secondary" onclick="sortWorkers('time')" id="btn-sort-worker-time" data-i18n="sort_time">æ—¶é—´</button>
                                    <button class="btn btn-outline-secondary" onclick="sortWorkers('msg')" id="btn-sort-worker-msg" data-i18n="sort_processed">å¤„ç†</button>
                                    <button class="btn btn-outline-secondary" onclick="sortWorkers('status')" id="btn-sort-worker-status" data-i18n="sort_status">çŠ¶æ€</button>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary active" id="btn-worker-view-detail" onclick="setWorkerViewMode('detail')" title="è¯¦ç»†æ¨¡å¼" data-i18n-title="view_mode_detail"><i class="bi bi-card-text"></i></button>
                                    <button class="btn btn-outline-secondary" id="btn-worker-view-compact" onclick="setWorkerViewMode('compact')" title="ç²¾ç®€æ¨¡å¼" data-i18n-title="view_mode_compact"><i class="bi bi-grid-fill"></i></button>
                                </div>
                            </div>
                            <div class="row g-3 worker-list-container" id="worker-list-container">
                                <!-- Worker Cards -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overmind Tab -->
        <div id="tab-overmind" class="content-section" style="display:none; height: calc(100vh - 100px);">
            <iframe id="overmind-iframe" src="" style="width: 100%; height: 100%; border: none; border-radius: 0.75rem;"></iframe>
        </div>

        <!-- System Monitor (Merged Events & Logs) -->
        <div id="tab-monitor" class="tab-content" style="display:none; height: calc(100vh - 80px);">
            <ul class="nav nav-tabs mb-3" id="monitor-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="monitor-events-tab" data-bs-toggle="tab" data-bs-target="#view-events" type="button" role="tab" data-i18n="monitor_events">å®æ—¶æ¶ˆæ¯</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="monitor-logs-tab" data-bs-toggle="tab" data-bs-target="#view-logs" type="button" role="tab" onclick="fetchLogs()" data-i18n="monitor_logs">ç³»ç»Ÿæ—¥å¿—</button>
                </li>
            </ul>
            
            <div class="tab-content h-100">
                <!-- Real-time Events -->
                <div class="tab-pane fade show active h-100" id="view-events" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0" data-i18n="monitor_events_title">å®æ—¶æ¶ˆæ¯ç›‘æ§</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-danger" onclick="clearEvents()" data-i18n="clear">æ¸…ç©º</button>
                            <div class="form-check form-switch d-inline-block ms-2">
                                <input class="form-check-input" type="checkbox" id="auto-scroll-events" checked>
                                <label class="form-check-label" for="auto-scroll-events" data-i18n="auto_scroll">è‡ªåŠ¨æ»šåŠ¨</label>
                            </div>
                            <span id="ws-status" class="badge bg-secondary ms-2">Disconnected</span>
                        </div>
                    </div>
                    <div class="log-box" id="event-container" style="height: calc(100% - 60px);">
                        <div class="text-muted text-center mt-5" data-i18n="waiting_events_connection">ç­‰å¾…äº‹ä»¶è¿æ¥...</div>
                    </div>
                </div>

                <!-- Logs -->
                <div class="tab-pane fade h-100" id="view-logs" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0" data-i18n="system_logs_title">ç³»ç»Ÿæ—¥å¿—</h5>
                        <div class="d-flex align-items-center">
                            <select class="form-select form-select-sm me-2" id="log-bot-selector" style="width: auto; min-width: 150px;" onchange="fetchLogs()">
                                <option value="">å…¨éƒ¨ (All)</option>
                                <option value="system">BotNexus System</option>
                            </select>
                            <button class="btn btn-sm btn-outline-secondary" onclick="fetchLogs()" data-i18n="refresh">åˆ·æ–°</button>
                            <div class="form-check form-switch d-inline-block ms-2">
                                <input class="form-check-input" type="checkbox" id="auto-refresh-logs" checked>
                                <label class="form-check-label" for="auto-refresh-logs" data-i18n="auto_refresh">è‡ªåŠ¨åˆ·æ–°</label>
                            </div>
                        </div>
                    </div>
                    <div class="log-box" id="log-container" style="height: calc(100% - 60px);">
                        <!-- Logs -->
                    </div>
                </div>
            </div>
        </div>




        <!-- Docker Tab -->
        <div id="tab-docker" class="content-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0" data-i18n="sidebar_docker">Dockerç®¡ç†</h4>
                <div class="d-flex align-items-center">
                    <div class="input-group input-group-sm me-2" style="width: 200px;">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="docker-search-input" placeholder="æœç´¢å®¹å™¨..." data-i18n-placeholder="search_placeholder" oninput="filterDockerContainers()">
                    </div>
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="addBotContainer()">
                        <i class="bi bi-plus-lg"></i> <span data-i18n="docker_add_bot">æ·»åŠ æœºå™¨äºº</span>
                    </button>
                    <button class="btn btn-sm btn-outline-success me-2" onclick="addWorkerContainer()">
                        <i class="bi bi-plus-lg"></i> <span data-i18n="docker_add_node">æ·»åŠ èŠ‚ç‚¹</span>
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="loadDockerContainers()">
                        <i class="bi bi-arrow-clockwise"></i> <span data-i18n="refresh">åˆ·æ–°</span>
                    </button>
                </div>
            </div>
            <div class="card">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th data-i18n="docker_container_id">ID</th>
                                <th>Names</th>
                                <th data-i18n="docker_image">Image</th>
                                <th data-i18n="docker_status">State</th>
                                <th data-i18n="docker_status">Status</th>
                                <th data-i18n="docker_action">Action</th>
                            </tr>
                        </thead>
                        <tbody id="docker-container-list">
                            <tr><td colspan="6" class="text-center text-muted" data-i18n="loading">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Routing Tab -->
        <div id="tab-routing" class="content-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="d-flex align-items-center">
                    <h4 class="mb-0 me-2" data-i18n="sidebar_routing">è·¯ç”±ç®¡ç†</h4>
                    <button class="btn btn-sm btn-outline-info" onclick="toggleRoutingHelp()" data-i18n-title="routing_help_tooltip" title="ä½¿ç”¨è¯´æ˜">
                        <i class="bi bi-question-circle"></i>
                    </button>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="showAddRoutingRuleDialog()">
                        <i class="bi bi-plus-lg"></i> <span data-i18n="routing_add_rule">æ·»åŠ è·¯ç”±è§„åˆ™</span>
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="fetchRoutingRules()">
                        <i class="bi bi-arrow-clockwise"></i> <span data-i18n="refresh">åˆ·æ–°</span>
                    </button>
                </div>
            </div>

            <!-- è·¯ç”±è§„åˆ™ä½¿ç”¨è¯´æ˜ -->
            <div class="alert alert-info mb-4" id="routing-help-section" style="display: none;">
                <div class="d-flex align-items-start">
                    <i class="bi bi-info-circle-fill me-2 mt-1"></i>
                    <div>
                        <h6 class="alert-heading mb-2" data-i18n="routing_usage_title">ğŸ“‹ è·¯ç”±è§„åˆ™ä½¿ç”¨è¯´æ˜</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong data-i18n="routing_pattern_format">ğŸ¯ åŒ¹é…æ¨¡å¼æ ¼å¼ï¼š</strong></p>
                                <ul class="small mb-2">
                                <li><code>user_123456</code> - ç²¾ç¡®åŒ¹é…ç”¨æˆ·IDï¼ˆ123456ï¼‰</li>
                                <li><code>group_789012</code> - ç²¾ç¡®åŒ¹é…ç¾¤ç»„IDï¼ˆ789012ï¼‰</li>
                                <li><code>*_test</code> - é€šé…ç¬¦åŒ¹é…ï¼ˆä»¥_testç»“å°¾ï¼‰</li>
                                <li><code>123*</code> - é€šé…ç¬¦åŒ¹é…ï¼ˆä»¥123å¼€å¤´ï¼‰</li>
                            </ul>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong data-i18n="routing_target_format">ğŸ”„ ç›®æ ‡èŠ‚ç‚¹æ ¼å¼ï¼š</strong></p>
                            <ul class="small mb-2">
                                <li><code>worker_1</code> - æŒ‡å®šå·¥ä½œèŠ‚ç‚¹</li>
                                <li><code>worker_2</code> - æŒ‡å®šå·¥ä½œèŠ‚ç‚¹</li>
                                <li><code>default</code> - é»˜è®¤å¤„ç†èŠ‚ç‚¹</li>
                            </ul>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <p class="mb-1"><strong data-i18n="routing_priority_rules">âš¡ ä¼˜å…ˆçº§è§„åˆ™ï¼š</strong></p>
                                <ul class="small mb-0">
                                    <li>ç²¾ç¡®åŒ¹é… > é€šé…ç¬¦åŒ¹é…</li>
                                    <li>å…ˆæ·»åŠ çš„è§„åˆ™ä¼˜å…ˆåŒ¹é…</li>
                                    <li>æ— åŒ¹é…æ—¶ä½¿ç”¨é»˜è®¤å¤„ç†</li>
                                </ul>
                            </div>
                        </div>
                        <hr>
                        <p class="small mb-0" data-i18n="routing_example_usage">ğŸ’¡ ç¤ºä¾‹ï¼šå°†ç”¨æˆ·123456çš„æ¶ˆæ¯è·¯ç”±åˆ°worker_1å¤„ç†ï¼Œè®¾ç½®åŒ¹é…æ¨¡å¼ä¸º"user_123456"ï¼Œç›®æ ‡èŠ‚ç‚¹ä¸º"worker_1"</p>
                    </div>
                </div>
            </div>
            
            <div class="row" id="routing-list-container">
                <!-- Routing Rule Cards -->
                <div class="col-12 text-center text-muted">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2" data-i18n="loading_routing_rules">æ­£åœ¨åŠ è½½è·¯ç”±è§„åˆ™...</p>
                </div>
            </div>
        </div>

        <!-- Visualization Tab -->
        <div id="tab-visualization" class="content-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0"><i class="bi bi-broadcast"></i> <span data-i18n="sidebar_visualization">è½¬å‘å¯è§†åŒ–</span></h4>
                <div class="d-flex gap-3 align-items-center">
                    <div class="text-muted small">
                        <span class="badge bg-primary me-1" style="width: 12px; height: 12px; padding: 0; display: inline-block;"> </span> <span data-i18n="viz_bot">Bot</span>
                        <span class="badge bg-success ms-2 me-1" style="width: 12px; height: 12px; padding: 0; display: inline-block;"> </span> <span data-i18n="viz_nexus">Nexus</span>
                        <span class="badge bg-warning ms-2 me-1" style="width: 12px; height: 12px; padding: 0; display: inline-block;"> </span> <span data-i18n="viz_worker">Worker</span>
                    </div>
                    <button id="btn-fullscreen" class="btn btn-outline-info btn-sm" onclick="toggleFullScreen()">
                        <i id="icon-fullscreen" class="bi bi-arrows-fullscreen"></i> <span id="text-fullscreen" data-i18n="full_screen">å…¨å±</span>
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearVisualization()">
                        <i class="bi bi-trash"></i> <span data-i18n="clear">æ¸…é™¤</span>
                    </button>
                </div>
            </div>
            <div id="visualization-container">
                <canvas id="viz-canvas"></canvas>
                <div id="viz-nodes"></div>
            </div>
        </div>

        <!-- Logs Tab (Full Page) -->
        <div id="tab-logs" class="content-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0" data-i18n="log_center">æ—¥å¿—ä¸­å¿ƒ</h4>
                <div class="d-flex align-items-center">
                    <select class="form-select form-select-sm me-2" id="log-bot-selector-full" style="width: auto; min-width: 200px;" onchange="fetchLogsFull()">
                        <option value="">å…¨éƒ¨ (All)</option>
                        <option value="system">BotNexus System</option>
                    </select>
                    <button class="btn btn-sm btn-outline-secondary" onclick="fetchLogsFull()" data-i18n="refresh">åˆ·æ–°</button>
                    <div class="form-check form-switch d-inline-block ms-3">
                        <input class="form-check-input" type="checkbox" id="auto-refresh-logs-full" checked>
                        <label class="form-check-label" for="auto-refresh-logs-full" data-i18n="auto_refresh">è‡ªåŠ¨åˆ·æ–°</label>
                    </div>
                </div>
            </div>
            
            <div class="card h-100" style="height: calc(100vh - 150px) !important;">
                <div class="card-body p-0 d-flex flex-column h-100">
                    <div class="log-box flex-grow-1" id="log-container-full" style="border: none; border-radius: 0 0 0.75rem 0.75rem;">
                        <!-- Logs -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Debug & Test (Merged) -->
        <div id="tab-debug" class="content-section" style="display:none;">
            <h4 class="mb-4" data-i18n="debug_test_title">è°ƒè¯•æµ‹è¯•</h4>
            
            <ul class="nav nav-tabs mb-3" id="debug-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="debug-visual-tab" data-bs-toggle="tab" data-bs-target="#debug-visual" type="button" role="tab" data-i18n="debug_msg_builder">æ¶ˆæ¯æ„é€ </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="debug-raw-tab" data-bs-toggle="tab" data-bs-target="#debug-raw" type="button" role="tab" data-i18n="debug_api_test">æ¥å£è°ƒè¯•</button>
                </li>
            </ul>

            <div class="tab-content">
                <!-- Visual Sender -->
                <div class="tab-pane fade show active" id="debug-visual" role="tabpanel">
                    <div class="row">
                        <div class="col-md-7">
                            <div class="card mb-3">
                                <div class="card-header" data-i18n="send_message_card_title">å‘é€æ¶ˆæ¯</div>
                                <div class="card-body">
                                    <form id="msg-test-form" onsubmit="return false;">
                                        <div class="mb-3">
                                            <label class="form-label" data-i18n="target_uid_label">ç›®æ ‡ç”¨æˆ·/ç¾¤ç»„ UID</label>
                                            <div class="input-group mb-2">
                                                <select class="form-select" id="mt-group-select" onchange="onTestGroupSelectChange()">
                                                    <option value="" data-i18n="select_group_placeholder">-- é€‰æ‹©ç¾¤ç»„ (æˆ–æ‰‹åŠ¨è¾“å…¥ UID) --</option>
                                                </select>
                                                <button class="btn btn-outline-secondary" type="button" onclick="loadTestGroups()" title="åˆ·æ–°ç¾¤ç»„åˆ—è¡¨"><i class="bi bi-arrow-clockwise"></i></button>
                                            </div>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="mt-target" placeholder="ç¾¤å· (Group ID) æˆ– QQå· (User ID)" data-i18n-placeholder="target_uid_placeholder" oninput="updateCodePreview()">
                                                <button class="btn btn-outline-secondary" type="button" onclick="pasteTargetUid()" data-i18n="paste_selected">ç²˜è´´é€‰ä¸­</button>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label" data-i18n="message_type_label">æ¶ˆæ¯ç±»å‹</label>
                                            <select class="form-select" id="mt-type" onchange="updateMsgForm(); updateCodePreview()">
                                                <option value="text" data-i18n="msg_type_text">æ–‡æœ¬ (Text / CQ Code)</option>
                                                <option value="image" data-i18n="msg_type_image">å›¾ç‰‡ (Image)</option>
                                                <option value="record" data-i18n="msg_type_record">è¯­éŸ³ (Record)</option>
                                                <option value="video" data-i18n="msg_type_video">è§†é¢‘ (Video)</option>
                                                <option value="music" data-i18n="msg_type_music">éŸ³ä¹åˆ†äº« (Music)</option>
                                                <option value="share" data-i18n="msg_type_share">é“¾æ¥åˆ†äº« (Share)</option>
                                                <option value="poke" data-i18n="msg_type_poke">æˆ³ä¸€æˆ³ (Poke)</option>
                                                <option value="json" data-i18n="msg_type_json">JSON å¡ç‰‡</option>
                                                <option value="xml" data-i18n="msg_type_xml">XML å¡ç‰‡</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Text Input -->
                                        <div id="mt-group-text" class="mb-3">
                                            <label class="form-label" data-i18n="message_content_label">å†…å®¹</label>
                                            <textarea class="form-control" id="mt-content" rows="3" placeholder="è¾“å…¥æ–‡æœ¬å†…å®¹..." data-i18n-placeholder="enter_text_content_placeholder" oninput="updateCodePreview()"></textarea>
                                        </div>
                                        
                                        <!-- File/Image Input -->
                                        <div id="mt-group-file" class="mb-3" style="display:none;">
                                            <label class="form-label" id="mt-file-label" data-i18n="file_image_url_label">æ–‡ä»¶/å›¾ç‰‡ URL</label>
                                            <input type="text" class="form-control" id="mt-file-path" placeholder="http://... or file://..." data-i18n-placeholder="file_url_placeholder" oninput="updateCodePreview()">
                                        </div>
        
                                        <!-- Music Input -->
                                <div id="mt-group-music" class="mb-3" style="display:none;">
                                    <label class="form-label" data-i18n="music_share_label">éŸ³ä¹åˆ†äº«</label>
                                    <div class="input-group mb-2">
                                        <span class="input-group-text" data-i18n="platform_label">å¹³å°</span>
                                        <select class="form-select" id="mt-music-type" onchange="updateCodePreview()">
                                            <option value="qq" data-i18n="platform_qq">QQéŸ³ä¹</option>
                                            <option value="163" data-i18n="platform_163">ç½‘æ˜“äº‘éŸ³ä¹</option>
                                            <option value="migu" data-i18n="platform_migu">å’ªå’•éŸ³ä¹</option>
                                        </select>
                                    </div>
                                    <div class="input-group">
                                        <span class="input-group-text" data-i18n="song_id_label">æ­Œæ›²ID</span>
                                        <input type="text" class="form-control" id="mt-music-id" placeholder="ä¾‹å¦‚: 123456" oninput="updateCodePreview()">
                                    </div>
                                </div>
        
                                        <!-- Share Input -->
                                        <div id="mt-group-share" class="mb-3" style="display:none;">
                                            <label class="form-label" data-i18n="link_share_label">é“¾æ¥åˆ†äº«</label>
                                            <input type="text" class="form-control mb-2" id="mt-share-url" placeholder="è·³è½¬ URL" data-i18n-placeholder="redirect_url_placeholder" oninput="updateCodePreview()">
                                            <input type="text" class="form-control mb-2" id="mt-share-title" placeholder="æ ‡é¢˜" data-i18n-placeholder="title_placeholder" oninput="updateCodePreview()">
                                            <input type="text" class="form-control mb-2" id="mt-share-content" placeholder="å†…å®¹æè¿°" data-i18n-placeholder="content_desc_placeholder" oninput="updateCodePreview()">
                                            <input type="text" class="form-control" id="mt-share-image" placeholder="å°é¢å›¾ç‰‡ URL" data-i18n-placeholder="cover_image_url_placeholder" oninput="updateCodePreview()">
                                        </div>
                                        
                                        <!-- JSON/XML Input -->
                                        <div id="mt-group-raw" class="mb-3" style="display:none;">
                                            <label class="form-label" id="mt-raw-label" data-i18n="raw_content_label">å†…å®¹</label>
                                            <textarea class="form-control font-monospace" id="mt-raw-content" rows="5" placeholder='{"app":"com.tencent.miniapp", ...}' oninput="updateCodePreview()"></textarea>
                                        </div>
                                        
                                        <div class="d-grid">
                                            <button class="btn btn-primary" onclick="submitTestMsg()" data-i18n="send_msg">å‘é€æ¶ˆæ¯</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="card mb-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span data-i18n="code_preview_title">ä»£ç é¢„è§ˆ (JSON)</span>
                                    <button class="btn btn-sm btn-outline-secondary py-0" onclick="copyCodePreview()" data-i18n="copy">å¤åˆ¶</button>
                                </div>
                                <div class="card-body bg-light p-0 position-relative">
                                    <pre id="code-preview" class="p-3 mb-0" style="white-space: pre-wrap; font-size: 0.8rem; color: #d63384; max-height: 300px; overflow-y: auto;">{}</pre>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header" data-i18n="send_result_title">å‘é€ç»“æœ</div>
                                <div class="card-body p-3">
                                     <div id="mt-result" class="alert alert-secondary mb-0" role="alert" style="display:none;"></div>
                                </div>
                            </div>
                            <div class="mt-3 text-muted small">
                                <ul>
                                    <li data-i18n="debug_help_1">åœ¨æ­¤é¡µé¢å¯è§†åŒ–çš„æ„é€ æ¶ˆæ¯ï¼Œå¹¶å®æ—¶æŸ¥çœ‹å¯¹åº”çš„ JSON æ•°æ®ç»“æ„ã€‚</li>
                                    <li data-i18n="debug_help_2">æ”¯æŒ OneBot 11 æ ‡å‡†æ¶ˆæ¯ç±»å‹ã€‚</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Raw API -->
                <div class="tab-pane fade" id="debug-raw" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header" data-i18n="send_action_title">å‘é€ Action</div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label" data-i18n="bot_id_label">Bot ID</label>
                                        <input type="text" class="form-control" id="action-bot-id" placeholder="ç•™ç©ºåˆ™éšæœºé€‰æ‹©" data-i18n-placeholder="action_bot_id_placeholder">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label" data-i18n="action_name_label">Action Name</label>
                                        <input type="text" class="form-control" id="action-name" value="send_group_msg">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label" data-i18n="action_params_label">Params (JSON)</label>
                                        <textarea class="form-control font-monospace" id="action-params" rows="5">{"group_id": 123456, "message": "Hello from Go Manager"}</textarea>
                                    </div>
                                    <button class="btn btn-primary" onclick="sendAction()" data-i18n="send_request_btn">å‘é€è¯·æ±‚</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header" data-i18n="response_result_title">å“åº”ç»“æœ</div>
                                <div class="card-body bg-light">
                                    <pre id="action-result" class="mb-0" data-i18n="waiting_request">ç­‰å¾…è¯·æ±‚...</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Users Tab -->
        <div id="tab-users" class="content-section" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="m-0" data-i18n="users_title">ç”¨æˆ·ç®¡ç†</h4>
                <button class="btn btn-primary" onclick="showCreateUserModal()">
                    <i class="bi bi-person-plus"></i> <span data-i18n="add_user_btn">æ·»åŠ ç”¨æˆ·</span>
                </button>
            </div>
            
            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th data-i18n="user_col_id">ID</th>
                                    <th data-i18n="user_col_username">ç”¨æˆ·å</th>
                                    <th data-i18n="user_col_role">è§’è‰²</th>
                                    <th data-i18n="user_col_created">åˆ›å»ºæ—¶é—´</th>
                                    <th class="text-end" data-i18n="user_col_actions">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <!-- Users list will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="tab-settings" class="content-section" style="display:none;">
            <h4 class="mb-4" data-i18n="settings_title">ç³»ç»Ÿè®¾ç½®</h4>
            
            <div class="row">
                <!-- Common Settings -->
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header" data-i18n="common_settings_title">å¸¸ç”¨è®¾ç½®</div>
                        <div class="card-body">
                            <form>
                                <div class="mb-3">
                                    <label class="form-label" data-i18n="theme_label">ç•Œé¢ä¸»é¢˜</label>
                                    <select class="form-select" onchange="setTheme(this.value)">
                                        <option value="light" data-i18n="theme_light">æµ…è‰² (Light)</option>
                                        <option value="dark" data-i18n="theme_dark">æ·±è‰² (Dark)</option>
                                        <option value="auto" data-i18n="theme_auto">è·Ÿéšç³»ç»Ÿ (Auto)</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" data-i18n="refresh_rate_label">æ•°æ®åˆ·æ–°é¢‘ç‡</label>
                                    <select id="setting-refresh-rate" class="form-select" onchange="updateRefreshRate(this.value)">
                                        <option value="2000" data-i18n="rate_fast">2 ç§’ (å¿«é€Ÿ)</option>
                                        <option value="5000" data-i18n="rate_normal">5 ç§’ (æ­£å¸¸)</option>
                                        <option value="10000" data-i18n="rate_slow">10 ç§’ (çœæµ)</option>
                                    </select>
                                </div>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="setting-notify" checked>
                                    <label class="form-check-label" for="setting-notify" data-i18n="enable_notification_label">å¯ç”¨æ¡Œé¢é€šçŸ¥</label>
                                </div>
                                <button type="button" class="btn btn-primary" data-i18n="save_common_settings_btn">ä¿å­˜å¸¸ç”¨è®¾ç½®</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Personal Preferences -->
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header"><i class="bi bi-person-gear me-2"></i><span data-i18n="personal_settings_title">ä¸ªäººåå¥½è®¾ç½®</span></div>
                        <div class="card-body">
                             <form>
                                <div class="mb-3">
                                    <label class="form-label" data-i18n="default_home_label">é»˜è®¤é¦–é¡µ</label>
                                    <select id="setting-default-home" class="form-select" onchange="localStorage.setItem('default_home', this.value)">
                                        <option value="dashboard" data-i18n="dashboard_label">ä»ªè¡¨ç›˜</option>
                                        <option value="bots" data-i18n="bot_list_label">æœºå™¨äººåˆ—è¡¨</option>
                                        <option value="groups" data-i18n="group_manage_label">ç¾¤ç»„ç®¡ç†</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" data-i18n="items_per_page_label">æ¯é¡µæ˜¾ç¤ºæ¡æ•°</label>
                                    <input type="number" id="setting-items-per-page" class="form-control" value="20" onchange="localStorage.setItem('items_per_page', this.value)">
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="card mb-4 border-warning">
                        <div class="card-header bg-warning text-dark"><i class="bi bi-shield-lock me-2"></i><span data-i18n="change_password_label">ä¿®æ”¹å¯†ç </span></div>
                        <div class="card-body">
                            <form onsubmit="event.preventDefault(); updatePassword();">
                                <div class="mb-3">
                                    <input type="password" id="pwd-current" class="form-control mb-2" placeholder="å½“å‰å¯†ç " data-i18n-placeholder="current_pwd_placeholder">
                                    <input type="password" id="pwd-new" class="form-control mb-2" placeholder="æ–°å¯†ç " data-i18n-placeholder="new_pwd_placeholder">
                                    <input type="password" id="pwd-confirm" class="form-control" placeholder="ç¡®è®¤æ–°å¯†ç " data-i18n-placeholder="confirm_pwd_placeholder">
                                </div>
                                <button type="submit" class="btn btn-warning w-100" data-i18n="save_password_btn">æ›´æ–°ç™»å½•å¯†ç </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Backend Configuration (Admin Only) -->
                <div class="col-md-12 admin-only" style="display:none;">
                    <div class="card mb-4 border-primary">
                        <div class="card-header bg-primary text-white">
                            <i class="bi bi-server me-2"></i> <span data-i18n="backend_config_title">åç«¯æœåŠ¡é…ç½® (ç®¡ç†å‘˜)</span>
                        </div>
                        <div class="card-body">
                            <form id="backend-config-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label" data-i18n="config_ws_port">WebSocket æœåŠ¡ç«¯å£</label>
                                            <input type="text" id="cfg-ws-port" class="form-control" placeholder=":3001">
                                            <div class="form-text" data-i18n="config_ws_port_help">Bot å’Œ Worker è¿æ¥ä½¿ç”¨çš„ç«¯å£ï¼Œéœ€åŒ…å«å†’å· (ä¾‹å¦‚ :3001)</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label" data-i18n="config_webui_port">WebUI æœåŠ¡ç«¯å£</label>
                                            <input type="text" id="cfg-webui-port" class="form-control" placeholder=":5000">
                                            <div class="form-text" data-i18n="config_webui_port_help">ç®¡ç†åå°ç•Œé¢è®¿é—®ç«¯å£ï¼Œéœ€åŒ…å«å†’å· (ä¾‹å¦‚ :5000)</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label" data-i18n="config_redis_addr">Redis åœ°å€</label>
                                            <input type="text" id="cfg-redis-addr" class="form-control" placeholder="127.0.0.1:6379">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label" data-i18n="config_redis_pwd">Redis å¯†ç </label>
                                            <input type="password" id="cfg-redis-pwd" class="form-control" placeholder="******">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label" data-i18n="config_admin_pwd">é»˜è®¤ç®¡ç†å‘˜å¯†ç </label>
                                            <input type="text" id="cfg-admin-pwd" class="form-control" placeholder="admin123">
                                            <div class="form-text" data-i18n="config_admin_pwd_help">æ–°éƒ¨ç½²ç³»ç»Ÿæ—¶çš„é»˜è®¤å¯†ç </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label" data-i18n="config_stats_file">ç»Ÿè®¡æ•°æ®å­˜å‚¨æ–‡ä»¶</label>
                                            <input type="text" id="cfg-stats-file" class="form-control" placeholder="stats.json">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" data-i18n="config_jwt_secret">JWT å¯†é’¥ (æ…æ”¹)</label>
                                    <input type="text" id="cfg-jwt-secret" class="form-control">
                                    <div class="form-text" data-i18n="config_jwt_secret_help">ä¿®æ”¹æ­¤é¡¹ä¼šå¯¼è‡´æ‰€æœ‰å·²ç™»å½•ç”¨æˆ· Token å¤±æ•ˆ</div>
                                </div>
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle me-2"></i> <span data-i18n="config_restart_warning">æ³¨æ„ï¼šä¿®æ”¹ç«¯å£æˆ– Redis é…ç½®åï¼Œé€šå¸¸éœ€è¦æ‰‹åŠ¨é‡å¯åç«¯æœåŠ¡æ‰èƒ½å®Œå…¨ç”Ÿæ•ˆã€‚</span>
                                </div>
                                <button type="button" class="btn btn-primary" onclick="updateBackendConfig()" data-i18n="config_save">ä¿å­˜åç«¯é…ç½®</button>
                                <button type="button" class="btn btn-outline-secondary ms-2" onclick="loadBackendConfig()" data-i18n="config_reload">é‡æ–°åŠ è½½</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Routing Rule Modal -->
    <div class="modal fade" id="routingRuleModal" tabindex="-1" aria-labelledby="routingRuleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="routingRuleModalLabel" data-i18n="routing_add_rule">æ·»åŠ è·¯ç”±è§„åˆ™</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="routing-rule-form">
                        <div class="mb-3">
                            <label for="routing-pattern" class="form-label" data-i18n="routing_pattern">åŒ¹é…æ¨¡å¼</label>
                            <input type="text" class="form-control" id="routing-pattern" placeholder="group_123, user_456, *" data-i18n-placeholder="routing_pattern_placeholder">
                            <div class="form-text" data-i18n="routing_pattern_help">æ”¯æŒé€šé…ç¬¦*ï¼Œå¤šä¸ªæ¨¡å¼ç”¨é€—å·åˆ†éš”</div>
                        </div>
                        <div class="mb-3">
                            <label for="routing-target" class="form-label" data-i18n="routing_target">ç›®æ ‡åœ°å€</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="routing-target" placeholder="ws://localhost:8080, http://example.com" data-i18n-placeholder="routing_target_placeholder">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-i18n="select_worker">é€‰æ‹©èŠ‚ç‚¹</button>
                                <ul class="dropdown-menu dropdown-menu-end" id="worker-select-dropdown">
                                    <!-- Workers will be populated here -->
                                </ul>
                            </div>
                            <div class="form-text" data-i18n="routing_target_help">æ¶ˆæ¯è½¬å‘ç›®æ ‡åœ°å€</div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="routing-enabled" checked>
                                <label class="form-check-label" for="routing-enabled" data-i18n="routing_enabled">å¯ç”¨è§„åˆ™</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="cancel">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveRoutingRule()" data-i18n="save">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Language Management ---
        let currentLang = 'zh-CN';

        function initLanguage() {
            const savedLang = localStorage.getItem('language') || 'zh-CN';
            setLanguage(savedLang);
        }

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('language', lang);
            
            if (typeof translations === 'undefined') return;

            // Update document title
            if (translations[lang] && translations[lang].app_title) {
                document.title = translations[lang].app_title;
            }

            // Update elements with data-i18n (innerText)
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                     el.innerText = translations[lang][key];
                }
            });

            // Update elements with data-i18n-placeholder
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[lang] && translations[lang][key]) {
                     el.placeholder = translations[lang][key];
                }
            });
            
             // Update elements with data-i18n-title
            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                const key = el.getAttribute('data-i18n-title');
                if (translations[lang] && translations[lang][key]) {
                     el.title = translations[lang][key];
                }
            });

            // Update Overmind iframe if loaded
            const overmindIframe = document.getElementById('overmind-iframe');
            if (overmindIframe && overmindIframe.src && overmindIframe.src !== 'about:blank' && !overmindIframe.src.endsWith('/')) {
                const token = authToken || localStorage.getItem('wxbot_token');
                const langParam = lang === 'zh-CN' ? 'zh' : 'en';
                overmindIframe.src = `/overmind/?lang=${langParam}&token=${encodeURIComponent(token)}`;
            }

            // Update visualization if active
            if (window.visualizer && typeof window.visualizer.updateLanguage === 'function') {
                window.visualizer.updateLanguage();
            }
        }

        // --- Theme Management ---
        let themeListener = null;

        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'auto';
            applyTheme(savedTheme);
            
            // Sync with settings dropdown if exists
            const themeSelect = document.querySelector('select[onchange="setTheme(this.value)"]');
            if (themeSelect) themeSelect.value = savedTheme;
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
            const next = current === 'dark' ? 'light' : 'dark';
            applyTheme(next);
        }

        function applyTheme(theme) {
            // Remove existing listener if any
            if (themeListener) {
                window.matchMedia('(prefers-color-scheme: dark)').removeEventListener('change', themeListener);
                themeListener = null;
            }

            if (theme === 'auto') {
                const mq = window.matchMedia('(prefers-color-scheme: dark)');
                
                // Define listener
                themeListener = (e) => {
                     if (e.matches) {
                        document.documentElement.setAttribute('data-theme', 'dark');
                    } else {
                        document.documentElement.removeAttribute('data-theme');
                    }
                    updateThemeIcon();
                };
                
                // Add listener
                mq.addEventListener('change', themeListener);
                
                // Apply current
                themeListener(mq);
                
            } else if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                updateThemeIcon();
            } else {
                document.documentElement.removeAttribute('data-theme');
                updateThemeIcon();
            }
            
            localStorage.setItem('theme', theme);
        }

        function updateThemeIcon() {
            const btn = document.querySelector('.theme-toggle-btn-sidebar i');
            if (btn) {
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                btn.className = isDark ? 'bi bi-sun-fill' : 'bi bi-moon-stars';
            }
        }

        function setTheme(theme) {
            applyTheme(theme);
            // åŒæ­¥æ›´æ–°è®¾ç½®é¡µé¢çš„ä¸‹æ‹‰æ¡†
            const select = document.querySelector('select[onchange="setTheme(this.value)"]');
            if (select) select.value = theme;
        }

        function updateRefreshRate(rate) {
            rate = parseInt(rate);
            localStorage.setItem('refresh_rate', rate);
            
            // é‡æ–°å¯åŠ¨å®šæ—¶å™¨
            if (window.updateInterval) clearInterval(window.updateInterval);
            if (window.systemStatsInterval) clearInterval(window.systemStatsInterval);
            
            const safeSetInterval = (fn, interval, name) => {
                return setInterval(() => {
                    try {
                        fn();
                    } catch (error) {
                        console.error(`${name}å®šæ—¶å™¨æ‰§è¡Œå¤±è´¥:`, error);
                    }
                }, interval);
            };
            
            window.updateInterval = safeSetInterval(updateStats, rate, 'updateStats');
            window.systemStatsInterval = safeSetInterval(updateSystemStats, rate, 'updateSystemStats');
            
            showToast('åˆ·æ–°é¢‘ç‡å·²æ›´æ–°', 'info');
        }

        async function updatePassword() {
            const oldPwd = document.getElementById('pwd-current').value;
            const newPwd = document.getElementById('pwd-new').value;
            const confirmPwd = document.getElementById('pwd-confirm').value;

            const t = translations[currentLang] || translations['zh-CN'];

            if (!newPwd) return alert(t.enter_new_pwd || 'è¯·è¾“å…¥æ–°å¯†ç ');
            if (newPwd !== confirmPwd) return alert(t.pwd_mismatch || 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
            if (!oldPwd) return alert(t.enter_current_pwd || 'è¯·è¾“å…¥å½“å‰å¯†ç ');

            try {
                const res = await fetchWithAuth('/api/user/password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ old_password: oldPwd, new_password: newPwd })
                });

                if (!res.ok) {
                    const txt = await res.text();
                    throw new Error(txt);
                }

                alert(t.password_change_success || 'å¯†ç ä¿®æ”¹æˆåŠŸ');
                document.getElementById('pwd-current').value = '';
                document.getElementById('pwd-new').value = '';
                document.getElementById('pwd-confirm').value = '';
            } catch (e) {
                alert((t.password_change_fail || 'ä¿®æ”¹å¤±è´¥: ') + e.message);
            }
        }

        async function loadBackendConfig() {
            if (authRole !== 'admin' && authRole !== 'super') return;
            
            try {
                const res = await fetchWithAuth('/api/admin/config');
                if (!res.ok) throw new Error('Failed to load config');
                
                const config = await res.json();
                document.getElementById('cfg-ws-port').value = config.ws_port || '';
                document.getElementById('cfg-webui-port').value = config.webui_port || '';
                document.getElementById('cfg-redis-addr').value = config.redis_addr || '';
                document.getElementById('cfg-redis-pwd').value = config.redis_pwd || '';
                document.getElementById('cfg-jwt-secret').value = config.jwt_secret || '';
                document.getElementById('cfg-admin-pwd').value = config.default_admin_password || '';
                document.getElementById('cfg-stats-file').value = config.stats_file || '';
            } catch (e) {
                console.error('Error loading backend config:', e);
            }
        }

        async function updateBackendConfig() {
            const config = {
                ws_port: document.getElementById('cfg-ws-port').value,
                webui_port: document.getElementById('cfg-webui-port').value,
                redis_addr: document.getElementById('cfg-redis-addr').value,
                redis_pwd: document.getElementById('cfg-redis-pwd').value,
                jwt_secret: document.getElementById('cfg-jwt-secret').value,
                default_admin_password: document.getElementById('cfg-admin-pwd').value,
                stats_file: document.getElementById('cfg-stats-file').value
            };

            if (!confirm('ç¡®å®šè¦ä¿å­˜åç«¯é…ç½®å—ï¼Ÿéƒ¨åˆ†ä¿®æ”¹ï¼ˆå¦‚ç«¯å£ï¼‰éœ€è¦é‡å¯æœåŠ¡åç”Ÿæ•ˆã€‚')) return;

            try {
                const res = await fetchWithAuth('/api/admin/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                const data = await res.json();
                if (data.success) {
                    alert(data.message || 'é…ç½®å·²æ›´æ–°');
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + data.message);
                }
            } catch (e) {
                alert('æ›´æ–°å‡ºé”™: ' + e.message);
            }
        }

        // --- Auth & Login ---
        let authToken = localStorage.getItem('wxbot_token');
        let authRole = localStorage.getItem('wxbot_role');
        let currentBotId = '';

        /**
         * å°è£…å¸¦è®¤è¯çš„ fetch è¯·æ±‚
         */
        async function fetchWithAuth(url, options = {}) {
            if (!authToken) {
                console.error('No auth token found');
                throw new Error('æœªç™»å½•');
            }
            
            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            };
            
            // åˆå¹¶ options
            const mergedOptions = {
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...(options.headers || {})
                }
            };
            
            return fetch(url, mergedOptions);
        }

        // Check Auth on Load
        document.addEventListener('DOMContentLoaded', () => {
            try {
                initTheme(); // Initialize theme
                initLanguage(); // Initialize language

            // Force logout if requested via URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('logout') === '1') {
                localStorage.removeItem('wxbot_token');
                localStorage.removeItem('wxbot_role');
                // Clear the logout parameter from URL
                window.history.replaceState({}, document.title, window.location.pathname);
                alert('å·²å¼ºåˆ¶é€€å‡ºç™»å½•');
            }

            // Check for Magic Link
            const magicToken = urlParams.get('magic_token');

                // ä¿®æ”¹ï¼šåœ¨æ£€æŸ¥è®¤è¯å‰ï¼Œå…ˆæ ¹æ®æ˜¯å¦æœ‰ token å†³å®šæ˜¯å¦æ˜¾ç¤ºç™»å½•é¡µ
                if (!magicToken && !authToken) {
                    document.getElementById('loginPage').style.display = 'flex';
                }

                if (magicToken) {
                // Attempt Magic Login
                fetch('/api/login/magic', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: magicToken })
                })
                .then(res => {
                    if (!res.ok) throw new Error('Magic login failed');
                    return res.json();
                })
                .then(data => {
                    authToken = data.token;
                    authRole = data.role;
                    localStorage.setItem('wxbot_token', authToken);
                    localStorage.setItem('wxbot_role', authRole);
                    
                    // Clear URL params
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    document.getElementById('loginPage').classList.add('hidden');
                    setTimeout(() => {
                        document.getElementById('loginPage').style.display = 'none';
                    }, 500);
                    startApp();
                })
                .catch(err => {
                    console.error(err);
                    const t = translations[currentLang] || translations['zh-CN'];
                    alert(t.magic_login_fail || 'å…å¯†ç ç™»å½•å¤±è´¥ï¼Œé“¾æ¥å¯èƒ½å·²è¿‡æœŸã€‚è¯·é‡æ–°è·å–æˆ–ä½¿ç”¨å¯†ç ç™»å½•ã€‚');
                    // Clean URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                    // Show login
                    document.getElementById('loginPage').classList.remove('hidden');
                    document.getElementById('loginPage').style.display = 'flex';
                });
                return;
            }

            if (!authToken) {
                document.getElementById('loginPage').classList.remove('hidden');
                document.getElementById('loginPage').style.display = 'flex';
            } else {
                document.getElementById('loginPage').classList.add('hidden');
                setTimeout(() => {
                    document.getElementById('loginPage').style.display = 'none';
                }, 500);
                startApp();
            }
            } catch (e) {
                console.error('DOMContentLoaded error:', e);
                document.getElementById('loginPage').style.display = 'flex';
            }
        });

        function applyRoleUI(role) {
            const isAdmin = (role === 'super' || role === 'admin');
            
            // Helper to toggle visibility
            const toggle = (id, show) => {
                const el = document.getElementById(id);
                if(el) el.style.display = show ? '' : 'none';
            };

            // Sidebar
            toggle('nav-debug', isAdmin);
            toggle('nav-users', isAdmin);
            toggle('nav-settings', isAdmin);
            toggle('nav-routing', isAdmin);
            toggle('nav-docker', isAdmin);
            toggle('nav-overmind', isAdmin);
            
            // Admin only sections by class
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = isAdmin ? '' : 'none';
            });
            
            // Monitor Tabs
            toggle('monitor-logs-tab', isAdmin);
            
            // Dashboard
            toggle('dash-system-stats', isAdmin); // CPU/Mem cards
            // Charts should be visible to everyone now (with limited/relevant data)
            toggle('dash-charts-row', true); 
            toggle('dash-process-card', isAdmin); // Process List
            toggle('dash-actions-card', isAdmin); // Quick Actions
            toggle('dash-logs-card', isAdmin); // Recent Logs
            
            // If user is not admin and is currently on a hidden tab, switch to dashboard
            if (!isAdmin) {
                const hash = window.location.hash;
                if (hash === '#debug') {
                    showTab('dashboard');
                }
            }
        }

        function showOvermind(e) {
            if (e) e.preventDefault();
            const lang = currentLang || 'zh-CN';
            const token = authToken || localStorage.getItem('wxbot_token');
            window.open(`/overmind/?lang=${lang}&token=${encodeURIComponent(token)}`, '_blank');
        }

        let currentSlideIndex = 0;
        const totalSlides = 3;

        function rotateStatsSlide() {
            const container = document.getElementById('combined-stats-container');
            if (!container) return;

            const slides = container.querySelectorAll('.stats-slide');
            const icon = document.getElementById('combined-stats-icon').querySelector('i');
            if (!slides.length || !icon) return;
            
            // Fade out current
            slides[currentSlideIndex].classList.remove('fade-in');
            slides[currentSlideIndex].classList.add('fade-out');
            
            setTimeout(() => {
                slides[currentSlideIndex].style.display = 'none';
                slides[currentSlideIndex].classList.remove('fade-out');
                
                currentSlideIndex = (currentSlideIndex + 1) % totalSlides;
                
                // Update icon based on slide
                if (currentSlideIndex === 0) { // Goroutines
                    icon.className = 'bi bi-activity';
                } else if (currentSlideIndex === 1) { // Active
                    icon.className = 'bi bi-people';
                } else if (currentSlideIndex === 2) { // Messages
                    icon.className = 'bi bi-chat-text';
                }
                
                slides[currentSlideIndex].style.display = 'block';
                // Trigger reflow
                slides[currentSlideIndex].offsetHeight;
                slides[currentSlideIndex].classList.add('fade-in');
            }, 500);
        }

        // Start rotation every 5 seconds
        setInterval(rotateStatsSlide, 5000);

        // --- Visualization Engine ---
        class RoutingVisualizer {
            constructor() {
                this.container = document.getElementById('visualization-container');
                if (!this.container) return;

                // 3D Scene Setup
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(75, this.container.clientWidth / this.container.clientHeight, 0.1, 100000);
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(this.container.clientWidth, this.container.clientHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                this.container.appendChild(this.renderer.domElement);

                // Controls
                this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.controls.dampingFactor = 0.05;
                this.controls.minDistance = 50;  // Allow zooming in very close
                this.controls.maxDistance = 50000; // Increased significantly for larger scene

                // Camera Position
                this.camera.position.z = 500;

                // Lights
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
                this.scene.add(ambientLight);
                const pointLight = new THREE.PointLight(0x00ff41, 1, 1000);
                pointLight.position.set(0, 0, 100);
                this.scene.add(pointLight);

                this.nodes = new Map(); // ID -> {mesh, type, label, lastActive, floatingOffset}
                this.particles = [];
                this.running = true;
                this.totalMessages = 0;

                // Configuration for visualization (can be adjusted by user)
                this.config = {
                    botRadius: 1750,
                    botGroupMultiplier: 200,
                    groupRadius: 15000,
                    groupCountMultiplier: 2000,
                    groupSpread: 8000,
                    userRadius: 8000,
                    userCountMultiplier: 500,
                    userSpread: 4000,
                    wanderScale: 1.0,
                    verticalSpread: 1.0
                };
                this.loadConfig();

                // Add Stars
                this.addStars();
                
                // Add Nexus (Central Node)
                const t = (typeof translations !== 'undefined') ? (translations[currentLang] || translations['zh-CN']) : {};
                this.getOrCreateNode('nexus', 'nexus', t.viz_nexus || 'Nexus');

                // Stats UI
                this.statsEl = document.createElement('div');
                this.statsEl.className = 'viz-stats';
                this.container.appendChild(this.statsEl);
                this.updateStatsUI();

                // Settings UI
                this.createSettingsUI();

                this.raycaster = new THREE.Raycaster();
                this.mouse = new THREE.Vector2();
                this.container.addEventListener('dblclick', (e) => this.onDoubleClick(e));

                window.addEventListener('resize', () => this.resize());
                
                // Start Animation Loop
                this.animate();

                // Periodic cleanup
                this.cleanupInterval = setInterval(() => {
                    this.cleanupNodes();
                }, 10000);
            }

            addStars() {
                const starsGeometry = new THREE.BufferGeometry();
                const starsMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 1, transparent: true });
                const starsVertices = [];
                for (let i = 0; i < 5000; i++) { // Reduced star count
                    const x = (Math.random() - 0.5) * 100000;
                    const y = (Math.random() - 0.5) * 100000;
                    const z = (Math.random() - 0.5) * 100000;
                    starsVertices.push(x, y, z);
                }
                starsGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starsVertices, 3));
                this.stars = new THREE.Points(starsGeometry, starsMaterial);
                this.scene.add(this.stars);
            }

            updateStatsUI() {
                const t = (typeof translations !== 'undefined') ? (translations[currentLang] || translations['zh-CN']) : {};
                const activeNodes = this.nodes.size;
                const activeParticles = this.particles.length;
                
                this.statsEl.innerHTML = `
                    <div style="font-size: 1.1rem; border-bottom: 1px solid rgba(0,255,65,0.3); margin-bottom: 5px; padding-bottom: 2px;">
                        ${t.viz_stats_title || 'SYSTEM STATUS'}
                    </div>
                    <div>${t.total_messages || 'æ¶ˆæ¯æ€»é‡'}: <span style="color: #fff; text-shadow: 0 0 5px #00ff41;">${this.totalMessages}</span></div>
                    <div>${t.viz_active_nodes || 'æ´»åŠ¨èŠ‚ç‚¹'}: ${activeNodes}</div>
                    <div>${t.viz_active_tasks || 'å¤„ç†ä¸­ä»»åŠ¡'}: ${activeParticles}</div>
                `;
            }

            loadConfig() {
                const saved = localStorage.getItem('botmatrix_viz_config');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        this.config = { ...this.config, ...parsed };
                    } catch (e) { console.error("Failed to load viz config", e); }
                }
            }

            saveConfig() {
                localStorage.setItem('botmatrix_viz_config', JSON.stringify(this.config));
                // Recalculate all positions
                this.nodes.forEach(node => {
                    if (node.type === 'bot') {
                        // Keep current angle, but update radius
                        const angle = Math.atan2(node.targetPos.z, node.targetPos.x);
                        let groupCount = 0;
                        this.nodes.forEach(n => { if (n.type === 'group' && n.botId === node.id) groupCount++; });
                        const radius = this.config.botRadius + (groupCount * this.config.botGroupMultiplier);
                        node.targetPos.set(Math.cos(angle) * radius, (Math.random() - 0.5) * 1500 * this.config.verticalSpread, Math.sin(angle) * radius);
                    } else if (node.type === 'group') {
                        this.resetGroupPosition(node);
                    } else if (node.type === 'user') {
                        this.resetUserPosition(node);
                    }
                });
            }

            toggleSettings() {
                const el = document.getElementById('viz-settings-panel');
                if (el) {
                    const isHidden = (el.style.display === 'none' || el.style.display === '');
                    el.style.display = isHidden ? 'block' : 'none';
                    console.log("[Visualizer] Settings panel toggled. Now visible:", !isHidden);
                } else {
                    console.error("[Visualizer] Settings panel element not found!");
                }
            }

            createSettingsUI() {
                // 1. Create Settings Trigger Button (Gear icon)
                if (!document.getElementById('viz-settings-trigger')) {
                    const trigger = document.createElement('div');
                    trigger.id = 'viz-settings-trigger';
                    trigger.innerHTML = `<i class="bi bi-gear-fill"></i>`;
                    trigger.style.cssText = `
                        position: absolute;
                        bottom: 20px;
                        right: 20px;
                        width: 44px;
                        height: 44px;
                        background: rgba(0, 255, 65, 0.2);
                        border: 1px solid #00ff41;
                        color: #00ff41;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        z-index: 1010;
                        transition: all 0.3s;
                        box-shadow: 0 0 15px rgba(0,255,65,0.4);
                        font-size: 1.2rem;
                    `;
                    trigger.onmouseover = () => {
                        trigger.style.background = 'rgba(0, 255, 65, 0.4)';
                        trigger.style.transform = 'rotate(30deg) scale(1.1)';
                    };
                    trigger.onmouseout = () => {
                        trigger.style.background = 'rgba(0, 255, 65, 0.2)';
                        trigger.style.transform = 'rotate(0) scale(1)';
                    };
                    trigger.onclick = (e) => {
                        e.stopPropagation();
                        this.toggleSettings();
                    };
                    this.container.appendChild(trigger);
                }

                // 2. Create Settings Panel if not exists
                let panel = document.getElementById('viz-settings-panel');
                if (!panel) {
                    panel = document.createElement('div');
                    panel.id = 'viz-settings-panel';
                    panel.style.cssText = `
                        position: absolute;
                        top: 80px;
                        right: 20px;
                        width: 280px;
                        background: rgba(0, 10, 5, 0.9);
                        backdrop-filter: blur(15px);
                        border: 1px solid rgba(0, 255, 65, 0.4);
                        border-radius: 12px;
                        padding: 18px;
                        color: #00ff41;
                        font-family: 'Courier New', Courier, monospace;
                        font-size: 0.85rem;
                        z-index: 1011;
                        display: none;
                        box-shadow: 0 0 30px rgba(0,0,0,0.8), inset 0 0 10px rgba(0,255,65,0.1);
                        max-height: calc(100% - 100px);
                        overflow-y: auto;
                    `;
                    this.container.appendChild(panel);
                }

                this.updateSettingsUIContent();
            }

            updateSettingsUIContent() {
                const panel = document.getElementById('viz-settings-panel');
                if (!panel) return;
                
                const t = (typeof translations !== 'undefined') ? (translations[currentLang] || translations['zh-CN']) : {};
                
                const createSlider = (label, key, min, max, step = 1) => `
                    <div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span>${label}</span>
                            <span id="val-${key}">${this.config[key]}</span>
                        </div>
                        <input type="range" min="${min}" max="${max}" step="${step}" value="${this.config[key]}" 
                            style="width: 100%; accent-color: #00ff41; cursor: pointer;"
                            oninput="window.visualizer.updateConfig('${key}', this.value)">
                    </div>
                `;

                panel.innerHTML = `
                    <div style="font-weight: bold; border-bottom: 1px solid rgba(0,255,65,0.3); margin-bottom: 15px; padding-bottom: 5px; display: flex; justify-content: space-between;">
                        <span>${t.viz_settings_title || 'VISUALIZATION CONFIG'}</span>
                        <i class="bi bi-x-lg" onclick="window.visualizer.toggleSettings()" style="cursor: pointer;"></i>
                    </div>
                    ${createSlider(t.viz_bot_dist || 'æœºå™¨äººè·ç¦»', 'botRadius', 500, 10000, 50)}
                    ${createSlider(t.viz_bot_mult || 'æœºå™¨äººé—´è·ç³»æ•°', 'botGroupMultiplier', 0, 1000, 10)}
                    ${createSlider(t.viz_group_dist || 'ç¾¤ç»„è·ç¦»', 'groupRadius', 1000, 40000, 100)}
                    ${createSlider(t.viz_group_mult || 'ç¾¤ç»„é—´è·ç³»æ•°', 'groupCountMultiplier', 0, 5000, 100)}
                    ${createSlider(t.viz_group_spread || 'ç¾¤ç»„ç¦»æ•£åº¦', 'groupSpread', 0, 20000, 100)}
                    ${createSlider(t.viz_user_dist || 'ç”¨æˆ·è·ç¦»', 'userRadius', 1000, 30000, 100)}
                    ${createSlider(t.viz_user_spread || 'ç”¨æˆ·ç¦»æ•£åº¦', 'userSpread', 0, 10000, 100)}
                    ${createSlider(t.viz_wander || 'æµ®åŠ¨å¹…åº¦', 'wanderScale', 0, 5, 0.1)}
                    ${createSlider(t.viz_vertical || 'å‚ç›´åˆ†å¸ƒ', 'verticalSpread', 0, 3, 0.1)}
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button onclick="window.visualizer.resetConfig()" style="flex: 1; background: rgba(255,0,0,0.2); border: 1px solid #ff4444; color: #ff4444; padding: 5px; cursor: pointer; border-radius: 4px;">${t.reset || 'é‡ç½®'}</button>
                        <button onclick="window.visualizer.saveConfigToDisk()" style="flex: 1; background: rgba(0,255,65,0.2); border: 1px solid #00ff41; color: #00ff41; padding: 5px; cursor: pointer; border-radius: 4px;">${t.save || 'ä¿å­˜'}</button>
                    </div>
                `;
            }

            updateLanguage() {
                this.updateStatsUI();
                this.updateSettingsUIContent();

                // Update Nexus Label
                const t = (typeof translations !== 'undefined') ? (translations[currentLang] || translations['zh-CN']) : {};
                const nexus = this.nodes.get('nexus');
                if (nexus) {
                    nexus.label = t.viz_nexus || 'Nexus';
                }

                // Update all node textures to reflect language change
                this.nodes.forEach(node => {
                    this.updateNodeTexture(node);
                });
            }

            updateConfig(key, value) {
                this.config[key] = parseFloat(value);
                const valEl = document.getElementById(`val-${key}`);
                if (valEl) valEl.innerText = value;
                this.saveConfig(); // Real-time update in scene
            }

            resetConfig() {
                this.config = {
                    botRadius: 1750,
                    botGroupMultiplier: 200,
                    groupRadius: 15000,
                    groupCountMultiplier: 2000,
                    groupSpread: 8000,
                    userRadius: 8000,
                    userCountMultiplier: 500,
                    userSpread: 4000,
                    wanderScale: 1.0,
                    verticalSpread: 1.0
                };
                localStorage.removeItem('botmatrix_viz_config');
                // Update UI sliders
                Object.keys(this.config).forEach(key => {
                    const el = document.querySelector(`input[oninput*="'${key}'"]`);
                    if (el) el.value = this.config[key];
                    const valEl = document.getElementById(`val-${key}`);
                    if (valEl) valEl.innerText = this.config[key];
                });
                this.saveConfig();
            }

            saveConfigToDisk() {
                this.saveConfig();
                const t = (typeof translations !== 'undefined') ? (translations[currentLang] || translations['zh-CN']) : {};
                alert(t.viz_save_success || 'Settings saved to local storage');
                this.toggleSettings();
            }

            resize() {
                if (!this.container || !this.renderer) return;
                const width = this.container.clientWidth;
                const height = this.container.clientHeight;
                if (width <= 0 || height <= 0) return;
                this.camera.aspect = width / height;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(width, height);
            }

            getOrCreateNode(id, type, label, avatar, groupId = null, botId = null) {
                if (this.nodes.has(id)) {
                    const node = this.nodes.get(id);
                    node.lastActive = Date.now();
                    
                    let needsUpdate = false;
                    // Update avatar if changed
                    if (avatar && node.avatar !== avatar) {
                        node.avatar = avatar;
                        needsUpdate = true;
                    }
                    // Update label if changed
                    if (label && node.label !== label) {
                        node.label = label;
                        needsUpdate = true;
                    }
                    // Update groupId if provided and changed
                    if (groupId && node.groupId !== groupId) {
                        node.groupId = groupId;
                        // For users, reset their position to cluster around new group
                        if (node.type === 'user') {
                            this.resetUserPosition(node);
                        }
                    }
                    // Update botId if provided and changed
                    if (botId && node.botId !== botId) {
                        node.botId = botId;
                        if (node.type === 'group') {
                            this.resetGroupPosition(node);
                        }
                    }

                    if (needsUpdate) {
                        this.updateNodeTexture(node);
                    }
                    return node;
                }

                const node = {
                    id, type, label, avatar, groupId, botId,
                    mesh: null,
                    orbs: [], // Color orbiting orbs
                    nexusLine: null, // Virtual line to Nexus
                    lastActive: Date.now(),
                    floatingOffset: Math.random() * Math.PI * 2,
                    targetPos: new THREE.Vector3(0, 0, 0),
                    clusterOffset: new THREE.Vector3(0, 0, 0) // Offset relative to center
                };

                // 3D Space Partitioning (Hierarchy Layout)
                if (id === 'nexus') {
                    node.targetPos.set(0, 0, 0);
                } else if (type === 'worker') {
                    // Workers: Closest to Nexus
                    const angle = Math.random() * Math.PI * 2;
                    const radius = 1000 + Math.random() * 500; // Increased 10x
                    node.targetPos.set(
                        Math.cos(angle) * radius,
                        (Math.random() - 0.5) * 800, // Increased 10x
                        Math.sin(angle) * radius
                    );
                } else if (type === 'bot') {
                    // Count how many groups this bot has
                    let groupCount = 0;
                    this.nodes.forEach(n => {
                        if (n.type === 'group' && n.botId === id) groupCount++;
                    });

                    // Bots: Inner layer, distance depends on group count
                    const angle = Math.random() * Math.PI * 2;
                    const baseRadius = this.config.botRadius + (groupCount * this.config.botGroupMultiplier);
                    const radius = baseRadius + Math.random() * 500; 
                    node.targetPos.set(
                        Math.cos(angle) * radius,
                        (Math.random() - 0.5) * 1500 * this.config.verticalSpread,
                        Math.sin(angle) * radius
                    );
                } else if (type === 'group') {
                    this.resetGroupPosition(node);
                } else if (type === 'user') {
                    this.resetUserPosition(node);
                }

                this.updateNodeTexture(node, true);
                this.nodes.set(id, node);
                return node;
            }

            resetGroupPosition(node) {
                if (node.botId && this.nodes.has(node.botId)) {
                    // Count how many groups this bot already has
                    let groupCount = 0;
                    this.nodes.forEach(n => {
                        if (n.type === 'group' && n.botId === node.botId) groupCount++;
                    });

                    // Cluster around bot: Dynamic relative offset
                    const angle = Math.random() * Math.PI * 2;
                    // Base radius increases with group count
                    const baseRadius = this.config.groupRadius + (groupCount * this.config.groupCountMultiplier); 
                    const radius = baseRadius + Math.random() * this.config.groupSpread;
                    node.clusterOffset.set(
                        Math.cos(angle) * radius,
                        (Math.random() - 0.5) * 6000 * this.config.verticalSpread,
                        Math.sin(angle) * radius
                    );
                    const bot = this.nodes.get(node.botId);
                    node.targetPos.copy(bot.targetPos).add(node.clusterOffset);
                } else {
                    // Lone group: Middle layer
                    const angle = Math.random() * Math.PI * 2;
                    const radius = (this.config.groupRadius * 2) + Math.random() * 10000; 
                    node.targetPos.set(
                        Math.cos(angle) * radius,
                        (Math.random() - 0.5) * 5000 * this.config.verticalSpread,
                        Math.sin(angle) * radius
                    );
                    node.clusterOffset.set(0, 0, 0);
                }
            }

            resetUserPosition(node) {
                if (node.groupId && this.nodes.has(node.groupId)) {
                    // Count users in this group
                    let userCount = 0;
                    this.nodes.forEach(n => {
                        if (n.type === 'user' && n.groupId === node.groupId) userCount++;
                    });

                    // Cluster around group: Small relative offset
                    const angle = Math.random() * Math.PI * 2;
                    const baseRadius = this.config.userRadius + (userCount * this.config.userCountMultiplier);
                    const radius = baseRadius + Math.random() * this.config.userSpread;
                    node.clusterOffset.set(
                        Math.cos(angle) * radius,
                        (Math.random() - 0.5) * 3000 * this.config.verticalSpread,
                        Math.sin(angle) * radius
                    );
                    // Initial position
                    const group = this.nodes.get(node.groupId);
                    node.targetPos.copy(group.targetPos).add(node.clusterOffset);
                } else {
                    // Lone user: Outer layer
                    const angle = Math.random() * Math.PI * 2;
                    const radius = (this.config.userRadius * 8) + Math.random() * 15000; 
                    node.targetPos.set(
                        Math.cos(angle) * radius,
                        (Math.random() - 0.5) * 8000 * this.config.verticalSpread,
                        Math.sin(angle) * radius
                    );
                    node.clusterOffset.set(0, 0, 0);
                }
            }

            onDoubleClick(event) {
                const rect = this.container.getBoundingClientRect();
                this.mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                this.mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

                this.raycaster.setFromCamera(this.mouse, this.camera);
                const intersects = this.raycaster.intersectObjects(Array.from(this.nodes.values()).map(n => n.mesh));

                if (intersects.length > 0) {
                    const targetPos = intersects[0].object.position.clone();
                    
                    // Zoom towards the clicked node
                    const direction = new THREE.Vector3().subVectors(this.camera.position, targetPos).normalize();
                    const newCameraPos = targetPos.clone().add(direction.multiplyScalar(2000)); // Increased 10x
                    
                    // Animate camera and controls target
                    const startPos = this.camera.position.clone();
                    const startTarget = this.controls.target.clone();
                    let progress = 0;
                    const duration = 30; // frames
                    
                    const animateZoom = () => {
                        progress++;
                        const t = progress / duration;
                        const easedT = t * (2 - t); // easeOutQuad
                        
                        this.camera.position.lerpVectors(startPos, newCameraPos, easedT);
                        this.controls.target.lerpVectors(startTarget, targetPos, easedT);
                        
                        if (progress < duration) {
                            requestAnimationFrame(animateZoom);
                        }
                    };
                    animateZoom();
                }
            }

            updateNodeTexture(node, isNew = false) {
                const canvas = document.createElement('canvas');
                canvas.width = 256;
                canvas.height = 256;
                const ctx = canvas.getContext('2d');

                const draw = () => {
                    ctx.clearRect(0, 0, 256, 256);
                    
                    // Glow effect
                    let color = '0, 255, 65'; // Default green
                    if (node.type === 'user') color = '0, 255, 255'; // Cyan for users
                    if (node.type === 'group') color = '255, 215, 0'; // Gold for groups
                    
                    const gradient = ctx.createRadialGradient(128, 128, 50, 128, 128, 120);
                    gradient.addColorStop(0, `rgba(${color}, 0.2)`);
                    gradient.addColorStop(1, `rgba(${color}, 0)`);
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, 256, 256);

                    // Avatar or Icon Circle
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(128, 100, 60, 0, Math.PI * 2);
                    ctx.clip();
                    
                    if (node.avatar) {
                        const img = new Image();
                        
                        // Use backend proxy for external avatars (like QQ) to avoid CORS issues
                        let finalAvatarUrl = node.avatar;
                        if (node.avatar.startsWith('http')) {
                            // Add cache buster to avoid browser caching broken images
                            const separator = node.avatar.includes('?') ? '&' : '?';
                            const proxiedUrl = `${node.avatar}${separator}t=${Date.now()}`;
                            finalAvatarUrl = `/api/proxy/avatar?url=${encodeURIComponent(proxiedUrl)}`;
                            // For proxied images, we MUST set crossOrigin because our proxy returns CORS headers
                            img.crossOrigin = "anonymous";
                        } else {
                            // Local images don't need CORS
                            img.crossOrigin = null;
                        }
                        
                        img.src = finalAvatarUrl;
                        img.onload = () => {
                            // Draw background for avatar
                            ctx.fillStyle = '#000';
                            ctx.fillRect(68, 40, 120, 120);
                            ctx.drawImage(img, 68, 40, 120, 120);
                            ctx.restore(); // Restore clip state
                            this.drawDetails(ctx, node);
                            this.finishTexture(node, canvas, isNew);
                        };
                        img.onerror = (e) => {
                            console.warn(`Failed to load avatar for ${node.id}: ${finalAvatarUrl}`, e);
                            ctx.restore(); // Restore clip state
                            this.drawDefaultIcon(ctx, node.type);
                            this.drawDetails(ctx, node);
                            this.finishTexture(node, canvas, isNew);
                        };
                        return; // Async handling
                    } else {
                        this.drawDefaultIcon(ctx, node.type);
                    }
                    ctx.restore();

                    this.drawDetails(ctx, node);
                    this.finishTexture(node, canvas, isNew);
                };

                draw();
            }

            drawDetails(ctx, node) {
                // Background scanlines (Matrix style)
                let primaryColor = '#00ff41';
                let secondaryColor = 'rgba(0, 255, 65, 0.1)';
                let glowColor = 'rgba(0, 255, 65, 0.5)';
                
                if (node.type === 'user') {
                    primaryColor = '#00ffff';
                    secondaryColor = 'rgba(0, 255, 255, 0.1)';
                    glowColor = 'rgba(0, 255, 255, 0.5)';
                } else if (node.type === 'group') {
                    primaryColor = '#ffd700';
                    secondaryColor = 'rgba(255, 215, 0, 0.1)';
                    glowColor = 'rgba(255, 215, 0, 0.5)';
                }

                ctx.strokeStyle = secondaryColor;
                ctx.lineWidth = 1;
                for (let i = 0; i < 256; i += 4) {
                    ctx.beginPath();
                    ctx.moveTo(0, i);
                    ctx.lineTo(256, i);
                    ctx.stroke();
                }

                // Border
                ctx.beginPath();
                ctx.arc(128, 100, 60, 0, Math.PI * 2);
                ctx.strokeStyle = primaryColor;
                ctx.lineWidth = 4;
                ctx.stroke();
                
                // Glow border
                ctx.strokeStyle = glowColor;
                ctx.lineWidth = 8;
                ctx.stroke();

                // Text Info (Matrix Style)
                ctx.fillStyle = primaryColor;
                ctx.shadowColor = primaryColor;
                ctx.shadowBlur = 10;
                ctx.font = 'bold 22px monospace';
                ctx.textAlign = 'center';
                
                let displayLabel = node.label || node.id;
                if (node.id === 'nexus') {
                    const t = (typeof translations !== 'undefined') ? (translations[currentLang] || translations['zh-CN']) : {};
                    displayLabel = t.viz_nexus || 'Nexus';
                }
                ctx.fillText(displayLabel, 128, 190);
                
                ctx.font = '14px monospace';
                ctx.fillStyle = secondaryColor.replace('0.1', '0.8');
                const idDisplay = node.id === 'nexus' ? '' : `#${node.id}`;
                if (idDisplay) {
                    const truncatedId = idDisplay.length > 25 ? idDisplay.substring(0, 22) + '...' : idDisplay;
                    ctx.fillText(truncatedId, 128, 212);
                }
                
                if (node.type === 'bot' || node.type === 'worker') {
                    const t = (typeof translations !== 'undefined') ? (translations[currentLang] || translations['zh-CN']) : {};
                    const typeLabel = node.type === 'worker' ? (t.viz_worker || 'PROCESSOR') : (t.viz_bot || 'MATRIX BOT');
                    ctx.font = 'bold 12px monospace';
                    ctx.fillStyle = primaryColor;
                    ctx.fillText(typeLabel.toUpperCase(), 128, 235);
                } else if (node.type === 'user') {
                    const t = (typeof translations !== 'undefined') ? (translations[currentLang] || translations['zh-CN']) : {};
                    ctx.font = '12px monospace';
                    ctx.fillStyle = primaryColor;
                    ctx.fillText((t.viz_user || 'USER').toUpperCase(), 128, 235);
                } else if (node.type === 'group') {
                    const t = (typeof translations !== 'undefined') ? (translations[currentLang] || translations['zh-CN']) : {};
                    ctx.font = 'bold 12px monospace';
                    ctx.fillStyle = primaryColor;
                    ctx.fillText((t.viz_group || 'GROUP HUB').toUpperCase(), 128, 235);
                }
            }

            drawDefaultIcon(ctx, type) {
                ctx.fillStyle = '#0a0a0a';
                ctx.fillRect(0, 0, 256, 256);
                
                // Add some random binary code in background
                ctx.fillStyle = 'rgba(0, 255, 65, 0.15)';
                ctx.font = '10px monospace';
                for(let i=0; i<10; i++) {
                    const binary = Math.random() > 0.5 ? "1010101" : "0101010";
                    ctx.fillText(binary, Math.random() * 256, Math.random() * 256);
                }

                ctx.fillStyle = '#00ff41';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                if (type === 'bot') {
                    // Draw a more high-tech robot icon using lines/shapes
                    ctx.strokeStyle = '#00ff41';
                    ctx.lineWidth = 4;
                    // Head
                    ctx.strokeRect(88, 60, 80, 70);
                    // Eyes
                    ctx.fillStyle = '#00ff41';
                    ctx.fillRect(105, 85, 15, 15);
                    ctx.fillRect(135, 85, 15, 15);
                    // Mouth
                    ctx.fillRect(108, 115, 40, 5);
                    // Antennas
                    ctx.beginPath();
                    ctx.moveTo(128, 60);
                    ctx.lineTo(128, 40);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.arc(128, 35, 5, 0, Math.PI * 2);
                    ctx.fill();
                } else if (type === 'group') {
                    ctx.font = '80px serif';
                    ctx.fillText('ğŸ˜ï¸', 128, 100);
                } else {
                    ctx.font = '80px serif';
                    let icon = 'ğŸ‘¤';
                    if (type === 'nexus') icon = 'ğŸ•¸ï¸';
                    if (type === 'worker') icon = 'âš™ï¸';
                    ctx.fillText(icon, 128, 100);
                }
            }

            finishTexture(node, canvas, isNew) {
                const texture = new THREE.CanvasTexture(canvas);
                if (node.mesh) {
                    node.mesh.material.map = texture;
                    node.mesh.material.needsUpdate = true;
                } else {
                    const material = new THREE.SpriteMaterial({ map: texture, transparent: true });
                    const sprite = new THREE.Sprite(material);
                    const size = node.id === 'nexus' ? 120 : 80;
                    sprite.scale.set(size, size, 1);
                    sprite.position.copy(node.targetPos);
                    node.mesh = sprite;
                    this.scene.add(sprite);

                    // Add Orbiting Orbs for Bots and Workers
                    if (node.type === 'bot' || node.type === 'worker') {
                        const orbColors = [0x00ff41, 0x00d2ff, 0xff00ff, 0xffff00];
                        const orbCount = node.type === 'bot' ? 3 : 2;
                        for (let i = 0; i < orbCount; i++) {
                            const orbGeom = new THREE.SphereGeometry(3, 8, 8);
                            const orbMat = new THREE.MeshBasicMaterial({ color: orbColors[i % orbColors.length] });
                            const orb = new THREE.Mesh(orbGeom, orbMat);
                            
                            // Add small light to orb
                            const orbLight = new THREE.PointLight(orbColors[i % orbColors.length], 1, 30);
                            orb.add(orbLight);
                            
                            orb.orbitData = {
                                radius: 45 + Math.random() * 15,
                                speed: (Math.random() + 0.5) * 2,
                                angle: Math.random() * Math.PI * 2,
                                axis: new THREE.Vector3(Math.random(), Math.random(), Math.random()).normalize()
                            };
                            this.scene.add(orb);
                            node.orbs.push(orb);
                        }

                        // Add permanent virtual dashed line to Nexus
                        const lineMat = new THREE.LineDashedMaterial({ 
                            color: 0x00ff41, 
                            transparent: true, 
                            opacity: 0.1,
                            dashSize: 5,
                            gapSize: 3,
                            blending: THREE.AdditiveBlending
                        });
                        const lineGeom = new THREE.BufferGeometry().setFromPoints([
                            new THREE.Vector3(0, 0, 0),
                            node.mesh.position.clone()
                        ]);
                        const line = new THREE.Line(lineGeom, lineMat);
                        line.computeLineDistances();
                        this.scene.add(line);
                        node.nexusLine = line;
                    }
                }
            }

            addEvent(event) {
                if (event.total_messages !== undefined) {
                    this.totalMessages = event.total_messages;
                    this.updateStatsUI();
                }

                const nexus = this.getOrCreateNode('nexus', 'nexus', 'Nexus');
                let startNode, endNode;

                // Try to find bot info from currentBots global or event platform
                const findBotInfo = (botId, platformFromEvent) => {
                    if (typeof currentBots !== 'undefined') {
                        const bot = currentBots.find(b => b.self_id === botId || b.id === botId);
                        if (bot) {
                            let avatarUrl = null;
                            const platform = (platformFromEvent || bot.platform || '').toUpperCase();
                            if (platform === 'QQ') {
                                avatarUrl = `https://q1.qlogo.cn/g?b=qq&nk=${bot.self_id}&s=640`;
                            } else if (platform === 'WECHAT' || platform === 'WX') {
                                avatarUrl = '/static/avatars/wechat_default.png';
                            } else if (bot.user_avatar) {
                                avatarUrl = bot.user_avatar;
                            }
                            return { nickname: bot.nickname || bot.name || botId, avatar: avatarUrl };
                        }
                    }
                    // Fallback using platform from event
                    if (platformFromEvent) {
                        const platform = platformFromEvent.toUpperCase();
                        if (platform === 'QQ') {
                            return { nickname: botId, avatar: `https://q1.qlogo.cn/g?b=qq&nk=${botId}&s=640` };
                        }
                    }
                    return { nickname: botId, avatar: null };
                };

                const formatUserAvatar = (avatar, source, platform) => {
                    if (avatar && avatar.startsWith('http')) return avatar;
                    if (platform && platform.toUpperCase() === 'QQ') {
                        const qq = avatar || source;
                        if (/^\d+$/.test(qq)) {
                            return `https://q1.qlogo.cn/g?b=qq&nk=${qq}&s=640`;
                        }
                    }
                    return avatar;
                };

                if (event.direction === 'user_to_bot') {
                    const userAvatar = formatUserAvatar(event.user_avatar, event.source, event.platform);
                    const userNode = this.getOrCreateNode(event.source, 'user', event.user_name || event.source, userAvatar, event.group_id);
                    const botInfo = findBotInfo(event.target, event.platform);
                    const botNode = this.getOrCreateNode(event.target, 'bot', botInfo.nickname, botInfo.avatar, event.group_id);

                    if (event.group_id) {
                        const groupNode = this.getOrCreateNode(event.group_id, 'group', event.group_name || `Group ${event.group_id}`, null, null, event.target);
                        // Routing: User -> Group -> Bot -> Nexus
                        this.createParticle(userNode, groupNode, event.msg_type, event.content);
                        setTimeout(() => {
                            this.createParticle(groupNode, botNode, event.msg_type);
                            setTimeout(() => {
                                this.createParticle(botNode, nexus, event.msg_type);
                            }, 400);
                        }, 400); // Slight delay for second leg
                    } else {
                        this.createParticle(userNode, botNode, event.msg_type, event.content);
                        setTimeout(() => {
                            this.createParticle(botNode, nexus, event.msg_type);
                        }, 400);
                    }
                    return;
                } else if (event.direction === 'bot_to_user') {
                    const botInfo = findBotInfo(event.source, event.platform);
                    const botNode = this.getOrCreateNode(event.source, 'bot', botInfo.nickname, botInfo.avatar, event.group_id);
                    const userAvatar = formatUserAvatar(event.user_avatar, event.target, event.platform);
                    const userNode = this.getOrCreateNode(event.target, 'user', event.user_name || event.target, userAvatar, event.group_id);

                    if (event.group_id) {
                        const groupNode = this.getOrCreateNode(event.group_id, 'group', event.group_name || `Group ${event.group_id}`, null, null, event.source);
                        // Routing: Nexus -> Bot -> Group -> User
                        this.createParticle(nexus, botNode, event.msg_type, event.content);
                        setTimeout(() => {
                            this.createParticle(botNode, groupNode, event.msg_type);
                            setTimeout(() => {
                                this.createParticle(groupNode, userNode, event.msg_type);
                            }, 400);
                        }, 400);
                    } else {
                        this.createParticle(nexus, botNode, event.msg_type, event.content);
                        setTimeout(() => {
                            this.createParticle(botNode, userNode, event.msg_type);
                        }, 400);
                    }
                    return;
                } else if (event.direction === 'bot_to_nexus') {
                    const botInfo = findBotInfo(event.source, event.platform);
                    startNode = this.getOrCreateNode(event.source, 'bot', botInfo.nickname, botInfo.avatar);
                    endNode = nexus;
                } else if (event.direction === 'nexus_to_worker') {
                    startNode = nexus;
                    endNode = this.getOrCreateNode(event.target, 'worker', event.target);
                } else if (event.direction === 'worker_to_nexus') {
                    startNode = this.getOrCreateNode(event.source, 'worker', event.source);
                    endNode = nexus;
                } else if (event.direction === 'nexus_to_bot') {
                    const botInfo = findBotInfo(event.target, event.platform);
                    const botNode = this.getOrCreateNode(event.target, 'bot', botInfo.nickname, botInfo.avatar, event.group_id);
                    
                    // Routing: Nexus -> Bot -> (Group -> User)
                    this.createParticle(nexus, botNode, event.msg_type, event.content);
                    if (event.group_id && event.user_id) {
                        setTimeout(() => {
                            const groupNode = this.getOrCreateNode(event.group_id, 'group', event.group_name || `Group ${event.group_id}`, null, null, event.target);
                            const userAvatar = formatUserAvatar(event.user_avatar, event.user_id, event.platform);
                            const userNode = this.getOrCreateNode(event.user_id, 'user', event.user_name || event.user_id, userAvatar, event.group_id);
                            
                            this.createParticle(botNode, groupNode, event.msg_type);
                            setTimeout(() => {
                                this.createParticle(groupNode, userNode, event.msg_type);
                            }, 400);
                        }, 400);
                    }
                    return;
                } else if (event.direction === 'worker_to_bot') {
                    const workerNode = this.getOrCreateNode(event.source, 'worker', event.source);
                    const botInfo = findBotInfo(event.target, event.platform);
                    const botNode = this.getOrCreateNode(event.target, 'bot', botInfo.nickname, botInfo.avatar, event.group_id);
                    
                    // Full path: Worker -> Nexus -> Bot
                    this.createParticle(workerNode, nexus, event.msg_type, event.content);
                    setTimeout(() => {
                        this.createParticle(nexus, botNode, event.msg_type);
                        
                        // If it's a group message, continue the path: Bot -> Group -> User
                        if (event.group_id && event.user_id) {
                            setTimeout(() => {
                                const groupNode = this.getOrCreateNode(event.group_id, 'group', event.group_name || `Group ${event.group_id}`, null, null, event.target);
                                const userAvatar = formatUserAvatar(event.user_avatar, event.user_id, event.platform);
                                const userNode = this.getOrCreateNode(event.user_id, 'user', event.user_name || event.user_id, userAvatar, event.group_id);
                                
                                this.createParticle(botNode, groupNode, event.msg_type);
                                setTimeout(() => {
                                    this.createParticle(groupNode, userNode, event.msg_type);
                                }, 400);
                            }, 400);
                        }
                    }, 400);
                    return;
                }

                if (startNode && endNode) {
                    this.createParticle(startNode, endNode, event.msg_type, event.content);
                }
            }

            createParticle(start, end, msgType, content) {
                const colors = {
                    'message': 0x00ff41,
                    'request': 0x00d2ff,
                    'response': 0xff00ff,
                    'image': 0xffff00
                };
                const color = colors[msgType] || 0x00ff41;

                // 1. Create fast traveling sphere
                const geometry = new THREE.SphereGeometry(80, 16, 16); // Increased 10x
                const material = new THREE.MeshBasicMaterial({ color: color });
                const ballMesh = new THREE.Mesh(geometry, material);
                
                // Add Glow to ball
                const light = new THREE.PointLight(color, 3, 1000); // Increased 10x
                ballMesh.add(light);
                ballMesh.position.copy(start.mesh.position);
                this.scene.add(ballMesh);

                // 2. Create dashed connection
                const startPos = start.mesh.position.clone();
                const endPos = end.mesh.position.clone();
                
                // Create a dashed line connection
                const lineGeom = new THREE.BufferGeometry().setFromPoints([startPos, endPos]);
                const lineMat = new THREE.LineDashedMaterial({ 
                    color: color, 
                    transparent: true, 
                    opacity: 0.6,
                    dashSize: 150, // Increased 10x
                    gapSize: 80,   // Increased 10x
                    blending: THREE.AdditiveBlending
                });
                const lineMesh = new THREE.Line(lineGeom, lineMat);
                lineMesh.computeLineDistances(); // Required for dashed lines
                this.scene.add(lineMesh);

                // 3. Create static message hint at midpoint
                let hintMesh = null;
                const midpoint = new THREE.Vector3().lerpVectors(start.mesh.position, end.mesh.position, 0.5);
                if (content) {
                    hintMesh = this.createMessageHint(midpoint, content, color);
                    // Move it slightly above the line
                    hintMesh.position.y += 400; // Increased 10x
                }

                this.particles.push({
                    mesh: ballMesh,
                    lineMesh: lineMesh,
                    hintMesh: hintMesh,
                    startPos: start.mesh.position.clone(),
                    endPos: end.mesh.position.clone(),
                    startNode: start, // Keep reference to track node movement
                    endNode: end,     // Keep reference to track node movement
                    progress: 0,
                    speed: 0.12, // Faster speed for better performance (less concurrent particles)
                    ttl: 5000, // Messages and lines vanish after 5 seconds to keep scene clean
                    createdAt: Date.now(),
                    color: color
                });
            }

            createMessageHint(pos, content, color) {
                const canvas = document.createElement('canvas');
                // Increase resolution for clearer text
                const resolutionScale = 2;
                canvas.width = 512 * resolutionScale;
                canvas.height = 128 * resolutionScale;
                const ctx = canvas.getContext('2d');
                ctx.scale(resolutionScale, resolutionScale);
                
                // Holographic grid background
                ctx.strokeStyle = 'rgba(0, 255, 65, 0.1)';
                ctx.lineWidth = 1;
                for (let i = 0; i < 512; i += 20) {
                    ctx.beginPath();
                    ctx.moveTo(i, 0);
                    ctx.lineTo(i, 128);
                    ctx.stroke();
                }
                for (let i = 0; i < 128; i += 20) {
                    ctx.beginPath();
                    ctx.moveTo(0, i);
                    ctx.lineTo(512, i);
                    ctx.stroke();
                }

                // Draw background with holographic glow
                ctx.fillStyle = 'rgba(0, 15, 0, 0.9)';
                ctx.beginPath();
                ctx.roundRect(10, 10, 492, 108, 15);
                ctx.fill();
                
                // Double border for high-tech look
                const colorStr = '#' + color.toString(16).padStart(6, '0');
                ctx.strokeStyle = colorStr;
                ctx.lineWidth = 3; // Thicker border
                ctx.stroke();
                
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.roundRect(15, 15, 482, 98, 12);
                ctx.stroke();

                // Text styling - use better fonts and clear rendering
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 28px "PingFang SC", "Microsoft YaHei", "Segoe UI", monospace';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                let text = content;
                if (text.length > 40) text = text.substring(0, 37) + '...';
                
                // Shadow for depth instead of aberration which can blur
                ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                ctx.shadowBlur = 4;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;

                if (text.length > 20) {
                    ctx.fillText(text.substring(0, 20), 256, 45);
                    ctx.fillText(text.substring(20), 256, 85);
                } else {
                    ctx.fillText(text, 256, 64);
                }

                const texture = new THREE.CanvasTexture(canvas);
                // Important for clarity
                texture.minFilter = THREE.LinearFilter;
                texture.magFilter = THREE.LinearFilter;
                texture.generateMipmaps = false;
                
                const material = new THREE.SpriteMaterial({ 
                    map: texture, 
                    transparent: true, 
                    blending: THREE.AdditiveBlending,
                    opacity: 0.9
                });
                const sprite = new THREE.Sprite(material);
                
                sprite.position.copy(pos);
                sprite.position.y += 800; // Increased 10x
                sprite.scale.set(1600, 400, 1); // Increased 10x
                
                this.scene.add(sprite);
                return sprite;
            }

            animate() {
                if (!this.running) return;
                requestAnimationFrame(() => this.animate());

                const time = Date.now() * 0.001;

                // Rotate stars slowly
                if (this.stars) {
                    this.stars.rotation.y += 0.0002;
                    this.stars.rotation.x += 0.0001;
                }

                // Update Nodes Animation
                this.nodes.forEach(node => {
                    if (node.id === 'nexus') {
                        // Nexus: Stable center but shaking
                        const shakeFreq = 15;
                        const shakeAmp = 2;
                        node.mesh.position.set(
                            Math.sin(time * shakeFreq) * shakeAmp,
                            Math.cos(time * (shakeFreq + 1)) * shakeAmp,
                            Math.sin(time * (shakeFreq - 1)) * shakeAmp
                        );
                        
                        const scale = 120 + Math.sin(time * 2) * 5;
                        node.mesh.scale.set(scale, scale, 1);
                        node.mesh.material.rotation = Math.sin(time * 0.5) * 0.1;
                        return;
                    }

                    const offset = node.floatingOffset;
                    const inactivity = (Date.now() - node.lastActive) / 1000;

                    // Update target position based on inactivity and clustering
                    if (node.type === 'user') {
                        if (node.groupId && this.nodes.has(node.groupId)) {
                            // Cluster around group: Update targetPos relative to group
                            const group = this.nodes.get(node.groupId);
                            node.targetPos.copy(group.targetPos).add(node.clusterOffset);
                        } else {
                            // Lone user: Outer rim drifting
                            const isActive = inactivity < 10;
                            const targetRadius = isActive ? this.config.userRadius * 2 : this.config.userRadius * 8;
                            
                            // Optimization: If it's a bot, update its targetPos based on group count periodically
                            if (node.type === 'bot') {
                                let groupCount = 0;
                                this.nodes.forEach(n => {
                                    if (n.type === 'group' && n.botId === node.id) groupCount++;
                                });
                                const dynamicRadius = this.config.botRadius + (groupCount * this.config.botGroupMultiplier);
                                const currentRadius = node.targetPos.length();
                                if (currentRadius > 0.1) {
                                    node.targetPos.multiplyScalar(dynamicRadius / currentRadius);
                                }
                            } else {
                                const currentRadius = node.targetPos.length();
                                const lerpFactor = isActive ? 0.08 : 0.002;
                                const nextRadius = currentRadius + (targetRadius - currentRadius) * lerpFactor;
                                if (currentRadius > 0.1) {
                                    node.targetPos.multiplyScalar(nextRadius / currentRadius);
                                }
                            }
                        }
                    } else if (node.type === 'bot') {
                        // Bots: Keep them stable
                        let groupCount = 0;
                        this.nodes.forEach(n => {
                            if (n.type === 'group' && n.botId === node.id) groupCount++;
                        });
                        const targetRadius = this.config.botRadius + (groupCount * this.config.botGroupMultiplier);
                        const currentRadius = node.targetPos.length();
                        const lerpFactor = 0.01;
                        const nextRadius = currentRadius + (targetRadius - currentRadius) * lerpFactor;
                        if (currentRadius > 0.1) {
                            node.targetPos.multiplyScalar(nextRadius / currentRadius);
                        }
                    } else if (node.type === 'group') {
                        if (node.botId && this.nodes.has(node.botId)) {
                            // Cluster around bot: Update targetPos relative to bot
                            const bot = this.nodes.get(node.botId);
                            node.targetPos.copy(bot.targetPos).add(node.clusterOffset);
                        } else {
                            // Lone group: Middle layer stability
                            const targetRadius = this.config.groupRadius * 2; 
                            const currentRadius = node.targetPos.length();
                            const lerpFactor = 0.005;
                            const nextRadius = currentRadius + (targetRadius - currentRadius) * lerpFactor;
                            if (currentRadius > 0.1) {
                                node.targetPos.multiplyScalar(nextRadius / currentRadius);
                            }
                        }
                        
                        // Vanish if no activity for 2 hours
                        if (inactivity > 7200) {
                            node.mesh.visible = false;
                        } else {
                            node.mesh.visible = true;
                        }
                    }

                    // Common wandering logic
                    const wanderSpeed = 0.2;
                    const wanderRadius = (node.type === 'worker' ? 200 : (node.type === 'bot' ? 400 : 600)) * this.config.wanderScale;
                    
                    const wanderX = Math.sin(time * wanderSpeed + offset) * wanderRadius;
                    const wanderY = Math.cos(time * (wanderSpeed * 0.8) + offset) * wanderRadius;
                    const wanderZ = Math.sin(time * (wanderSpeed * 1.2) + offset) * wanderRadius;

                    node.mesh.position.x = node.targetPos.x + wanderX;
                    node.mesh.position.y = node.targetPos.y + wanderY;
                    node.mesh.position.z = node.targetPos.z + wanderZ;
                    
                    // Gentle swaying and pulsing
                    node.mesh.material.rotation = Math.sin(time * 0.3 + offset) * 0.2;
                    const baseScale = node.type === 'user' ? 700 : 900; // Increased 10x
                    const pulse = 1 + Math.sin(time * 1.2 + offset) * 0.08;
                    node.mesh.scale.set(baseScale * pulse, baseScale * pulse, 1);

                    // Update Orbs Animation
                    if (node.orbs.length > 0) {
                        node.orbs.forEach(orb => {
                            orb.orbitData.angle += orb.orbitData.speed * 0.01;
                            const x = Math.cos(orb.orbitData.angle) * orb.orbitData.radius;
                            const y = Math.sin(orb.orbitData.angle) * orb.orbitData.radius;
                            
                            // Rotate around node position
                            orb.position.copy(node.mesh.position);
                            const relativePos = new THREE.Vector3(x, y, 0);
                            relativePos.applyAxisAngle(orb.orbitData.axis, orb.orbitData.angle);
                            orb.position.add(relativePos);
                        });
                    }

                    // Update Group Connection Line (User -> Group)
                    if (node.groupId && this.nodes.has(node.groupId)) {
                        const group = this.nodes.get(node.groupId);
                        if (!node.groupLine) {
                            const lineMat = new THREE.LineDashedMaterial({ 
                                color: 0xffd700, // Golden for group connections
                                transparent: true, 
                                opacity: 0.1,
                                dashSize: 40, // Scaled for 10x
                                gapSize: 20,
                                blending: THREE.AdditiveBlending
                            });
                            const lineGeom = new THREE.BufferGeometry().setFromPoints([
                                group.mesh.position.clone(),
                                node.mesh.position.clone()
                            ]);
                            node.groupLine = new THREE.Line(lineGeom, lineMat);
                            node.groupLine.computeLineDistances();
                            this.scene.add(node.groupLine);
                        } else {
                            const positions = node.groupLine.geometry.attributes.position.array;
                            positions[0] = group.mesh.position.x;
                            positions[1] = group.mesh.position.y;
                            positions[2] = group.mesh.position.z;
                            positions[3] = node.mesh.position.x;
                            positions[4] = node.mesh.position.y;
                            positions[5] = node.mesh.position.z;
                            node.groupLine.geometry.attributes.position.needsUpdate = true;
                            node.groupLine.computeLineDistances();
                            node.groupLine.material.opacity = 0.15 + Math.sin(time * 3 + offset) * 0.05;
                            node.groupLine.visible = group.mesh.visible && node.mesh.visible;
                        }
                    } else if (node.groupLine) {
                        this.scene.remove(node.groupLine);
                        node.groupLine = null;
                    }

                    // Update Bot Connection Line (Group -> Bot)
                    if (node.type === 'group' && node.botId && this.nodes.has(node.botId)) {
                        const bot = this.nodes.get(node.botId);
                        if (!node.botLine) {
                            const lineMat = new THREE.LineDashedMaterial({ 
                                color: 0x00d2ff, // Cyan for bot connections
                                transparent: true, 
                                opacity: 0.15,
                                dashSize: 60,
                                gapSize: 30,
                                blending: THREE.AdditiveBlending
                            });
                            const lineGeom = new THREE.BufferGeometry().setFromPoints([
                                bot.mesh.position.clone(),
                                node.mesh.position.clone()
                            ]);
                            node.botLine = new THREE.Line(lineGeom, lineMat);
                            node.botLine.computeLineDistances();
                            this.scene.add(node.botLine);
                        } else {
                            const positions = node.botLine.geometry.attributes.position.array;
                            positions[0] = bot.mesh.position.x;
                            positions[1] = bot.mesh.position.y;
                            positions[2] = bot.mesh.position.z;
                            positions[3] = node.mesh.position.x;
                            positions[4] = node.mesh.position.y;
                            positions[5] = node.mesh.position.z;
                            node.botLine.geometry.attributes.position.needsUpdate = true;
                            node.botLine.computeLineDistances();
                            node.botLine.material.opacity = 0.2 + Math.sin(time * 2.5 + offset) * 0.08;
                            node.botLine.visible = bot.mesh.visible && node.mesh.visible;
                        }
                    } else if (node.botLine) {
                        this.scene.remove(node.botLine);
                        node.botLine = null;
                    }

                    // Update Nexus Line (Bot -> Nexus)
                    if (node.type === 'bot') {
                        const nexus = this.nodes.get('nexus');
                        if (nexus) {
                            if (!node.nexusLine) {
                                const lineMat = new THREE.LineDashedMaterial({ 
                                    color: 0x00ff41, // Green for core connections
                                    transparent: true, 
                                    opacity: 0.2,
                                    dashSize: 100,
                                    gapSize: 50,
                                    blending: THREE.AdditiveBlending
                                });
                                const lineGeom = new THREE.BufferGeometry().setFromPoints([
                                    new THREE.Vector3(0,0,0),
                                    node.mesh.position.clone()
                                ]);
                                node.nexusLine = new THREE.Line(lineGeom, lineMat);
                                node.nexusLine.computeLineDistances();
                                this.scene.add(node.nexusLine);
                            } else {
                                const positions = node.nexusLine.geometry.attributes.position.array;
                                positions[0] = 0; positions[1] = 0; positions[2] = 0;
                                positions[3] = node.mesh.position.x;
                                positions[4] = node.mesh.position.y;
                                positions[5] = node.mesh.position.z;
                                node.nexusLine.geometry.attributes.position.needsUpdate = true;
                                node.nexusLine.computeLineDistances();
                                node.nexusLine.material.opacity = 0.25 + Math.sin(time * 2 + offset) * 0.1;
                                node.nexusLine.visible = node.mesh.visible;
                            }
                        }
                    }
                });

                // Update Particles and Hints
                const nowMs = Date.now();
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const p = this.particles[i];
                    const elapsed = nowMs - p.createdAt;
                    
                    // Update dynamic start/end positions from nodes
                    if (p.startNode && p.startNode.mesh) p.startPos.copy(p.startNode.mesh.position);
                    if (p.endNode && p.endNode.mesh) p.endPos.copy(p.endNode.mesh.position);

                    // Update Line Mesh (Dashed Line) to connect moving nodes
                    if (p.lineMesh) {
                        if (p.lineMesh.isLine) {
                            // Update Line segments
                            const positions = p.lineMesh.geometry.attributes.position.array;
                            positions[0] = p.startPos.x;
                            positions[1] = p.startPos.y;
                            positions[2] = p.startPos.z;
                            positions[3] = p.endPos.x;
                            positions[4] = p.endPos.y;
                            positions[5] = p.endPos.z;
                            p.lineMesh.geometry.attributes.position.needsUpdate = true;
                            p.lineMesh.computeLineDistances(); // Update dash scaling for moving distance
                        } else {
                            // Fallback for Cylinder (if any old ones remain)
                            const direction = new THREE.Vector3().subVectors(p.endPos, p.startPos);
                            const distance = direction.length();
                            if (distance > 0.1) {
                                p.lineMesh.scale.set(1, distance / p.lineMesh.geometry.parameters.height, 1);
                                p.lineMesh.position.copy(p.startPos).add(direction.clone().multiplyScalar(0.5));
                                p.lineMesh.quaternion.setFromUnitVectors(new THREE.Vector3(0, 1, 0), direction.clone().normalize());
                            }
                        }
                    }

                    // 1. Update Particle Ball Position (Fast travel)
                    if (p.progress < 1) {
                        p.progress += p.speed;
                        const t = Math.min(1, p.progress);
                        // Eased position for smooth but fast travel
                        const easedT = t * (2 - t); // Simple quad out
                        const pos = new THREE.Vector3().lerpVectors(p.startPos, p.endPos, easedT);
                        
                        // Arc height (less dramatic than before for speed)
                        const dist = p.startPos.distanceTo(p.endPos);
                        const arcHeight = Math.sin(Math.PI * t) * (dist * 0.05);
                        pos.y += arcHeight;
                        
                        p.mesh.position.copy(pos);
                        
                        // If just reached destination, hide ball
                        if (p.progress >= 1) {
                            p.mesh.visible = false;
                        }
                    }

                    // 2. Lifecycle management and Fading
                    if (p.ttl !== Infinity) {
                        const remaining = p.ttl - elapsed;
                        if (remaining <= 0) {
                            // Cleanup
                            this.scene.remove(p.mesh);
                            if (p.lineMesh) this.scene.remove(p.lineMesh);
                            if (p.hintMesh) {
                                this.scene.remove(p.hintMesh);
                                if (p.hintMesh.material.map) p.hintMesh.material.map.dispose();
                                p.hintMesh.material.dispose();
                            }
                            this.particles.splice(i, 1);
                            continue;
                        }

                        // Fade out lines and hints in last 1s
                        if (remaining < 1000) {
                            const opacity = remaining / 1000;
                            if (p.lineMesh) p.lineMesh.material.opacity = opacity * 0.6;
                            if (p.hintMesh) p.hintMesh.material.opacity = opacity * 0.9;
                        }
                    }

                    // 3. Update Hint position
                    if (p.hintMesh) {
                        const midpoint = new THREE.Vector3().lerpVectors(p.startPos, p.endPos, 0.5);
                        p.hintMesh.position.copy(midpoint);
                        p.hintMesh.position.y += 40;
                    }
                }

                this.controls.update();
                this.renderer.render(this.scene, this.camera);
            }

            cleanupNodes() {
                const now = Date.now();
                
                // Dynamic retention based on system load (node count)
                const nodeCount = this.nodes.size;
                let userIdleLimit = 300000; // Default 5 mins
                let serviceIdleLimit = 1800000; // Default 30 mins
                
                if (nodeCount > 100) {
                    // High load: clean up faster to keep performance
                    userIdleLimit = 120000; // 2 mins
                    serviceIdleLimit = 600000; // 10 mins
                } else if (nodeCount < 30) {
                    // Low load: keep nodes longer to make it look "busy"
                    userIdleLimit = 1200000; // 20 mins
                    serviceIdleLimit = 3600000; // 60 mins
                }

                // Use self_id for bots as that's what's used in events
                const activeBotIds = new Set(currentBots.filter(b => b.is_alive).map(b => b.self_id || b.id));
                const activeWorkerIds = new Set(currentWorkers.map(w => w.id));

                this.nodes.forEach((node, id) => {
                    if (id === 'nexus') return;
                    
                    let shouldRemove = false;
                    const idleTime = now - node.lastActive;

                    if (node.type === 'user') {
                        // Users never vanish
                        shouldRemove = false;
                    } else if (node.type === 'group') {
                        // Groups: Remove if no activity for 2 hours
                        if (idleTime > 7200000) {
                            shouldRemove = true;
                        }
                    } else if (node.type === 'bot') {
                        // Service node: remove if offline
                        // We check if we have data about active bots
                        const isKnownActive = activeBotIds.has(id);
                        if (!isKnownActive) {
                            // If we have other active bots, but not this one, it's definitely offline
                            if (activeBotIds.size > 0) {
                                shouldRemove = true; 
                            } else if (idleTime > 60000) {
                                // If we don't see ANY active bots, maybe API failed? 
                                // Give it 1 minute before removing
                                shouldRemove = true;
                            }
                        }
                    } else if (node.type === 'worker') {
                        // Worker node: remove if offline
                        const isKnownActive = activeWorkerIds.has(id);
                        if (!isKnownActive) {
                            if (activeWorkerIds.size > 0) {
                                shouldRemove = true;
                            } else if (idleTime > 30000) {
                                shouldRemove = true;
                            }
                        }
                    }

                    if (shouldRemove) {
                        if (node.mesh) {
                            this.scene.remove(node.mesh);
                            if (node.mesh.material.map) node.mesh.material.map.dispose();
                            node.mesh.material.dispose();
                        }
                        this.nodes.delete(id);
                    }
                });
            }

            clear() {
                this.nodes.forEach(node => {
                    if (node.id !== 'nexus') {
                        this.scene.remove(node.mesh);
                    }
                });
                const nexus = this.nodes.get('nexus');
                this.nodes.clear();
                if (nexus) this.nodes.set('nexus', nexus);
                
                this.particles.forEach(p => this.scene.remove(p.mesh));
                this.particles = [];
            }
        }

        window.visualizer = null;
        function initVisualizer() {
            if (!window.visualizer) {
                window.visualizer = new RoutingVisualizer();
                window.visualizer.getOrCreateNode('nexus', 'nexus');
                
                // Apply last sync state if available
                if (lastSyncState) {
                    handleSyncState(lastSyncState);
                }
            }
        }

        function handleRoutingEvent(data) {
            if (window.visualizer) {
                window.visualizer.addEvent(data);
            }
            // åŒæ—¶åœ¨æœ€è¿‘æ´»åŠ¨ä¸­æ˜¾ç¤ºæ¶ˆæ¯
            if (data.msg_type === 'message') {
                const logData = {
                    post_type: 'message',
                    user_id: data.user_id,
                    group_id: data.group_id,
                    message: data.content,
                    sender: {
                        nickname: data.user_name || data.user_id
                    },
                    platform: data.platform
                };
                addEventLog(logData);
            }
        }

        let lastSyncState = null;

        function handleSyncState(data) {
            lastSyncState = data;
            if (window.visualizer) {
                console.log("Syncing state:", data);
                
                // Sync groups
                if (data.groups) {
                    Object.values(data.groups).forEach(g => {
                        window.visualizer.getOrCreateNode(g.group_id, 'group', g.group_name || `Group ${g.group_id}`, null, null, g.bot_id);
                    });
                }
                
                // Sync friends
                if (data.friends) {
                    Object.values(data.friends).forEach(f => {
                        window.visualizer.getOrCreateNode(f.user_id, 'user', f.nickname || f.user_id, null);
                    });
                }
                
                // Sync members
                if (data.members) {
                    Object.values(data.members).forEach(m => {
                        window.visualizer.getOrCreateNode(m.user_id, 'user', m.card || m.nickname || m.user_id, null, m.group_id);
                    });
                }
            }
            
            // Auto-refresh contact lists if we receive sync state
            const currentTab = window.location.hash.substring(1);
            if (currentTab === 'groups' || currentTab === 'debug') {
                if (typeof refreshGroupList === 'function') refreshGroupList();
            } else if (currentTab === 'friends') {
                 if (typeof refreshFriendList === 'function') refreshFriendList();
            }
            
            if (data.total_messages) {
                const el = document.getElementById('metric-msgs-total');
                if (el) el.innerText = data.total_messages;
            }
            
            // Update other counts if available
            if (data.groups) {
                const el = document.getElementById('metric-groups-total');
                if (el) el.innerText = Object.keys(data.groups).length;
            }
            if (data.friends) {
                const el = document.getElementById('metric-users-total');
                if (el) el.innerText = Object.keys(data.friends).length;
            }
        }

        function clearVisualization() {
            if (window.visualizer) window.visualizer.clear();
        }

        function toggleFullScreen() {
            const container = document.getElementById('visualization-container');
            if (!container) return;

            if (!document.fullscreenElement) {
                container.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Handle full screen change
        document.addEventListener('fullscreenchange', () => {
            const isFullScreen = !!document.fullscreenElement;
            const btn = document.getElementById('btn-fullscreen');
            const icon = document.getElementById('icon-fullscreen');
            const text = document.getElementById('text-fullscreen');

            if (btn && icon && text) {
                if (isFullScreen) {
                    icon.className = 'bi bi-fullscreen-exit';
                    text.setAttribute('data-i18n', 'exit_full_screen');
                } else {
                    icon.className = 'bi bi-arrows-fullscreen';
                    text.setAttribute('data-i18n', 'full_screen');
                }
                // Trigger re-translation
                 if (typeof setLanguage === 'function') {
                     setLanguage(currentLang);
                 }
            }

            if (window.visualizer) {
                setTimeout(() => window.visualizer.resize(), 100);
            }
        });

        function showTab(tabId) {
            if (!tabId) return;

            // Handle visualization init
            if (tabId === 'visualization') {
                initVisualizer();
            }
            // Handle #hash
            if (tabId.startsWith('#')) tabId = tabId.substring(1);
            // Handle tab- prefix
            if (tabId.startsWith('tab-')) tabId = tabId.replace('tab-', '');
            
            try {
                // éšè—æ‰€æœ‰å†…å®¹åŒºåŸŸ
                const contentSections = document.querySelectorAll('.main-content > div[id^="tab-"]');
                contentSections.forEach(section => {
                    section.style.display = 'none';
                });
                
                // æ˜¾ç¤ºç›®æ ‡å†…å®¹åŒºåŸŸ
                const targetTab = document.getElementById('tab-' + tabId);
                if (targetTab) {
                    targetTab.style.display = 'block';
                    
                    // Visualization resize after tab becomes visible
                    if (tabId === 'visualization' && window.visualizer) {
                        setTimeout(() => window.visualizer.resize(), 50);
                    }
                }
                
                // æ›´æ–°å¯¼èˆªçŠ¶æ€
                const navLinks = document.querySelectorAll('.sidebar .nav-link');
                navLinks.forEach(link => {
                    link.classList.remove('active');
                });
                
                const targetNav = document.getElementById('nav-' + tabId) || 
                                  document.querySelector(`.sidebar .nav-link[href="#${tabId}"]`);
                if (targetNav) {
                    targetNav.classList.add('active');
                }
                
                // æ›´æ–°URL hash (ä½¿ç”¨ replaceState é¿å…è§¦å‘ hashchange äº‹ä»¶)
                const newHash = '#' + tabId;
                if (window.location.hash !== newHash) {
                    window.history.replaceState(null, null, newHash);
                }
                
                // æ ¹æ®tabè§¦å‘ç›¸åº”çš„åˆå§‹åŒ–å‡½æ•°
                switch(tabId) {
                    case 'dashboard':
                        // ä»ªè¡¨æ¿æ•°æ®åœ¨ startApp ä¸­å®šæ—¶æ›´æ–°
                        break;
                    case 'bots':
                        if (typeof fetchBots === 'function') fetchBots(currentBots.length === 0);
                        if (typeof fetchWorkers === 'function') fetchWorkers(currentWorkers.length === 0);
                        break;
                    case 'groups':
                        if (typeof loadGroups === 'function') loadGroups();
                        const listEl = document.getElementById('group-list');
                        if (window.currentBotId && (!window.currentGroups || window.currentGroups.length === 0) && listEl && !listEl.innerHTML.includes('åˆ‡æ¢æœºå™¨äººä¸­')) {
                            if (typeof refreshGroupList === 'function') refreshGroupList();
                        }
                        break;
                    case 'monitor':
                        const activeMonitorTab = document.querySelector('#monitor-tabs .nav-link.active');
                        if (activeMonitorTab && activeMonitorTab.id === 'monitor-logs-tab') {
                            if (typeof fetchLogs === 'function') fetchLogs();
                        }
                        break;
                    case 'workers':
                        if (typeof fetchWorkers === 'function') fetchWorkers(currentWorkers.length === 0);
                        break;
                    case 'docker':
                        if (typeof loadDockerContainers === 'function') loadDockerContainers();
                        break;
                    case 'routing':
                        if (typeof fetchRoutingRules === 'function') fetchRoutingRules();
                        break;
                    case 'logs':
                        if (typeof fetchLogsFull === 'function') fetchLogsFull();
                        break;
                    case 'debug':
                        if (typeof loadTestGroups === 'function') loadTestGroups();
                        break;
                    case 'users':
                        if (typeof fetchUsers === 'function') fetchUsers();
                        break;
                    case 'settings':
                        if (typeof loadBackendConfig === 'function') loadBackendConfig();
                        break;
                    case 'overmind':
                        const overmindIframe = document.getElementById('overmind-iframe');
                        if (overmindIframe && (!overmindIframe.src || overmindIframe.src === window.location.href || overmindIframe.src.endsWith('/web/') || overmindIframe.src.endsWith('index.html'))) {
                            const lang = currentLang || 'zh-CN';
                            const langParam = lang === 'zh-CN' ? 'zh' : 'en';
                            const token = authToken || localStorage.getItem('wxbot_token');
                            overmindIframe.src = `/overmind/?lang=${langParam}&token=${encodeURIComponent(token)}`;
                        }
                        break;
                }
                
                // ç§»åŠ¨ç«¯å…³é—­ä¾§è¾¹æ 
                if (window.innerWidth <= 768) {
                    const sidebar = document.getElementById('sidebar');
                    const overlay = document.getElementById('sidebar-overlay');
                    if (sidebar) sidebar.classList.remove('show');
                    if (overlay) overlay.classList.remove('show');
                }
                
                console.log('åˆ‡æ¢åˆ°æ ‡ç­¾é¡µ:', tabId);
                
            } catch (error) {
                console.error('åˆ‡æ¢æ ‡ç­¾é¡µå¤±è´¥:', error);
                if (tabId !== 'dashboard') {
                    showTab('dashboard');
                }
            }
        }

        function startApp() {
            try {
                applyRoleUI(authRole);
                
                // è·å–åˆå§‹æ ‡ç­¾é¡µ
                let initialTab = 'dashboard';
                const hash = window.location.hash;
                if (hash) {
                    const tabId = hash.substring(1);
                    const validTabs = ['dashboard', 'bots', 'groups', 'monitor', 'workers', 'docker', 'routing', 'logs', 'debug', 'users', 'settings', 'visualization'];
                    const isValidTab = validTabs.includes(tabId) && document.getElementById('tab-' + tabId);
                    
                    if (isValidTab) {
                        const isAdmin = (authRole === 'super' || authRole === 'admin');
                        if (tabId === 'debug' && !isAdmin) {
                            initialTab = 'dashboard';
                        } else {
                            initialTab = tabId;
                        }
                    }
                }
                
                // ç«‹å³æ˜¾ç¤ºåˆå§‹æ ‡ç­¾é¡µï¼Œé˜²æ­¢é—ªçƒ
                showTab(initialTab);

                // å»¶è¿Ÿåˆå§‹åŒ–å…¶ä»–ç»„ä»¶ï¼Œé˜²æ­¢é¡µé¢å¡æ­»
                setTimeout(() => {
                    try {
                        initWebSocket();
                    } catch (wsError) {
                        console.error('WebSocketåˆå§‹åŒ–å¤±è´¥:', wsError);
                    }
                }, 100);
                
                // åˆ†æ‰¹åŠ è½½æ•°æ®
                setTimeout(() => {
                    try {
                        updateStats();
                        updateSystemStats();
                    } catch (error) {
                        console.error('ç³»ç»Ÿæ•°æ®åŠ è½½å¤±è´¥:', error);
                    }
                }, 200);
                
                setTimeout(() => {
                    try {
                        fetchBots();
                        fetchWorkers();
                    } catch (error) {
                        console.error('æœºå™¨äººæ•°æ®åŠ è½½å¤±è´¥:', error);
                    }
                }, 400);
                
                setTimeout(() => {
                    try {
                        updateChatStats();
                    } catch (error) {
                        console.error('èŠå¤©æ•°æ®åŠ è½½å¤±è´¥:', error);
                    }
                }, 600);
                
                // å¯åŠ¨å®šæ—¶å™¨
                const rate = parseInt(localStorage.getItem('refresh_rate')) || 2000;
                // åŒæ­¥è®¾ç½®é¡µé¢ä¸‹æ‹‰æ¡†
                const rateSelect = document.getElementById('setting-refresh-rate');
                if (rateSelect) rateSelect.value = rate.toString();

                const safeSetInterval = (fn, interval, name) => {
                    return setInterval(() => {
                        try {
                            fn();
                        } catch (error) {
                            console.error(`${name}å®šæ—¶å™¨æ‰§è¡Œå¤±è´¥:`, error);
                        }
                    }, interval);
                };
                
                window.updateInterval = safeSetInterval(updateStats, rate, 'updateStats');
                window.systemStatsInterval = safeSetInterval(updateSystemStats, rate, 'updateSystemStats');
                window.timeUpdateInterval = safeSetInterval(updateTimeDisplay, 500, 'updateTimeDisplay');
                window.chatStatsInterval = safeSetInterval(updateChatStats, 5000, 'updateChatStats');
                window.botsInterval = safeSetInterval(updateBots, 5000, 'updateBots');
                window.workersInterval = safeSetInterval(fetchWorkers, 5000, 'fetchWorkers');
                
                // Start combined stats rotation
                window.combinedStatsInterval = safeSetInterval(rotateCombinedStats, 3000, 'rotateCombinedStats');
                
            } catch (error) {
                console.error('startAppåˆå§‹åŒ–å¤±è´¥:', error);
                try {
                    const t = translations[currentLang] || translations['zh-CN'];
                    alert(t.startup_error || 'åº”ç”¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                } catch (alertError) {
                    console.error('æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯å¤±è´¥:', alertError);
                }
            }
        }

        let lastSystemStats = null;
        let serverStartTime = null;

        function updateTimeDisplay() {
            // Current Time & Date
            if (document.getElementById('metric-current-time')) {
                const now = new Date();
                const dateStr = now.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
                const timeStr = now.toLocaleTimeString('zh-CN', { hour12: false });
                document.getElementById('metric-current-time').innerText = `${dateStr} ${timeStr}`;
            }
            // Up Time
            if (document.getElementById('metric-uptime') && serverStartTime) {
                const uptimeSeconds = Math.floor(Date.now() / 1000 - serverStartTime);
                const h = Math.floor(uptimeSeconds / 3600);
                const m = Math.floor((uptimeSeconds % 3600) / 60);
                const s = uptimeSeconds % 60;
                document.getElementById('metric-uptime').innerText = 
                    `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }
        }

        async function fetchSystemStats(updateDetails = false) {
            if (!authToken) return;
            try {
                const res = await fetchWithAuth('/api/system/stats');
                if (!res.ok) throw new Error(res.statusText);
                const data = await res.json();
                lastSystemStats = data;
                window.lastSystemStats = data; // Ensure global access

                // Update Dashboard Cards
                if (document.getElementById('metric-cpu')) {
                    const cpu = (data.cpu_usage !== undefined && data.cpu_usage !== null) ? data.cpu_usage : 0;
                    document.getElementById('metric-cpu').innerText = cpu.toFixed(1) + '%';
                    if (document.getElementById('metric-cpu-bar')) {
                        document.getElementById('metric-cpu-bar').style.width = cpu.toFixed(1) + '%';
                    }
                }

                // OS Info
                if (data.os_platform || data.host_info) {
                    if (document.getElementById('metric-os-plat')) {
                        const plat = data.os_platform || (data.host_info ? data.host_info.platform : 'Unknown');
                        const ver = data.os_version || (data.host_info ? data.host_info.platformVersion : '');
                        const full = `${plat} ${ver}`.trim() || 'alpine 3.23.0'; // Fallback to user requested default if both missing
                        document.getElementById('metric-os-plat').innerText = full;
                        document.getElementById('metric-os-plat').title = full;
                    }
                    if (document.getElementById('metric-os-ver')) {
                         const kernel = data.host_info ? `å†…æ ¸: ${data.host_info.kernelVersion}` : 'å†…æ ¸: 6.8.0-86-generic';
                         document.getElementById('metric-os-ver').innerText = kernel;
                    }
                    if (document.getElementById('metric-os-arch')) {
                         document.getElementById('metric-os-arch').innerText = data.os_arch || (data.host_info ? data.host_info.kernelArch : '');
                    }
                }

                // Update Memory if provided in system stats
                if (data.mem_usage !== undefined && data.mem_usage !== null) {
                    // This might overlap with updateStats, but ensures system stats also update it
                    if (document.getElementById('metric-mem-percent')) {
                        document.getElementById('metric-mem-percent').innerText = data.mem_usage.toFixed(1) + '%';
                    }
                    if (document.getElementById('metric-mem-bar')) {
                        document.getElementById('metric-mem-bar').style.width = data.mem_usage.toFixed(1) + '%';
                    }
                }

                // Process List
                const procBody = document.getElementById('process-list');
                if (procBody && data.processes) {
                    if (data.processes.length === 0) {
                        procBody.innerHTML = '<tr><td colspan="4" class="text-center">æš‚æ— æ•°æ®</td></tr>';
                    } else {
                        procBody.innerHTML = data.processes.map(p => {
                            const cpu = (p.cpu !== undefined && p.cpu !== null) ? p.cpu : 0;
                            const mem = (p.memory !== undefined && p.memory !== null) ? p.memory : 0;
                            return `
                                <tr>
                                    <td>${p.pid}</td>
                                    <td class="text-truncate" style="max-width: 150px;" title="${p.name}">${p.name || 'unknown'}</td>
                                    <td>${cpu.toFixed(1)}%</td>
                                    <td>${(mem / 1024 / 1024).toFixed(1)}</td>
                                </tr>
                            `;
                        }).join('');
                    }
                }
                
                // Update Detail View if active
                if (updateDetails || (document.getElementById('tab-view-system-details') && document.getElementById('tab-view-system-details').style.display !== 'none')) {
                    updateDetailChart(); // This uses lastSystemStats
                }

            } catch (e) {
                console.error("Fetch system stats error:", e);
            }
        }

        function updateSystemStats() {
            fetchSystemStats();
        }

        // Handle Login Submit
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUser').value;
            const password = document.getElementById('loginPass').value;
            const errorBox = document.getElementById('loginError');
            const btnText = document.getElementById('loginBtnText');
            const btnLoading = document.getElementById('loginBtnLoading');
            
            errorBox.classList.add('d-none');
            btnText.classList.add('d-none');
            btnLoading.classList.remove('d-none');
            
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password})
                });
                
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.message || 'ç™»å½•å¤±è´¥ï¼šç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
                }
                
                const data = await res.json();
                authToken = data.token;
                authRole = data.role;
                localStorage.setItem('wxbot_token', authToken);
                localStorage.setItem('wxbot_role', authRole);
                
                applyRoleUI(authRole);

                // Hide Login Page
                document.getElementById('loginPage').classList.add('hidden');
                setTimeout(() => {
                    document.getElementById('loginPage').style.display = 'none';
                }, 500);
                
                // Init
                startApp();
                
            } catch (err) {
                errorBox.innerText = err.message;
                errorBox.classList.remove('d-none');
            } finally {
                btnText.classList.remove('d-none');
                btnLoading.classList.add('d-none');
            }
        });

        function logout() {
            // Clear WebSocket connection if exists
            if (window.wsSubscriber) {
                try {
                    window.wsSubscriber.close();
                } catch (e) {
                    console.error('WebSocket close error:', e);
                }
                window.wsSubscriber = null;
            }
            
            // Clear all intervals
            if (window.updateInterval) clearInterval(window.updateInterval);
            if (window.systemStatsInterval) clearInterval(window.systemStatsInterval);
            if (window.chatStatsInterval) clearInterval(window.chatStatsInterval);
            if (window.botsInterval) clearInterval(window.botsInterval);
            if (window.workersInterval) clearInterval(window.workersInterval);
            
            // Clear localStorage
            localStorage.removeItem('wxbot_token');
            localStorage.removeItem('wxbot_role');
            
            // Clear session variables
            window.authToken = null;
            window.authRole = null;
            window.currentBotId = '';
            
            // Force reload with cache clear
            location.href = location.origin + location.pathname + '?logout=1';
        }

        // --- Navigation ---
        // Toggle Sidebar for Mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        }

        // --- Dashboard & Stats ---
        let memChart = null;
        let cpuChart = null;
        let msgChart = null;
        let lastMsgCount = 0;
        let lastSentCount = 0;
        let msgHistory = [];
        let sentHistory = [];
        let recvHistory = [];
        const MSG_HISTORY_SIZE = 30; // 30 * 2s = 60s
        const MAX_CHART_POINTS = 1800; // 1800 * 2s = 60 minutes

        function initCharts() {
            try {
                // Memory Chart
                const ctxMem = document.getElementById('memChart');
                if (ctxMem) {
                    memChart = new Chart(ctxMem.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Memory Alloc (MB)',
                                data: [],
                                borderColor: '#0d6efd',
                                tension: 0.4,
                                fill: true,
                                backgroundColor: 'rgba(13, 110, 253, 0.1)'
                            }]
                        },
                        options: {
                            responsive: true,
                            animation: false,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { 
                                y: { beginAtZero: true, grid: { display: true, drawBorder: false } },
                                x: { grid: { display: false } }
                            }
                        }
                    });
                }

                // CPU Chart
                const ctxCpu = document.getElementById('cpuChart');
                if (ctxCpu) {
                    cpuChart = new Chart(ctxCpu.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'CPU Usage (%)',
                                data: [],
                                borderColor: '#ffc107',
                                tension: 0.4,
                                fill: true,
                                backgroundColor: 'rgba(255, 193, 7, 0.1)'
                            }]
                        },
                        options: {
                            responsive: true,
                            animation: false,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { 
                                y: { beginAtZero: true, max: 100, grid: { display: true, drawBorder: false } },
                                x: { grid: { display: false } }
                            }
                        }
                    });
                }

                // Message Chart
                const ctxMsg = document.getElementById('msgChart');
                if (ctxMsg) {
                    msgChart = new Chart(ctxMsg.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [
                                {
                                    label: 'æ¥æ”¶',
                                    data: [],
                                    borderColor: '#198754', // Green
                                    tension: 0.4,
                                    fill: false,
                                    borderWidth: 2
                                },
                                {
                                    label: 'å‘é€',
                                    data: [],
                                    borderColor: '#0d6efd', // Blue
                                    tension: 0.4,
                                    fill: false,
                                    borderWidth: 2
                                },
                                {
                                    label: 'æ€»é‡',
                                    data: [],
                                    borderColor: '#6c757d', // Gray
                                    tension: 0.4,
                                    fill: false,
                                    borderDash: [5, 5],
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            animation: false,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            plugins: { 
                                legend: { display: true, position: 'top', labels: { boxWidth: 10, usePointStyle: true } },
                                tooltip: { mode: 'index', intersect: false }
                            },
                            scales: { 
                                y: { beginAtZero: true, grid: { display: true, drawBorder: false } },
                                x: { grid: { display: false } }
                            }
                        }
                    });
                }
            } catch (e) {
                console.error("Chart init error:", e);
            }
        }
        
        initCharts();

        function formatBytes(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            if (i < 0 || isNaN(i)) return '0 B';
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function rotateCombinedStats() {
            const container = document.getElementById('combined-stats-container');
            if (!container) return;
            
            const slides = container.querySelectorAll('.stats-slide');
            if (slides.length <= 1) return;
            
            let activeIndex = -1;
            for (let i = 0; i < slides.length; i++) {
                if (slides[i].classList.contains('active')) {
                    activeIndex = i;
                    break;
                }
            }
            
            if (activeIndex === -1) {
                slides[0].classList.add('active');
                slides[0].style.display = 'block';
                return;
            }
            
            // Hide current
            slides[activeIndex].classList.remove('active');
            slides[activeIndex].style.display = 'none';
            
            // Show next
            const nextIndex = (activeIndex + 1) % slides.length;
            slides[nextIndex].classList.add('active');
            slides[nextIndex].style.display = 'block';
            
            // Update icon
            const iconElement = document.querySelector('#combined-stats-icon i');
            if (iconElement) {
                const icons = ['bi-activity', 'bi-people', 'bi-chat-text'];
                iconElement.className = `bi ${icons[nextIndex]}`;
            }
        }

        function updateStats() {
            if (!authToken) return;
            fetchWithAuth('/api/stats')
                .then(r => r.json())
                .then(data => {
                    window.latestStats = data; // Store globally for details view
                    if (document.getElementById('metric-goroutines')) {
                        document.getElementById('metric-goroutines').innerText = data.goroutines !== undefined ? data.goroutines : '0';
                    }
                    if (document.getElementById('metric-mem')) {
                        const used = data.memory_used !== undefined ? data.memory_used : (data.memory_alloc !== undefined ? data.memory_alloc : 0);
                        document.getElementById('metric-mem').innerText = formatBytes(used);
                        if (data.memory_total && document.getElementById('metric-mem-bar')) {
                            const pct = (used / data.memory_total) * 100;
                            document.getElementById('metric-mem-bar').style.width = pct.toFixed(1) + '%';
                        }
                    }
                    if (document.getElementById('metric-mem-total')) {
                        document.getElementById('metric-mem-total').innerText = data.memory_total !== undefined ? formatBytes(data.memory_total) : '0 B';
                    }

                    if (document.getElementById('metric-bots')) {
                        document.getElementById('metric-bots').innerText = data.bot_count !== undefined ? data.bot_count : '0';
                    }
                    if (document.getElementById('metric-bots-offline')) {
                        document.getElementById('metric-bots-offline').innerText = data.bot_count_offline !== undefined ? data.bot_count_offline : '0';
                    }
                    if (document.getElementById('metric-bots-total')) {
                        document.getElementById('metric-bots-total').innerText = data.bot_count_total !== undefined ? data.bot_count_total : '0';
                    }
                    if (document.getElementById('metric-workers')) {
                        document.getElementById('metric-workers').innerText = data.worker_count !== undefined ? data.worker_count : '0';
                    }

                    // CPU & OS Details
                    if (document.getElementById('metric-cpu-model') && data.cpu_model) {
                         let model = data.cpu_model;
                         if (model.length > 25) model = model.substring(0, 25) + '...';
                         document.getElementById('metric-cpu-model').innerText = model;
                         const card = document.getElementById('metric-cpu-model').closest('.stat-card');
                         if (card) card.title = data.cpu_model;
                    }
                    if (document.getElementById('metric-cpu-cores')) {
                         document.getElementById('metric-cpu-cores').innerText = (data.cpu_cores_physical || 0) + 'P/' + (data.cpu_cores_logical || 0) + 'L';
                    }
                    if (document.getElementById('metric-cpu-freq')) {
                         document.getElementById('metric-cpu-freq').innerText = (data.cpu_freq || 0).toFixed(0) + ' MHz';
                    }
                    if (document.getElementById('metric-os-plat')) {
                        document.getElementById('metric-os-plat').innerText = data.os_platform || 'Unknown';
                    }
                    if (document.getElementById('metric-os-ver')) {
                        const t = translations[currentLang] || translations['zh-CN'];
                        document.getElementById('metric-os-ver').innerText = (t.version_label || 'ç‰ˆæœ¬: ') + (data.os_version || 'Unknown');
                    }

                    if (data.start_time) {
                        serverStartTime = data.start_time;
                    }

                    // New metrics
                    if (document.getElementById('metric-groups-today')) document.getElementById('metric-groups-today').innerText = (data.active_groups_today !== undefined && data.active_groups_today !== null) ? data.active_groups_today : 0;
                    if (document.getElementById('metric-groups-total')) document.getElementById('metric-groups-total').innerText = (data.active_groups !== undefined && data.active_groups !== null) ? data.active_groups : 0;
                    if (document.getElementById('metric-users-today')) document.getElementById('metric-users-today').innerText = (data.active_users_today !== undefined && data.active_users_today !== null) ? data.active_users_today : 0;
                    if (document.getElementById('metric-users-total')) document.getElementById('metric-users-total').innerText = (data.active_users !== undefined && data.active_users !== null) ? data.active_users : 0;
                    if (document.getElementById('metric-msgs-total')) document.getElementById('metric-msgs-total').innerText = (data.message_count !== undefined && data.message_count !== null) ? data.message_count : 0;
                    if (document.getElementById('metric-sent-total')) document.getElementById('metric-sent-total').innerText = (data.sent_message_count !== undefined && data.sent_message_count !== null) ? data.sent_message_count : 0;

                    const now = new Date().toLocaleTimeString();

                    let justInitialized = false;

                    // --- Init History (Once) ---
                    if (data.cpu_trend && cpuChart && cpuChart.data.labels.length === 0) {
                        data.cpu_trend.forEach(() => cpuChart.data.labels.push(''));
                        cpuChart.data.datasets[0].data = data.cpu_trend;
                        cpuChart.update();
                        justInitialized = true;
                    }
                    if (data.mem_trend && memChart && memChart.data.labels.length === 0) {
                        data.mem_trend.forEach(() => memChart.data.labels.push(''));
                        memChart.data.datasets[0].data = data.mem_trend.map(v => v / 1024 / 1024);
                        memChart.update();
                        justInitialized = true;
                    }
                    if (data.msg_trend && msgChart && msgChart.data.labels.length === 0) {
                        // Load history
                        msgHistory = [...data.msg_trend];
                        sentHistory = data.sent_trend ? [...data.sent_trend] : new Array(msgHistory.length).fill(0);
                        recvHistory = data.recv_trend ? [...data.recv_trend] : new Array(msgHistory.length).fill(0);

                        // Reconstruct chart data (Moving Sum)
                        const chartDataRecv = [];
                        const chartDataSent = [];
                        const chartDataTotal = [];
                        const labels = [];
                        
                        for (let i = 0; i < msgHistory.length; i++) {
                            let start = Math.max(0, i - MSG_HISTORY_SIZE + 1);
                            let sumTotal = 0, sumSent = 0, sumRecv = 0;
                            for (let j = start; j <= i; j++) {
                                sumTotal += msgHistory[j] || 0;
                                sumSent += sentHistory[j] || 0;
                                sumRecv += recvHistory[j] || 0;
                            }
                            chartDataRecv.push(sumRecv);
                            chartDataSent.push(sumSent);
                            chartDataTotal.push(sumTotal);
                            labels.push('');
                        }
                        msgChart.data.labels = labels;
                        msgChart.data.datasets[0].data = chartDataRecv;
                        msgChart.data.datasets[1].data = chartDataSent;
                        msgChart.data.datasets[2].data = chartDataTotal;
                        msgChart.update();
                        
                        // Sync counters
                        lastMsgCount = data.message_count || 0;
                        lastSentCount = data.sent_message_count || 0;
                        justInitialized = true;
                    }

                    // Update Memory Chart
                    if (memChart && !justInitialized) {
                        if (memChart.data.labels.length > MAX_CHART_POINTS) {
                            memChart.data.labels.shift();
                            memChart.data.datasets[0].data.shift();
                        }
                        memChart.data.labels.push(now);
                        memChart.data.datasets[0].data.push(data.memory_alloc / 1024 / 1024);
                        memChart.update();
                    }
                    
                    // Update Message Chart
                    if (msgChart && !justInitialized) {
                        const currentTotal = data.message_count || 0;
                        const currentSent = data.sent_message_count || 0;
                        
                        const diffTotal = currentTotal - lastMsgCount;
                        const diffSent = currentSent - lastSentCount;
                        
                        // Avoid spike on first load
                        const valTotal = lastMsgCount === 0 ? 0 : (diffTotal < 0 ? 0 : diffTotal);
                        const valSent = lastSentCount === 0 ? 0 : (diffSent < 0 ? 0 : diffSent);
                        const valRecv = (valTotal - valSent) < 0 ? 0 : (valTotal - valSent);
                        
                        lastMsgCount = currentTotal;
                        lastSentCount = currentSent;

                        // Add to history
                        msgHistory.push(valTotal);
                        sentHistory.push(valSent);
                        recvHistory.push(valRecv);

                        if (msgHistory.length > MSG_HISTORY_SIZE) msgHistory.shift();
                        if (sentHistory.length > MSG_HISTORY_SIZE) sentHistory.shift();
                        if (recvHistory.length > MSG_HISTORY_SIZE) recvHistory.shift();

                        const rateTotal = msgHistory.reduce((a, b) => a + b, 0);
                        const rateSent = sentHistory.reduce((a, b) => a + b, 0);
                        const rateRecv = recvHistory.reduce((a, b) => a + b, 0);

                        if (msgChart.data.labels.length > MAX_CHART_POINTS) {
                            msgChart.data.labels.shift();
                            msgChart.data.datasets.forEach(d => d.data.shift());
                        }
                        msgChart.data.labels.push(now);
                        msgChart.data.datasets[0].data.push(rateRecv);
                        msgChart.data.datasets[1].data.push(rateSent);
                        msgChart.data.datasets[2].data.push(rateTotal);
                        msgChart.update();
                    }

                    // Update CPU Chart
                    if (cpuChart && !justInitialized) {
                        if (cpuChart.data.labels.length > MAX_CHART_POINTS) {
                            cpuChart.data.labels.shift();
                            cpuChart.data.datasets[0].data.shift();
                        }
                        cpuChart.data.labels.push(now);
                        cpuChart.data.datasets[0].data.push(data.cpu_usage);
                        cpuChart.update();
                    }

                    // Save stats to cache
                    saveStatsToCache({
                        bot_count: data.bot_count,
                        bot_count_offline: data.bot_count_offline || 0,
                        bot_count_total: data.bot_count_total || 0,
                        // Cache other critical stats if needed
                        memory_total: data.memory_total,
                        cpu_model: data.cpu_model,
                        cpu_cores_physical: data.cpu_cores_physical,
                        cpu_cores_logical: data.cpu_cores_logical,
                        cpu_freq: data.cpu_freq
                    });

                })
                .catch(e => console.error("Update stats error:", e));
        }

        // --- Cache Logic ---
        function saveStatsToCache(stats) {
            localStorage.setItem('bot_stats_cache', JSON.stringify(stats));
        }

        function loadStatsFromCache() {
            const cached = localStorage.getItem('bot_stats_cache');
            if (cached) {
                try {
                    const stats = JSON.parse(cached);
                    if (document.getElementById('metric-bots')) {
                        document.getElementById('metric-bots').innerText = stats.bot_count || 0;
                    }
                    if (document.getElementById('metric-bots-offline')) {
                        document.getElementById('metric-bots-offline').innerText = stats.bot_count_offline || 0;
                    }
                    if (document.getElementById('metric-bots-total')) {
                        document.getElementById('metric-bots-total').innerText = stats.bot_count_total || 0;
                    }
                    if (document.getElementById('metric-workers')) {
                        document.getElementById('metric-workers').innerText = stats.worker_count || 0;
                    }
                    
                    if (document.getElementById('metric-mem-total') && stats.memory_total) {
                        document.getElementById('metric-mem-total').innerText = formatBytes(stats.memory_total);
                    }

                    // CPU Details Cache
                    if (document.getElementById('metric-cpu-model') && stats.cpu_model) {
                         let model = stats.cpu_model;
                         if (model.length > 25) model = model.substring(0, 25) + '...';
                         document.getElementById('metric-cpu-model').innerText = model;
                         const card = document.getElementById('metric-cpu-model').closest('.stat-card');
                         if (card) card.title = stats.cpu_model;
                    }
                    if (document.getElementById('metric-cpu-cores') && stats.cpu_cores_physical) {
                         document.getElementById('metric-cpu-cores').innerText = (stats.cpu_cores_physical || 0) + 'P/' + (stats.cpu_cores_logical || 0) + 'L æ ¸';
                    }
                    if (document.getElementById('metric-cpu-freq') && stats.cpu_freq) {
                         document.getElementById('metric-cpu-freq').innerText = (stats.cpu_freq || 0).toFixed(0) + ' MHz';
                    }
                } catch (e) {
                    console.error("Failed to load cached stats", e);
                }
            }
        }
        
        // Load cache immediately
        loadStatsFromCache();
        
        // --- Bots & Workers ---
        let currentBots = [];
        let botSortBy = 'name'; // name, id, count, time
        let botSortAsc = true;
        let botFilterText = '';
        let botViewMode = localStorage.getItem('bot_view_mode') || 'detail';

        let currentWorkers = [];
        let workerSortBy = 'addr'; // addr, time, status
        let workerSortAsc = true;
        let workerFilterText = '';
        let workerViewMode = localStorage.getItem('worker_view_mode') || 'detail';

        // Update View Mode UI on Load
        document.addEventListener('DOMContentLoaded', () => {
             updateViewModeUI('bot', botViewMode);
             updateViewModeUI('worker', workerViewMode);
        });

        function setBotViewMode(mode) {
            botViewMode = mode;
            window._botViewModeManuallySet = true;
            localStorage.setItem('bot_view_mode', mode);
            updateViewModeUI('bot', mode);
            renderBots();
        }

        function setWorkerViewMode(mode) {
            workerViewMode = mode;
            window._workerViewModeManuallySet = true;
            localStorage.setItem('worker_view_mode', mode);
            updateViewModeUI('worker', mode);
            renderWorkers();
        }

        function updateViewModeUI(type, mode) {
            const btnDetail = document.getElementById(`btn-${type}-view-detail`);
            const btnCompact = document.getElementById(`btn-${type}-view-compact`);
            if (btnDetail && btnCompact) {
                if (mode === 'detail') {
                    btnDetail.classList.add('active');
                    btnCompact.classList.remove('active');
                } else {
                    btnDetail.classList.remove('active');
                    btnCompact.classList.add('active');
                }
            }
        }

        function timeAgo(date) {
            const t = translations[currentLang] || translations['zh-CN'];
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + t.time_ago_year;
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + t.time_ago_month;
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + t.time_ago_day;
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + t.time_ago_hour;
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + t.time_ago_minute;
            return Math.floor(seconds) + t.time_ago_second;
        }

        function updateBots() {
            fetchBots();
        }

        function fetchBots(showLoading = false) {
            if (!authToken) return;
            const t = translations[currentLang] || translations['zh-CN'];
            
            if (showLoading) {
                const container = document.getElementById('bot-list-container');
                if (container) {
                    container.innerHTML = `
                        <div class="col-12 text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="mt-2 text-muted">${t.loading || 'åŠ è½½ä¸­...'}</div>
                        </div>
                    `;
                }
            }

            fetchWithAuth('/api/bots')
                .then(r => r.json())
                .then(bots => {
                    currentBots = bots;
                    const onlineCount = bots.filter(b => b.is_alive).length;
                    
                    // Update Badge
                    const badge = document.getElementById('badge-bots');
                    if (badge) badge.innerText = onlineCount + '/' + bots.length;

                    // Update Metrics
                    if (document.getElementById('metric-bots')) {
                        document.getElementById('metric-bots').innerText = onlineCount;
                    }

                    // Update Global Selector (Dropdown)
                    const selectorInput = document.getElementById('global-bot-selector');
                    const dropdownList = document.getElementById('global-bot-list');
                    const currentVal = selectorInput.value;
                    
                    if (bots.length === 0) {
                        dropdownList.innerHTML = `<li><span class="dropdown-item disabled">${t.no_bot_data_simple}</span></li>`;
                        document.getElementById('global-bot-selected-content').innerHTML = t.no_bot_data_simple;
                    } else {
                        dropdownList.innerHTML = bots.map(bot => {
                            const isOffline = !bot.is_alive;
                            const statusClass = isOffline ? 'text-muted' : 'text-success fw-bold';
                            const badge = isOffline ? `<span class="badge bg-secondary ms-auto">${t.bot_status_offline}</span>` : `<span class="badge bg-success ms-auto">${t.bot_status_online}</span>`;
                            const platform = bot.platform || 'QQ';
                            let avatarUrl = `https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/robot.svg`;
                            let avatarBg = 'var(--bg-list-item)';
                            
                            if (platform === 'QQ') {
                                avatarUrl = `https://q1.qlogo.cn/g?b=qq&nk=${bot.self_id}&s=100`;
                            }
                            
                            // Use proxy for external avatars
                            if (avatarUrl.startsWith('http')) {
                                avatarUrl = `/api/proxy/avatar?url=${encodeURIComponent(avatarUrl)}`;
                            }

                            return `
                                <li>
                                    <a class="dropdown-item d-flex align-items-center p-2 ${isOffline ? 'disabled' : ''}" href="#" onclick="${isOffline ? 'return false;' : `selectBotFromDropdown('${bot.self_id}')`}">
                                        <div class="rounded-circle d-flex align-items-center justify-content-center me-2 flex-shrink-0" style="width: 32px; height: 32px; overflow: hidden; background: ${avatarBg};">
                                            <img src="${avatarUrl}" alt="" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/robot.svg';">
                                        </div>
                                        <div class="flex-grow-1 overflow-hidden">
                                            <div class="d-flex align-items-center">
                                                <div class="fw-bold text-truncate ${statusClass}" style="max-width: 120px;">${bot.nickname || bot.self_id}</div>
                                                ${badge}
                                            </div>
                                            <div class="text-muted small">${bot.self_id}</div>
                                        </div>
                                    </a>
                                </li>
                            `;
                        }).join('');
                        
                        // Restore selection or select first online
                        let targetId = currentVal;
                        if (!targetId || !bots.find(b => b.self_id === targetId && b.is_alive)) {
                            const firstOnline = bots.find(b => b.is_alive);
                            if (firstOnline) {
                                targetId = firstOnline.self_id;
                            }
                        }
                        
                        if (targetId) {
                            updateBotSelectorUI(targetId);
                            if (currentBotId !== targetId) {
                                currentBotId = targetId;
                            }
                        }
                    }

                    renderBots();
                    updateLogBotSelector(bots);
                    updateLogBotSelectorFull(bots);
                });
        }

        function updateLogBotSelector(bots) {
             const selector = document.getElementById('log-bot-selector');
             if (!selector) return;
             // Keep selection
             const current = selector.value;
             const t = translations[currentLang] || translations['zh-CN'];
             
             let html = `<option value="">${t.log_all}</option>`;
             html += `<option value="system">${t.log_system}</option>`;
             
             bots.forEach(b => {
                 const name = b.nickname || b.self_id;
                 const status = b.is_alive ? '' : ' (Offline)';
                 html += `<option value="${b.self_id}">${name} (${b.platform})${status}</option>`;
             });
             selector.innerHTML = html;
             selector.value = current;
        }

        function filterBots(text) {
            botFilterText = text.toLowerCase();
            renderBots();
        }

        function sortBots(field) {
            if (botSortBy === field) {
                botSortAsc = !botSortAsc;
            } else {
                botSortBy = field;
                botSortAsc = true;
                if (field === 'count' || field === 'time' || field === 'msg') botSortAsc = false;
            }

            const t = translations[currentLang] || translations['zh-CN'];

            // Update UI
            ['name', 'id', 'platform', 'count', 'time', 'msg'].forEach(f => {
                const btn = document.getElementById(`btn-sort-bot-${f}`);
                if (f === botSortBy) {
                    btn.classList.add('active');
                    let label = '';
                    switch(f) {
                        case 'name': label = t.sort_name; break;
                        case 'id': label = t.sort_id; break;
                        case 'platform': label = t.sort_platform; break;
                        case 'count': label = t.sort_group_count; break;
                        case 'time': label = t.sort_time; break;
                        case 'msg': label = t.sort_msg_count; break;
                    }
                    btn.innerHTML = label + (botSortAsc ? ' â†‘' : ' â†“');
                } else {
                    btn.classList.remove('active');
                    let label = '';
                    switch(f) {
                        case 'name': label = t.sort_name; break;
                        case 'id': label = t.sort_id; break;
                        case 'platform': label = t.sort_platform; break;
                        case 'count': label = t.sort_group_count; break;
                        case 'time': label = t.sort_time; break;
                        case 'msg': label = t.sort_msg_count; break;
                    }
                    btn.innerHTML = label;
                }
            });

            renderBots();
        }

        function renderBots() {
            const container = document.getElementById('bot-list-container');
            let bots = currentBots.filter(b => {
                if (!botFilterText) return true;
                return (b.nickname || '').toLowerCase().includes(botFilterText) || 
                       (b.self_id || '').includes(botFilterText) ||
                       (b.platform || '').toLowerCase().includes(botFilterText);
            });

            // Auto switch to compact mode if many bots
            if (bots.length > 12 && botViewMode === 'detail' && !window._botViewModeManuallySet) {
                botViewMode = 'compact';
                document.getElementById('btn-bot-view-detail').classList.remove('active');
                document.getElementById('btn-bot-view-compact').classList.add('active');
            }

            // Sort
            bots.sort((a, b) => {
                // Always put online bots first
                if (a.is_alive !== b.is_alive) {
                    return a.is_alive ? -1 : 1;
                }

                let res = 0;
                if (botSortBy === 'name') {
                    res = (a.nickname || '').localeCompare(b.nickname || '', 'zh-CN');
                } else if (botSortBy === 'id') {
                    res = (a.self_id || '').localeCompare(b.self_id || '');
                } else if (botSortBy === 'count') {
                    res = (a.group_count || 0) - (b.group_count || 0);
                } else if (botSortBy === 'time') {
                    res = new Date(a.connected) - new Date(b.connected);
                } else if (botSortBy === 'platform') {
                    res = (a.platform || 'QQ').localeCompare(b.platform || 'QQ', 'zh-CN');
                } else if (botSortBy === 'msg') {
                    res = (a.msg_count || 0) - (b.msg_count || 0);
                }
                
                // Primary sort result
                if (res !== 0) {
                    return botSortAsc ? res : -res;
                }
                
                // Secondary sort: ID (Always Ascending)
                return (a.self_id || '').localeCompare(b.self_id || '');
            });

            const t = translations[currentLang] || translations['zh-CN'];
            if (bots.length === 0) {
                container.innerHTML = `<div class="col-12 text-center text-muted">${t.no_bot_data}</div>`;
            } else {
                container.innerHTML = bots.map(bot => {
                    const connDate = new Date(bot.connected);
                    const timeStr = timeAgo(bot.connected);
                    const isOffline = !bot.is_alive;
                    const cardStyle = isOffline ? 'filter: grayscale(100%); opacity: 0.8;' : '';
                    const statusBadge = isOffline ? `<span class="badge bg-secondary ms-2">${t.bot_status_offline}</span>` : `<span class="badge bg-success ms-2">${t.bot_status_online}</span>`;
                    const timeLabel = isOffline ? t.card_status_offline_since : t.card_status_connected_at;
                    const platform = bot.platform || 'QQ';
                    let avatarUrl = `https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/robot.svg`;
                    let avatarBg = 'var(--bg-list-item)';
                    
                    if (platform.toUpperCase() === 'QQ') {
                        avatarUrl = `https://q1.qlogo.cn/g?b=qq&nk=${bot.self_id}&s=640`;
                    } else if (platform.toUpperCase().includes('TELEGRAM') || platform.toUpperCase() === 'TG') {
                        avatarUrl = `https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/telegram.svg`;
                        avatarBg = '#0088cc22';
                    } else if (platform.toUpperCase().includes('DISCORD')) {
                        avatarUrl = `https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/discord.svg`;
                        avatarBg = '#5865F222';
                    } else if (platform.toUpperCase().includes('WECHAT') || platform.toUpperCase().includes('WX')) {
                        avatarUrl = `https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/wechat.svg`;
                        avatarBg = '#07C16022';
                    } else if (platform.toUpperCase().includes('FEISHU') || platform.toUpperCase().includes('LARK')) {
                        avatarUrl = `https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/chat-dots.svg`;
                        avatarBg = '#3370ff22';
                    } else if (platform.toUpperCase().includes('DING')) {
                        avatarUrl = `https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/lightning-charge.svg`;
                        avatarBg = '#007FFF22';
                    }
                    
                    // Use proxy for external avatars
                    if (avatarUrl.startsWith('http')) {
                        avatarUrl = `/api/proxy/avatar?url=${encodeURIComponent(avatarUrl)}`;
                    }
                    
                    const platformBadge = `<span class="badge bg-info ms-1">${platform}</span>`;

                    if (botViewMode === 'compact') {
                         return `
                        <div class="col-sm-6 col-md-4 col-lg-3 col-xl-2 mb-3">
                            <div class="card p-2 h-100 shadow-sm" style="${cardStyle}">
                                <div class="d-flex align-items-center mb-2 ${isOffline ? '' : 'cursor-pointer'}" 
                                     ${isOffline ? '' : `onclick="setGlobalBot('${bot.self_id}')"`}
                                     ${isOffline ? '' : 'onmouseover="this.style.opacity=0.8" onmouseout="this.style.opacity=1"'}>
                                    <div class="rounded-circle d-flex align-items-center justify-content-center me-2 flex-shrink-0" style="width: 32px; height: 32px; overflow: hidden; background: ${avatarBg};">
                                        <img src="${avatarUrl}" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/robot.svg';this.style.padding='4px';">
                                    </div>
                                    <div class="overflow-hidden w-100">
                                        <div class="d-flex align-items-center">
                                            <div class="fw-bold text-truncate" title="${bot.nickname || bot.self_id}" style="font-size: 0.85rem;">${bot.nickname || bot.self_id}</div>
                                            ${isOffline ? '<span class="badge bg-secondary ms-1" style="font-size: 0.6em;">OFF</span>' : '<span class="badge bg-success ms-1" style="font-size: 0.6em;">ON</span>'}
                                        </div>
                                        <div class="text-muted text-truncate" style="font-size: 0.7rem;">${platform} | ${bot.self_id}</div>
                                    </div>
                                </div>
                                <div class="rounded p-1 mb-2 flex-grow-1" style="background-color: var(--bg-list-item); font-size: 0.75rem;">
                                     <div class="d-flex justify-content-between">
                                        <span class="text-muted">${t.card_label_groups}: ${bot.group_count || 0}</span>
                                        <span class="text-muted">${t.card_label_friends}: ${bot.friend_count || 0}</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted">${t.card_label_msgs}:</span>
                                        <span class="text-primary fw-bold">${bot.msg_count || 0}</span>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    }

                    return `
                        <div class="col-sm-12 col-md-6 col-lg-4 col-xl-4 col-xxl-3 mb-3">
                            <div class="card p-2 h-100 shadow-sm" style="${cardStyle}">
                                <div class="d-flex align-items-center mb-2 ${isOffline ? '' : 'cursor-pointer'}"
                                     ${isOffline ? '' : `onclick="setGlobalBot('${bot.self_id}')"`}
                                     ${isOffline ? '' : 'onmouseover="this.style.opacity=0.8" onmouseout="this.style.opacity=1"'}>
                                    <div class="rounded-circle d-flex align-items-center justify-content-center me-2 flex-shrink-0" style="width: 48px; height: 48px; overflow: hidden; background: ${avatarBg};">
                                        <img src="${avatarUrl}" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/robot.svg';this.style.padding='8px';">
                                    </div>
                                    <div class="overflow-hidden w-100">
                                        <div class="d-flex align-items-center">
                                            <div class="fw-bold text-truncate" title="${bot.nickname || bot.self_id}" style="font-size: 0.9rem;">${bot.nickname || bot.self_id}</div>
                                            ${statusBadge}
                                            ${platformBadge}
                                        </div>
                                        <div class="text-muted text-truncate" style="font-size: 0.7rem;">ID: ${bot.self_id}</div>
                                    </div>
                                </div>
                                <div class="rounded p-2 mb-2 flex-grow-1" style="background-color: var(--bg-list-item); font-size: 0.75rem;">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted">${t.card_label_groups}:</span>
                                        <span class="fw-bold text-primary">${bot.group_count || 0}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted">${t.card_label_friends}:</span>
                                        <span class="fw-bold text-success">${bot.friend_count || 0}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted">${t.card_label_msgs}:</span>
                                        <span><span class="fw-bold text-primary">${bot.msg_count || 0}</span> <span class="text-muted" style="font-size: 0.7em;">(${t.sort_today}:${bot.msg_count_today || 0})</span></span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted">${t.card_label_ip}:</span>
                                        <span class="text-truncate" style="max-width: 80px;" title="${bot.remote_addr}">${bot.remote_addr ? bot.remote_addr.split(':')[0] : 'N/A'}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted">${timeLabel}</span>
                                        <span title="${connDate.toLocaleString()}">${timeStr}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted">${t.card_label_protocol}:</span>
                                        <span class="fw-bold text-info">${platform}</span>
                                    </div>
                                    ${bot.owner ? `
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted">${t.card_label_owner}:</span>
                                        <span>${bot.owner}</span>
                                    </div>` : ''}
                                </div>
                            </div>
                        </div>
                    `}).join('');
            }
        }

        function fetchWorkers(showLoading = false) {
            if (!authToken) return;
            const t = translations[currentLang] || translations['zh-CN'];

            if (showLoading) {
                const container = document.getElementById('worker-list-container');
                if (container) {
                    container.innerHTML = `
                        <div class="col-12 text-center py-5">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="mt-2 text-muted">${t.loading || 'åŠ è½½ä¸­...'}</div>
                        </div>
                    `;
                }
            }

            fetchWithAuth('/api/workers')
                .then(r => r.json())
                .then(workers => {
                    currentWorkers = workers;
                    
                    // Update Badge
                    const badge = document.getElementById('badge-workers');
                    if (badge) badge.innerText = workers.length;

                    // Update Metrics
                    if (document.getElementById('metric-workers')) {
                        document.getElementById('metric-workers').innerText = workers.length;
                    }

                    renderWorkers();
                });
        }

        function filterWorkers(text) {
            workerFilterText = text.toLowerCase();
            renderWorkers();
        }

        function sortWorkers(field) {
            if (workerSortBy === field) {
                workerSortAsc = !workerSortAsc;
            } else {
                workerSortBy = field;
                workerSortAsc = true;
                if (field === 'time' || field === 'msg') workerSortAsc = false;
            }

            const t = translations[currentLang] || translations['zh-CN'];

            // Update UI
            ['addr', 'time', 'status', 'msg'].forEach(f => {
                const btn = document.getElementById(`btn-sort-worker-${f}`);
                if (f === workerSortBy) {
                    btn.classList.add('active');
                    let label = '';
                    switch(f) {
                        case 'addr': label = t.sort_address; break;
                        case 'time': label = t.sort_time; break;
                        case 'status': label = t.sort_status; break;
                        case 'msg': label = t.sort_processed; break;
                    }
                    btn.innerHTML = label + (workerSortAsc ? ' â†‘' : ' â†“');
                } else {
                    btn.classList.remove('active');
                    let label = '';
                    switch(f) {
                        case 'addr': label = t.sort_address; break;
                        case 'time': label = t.sort_time; break;
                        case 'status': label = t.sort_status; break;
                        case 'msg': label = t.sort_processed; break;
                    }
                    btn.innerHTML = label;
                }
            });

            renderWorkers();
        }

        function renderWorkers() {
            const container = document.getElementById('worker-list-container');
            let workers = currentWorkers.filter(w => {
                if (!workerFilterText) return true;
                return (w.remote_addr || '').includes(workerFilterText) || 
                       (w.status || '').toLowerCase().includes(workerFilterText);
            });

            // Auto switch to compact mode if many workers
            if (workers.length > 8 && workerViewMode === 'detail' && !window._workerViewModeManuallySet) {
                workerViewMode = 'compact';
                updateViewModeUI('worker', 'compact');
            }

            // Sort
            workers.sort((a, b) => {
                let res = 0;
                if (workerSortBy === 'addr') {
                    res = (a.remote_addr || '').localeCompare(b.remote_addr || '');
                } else if (workerSortBy === 'time') {
                    res = new Date(a.connected) - new Date(b.connected);
                } else if (workerSortBy === 'status') {
                    res = (a.status || '').localeCompare(b.status || '');
                } else if (workerSortBy === 'msg') {
                    res = (a.handled_count || 0) - (b.handled_count || 0);
                }
                return workerSortAsc ? res : -res;
            });

            const t = translations[currentLang] || translations['zh-CN'];
            if (workers.length === 0) {
                container.innerHTML = `<div class="col-12 text-center text-muted">${t.no_workers}</div>`;
                return;
            }
            container.innerHTML = workers.map(w => {
                const connDate = new Date(w.connected);
                const timeStr = timeAgo(w.connected);
                const addr = w.remote_addr || w.id || 'Unknown';
                const status = w.status || 'Online';
                const addrDisplay = addr.includes(':') ? addr.split(':')[0] : addr;
                
                if (workerViewMode === 'compact') {
                    return `
                    <div class="col-sm-6 col-md-6 col-lg-4 col-xl-4 col-xxl-3 mb-3">
                        <div class="card p-2 h-100 shadow-sm">
                            <div class="d-flex align-items-center mb-2 cursor-pointer" onmouseover="this.style.opacity=0.8" onmouseout="this.style.opacity=1">
                                <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-2 flex-shrink-0" style="width: 32px; height: 32px;">
                                    <i class="bi bi-gear-wide-connected fs-6"></i>
                                </div>
                                <div class="overflow-hidden w-100">
                                    <div class="fw-bold text-truncate" style="font-size: 0.85rem;">${t.worker_node_title}</div>
                                    <div class="text-muted text-truncate" style="font-size: 0.7rem;">${addrDisplay}</div>
                                </div>
                            </div>
                            <div class="bg-light rounded p-1 mb-2 flex-grow-1" style="font-size: 0.75rem;">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">${t.card_label_status}:</span>
                                    <span class="text-success">${status}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">${t.card_label_latency}:</span>
                                    <span class="text-info fw-bold">${w.avg_rtt || '0s'}</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">${t.card_label_processed}:</span>
                                    <span class="text-primary fw-bold">${w.handled_count || 0}</span>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }

                return `
                    <div class="col-sm-12 col-md-6 col-lg-6 col-xl-6 col-xxl-4 mb-3">
                        <div class="card p-2 h-100 shadow-sm">
                            <div class="d-flex align-items-center mb-2 cursor-pointer" onmouseover="this.style.opacity=0.8" onmouseout="this.style.opacity=1">
                                <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-2 flex-shrink-0" style="width: 36px; height: 36px;">
                                    <i class="bi bi-gear-wide-connected fs-5"></i>
                                </div>
                                <div class="overflow-hidden w-100">
                                    <div class="fw-bold text-truncate" style="font-size: 0.9rem;">${t.worker_node}</div>
                                    <div class="text-muted text-truncate" style="font-size: 0.7rem;">${t.worker_node_title}</div>
                                </div>
                            </div>
                            <div class="bg-light rounded p-2 mb-2 flex-grow-1" style="font-size: 0.75rem;">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">${t.card_label_ip}:</span>
                                    <span class="text-truncate" style="max-width: 80px;" title="${addr}">${addrDisplay}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">${t.card_label_connected}:</span>
                                    <span title="${connDate.toLocaleString()}">${timeStr}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">${t.card_label_status}:</span>
                                    <span class="text-success">${status}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">${t.card_label_latency}:</span>
                                    <span class="text-info fw-bold">${w.avg_rtt || '0s'}</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">${t.card_label_processed_msgs}:</span>
                                    <span class="text-primary fw-bold">${w.handled_count || 0}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `}).join('');
        }

        // --- Log Truncation & Interaction ---
        function renderLogMessage(message) {
            const MAX_LEN = 300;
            if (!message || message.length <= MAX_LEN) return message;
            
            // Simple escape to prevent breaking HTML structure
            // We assume message is mostly text. If it contains HTML tags, this simple truncation might break them.
            // For safety, we treat it as text for the truncated part, but we must be careful not to double escape if the original was HTML.
            // Given the existing code uses ${log.message} directly, we assume it's raw text or safe HTML.
            
            const shortMsg = message.substring(0, MAX_LEN) + '...';
            const t = translations[currentLang] || translations['zh-CN'];
            
            return `<span class="log-short" style="cursor:pointer; text-decoration:underline dotted; color: inherit;" onclick="toggleLogExpand(this)" title="${t.log_expand}">${shortMsg}</span>` + 
                   `<span class="log-full" style="display:none; cursor:pointer; color: inherit;" onclick="toggleLogExpand(this)" title="${t.log_collapse}">${message}</span>`;
        }

        function toggleLogExpand(el) {
            const parent = el.parentElement;
            const shortSpan = parent.querySelector('.log-short');
            const fullSpan = parent.querySelector('.log-full');
            
            // Pause refresh when clicked
            const autoRefreshFull = document.getElementById('auto-refresh-logs-full');
            if (autoRefreshFull) autoRefreshFull.checked = false;
            
            const autoRefreshWidget = document.getElementById('auto-refresh-logs');
            if (autoRefreshWidget) autoRefreshWidget.checked = false;

            if (el.classList.contains('log-short')) {
                shortSpan.style.display = 'none';
                fullSpan.style.display = 'inline';
            } else {
                shortSpan.style.display = 'inline';
                fullSpan.style.display = 'none';
            }
        }

        // --- Logs (Full Page) ---
        function fetchLogsFull() {
            if (!authToken) return;
            const t = translations[currentLang] || translations['zh-CN'];
            const container = document.getElementById('log-container-full');
            if (!container) return;

            // Show loading if container is empty or we want to show it
            if (!container.innerHTML || container.innerHTML.trim() === '') {
                container.innerHTML = `<div class="text-center py-5 text-muted"><div class="spinner-border spinner-border-sm me-2"></div>${t.loading || 'åŠ è½½ä¸­...'}</div>`;
            }

            const selector = document.getElementById('log-bot-selector-full');
            const botId = selector ? selector.value : '';

            fetchWithAuth(`/api/logs?bot_id=${botId}`)
                .then(r => r.json())
                .then(data => {
                    const logs = data.logs || [];
                    const container = document.getElementById('log-container-full');
                    if (!container) return;
                    
                    container.innerHTML = logs.map(log => `
                        <div class="log-entry">
                            <span class="log-time">[${log.time}]</span>
                            <span class="log-level-${log.level}">${log.level}</span>: 
                            ${renderLogMessage(log.message)}
                        </div>
                    `).join('');
                    // Scroll to bottom
                    container.scrollTop = container.scrollHeight;
                });
        }
        
        // Sync selectors
        function updateLogBotSelectorFull(bots) {
             const selector = document.getElementById('log-bot-selector-full');
             if (!selector) return;
             // Keep selection
             const current = selector.value;
             const t = translations[currentLang] || translations['zh-CN'];
             
             let html = `<option value="">${t.log_all}</option>`;
             html += `<option value="system">${t.log_system}</option>`;
             
             bots.forEach(b => {
                 const name = b.nickname || b.self_id;
                 const status = b.is_alive ? '' : ' (Offline)';
                 html += `<option value="${b.self_id}">${name} (${b.platform})${status}</option>`;
             });
             selector.innerHTML = html;
             selector.value = current;
        }

        // setInterval(() => {
        //     // Auto refresh full page logs - Disabled to prevent jumping, relying on WebSocket
        //     if (document.getElementById('tab-logs') && 
        //         document.getElementById('tab-logs').style.display !== 'none' && 
        //         document.getElementById('auto-refresh-logs-full').checked) {
        //         fetchLogsFull();
        //     }
        // }, 2000);

        // --- Logs (Widget) ---
        function fetchLogs() {
            if (!authToken) return;
            const t = translations[currentLang] || translations['zh-CN'];
            const container = document.getElementById('log-container');
            if (!container) return;

            // Show loading if container is empty
            if (!container.innerHTML || container.innerHTML.trim() === '') {
                container.innerHTML = `<div class="text-center py-4 text-muted small"><div class="spinner-border spinner-border-sm me-2" style="width: 1rem; height: 1rem;"></div>${t.loading || 'åŠ è½½ä¸­...'}</div>`;
            }

            const selector = document.getElementById('log-bot-selector');
            const botId = selector ? selector.value : '';

            fetchWithAuth(`/api/logs?bot_id=${botId}`)
                .then(r => r.json())
                .then(data => {
                    const logs = data.logs || [];
                    const container = document.getElementById('log-container');
                    container.innerHTML = logs.map(log => `
                        <div class="log-entry">
                            <span class="log-time">[${log.time}]</span>
                            <span class="log-level-${log.level}">${log.level}</span>: 
                            ${renderLogMessage(log.message)}
                        </div>
                    `).join('');
                    // Scroll to bottom
                    container.scrollTop = container.scrollHeight;
                });
        }
        setInterval(() => {
            if (document.getElementById('tab-logs').style.display !== 'none' && 
                document.getElementById('auto-refresh-logs').checked) {
                fetchLogs();
            }
        }, 2000);

        // --- Debug/Actions ---
        function sendAction() {
            let botId = document.getElementById('action-bot-id').value;
            if (!botId && currentBotId) {
                botId = currentBotId;
            }
            
            const action = document.getElementById('action-name').value;
            let params = {};
            try {
                params = JSON.parse(document.getElementById('action-params').value);
            } catch (e) {
                alert(translations[currentLang].alert_json_error);
                return;
            }

            fetchWithAuth('/api/action', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    bot_id: botId,
                    action: action,
                    params: params
                })
            })
            .then(r => r.json())
            .then(res => {
                document.getElementById('action-result').innerText = JSON.stringify(res, null, 2);
            })
            .catch(err => {
                document.getElementById('action-result').innerText = 'Error: ' + err;
            });
        }

        // --- WebSocket Subscriber ---
        let wsSubscriber = null;
        const pendingRequests = new Map(); // echo -> {resolve, reject, timeout}

        let wsReconnectAttempts = 0;
        const MAX_WS_RECONNECT_ATTEMPTS = 5; // å‡å°‘é‡è¿æ¬¡æ•°
        const WS_RECONNECT_DELAY = 5000; // å¢åŠ é‡è¿å»¶è¿Ÿåˆ°5ç§’
        
        function initWebSocket() {
            // é˜²æ­¢é‡å¤è¿æ¥
            if (wsSubscriber && wsSubscriber.readyState === WebSocket.CONNECTING) {
                console.log('WebSocketæ­£åœ¨è¿æ¥ä¸­...');
                return;
            }
            
            if (wsReconnectAttempts >= MAX_WS_RECONNECT_ATTEMPTS) {
                console.error('WebSocketé‡è¿æ¬¡æ•°è¿‡å¤šï¼Œåœæ­¢é‡è¿');
                const t = translations[currentLang] || translations['zh-CN'];
                document.getElementById('ws-status').className = 'badge bg-danger ms-2';
                document.getElementById('ws-status').innerText = t.status_error || 'è¿æ¥å¤±è´¥';
                addEventLog({type: 'system', message: 'WebSocketè¿æ¥å¤±è´¥æ¬¡æ•°è¿‡å¤šï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æœåŠ¡å™¨çŠ¶æ€'});
                return;
            }
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            // Use the same port as the current page and the correct path
            const wsPort = window.location.port ? `:${window.location.port}` : '';
            let wsUrl = `${protocol}//${window.location.hostname}${wsPort}/ws/subscriber?role=subscriber`;
            if (authToken) {
                wsUrl += `&token=${encodeURIComponent(authToken)}`;
            }
            
            try {
                wsSubscriber = new WebSocket(wsUrl);
                
                // è¿æ¥è¶…æ—¶å¤„ç†
                const connectTimeout = setTimeout(() => {
                    if (wsSubscriber && wsSubscriber.readyState === WebSocket.CONNECTING) {
                        console.warn('WebSocketè¿æ¥è¶…æ—¶');
                        wsSubscriber.close();
                    }
                }, 10000); // 10ç§’è¶…æ—¶
                
                wsSubscriber.onopen = () => {
                    clearTimeout(connectTimeout);
                    wsReconnectAttempts = 0; // é‡ç½®é‡è¿æ¬¡æ•°
                    const t = translations[currentLang] || translations['zh-CN'];
                    document.getElementById('ws-status').className = 'badge bg-success ms-2';
                    document.getElementById('ws-status').innerText = t.status_connected;
                    addEventLog({type: 'system', message: t.ws_connected || 'WebSocket è¿æ¥æˆåŠŸ'});
                    
                    // Refresh bots when connected
                    updateBots();
                };
                
                wsSubscriber.onerror = (error) => {
                    clearTimeout(connectTimeout);
                    const t = translations[currentLang] || translations['zh-CN'];
                    console.error('WebSocket error:', error);
                    document.getElementById('ws-status').className = 'badge bg-warning ms-2';
                    document.getElementById('ws-status').innerText = t.status_error || 'è¿æ¥é”™è¯¯';
                    addEventLog({type: 'system', message: t.ws_error || 'WebSocket è¿æ¥é”™è¯¯'});
                };
                
                wsSubscriber.onclose = () => {
                    clearTimeout(connectTimeout);
                    const t = translations[currentLang] || translations['zh-CN'];
                    document.getElementById('ws-status').className = 'badge bg-danger ms-2';
                    document.getElementById('ws-status').innerText = t.status_disconnected;
                    addEventLog({type: 'system', message: t.ws_disconnected_retry || 'WebSocket è¿æ¥æ–­å¼€ï¼Œ3ç§’åé‡è¿...'});
                    
                    // ç¡®ä¿æ¸…ç†å¹¶é‡è¿
                    if (wsSubscriber) {
                        wsSubscriber = null;
                    }
                    
                    wsReconnectAttempts++;
                    setTimeout(initWebSocket, WS_RECONNECT_DELAY);
                };

                wsSubscriber.onmessage = (evt) => {
                    try {
                        const data = JSON.parse(evt.data);
                        console.log("WS Recv:", data); // Debug Log
                        
                        if (data.type === 'routing_event') {
                            handleRoutingEvent(data);
                            return;
                        }

                        if (data.type === 'sync_state') {
                            handleSyncState(data);
                            return;
                        }

                        // Handle API Responses
                        if (data.echo && pendingRequests.has(data.echo)) {
                            const req = pendingRequests.get(data.echo);
                            clearTimeout(req.timeout);
                            pendingRequests.delete(data.echo);
                            req.resolve(data);
                            // Optional: Don't log API responses to event log to reduce noise
                            // return; 
                        }

                        // Auto-refresh bot list on connection/nickname update
                        if (data.echo === 'internal_get_login_info' || 
                            (data.post_type === 'meta_event' && data.meta_event_type === 'lifecycle')) {
                            setTimeout(updateBots, 500); // Wait a bit for state to settle
                        }

                        if (data.post_type === 'log') {
                            // Check filter
                            const selector = document.getElementById('log-bot-selector');
                            const filter = selector ? selector.value : '';
                            const log = data.data;
                            const selfId = data.self_id || '';
                            
                            // Auto-refresh bot list on client connection logs
                            if (log.message && log.message.includes('Client connected:')) {
                                setTimeout(updateBots, 1000); // Wait a bit longer for connection to settle
                            }

                            if (filter === '' || (filter === 'system' && !selfId) || filter === selfId) {
                                const container = document.getElementById('log-container');
                                if (container) {
                                    const div = document.createElement('div');
                                    div.className = 'log-entry';
                                    div.innerHTML = `<span class="log-time">[${log.time}]</span><span class="log-level-${log.level}">${log.level}</span>: ${renderLogMessage(log.message)}`;
                                    container.appendChild(div);
                                    if (container.children.length > 500) { // é™åˆ¶æ—¥å¿—æ¡ç›®æ•°é‡
                                        container.removeChild(container.firstChild);
                                    }
                                    if (document.getElementById('auto-refresh-logs').checked) {
                                        container.scrollTop = container.scrollHeight;
                                    }
                                }
                            }

                            // Full Page Log Update
                            const selectorFull = document.getElementById('log-bot-selector-full');
                            const filterFull = selectorFull ? selectorFull.value : '';
                            if (filterFull === '' || (filterFull === 'system' && !selfId) || filterFull === selfId) {
                                const containerFull = document.getElementById('log-container-full');
                                if (containerFull) {
                                    const div = document.createElement('div');
                                    div.className = 'log-entry';
                                    div.innerHTML = `<span class="log-time">[${log.time}]</span><span class="log-level-${log.level}">${log.level}</span>: ${renderLogMessage(log.message)}`;
                                    containerFull.appendChild(div);
                                    if (containerFull.children.length > 500) { // å‡å°‘æ—¥å¿—æ¡ç›®é™åˆ¶ï¼ŒèŠ‚çœå†…å­˜
                                        containerFull.removeChild(containerFull.firstChild);
                                    }
                                    if (document.getElementById('auto-refresh-logs-full').checked) {
                                        containerFull.scrollTop = containerFull.scrollHeight;
                                    }
                                }
                            }
                        }
                        addEventLog(data);
                    } catch (e) {
                        console.error('WS Parse Error', e);
                    }
                };
                
            } catch (error) {
                console.error('åˆ›å»ºWebSocketå¤±è´¥:', error);
                wsReconnectAttempts++;
                setTimeout(initWebSocket, WS_RECONNECT_DELAY);
            }
        }

        // --- API Helper ---
        async function callBotApi(action, params = {}) {
            if (!currentBotId) {
                const selector = document.getElementById('global-bot-selector');
                if (selector.value) {
                    currentBotId = selector.value;
                } else {
                    const t = translations[currentLang] || translations['zh-CN'];
                    throw new Error(t.alert_select_bot_first);
                }
            }

            const res = await fetchWithAuth('/api/action', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    bot_id: currentBotId,
                    action: action,
                    params: params
                })
            });
            
            if (res.status === 401) {
                localStorage.removeItem('wxbot_token');
                location.reload();
                throw new Error("Unauthorized");
            }

            const result = await res.json();
            if (result.error) throw new Error(result.error);
            if (!result.echo) return result; 

            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    pendingRequests.delete(result.echo);
                    reject(new Error("Request timed out (30s)"));
                }, 30000);
                
                pendingRequests.set(result.echo, { resolve, reject, timeout });
            });
        }

        // --- Global Bot Selector ---
        function updateBotSelectorUI(id) {
            const selector = document.getElementById('global-bot-selector');
            selector.value = id;
            const t = translations[currentLang] || translations['zh-CN'];
            
            const bot = currentBots.find(b => b.self_id == id);
            if (bot) {
                const platform = bot.platform || 'QQ';
                let avatarUrl = `https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/robot.svg`;
                if (platform === 'QQ') {
                    avatarUrl = `https://q1.qlogo.cn/g?b=qq&nk=${bot.self_id}&s=100`;
                }
                
                const statusBadge = bot.is_alive 
                    ? `<span class="badge bg-success ms-1" style="font-size: 0.6em; vertical-align: middle;">${t.status_online}</span>` 
                    : `<span class="badge bg-secondary ms-1" style="font-size: 0.6em; vertical-align: middle;">${t.status_offline}</span>`;
                
                const html = `
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle d-flex align-items-center justify-content-center me-2 flex-shrink-0" style="width: 28px; height: 28px; overflow: hidden; background: #f0f0f0;">
                            <img src="${avatarUrl}" alt="" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <div class="overflow-hidden text-start">
                            <div class="fw-bold text-truncate" style="font-size: 0.85rem; line-height: 1.2;">
                                ${bot.nickname || bot.self_id}
                                ${statusBadge}
                            </div>
                            <div class="text-muted text-truncate" style="font-size: 0.7rem; line-height: 1;">${bot.self_id}</div>
                        </div>
                    </div>
                `;
                document.getElementById('global-bot-selected-content').innerHTML = html;
            }
        }

        function selectBotFromDropdown(id) {
            updateBotSelectorUI(id);
            onBotChange();
        }

        function onBotChange() {
            currentBotId = document.getElementById('global-bot-selector').value;
            
            const t = translations[currentLang] || translations['zh-CN'];
            const loadingText = `<div class="text-center p-4 text-muted">${t.switching_bot}</div>`;

            // Clear group view
            document.getElementById('group-list').innerHTML = loadingText;
            document.getElementById('group-detail-content').style.setProperty('display', 'none', 'important');
            document.getElementById('group-detail-empty').style.display = 'block';
            
            // Clear friend view
            document.getElementById('friend-list').innerHTML = loadingText;
            document.getElementById('friend-detail-content').style.setProperty('display', 'none', 'important');
            document.getElementById('friend-detail-empty').style.display = 'block';
            
            currentGroups = [];
            currentFriends = [];
            
            // Auto refresh current tab
            setTimeout(refreshCurrentTabList, 500);
        }

        function setGlobalBot(id) {
            selectBotFromDropdown(id);
            showTab('groups'); // Jump to groups tab
        }

        function refreshCurrentTabList() {
             const activeTab = document.querySelector('#relation-tabs .nav-link.active');
             if (activeTab && activeTab.id === 'tab-friends-list-tab') {
                 refreshFriendList();
             } else {
                 refreshGroupList();
             }
        }

        function ensureFriendListLoaded() {
            if (currentFriends.length === 0) {
                refreshFriendList();
            }
        }

        // --- Friend Management ---
        let currentFriends = [];
        let currentFriendId = 0;
        let friendSortBy = 'name'; // name, id
        let friendSortAsc = true;

        async function refreshFriendList() {
            const listEl = document.getElementById('friend-list');
            listEl.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary"></div></div>';
            
            try {
                // Fetch from new contacts API with refresh
                const url = `/api/contacts?bot_id=${encodeURIComponent(currentBotId)}&refresh=true`;
                const response = await fetchWithAuth(url);
                const text = await response.text();
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${text}`);
                }
                let contacts = [];
                try {
                    contacts = JSON.parse(text);
                    if (!Array.isArray(contacts)) contacts = [];
                } catch (e) {
                    console.error("Failed to parse contacts JSON:", e, "Raw text:", text);
                    throw new Error("JSON è§£æé”™è¯¯: " + e.message);
                }
                
                // Filter by current Bot and type private
                const friends = contacts.filter(c => c && c.bot_id === currentBotId && c.type === 'private');
                
                currentFriends = friends;
                renderFriends(friends);
                document.getElementById('friend-count').innerText = `å…± ${friends.length} ä¸ªå¥½å‹`;
            } catch (e) {
                listEl.innerHTML = `<div class="text-center p-4 text-danger">åŠ è½½å¤±è´¥: ${e.message}</div>`;
            }
        }

        function renderFriends(friends = null) {
            if (!friends) friends = currentFriends;
            
            // Filter
            const keyword = (document.getElementById('friend-search').value || '').toLowerCase();
            let filtered = (friends || []).filter(f => {
                if (!f) return false;
                const name = (f.name || '').toLowerCase();
                const id = (f.id || '').toString();
                return name.includes(keyword) || id.includes(keyword);
            });
            
            // Sort
            filtered.sort((a, b) => {
                let res = 0;
                if (friendSortBy === 'name') {
                    const nameA = a ? (a.name || '') : '';
                    const nameB = b ? (b.name || '') : '';
                    res = nameA.localeCompare(nameB, 'zh');
                } else if (friendSortBy === 'id') {
                    res = String(a ? a.id : '').localeCompare(String(b ? b.id : ''));
                }
                return friendSortAsc ? res : -res;
            });
            
            const listEl = document.getElementById('friend-list');
            if (filtered.length === 0) {
                listEl.innerHTML = '<div class="text-center p-4 text-muted">æœªæ‰¾åˆ°å¥½å‹</div>';
                return;
            }

            listEl.innerHTML = filtered.map(f => {
                const name = f.name || 'Unknown';
                const id = f.id;
                const avatar = `https://q1.qlogo.cn/g?b=qq&nk=${id}&s=100`;
                const safeName = (name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                
                return `
                <button class="list-group-item list-group-item-action ${id == currentFriendId ? 'active' : ''}" onclick="selectFriend('${id}', '${safeName}')">
                    <div class="d-flex w-100 align-items-center">
                         <div class="rounded-circle me-2" style="width: 32px; height: 32px; overflow: hidden; background: #f0f0f0;">
                            <img src="${avatar}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/person.svg'">
                        </div>
                        <div style="overflow: hidden;">
                            <h6 class="mb-0 text-truncate" style="max-width: 150px;">${name}</h6>
                            <small class="${id == currentFriendId ? 'text-light' : 'text-muted'}">${id}</small>
                        </div>
                    </div>
                </button>
                `;
            }).join('');
        }

        function filterFriends() {
            renderFriends();
        }

        function sortFriends(by) {
            if (friendSortBy === by) {
                friendSortAsc = !friendSortAsc;
            } else {
                friendSortBy = by;
                friendSortAsc = true;
            }
            
            // Update buttons
            document.querySelectorAll('[id^="btn-sort-friend-"]').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-sort-friend-${by}`).classList.add('active');
            
            renderFriends();
        }

        function selectFriend(id, name) {
            currentFriendId = id;
            document.getElementById('current-friend-name').innerText = name;
            document.getElementById('current-friend-id').innerText = id;
            
            // Show details
            document.getElementById('friend-detail-empty').style.display = 'none';
            document.getElementById('friend-detail-content').style.setProperty('display', 'flex', 'important');
            
            // Re-render list to highlight active
            renderFriends();
        }

        async function sendFriendMsg() {
            const text = document.getElementById('friend-msg-input').value;
            if (!text.trim()) return;
            
            try {
                await callBotApi('send_private_msg', {
                    user_id: currentFriendId,
                    message: text
                });
                alert('å‘é€æˆåŠŸ');
                document.getElementById('friend-msg-input').value = '';
                addEventLog({type: 'message', message: `å‘é€ç»™å¥½å‹(${currentFriendId}): ${text}`});
            } catch (e) {
                alert('å‘é€å¤±è´¥: ' + e.message);
            }
        }

        // --- System Details View Logic ---
        let detailChartInstance = null;
        let detailData = {
            cpu: [],
            mem: [],
            msg: [],
            disk: [],
            net: []
        };
        let currentDetailType = 'cpu';
        let currentDetailTimeRange = '1h';

        function showSystemDetails(type) {
            showTab('#view-system-details');
            currentDetailType = type || 'cpu';
            
            // Set active tab
            document.querySelectorAll('#system-detail-tabs .nav-link').forEach(el => el.classList.remove('active'));
            document.querySelector(`#system-detail-tabs .nav-link[onclick*="'${currentDetailType}'"]`).classList.add('active');

            updateDetailChart();
            fetchSystemStats(true); // Fetch immediately with details
        }

        function switchDetailTab(type, event) {
            if (event) event.preventDefault();
            currentDetailType = type;
            
            document.querySelectorAll('#system-detail-tabs .nav-link').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');

            updateDetailChart();
        }

        function updateDetailTimeRange(range) {
            currentDetailTimeRange = range;
            document.querySelectorAll('#tab-view-system-details .btn-group .btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`#tab-view-system-details .btn-group .btn[onclick*="'${range}'"]`).classList.add('active');
            
            // For now, we only have session data, so we can't really change the data source yet,
            // but we can adjust the chart X-axis scaling or label if we had timestamps.
            // Since we only have "last 1800 points (1 hour)", we will just show what we have.
            // In a real implementation, we would fetch historical data here.
            
            updateDetailChart();
        }

        function updateDetailChart() {
            const ctx = document.getElementById('detailChart').getContext('2d');
            
            if (detailChartInstance) {
                detailChartInstance.destroy();
            }

            // Fix: Retrieve data from global stats (server trend) or fallback to charts
            let cpuDataBuffer = [];
            let memDataBuffer = [];
            let recvDataBuffer = [];
            let sentDataBuffer = [];
            let msgDataBuffer = [];
            let netSentTrend = [];
            let netRecvTrend = [];
            let sourceIsRaw = false;

            if (window.latestStats) {
                cpuDataBuffer = window.latestStats.cpu_trend || [];
                memDataBuffer = window.latestStats.mem_trend || [];
                // Msg trends in latestStats are raw counts per interval
                msgDataBuffer = window.latestStats.msg_trend || [];
                sentDataBuffer = window.latestStats.sent_trend || [];
                recvDataBuffer = window.latestStats.recv_trend || [];
                netSentTrend = window.latestStats.net_sent_trend || [];
                netRecvTrend = window.latestStats.net_recv_trend || [];
                sourceIsRaw = true;
            } else {
                cpuDataBuffer = cpuChart ? cpuChart.data.datasets[0].data : [];
                memDataBuffer = memChart ? memChart.data.datasets[0].data : [];
                recvDataBuffer = msgChart ? msgChart.data.datasets[0].data : [];
                sentDataBuffer = msgChart ? msgChart.data.datasets[1].data : [];
                msgDataBuffer = msgChart ? msgChart.data.datasets[2].data : [];
            }

            let labels = [];
            let datasets = [];
            let type = 'line';
            let options = {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                plugins: {
                    legend: { display: true },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    x: { display: true, grid: { display: false } },
                    y: { display: true, beginAtZero: true }
                }
            };

            // Common Labels (Just index for now, should be time)
            // We use global stats buffers
            
            if (currentDetailType === 'cpu') {
                labels = Array.from({length: cpuDataBuffer.length}, (_, i) => i);
                datasets = [{
                    label: 'CPU Usage (%)',
                    data: cpuDataBuffer,
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    fill: true,
                    tension: 0.4
                }];
                options.scales.y.max = 100;
            } else if (currentDetailType === 'mem') {
                labels = Array.from({length: memDataBuffer.length}, (_, i) => i);
                // Convert to GB
                // If sourceIsRaw (from server), unit is Bytes -> /1024/1024/1024
                // If from Chart (memChart), unit is MB -> /1024
                const dataGB = memDataBuffer.map(v => sourceIsRaw ? (v / 1024 / 1024 / 1024) : (v / 1024));
                datasets = [{
                    label: 'Memory Usage (GB)',
                    data: dataGB,
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    fill: true,
                    tension: 0.4
                }];
            } else if (currentDetailType === 'msg') {
                labels = Array.from({length: msgDataBuffer.length}, (_, i) => i);
                datasets = [
                    {
                        label: 'Total Messages',
                        data: msgDataBuffer,
                        borderColor: '#198754',
                        backgroundColor: 'rgba(25, 135, 84, 0.1)',
                        fill: true
                    },
                    {
                        label: 'Sent Messages',
                        data: sentDataBuffer,
                        borderColor: '#0dcaf0',
                        borderDash: [5, 5],
                        fill: false
                    },
                    {
                        label: 'Recv Messages',
                        data: recvDataBuffer,
                        borderColor: '#ffc107',
                        borderDash: [2, 2],
                        fill: false
                    }
                ];
            } else if (currentDetailType === 'disk') {
                type = 'bar';
                // Disk data comes from latest stats fetch, not trend
                // We need to store it globally or fetch it.
                // For now, use global `lastSystemStats` if available
                if (window.lastSystemStats && window.lastSystemStats.disk_usage) {
                    labels = window.lastSystemStats.disk_usage.map(d => d.path);
                    const dataUsed = window.lastSystemStats.disk_usage.map(d => (d.used / 1024 / 1024 / 1024).toFixed(2));
                    const dataFree = window.lastSystemStats.disk_usage.map(d => (d.free / 1024 / 1024 / 1024).toFixed(2));
                    
                    datasets = [
                        {
                            label: 'Used (GB)',
                            data: dataUsed,
                            backgroundColor: '#dc3545'
                        },
                        {
                            label: 'Free (GB)',
                            data: dataFree,
                            backgroundColor: '#198754'
                        }
                    ];
                    options.scales.x = { stacked: true };
                    options.scales.y = { stacked: true, beginAtZero: true };
                } else {
                    labels = ['Loading...'];
                    datasets = [{label: 'No Data', data: []}];
                }
            } else if (currentDetailType === 'net') {
                 // Net IO Trend - showing throughput (diff between samples)
                 if (netSentTrend.length > 1) {
                     labels = Array.from({length: netSentTrend.length - 1}, (_, i) => i);
                     const sentThroughput = [];
                     const recvThroughput = [];
                     
                     for (let i = 1; i < netSentTrend.length; i++) {
                         // Bytes -> KB/s (assuming 5s interval)
                         const s = (netSentTrend[i] - netSentTrend[i-1]) / 1024 / 5;
                         const r = (netRecvTrend[i] - netRecvTrend[i-1]) / 1024 / 5;
                         sentThroughput.push(s.toFixed(2));
                         recvThroughput.push(r.toFixed(2));
                     }

                     datasets = [
                         {
                             label: 'Sent (KB/s)',
                             data: sentThroughput,
                             borderColor: '#0dcaf0',
                             backgroundColor: 'rgba(13, 202, 240, 0.1)',
                             fill: true,
                             tension: 0.4
                         },
                         {
                             label: 'Recv (KB/s)',
                             data: recvThroughput,
                             borderColor: '#ffc107',
                             backgroundColor: 'rgba(255, 193, 7, 0.1)',
                             fill: true,
                             tension: 0.4
                         }
                     ];
                 } else if (window.lastSystemStats && window.lastSystemStats.net_io && window.lastSystemStats.net_io.length > 0) {
                     type = 'bar';
                     const io = window.lastSystemStats.net_io[0];
                     labels = ['Total Sent', 'Total Recv'];
                     datasets = [{
                         label: 'Bytes (MB)',
                         data: [
                             (io.bytesSent / 1024 / 1024).toFixed(2), 
                             (io.bytesRecv / 1024 / 1024).toFixed(2)
                         ],
                         backgroundColor: ['#0dcaf0', '#ffc107']
                     }];
                 } else {
                    labels = ['Loading...'];
                    datasets = [{label: 'No Data', data: []}];
                 }
            }

            detailChartInstance = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: options
            });
            
            // Render Hardware Info Grid
            renderHardwareGrid();
        }

        function renderHardwareGrid() {
            const container = document.getElementById('hardware-info-grid');
            if (!window.lastSystemStats) return;
            
            const s = window.lastSystemStats;
            let html = '';
            
            // Host Info
            if (s.host_info) {
                 html += `
                    <div class="col-12 mb-3">
                        <div class="card h-100">
                            <div class="card-header fw-bold">ä¸»æœºä¿¡æ¯</div>
                            <div class="card-body small">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div><span class="text-muted">Hostname:</span> ${s.host_info.hostname}</div>
                                        <div><span class="text-muted">OS:</span> ${s.host_info.platform} ${s.host_info.platformVersion}</div>
                                        <div><span class="text-muted">Kernel:</span> ${s.host_info.kernelVersion}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <div><span class="text-muted">Arch:</span> ${s.host_info.kernelArch}</div>
                                        <div><span class="text-muted">Uptime:</span> ${(s.host_info.uptime / 3600).toFixed(1)} Hours</div>
                                        <div><span class="text-muted">Boot Time:</span> ${new Date(s.host_info.bootTime * 1000).toLocaleString()}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }
            
            // Disk Info
            if (s.disk_usage) {
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header fw-bold">ç£ç›˜ä½¿ç”¨</div>
                            <div class="card-body small" style="overflow-y: auto; max-height: 200px;">
                                ${s.disk_usage.map(d => `
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between">
                                            <span>${d.path}</span>
                                            <span>${d.usedPercent.toFixed(1)}%</span>
                                        </div>
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar bg-${d.usedPercent > 90 ? 'danger' : (d.usedPercent > 70 ? 'warning' : 'success')}" 
                                                 role="progressbar" style="width: ${d.usedPercent}%"></div>
                                        </div>
                                        <div class="text-muted" style="font-size: 0.8em;">
                                            ${(d.used/1024/1024/1024).toFixed(1)} GB / ${(d.total/1024/1024/1024).toFixed(1)} GB
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>`;
            }
            
            // Net Info
            if (s.net_interfaces) {
                 html += `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header fw-bold">ç½‘ç»œæ¥å£</div>
                            <div class="card-body small" style="overflow-y: auto; max-height: 200px;">
                                ${s.net_interfaces.map(i => `
                                    <div class="mb-2 border-bottom pb-1">
                                        <div class="fw-bold text-primary">${i.name}</div>
                                        ${i.addrs.map(a => `<div>${a.addr}</div>`).join('')}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>`;
            }
            
            container.innerHTML = html;
        }

        // --- Group Management ---
        let currentGroups = [];
        let currentGroupId = 0;
        let groupSortBy = 'name'; // name, count, id
        let groupSortAsc = true;

        let currentMembers = [];
        let memberSortBy = 'card'; // card, id, role, time
        let memberSortAsc = true;

        async function refreshGroupList() {
            const listEl = document.getElementById('group-list');
            listEl.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary"></div></div>';
            
            try {
                // Fetch from new contacts API with refresh
                const url = `/api/contacts?bot_id=${encodeURIComponent(currentBotId)}&refresh=true`;
                const response = await fetchWithAuth(url);
                const text = await response.text();
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${text}`);
                }
                let contacts = [];
                try {
                    contacts = JSON.parse(text);
                    if (!Array.isArray(contacts)) contacts = [];
                } catch (e) {
                    console.error("Failed to parse contacts JSON:", e, "Raw text:", text);
                    throw new Error("JSON è§£æé”™è¯¯: " + e.message);
                }
                
                // Filter by current Bot and type group
                const filtered = contacts.filter(c => c && c.bot_id === currentBotId && c.type === 'group');
                
                currentGroups = filtered;
                renderGroups(filtered);
                document.getElementById('group-count').innerText = `å…± ${filtered.length} ä¸ªä¼šè¯`;
            } catch (e) {
                listEl.innerHTML = `<div class="text-center p-4 text-danger">è·å–å¤±è´¥: ${e.message}</div>`;
            }
        }

        function sortGroups(field) {
            if (groupSortBy === field) {
                groupSortAsc = !groupSortAsc;
            } else {
                groupSortBy = field;
                groupSortAsc = true; // Default asc for new field
                if (field === 'count' || field === 'msg_today') groupSortAsc = false; // Default desc for count/msg
            }
            
            const t = translations[currentLang] || translations['zh-CN'];

            // Update UI buttons
            ['name', 'count', 'id', 'msg_today'].forEach(f => {
                const btn = document.getElementById(`btn-sort-group-${f}`);
                if (f === groupSortBy) {
                    btn.classList.add('active');
                    let label = '';
                    switch(f) {
                        case 'name': label = t.sort_name; break;
                        case 'count': label = t.sort_count; break;
                        case 'id': label = t.sort_id; break;
                        case 'msg_today': label = t.sort_today; break;
                    }
                    btn.innerHTML = label + (groupSortAsc ? ' â†‘' : ' â†“');
                } else {
                    btn.classList.remove('active');
                    let label = '';
                    switch(f) {
                        case 'name': label = t.sort_name; break;
                        case 'count': label = t.sort_count; break;
                        case 'id': label = t.sort_id; break;
                        case 'msg_today': label = t.sort_today; break;
                    }
                    btn.innerHTML = label;
                }
            });

            filterGroups(); // Re-render with sort
        }

        function renderGroups(groups) {
            const listEl = document.getElementById('group-list');
            const t = translations[currentLang] || translations['zh-CN'];
            if (!groups || groups.length === 0) {
                listEl.innerHTML = `<div class="text-center p-4 text-muted">${t.no_groups || 'æœªæ‰¾åˆ°ä¼šè¯'}</div>`;
                return;
            }

            // Sort logic
            const sortedGroups = [...groups].sort((a, b) => {
                let res = 0;
                if (!a || !b) return 0;
                if (groupSortBy === 'name') {
                    res = (a.name || '').localeCompare(b.name || '', 'zh-CN');
                } else if (groupSortBy === 'count') {
                    res = 0; // Not available in session
                } else if (groupSortBy === 'id') {
                    res = String(a.id || '').localeCompare(String(b.id || ''));
                } else if (groupSortBy === 'msg_today') {
                    const statA = latestChatStats.group_stats_today ? (latestChatStats.group_stats_today[a.id] || 0) : 0;
                    const statB = latestChatStats.group_stats_today ? (latestChatStats.group_stats_today[b.id] || 0) : 0;
                    res = statA - statB;
                }
                return groupSortAsc ? res : -res;
            });
            
            listEl.innerHTML = sortedGroups.map(g => {
                const todayMsg = latestChatStats.group_stats_today ? (latestChatStats.group_stats_today[g.id] || 0) : 0;
                const totalMsg = latestChatStats.group_stats ? (latestChatStats.group_stats[g.id] || 0) : 0;
                
                let typeBadge = '<span class="badge bg-secondary" style="font-size: 0.6rem;">ç¾¤</span>';
                if (g.type === 'private') {
                    typeBadge = '<span class="badge bg-success" style="font-size: 0.6rem;">ç§</span>';
                } else if (g.type === 'guild') {
                    typeBadge = '<span class="badge bg-info" style="font-size: 0.6rem;">é¢‘</span>';
                }

                // Avatar URL logic
                let avatarUrl = '';
                if (g.type === 'group') {
                    avatarUrl = `https://p.qlogo.cn/gh/${g.id}/${g.id}/640/`;
                } else if (g.type === 'private') {
                    avatarUrl = `https://q1.qlogo.cn/g?b=qq&nk=${g.id}&s=100`;
                } else {
                    avatarUrl = 'https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/diagram-3.svg';
                }

                const safeName = (g.name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                return `
                <button class="list-group-item list-group-item-action ${g.id == currentGroupId ? 'active' : ''}" onclick="selectGroup('${g.id}', '${safeName}', '${g.type}', '${g.guild_id || ''}')">
                    <div class="d-flex w-100 align-items-center">
                        <div class="rounded-circle me-2 flex-shrink-0" style="width: 40px; height: 40px; overflow: hidden; background: #f0f0f0;">
                             <img src="${avatarUrl}" alt="${g.type}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/${g.type === 'private' ? 'person' : 'people'}.svg';this.style.padding='8px';">
                        </div>
                        <div class="flex-grow-1 overflow-hidden">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1 text-truncate" style="max-width: 140px;">${g.name || 'Unknown'}</h6>
                                <div>
                                    ${typeBadge}
                                </div>
                            </div>
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <small class="${g.id == currentGroupId ? 'text-light' : 'text-muted'}">ID: ${g.id}</small>
                                <span class="badge ${g.id == currentGroupId ? 'bg-light text-dark' : 'bg-secondary'} rounded-pill" title="ä»Šæ—¥: ${todayMsg} / æ€»è®¡: ${totalMsg}">${todayMsg}</span>
                            </div>
                        </div>
                    </div>
                </button>
            `}).join('');
        }

        function filterGroups() {
            const keyword = (document.getElementById('group-search').value || '').toLowerCase();
            const filtered = currentGroups.filter(g => 
                (g.name || '').toLowerCase().includes(keyword) || 
                String(g.id || '').includes(keyword)
            );
            renderGroups(filtered);
        }

        let currentContactType = 'group';
        let currentGuildId = '';

        async function selectGroup(id, name, type = 'group', guildId = '') {
            currentGroupId = id;
            currentContactType = type;
            currentGuildId = guildId;

            document.getElementById('current-group-name').innerText = name;
            document.getElementById('current-group-id').innerText = id;
            
            // Update Stats
            const todayMsg = latestChatStats.group_stats_today ? (latestChatStats.group_stats_today[id] || 0) : 0;
            const totalMsg = latestChatStats.group_stats ? (latestChatStats.group_stats[id] || 0) : 0;
            document.getElementById('current-group-stats').innerText = `ä»Šæ—¥: ${todayMsg} / æ€»è®¡: ${totalMsg}`;

            // Update Avatar
            const avatarEl = document.getElementById('current-group-avatar');
            if (type === 'group') {
                avatarEl.src = `https://p.qlogo.cn/gh/${id}/${id}/640/`;
            } else if (type === 'private') {
                avatarEl.src = `https://q1.qlogo.cn/g?b=qq&nk=${id}&s=100`;
            } else {
                 avatarEl.src = 'https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/diagram-3.svg';
            }
            avatarEl.style.display = 'block';
            avatarEl.onerror = function() {
                this.src = 'https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/people.svg';
                this.style.padding = '4px';
            };
            
            document.getElementById('group-detail-empty').style.display = 'none';
            document.getElementById('group-detail-content').style.setProperty('display', 'flex', 'important');
            
            // Highlight selection
            renderGroups(currentGroups.filter(g => {
                const keyword = (document.getElementById('group-search').value || '').toLowerCase();
                return (g.name || '').toLowerCase().includes(keyword) || String(g.id || '').includes(keyword);
            }));

            // Handle View switching
            const membersTabBtn = document.getElementById('members-tab');
            const actionsTabBtn = document.getElementById('actions-tab');
            
            if (type === 'group') {
                membersTabBtn.style.display = 'block';
                // Switch to members tab if not already active or if we just hid it previously
                const bsTab = new bootstrap.Tab(membersTabBtn);
                bsTab.show();
                loadGroupMembers(id);
            } else {
                membersTabBtn.style.display = 'none';
                // Switch to actions tab
                const bsTab = new bootstrap.Tab(actionsTabBtn);
                bsTab.show();
            }
        }

        async function loadGroupMembers(groupId) {
            const tbody = document.getElementById('member-list-body');
            tbody.innerHTML = '<tr><td colspan="4" class="text-center">åŠ è½½ä¸­...</td></tr>';
            
            try {
                const response = await callBotApi('get_group_member_list', { group_id: groupId });
                currentMembers = response.data || [];
                renderMembers();
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">åŠ è½½å¤±è´¥: ${e.message}</td></tr>`;
            }
        }

        function sortMembers(field) {
            if (memberSortBy === field) {
                memberSortAsc = !memberSortAsc;
            } else {
                memberSortBy = field;
                memberSortAsc = true;
                if (field === 'time' || field === 'msg_today') memberSortAsc = false; // Default desc for time/msg
            }

            // Update Icons
            ['card', 'id', 'role', 'time', 'msg_today'].forEach(f => {
                const icon = document.getElementById(`sort-icon-${f}`);
                if (f === memberSortBy) {
                    icon.className = memberSortAsc ? 'bi bi-sort-alpha-down' : 'bi bi-sort-alpha-down-alt';
                    if (f === 'id' || f === 'time' || f === 'msg_today') icon.className = memberSortAsc ? 'bi bi-sort-numeric-down' : 'bi bi-sort-numeric-down-alt';
                } else {
                    icon.className = 'bi';
                }
            });

            renderMembers();
        }

        function renderMembers() {
            const tbody = document.getElementById('member-list-body');
            const searchInput = document.getElementById('member-search');
            const keyword = searchInput ? searchInput.value.toLowerCase() : '';
            const t = translations[currentLang] || translations['zh-CN'];

            if (!currentMembers || currentMembers.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center">${t.no_members}</td></tr>`;
                return;
            }

            // Filter
            const filteredMembers = currentMembers.filter(m => {
                if (!keyword) return true;
                const card = (m.card || '').toLowerCase();
                const nick = (m.nickname || '').toLowerCase();
                const uid = String(m.user_id);
                return card.includes(keyword) || nick.includes(keyword) || uid.includes(keyword);
            });
            
            if (filteredMembers.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="6" class="text-center">${t.no_match_members}</td></tr>`;
                 return;
            }

            // Sort
            const sortedMembers = [...filteredMembers].sort((a, b) => {
                let res = 0;
                if (memberSortBy === 'card') {
                    const nameA = a.card || a.nickname || '';
                    const nameB = b.card || b.nickname || '';
                    res = nameA.localeCompare(nameB, 'zh-CN');
                } else if (memberSortBy === 'id') {
                    res = a.user_id - b.user_id;
                } else if (memberSortBy === 'role') {
                    const roleWeight = { 'owner': 3, 'admin': 2, 'member': 1 };
                    res = (roleWeight[a.role] || 0) - (roleWeight[b.role] || 0);
                } else if (memberSortBy === 'time') {
                    res = (a.last_sent_time || 0) - (b.last_sent_time || 0);
                } else if (memberSortBy === 'msg_today') {
                    const statA = latestChatStats.user_stats_today ? (latestChatStats.user_stats_today[a.user_id] || 0) : 0;
                    const statB = latestChatStats.user_stats_today ? (latestChatStats.user_stats_today[b.user_id] || 0) : 0;
                    res = statA - statB;
                }
                return memberSortAsc ? res : -res;
            });

            tbody.innerHTML = sortedMembers.map(m => {
                const todayMsg = latestChatStats.user_stats_today ? (latestChatStats.user_stats_today[m.user_id] || 0) : 0;
                const totalMsg = latestChatStats.user_stats ? (latestChatStats.user_stats[m.user_id] || 0) : 0;
                
                const roleKey = 'role_' + m.role;
                const roleText = t[roleKey] || m.role;
                const statsTooltip = t.stats_title_tooltip.replace('{today}', todayMsg).replace('{total}', totalMsg);
                const safeName = (m.card || m.nickname || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');

                return `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <img src="https://q1.qlogo.cn/g?b=qq&nk=${m.user_id}&s=100" 
                                 class="rounded-circle me-2" 
                                 width="32" height="32" 
                                 onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(m.card || m.nickname)}&background=random'"
                                 alt="Avatar">
                            <div>
                                <div>${m.card || m.nickname}</div>
                                ${m.card && m.card !== m.nickname ? `<small class="text-muted">${m.nickname}</small>` : ''}
                            </div>
                        </div>
                    </td>
                    <td>${m.user_id}</td>
                    <td>
                        <span class="badge bg-${m.role === 'owner' ? 'warning' : (m.role === 'admin' ? 'success' : 'secondary')}">
                            ${roleText}
                        </span>
                    </td>
                    <td>
                        <div class="d-flex flex-column" title="${statsTooltip}">
                            <span class="badge bg-primary rounded-pill mb-1" style="width: fit-content;">${todayMsg}</span>
                            <small class="text-muted">${t.stats_total}${totalMsg}</small>
                        </div>
                    </td>
                    <td>
                        <small class="text-muted">${m.last_sent_time ? new Date(m.last_sent_time * 1000).toLocaleString() : '-'}</small>
                    </td>
                    <td>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                ${t.action_ops}
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="setCard(${currentGroupId}, ${m.user_id}, '${safeName}')">${t.action_set_card}</a></li>
                                <li><a class="dropdown-item" href="#" onclick="banMember(${currentGroupId}, ${m.user_id})">${t.action_ban}</a></li>
                                <li><a class="dropdown-item" href="#" onclick="unbanMember(${currentGroupId}, ${m.user_id})">${t.action_unban}</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="kickMember(${currentGroupId}, ${m.user_id})">${t.action_kick}</a></li>
                            </ul>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        // --- Member Actions ---
        function banMember(groupId, userId) {
            const t = translations[currentLang] || translations['zh-CN'];
            const duration = prompt(t.prompt_ban_duration, "30");
            if (duration === null) return;
            const minutes = parseInt(duration);
            if (isNaN(minutes)) {
                alert(t.alert_invalid_number);
                return;
            }

            callBotApi('set_group_ban', {
                group_id: groupId,
                user_id: userId,
                duration: minutes * 60
            }).then(() => {
                alert(minutes > 0 ? t.alert_banned : t.alert_unbanned);
            }).catch(e => alert(t.alert_op_failed + e.message));
        }

        function unbanMember(groupId, userId) {
            const t = translations[currentLang] || translations['zh-CN'];
            callBotApi('set_group_ban', {
                group_id: groupId,
                user_id: userId,
                duration: 0
            }).then(() => {
                alert(t.alert_unbanned);
            }).catch(e => alert(t.alert_op_failed + e.message));
        }

        function setCard(groupId, userId, currentCard) {
            const t = translations[currentLang] || translations['zh-CN'];
            const newCard = prompt(t.prompt_new_card, currentCard);
            if (newCard === null) return;

            callBotApi('set_group_card', {
                group_id: groupId,
                user_id: userId,
                card: newCard
            }).then(() => {
                alert(t.alert_card_set);
                loadGroupMembers(groupId); // Reload to show change
            }).catch(e => alert(t.alert_op_failed + e.message));
        }

        function toggleAutoRecallInput() {
            const checked = document.getElementById('auto-recall-check').checked;
            document.getElementById('auto-recall-input-group').style.display = checked ? 'flex' : 'none';
        }

        async function sendGroupMsg() {
            const t = translations[currentLang] || translations['zh-CN'];
            const input = document.getElementById('group-msg-input');
            const msg = input.value.trim();
            if (!msg) return;
            
            // Auto Recall Params
            let autoRecall = 0;
            if (document.getElementById('auto-recall-check').checked) {
                const delayStr = document.getElementById('auto-recall-delay').value;
                autoRecall = parseInt(delayStr);
                if (isNaN(autoRecall) || autoRecall < 0) autoRecall = 0;
            }

            try {
                let action = 'send_group_msg';
                let params = {
                    message: msg
                };

                if (currentContactType === 'group') {
                    action = 'send_group_msg';
                    params.group_id = currentGroupId;
                } else if (currentContactType === 'private') {
                    action = 'send_private_msg';
                    params.user_id = currentGroupId;
                } else if (currentContactType === 'guild') {
                    action = 'send_msg';
                    params.message_type = 'guild';
                    params.channel_id = currentGroupId;
                    params.guild_id = currentGuildId;
                }

                // Inject auto_recall into the request wrapper, not params (unless the API design changed, but usually it's top level for the manager)
                // Wait, callBotApi wraps params. 
                // We need to pass auto_recall to the manager.
                // callBotApi implementation:
                /*
                function callBotApi(action, params) {
                    return fetch('/api/action', {
                        body: JSON.stringify({
                            bot_id: currentBotId,
                            action: action,
                            params: params
                        })
                    })
                }
                */
                // The manager expects auto_recall at the top level of the JSON body.
                // callBotApi currently only supports bot_id, action, params.
                // We need to modify callBotApi or manually call fetch here.
                
                // Let's manually call fetch here to support auto_recall without changing callBotApi signature for everyone
                const body = {
                    bot_id: currentBotId,
                    action: action,
                    params: params,
                    auto_recall: autoRecall
                };

                const res = await fetchWithAuth('/api/action', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                
                const result = await res.json();
                if (result.error) throw new Error(result.error);

                alert(t.alert_send_success);
                input.value = '';
                addEventLog({type: 'system', message: `å‘é€æ¶ˆæ¯åˆ° [${currentGroupId}]: ${msg}`});
            } catch (e) {
                alert(t.alert_op_failed + e.message);
            }
        }

        async function sendSmartGroupMsg() {
            if (!currentGroupId || !currentBotId) return;
            const content = document.getElementById('group-msg-input').value.trim();
            if (!content) return;
            
            // Auto Recall Params
            let autoRecall = 0;
            if (document.getElementById('auto-recall-check').checked) {
                const delayStr = document.getElementById('auto-recall-delay').value;
                autoRecall = parseInt(delayStr);
                if (isNaN(autoRecall) || autoRecall < 0) autoRecall = 0;
            }
            
            // UI Feedback
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> å‘é€ä¸­...';
            btn.disabled = true;

            try {
                const res = await fetchWithAuth('/api/smart_action', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'send_group_msg',
                        params: {
                            group_id: currentGroupId,
                            message: content
                        },
                        self_id: currentBotId,
                        auto_recall: autoRecall
                    })
                });

                if (!res.ok) {
                    throw new Error('è¯·æ±‚å¤±è´¥');
                }

                const data = await res.json();
                alert('æ™ºèƒ½å‘é€è¯·æ±‚å·²æäº¤: ' + (data.detail || 'Success'));
                document.getElementById('group-msg-input').value = '';
            } catch (e) {
                alert('æ™ºèƒ½å‘é€å¤±è´¥: ' + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        function kickMember(groupId, userId) {
            const t = translations[currentLang] || translations['zh-CN'];
            if (!confirm(t.confirm_kick_member.replace('{id}', userId))) return;
            callBotApi('set_group_kick', {
                group_id: groupId,
                user_id: userId
            }).then(() => {
                alert(t.alert_kicked);
                loadGroupMembers(groupId);
            }).catch(e => alert(t.alert_op_failed + e.message));
        }
        
        function leaveGroup() {
            const t = translations[currentLang] || translations['zh-CN'];
            if (!confirm(t.confirm_leave_group.replace('{id}', currentGroupId))) return;
             callBotApi('set_group_leave', {
                group_id: currentGroupId
            }).then(() => {
                alert(t.alert_left_group);
                refreshGroupList();
                document.getElementById('group-detail-empty').style.display = 'block';
                document.getElementById('group-detail-content').style.setProperty('display', 'none', 'important');
            }).catch(e => alert(t.alert_op_failed + e.message));
        }

        function checkGroupMember() {
            const userId = document.getElementById('check-member-input').value.trim();
            const resultEl = document.getElementById('check-member-result');
            const t = translations[currentLang] || translations['zh-CN'];
            
            if (!userId) {
                resultEl.innerHTML = `<span class="text-danger">${t.alert_invalid_number || 'Invalid ID'}</span>`;
                return;
            }

            resultEl.innerHTML = `<span class="text-muted">${t.loading || 'Loading...'}</span>`;
            
            callBotApi('get_group_member_info', {
                group_id: Number(currentGroupId),
                user_id: Number(userId),
                no_cache: true
            }).then(data => {
                if (data && (data.user_id || data.nickname)) {
                    // Found
                    let name = data.nickname || userId;
                    let card = data.card || '';
                    let text = t.member_found.replace('{name}', name).replace('{card}', card);
                    resultEl.innerHTML = `<span class="text-success"><i class="bi bi-check-circle"></i> ${text}</span>`;
                } else {
                    // Not found
                    resultEl.innerHTML = `<span class="text-warning">${t.member_not_found}</span>`;
                }
            }).catch(e => {
                console.error(e);
                // If 404 or other error, usually means not found or bot offline
                let msg = t.check_error + e.message;
                if (e.message.includes('not found') || e.message.includes('ä¸å­˜åœ¨')) {
                    msg = t.member_not_found;
                }
                resultEl.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle"></i> ${msg}</span>`;
            });
        }

        // --- System Actions ---
        async function callSystemAction(action) {
            const t = translations[currentLang] || translations['zh-CN'];
            if (action === 'clean_logs') {
                const dashLog = document.getElementById('recent-logs');
                if (dashLog) dashLog.innerHTML = '';
                
                clearEvents();
                
                addEventLog({type: 'system', message: t.log_cleaned});
                return;
            }
            
            try {
                const res = await callBotApi(action);
                alert(t.alert_op_success + JSON.stringify(res.data));
            } catch (e) {
                alert(t.alert_op_failed + e.message);
            }
        }

        function addEventLog(data) {
            const container = document.getElementById('event-container');
            if (container.children.length === 1 && container.children[0].classList.contains('text-muted')) {
                container.innerHTML = '';
            }
            
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.style.borderBottom = '1px solid var(--border-color)';
            div.style.padding = '8px 0';
            
            const time = new Date().toLocaleTimeString();
            
            // Format Content
            let content = '';
            if (data.type === 'system') {
                content = `<span class="text-info">[SYSTEM]</span> ${data.message}`;
            } else if (data.post_type === 'message' || data.post_type === 'message_sent') {
                const sender = data.sender ? (data.sender.nickname || data.sender.card || data.user_id) : data.user_id;
                const group = data.group_id ? `[ç¾¤:${data.group_id}] ` : '[ç§èŠ] ';
                let msg = data.message;
                if (typeof msg !== 'string') {
                    msg = JSON.stringify(msg);
                }
                content = `<span class="text-success">[MSG]</span> ${group}<span class="fw-bold text-warning">${sender}</span>: ${msg}`;
            } else if (data.post_type === 'log') {
                const log = data.data;
                const levelClass = log.level === 'ERROR' ? 'text-danger' : (log.level === 'WARN' ? 'text-warning' : 'text-info');
                content = `<span class="${levelClass}">[${log.level}]</span> ${log.message}`;
            } else if (data.post_type === 'meta_event') {
                if (data.meta_event_type === 'heartbeat') return; // Ignore heartbeat
                content = `<span class="text-secondary">[META]</span> ${data.meta_event_type}`;
            } else {
                content = `<span class="text-muted">[EVENT]</span> <pre class="d-inline m-0" style="font-size:0.8em">${JSON.stringify(data)}</pre>`;
            }
            
            div.innerHTML = `<span class="log-time">${time}</span> ${content}`;
            
            if (container) {
                container.appendChild(div);
                
                // Limit entries
                if (container.children.length > 200) {
                    container.removeChild(container.firstChild);
                }
                
                if (document.getElementById('auto-scroll-events') && document.getElementById('auto-scroll-events').checked) {
                    container.scrollTop = container.scrollHeight;
                }
            }

            // Update Dashboard Recent Logs
            const dashLog = document.getElementById('recent-logs');
            if (dashLog) {
                const clone = div.cloneNode(true);
                dashLog.appendChild(clone);
                if (dashLog.children.length > 50) {
                    dashLog.removeChild(dashLog.firstChild);
                }
                dashLog.scrollTop = dashLog.scrollHeight;
            }
        }

        function clearEvents() {
            document.getElementById('event-container').innerHTML = '<div class="text-muted text-center mt-5">ç­‰å¾…äº‹ä»¶è¿æ¥...</div>';
        }

        // --- Periodic Updates ---
        // Moved to startApp()
        
        let latestChatStats = {
            group_stats: {},
            user_stats: {},
            group_names: {},
            user_names: {}
        };

        function updateChatStats() {
            if (!authToken) return;
            fetchWithAuth('/api/stats/chat')
                .then(r => r.json())
                .then(data => {
                    latestChatStats = data;
                    // Fix: Use Today's stats for the dashboard top lists
                    renderTopList('top-groups', data.group_stats_today, data.group_names, 'Group');
                    renderTopList('top-users', data.user_stats_today, data.user_names, 'User');
                    
                    // Refresh lists if visible
                    const activeTab = document.querySelector('.nav-link.active').getAttribute('href');
                    if (activeTab === '#groups') {
                        // Only re-render if we have data to render, to avoid flickering or resetting scroll too often
                        // But since sorting might depend on stats, we should probably re-render.
                        // To be less intrusive, maybe only update if we are not dragging/selecting?
                        // For now, let's just re-render.
                        if (currentGroups && currentGroups.length > 0) {
                             renderGroups(currentGroups);
                        }
                        if (currentMembers && currentMembers.length > 0) {
                             renderMembers();
                        }
                    }
                })
                .catch(e => console.error("Update chat stats error:", e));
        }

        function getDisplayName(id, names, type) {
             if (names && names[id]) return names[id];
             if (type === 'Group') {
                 // Try to find in currentGroups loaded from bot
                 const g = currentGroups.find(x => x.group_id == id);
                 if (g) return g.group_name;
             }
             return `${type} ${id}`;
        }

        function renderTopList(elementId, stats, names, type) {
            const list = document.getElementById(elementId);
            if (!stats || Object.keys(stats).length === 0) {
                list.innerHTML = '<li class="list-group-item text-muted text-center">æš‚æ— æ•°æ®</li>';
                return;
            }

            const sorted = Object.entries(stats)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5);

            list.innerHTML = sorted.map(([id, count], index) => {
                const name = getDisplayName(id, names, type);
                // Optional: Fetch avatar if User or Group
                let avatar = '';
                if (type === 'User') {
                     avatar = `<img src="https://q1.qlogo.cn/g?b=qq&nk=${id}&s=100" class="rounded-circle me-2" width="20" height="20" onerror="this.style.display='none'">`;
                } else if (type === 'Group') {
                     avatar = `<img src="https://p.qlogo.cn/gh/${id}/${id}/100/" class="rounded-circle me-2" width="20" height="20" onerror="this.style.display='none'">`;
                }

                return `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div class="text-truncate" style="max-width: 70%;">
                            <span class="badge bg-light text-dark me-2">#${index + 1}</span>
                            ${avatar}
                            <span title="${id}">
                                ${name}
                                ${names && names[id] ? `<small class="text-muted ms-1" style="font-size:0.8em">(${id})</small>` : ''}
                            </span>
                        </div>
                        <span class="badge bg-primary rounded-pill">${count}</span>
                    </li>
                `;
            }).join('');
        }

        function showAllStats(type) {
            // Fix: Use Today's stats to match Dashboard
            const stats = type === 'Group' ? latestChatStats.group_stats_today : latestChatStats.user_stats_today;
            const names = type === 'Group' ? latestChatStats.group_names : latestChatStats.user_names;
            
            const t = translations[currentLang] || translations['zh-CN'];
            document.getElementById('statsModalTitle').innerText = type === 'Group' ? (t.top_active_groups || 'ä»Šæ—¥æ´»è·ƒç¾¤ç»„') : (t.top_active_users || 'ä»Šæ—¥é¾™ç‹');
            document.getElementById('statsModalNameHeader').innerText = type === 'Group' ? (t.group_name_default || 'ç¾¤ç»„åç§°') : (t.user_nickname || 'ç”¨æˆ·æ˜µç§°');
            
            const tbody = document.getElementById('statsModalBody');
            if (!stats || Object.keys(stats).length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="text-center p-4">${t.no_data || 'æš‚æ— æ•°æ®'}</td></tr>`;
            } else {
                const sorted = Object.entries(stats).sort(([, a], [, b]) => b - a);
                tbody.innerHTML = sorted.map(([id, count], index) => {
                    const name = getDisplayName(id, names, type);
                    let avatar = '';
                    if (type === 'User') {
                         avatar = `<img src="https://q1.qlogo.cn/g?b=qq&nk=${id}&s=100" class="rounded-circle me-2 border" width="32" height="32" onerror="this.src='https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/person-circle.svg'">`;
                    } else {
                         avatar = `<img src="https://p.qlogo.cn/gh/${id}/${id}/100/" class="rounded-circle me-2 border" width="32" height="32" onerror="this.src='https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/people-fill.svg'">`;
                    }
                    
                    return `
                        <tr>
                            <td class="align-middle">${index + 1}</td>
                            <td class="text-truncate align-middle" style="max-width: 300px;" title="${id}">
                                <div class="d-flex align-items-center">
                                    ${avatar}
                                    <div class="overflow-hidden">
                                        <div class="text-truncate">${name}</div>
                                        <div class="text-muted small" style="font-size: 0.75rem;">${id}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="text-end align-middle fw-bold text-primary">${count}</td>
                        </tr>
                    `;
                }).join('');
            }
            
            new bootstrap.Modal(document.getElementById('statsModal')).show();
        }
        // --- Message Test ---
        async function loadTestGroups() {
            const select = document.getElementById('mt-group-select');
            select.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
            
            try {
                const response = await callBotApi('get_group_list');
                const groups = response.data || [];
                
                // Sort by name
                groups.sort((a, b) => a.group_name.localeCompare(b.group_name, 'zh-CN'));
                
                let html = '<option value="">-- é€‰æ‹©ç¾¤ç»„ (æˆ–æ‰‹åŠ¨è¾“å…¥ UID) --</option>';
                groups.forEach(g => {
                    html += `<option value="${g.group_id}">[${g.group_id}] ${g.group_name}</option>`;
                });
                select.innerHTML = html;
            } catch (e) {
                select.innerHTML = '<option value="">åŠ è½½å¤±è´¥: ' + e.message + '</option>';
            }
        }

        function onTestGroupSelectChange() {
            const select = document.getElementById('mt-group-select');
            const targetInput = document.getElementById('mt-target');
            if (select.value) {
                targetInput.value = select.value;
            }
        }
        
        function pasteTargetUid() {
            const select = document.getElementById('mt-group-select');
            if (select.value) {
                document.getElementById('mt-target').value = select.value;
            }
        }

        function updateMsgForm() {
            const t = translations[currentLang] || translations['zh-CN'];
            const type = document.getElementById('mt-type').value;
            
            // Hide all specific inputs
            document.getElementById('mt-group-text').style.display = 'none';
            document.getElementById('mt-group-file').style.display = 'none';
            document.getElementById('mt-group-music').style.display = 'none';
            document.getElementById('mt-group-share').style.display = 'none';
            document.getElementById('mt-group-raw').style.display = 'none';
            
            if (type === 'text' || type === 'poke') {
                document.getElementById('mt-group-text').style.display = 'block';
                document.getElementById('mt-content').placeholder = type === 'poke' ? t.placeholder_poke : t.placeholder_text_cq;
            } else if (type === 'image' || type === 'record' || type === 'video') {
                document.getElementById('mt-group-file').style.display = 'block';
                let label = t.label_file_url;
                if (type === 'image') label = t.label_image_url;
                else if (type === 'record') label = t.label_record_url;
                else if (type === 'video') label = t.label_video_url;
                document.getElementById('mt-file-label').textContent = label;
            } else if (type === 'music') {
                document.getElementById('mt-group-music').style.display = 'block';
            } else if (type === 'share') {
                document.getElementById('mt-group-share').style.display = 'block';
            } else if (type === 'json' || type === 'xml') {
                document.getElementById('mt-group-raw').style.display = 'block';
                document.getElementById('mt-raw-label').textContent = type.toUpperCase() + t.label_raw_content_suffix;
            }
        }

        async function submitTestMsg() {
            const t = translations[currentLang] || translations['zh-CN'];
            const resultEl = document.getElementById('mt-result');
            resultEl.style.display = 'none';
            resultEl.className = 'alert alert-secondary';
            resultEl.textContent = t.msg_sending;
            resultEl.style.display = 'block';
            
            const target = document.getElementById('mt-target').value;
            const type = document.getElementById('mt-type').value;
            
            if (!target) {
                resultEl.className = 'alert alert-danger';
                resultEl.textContent = t.alert_enter_target_uid;
                return;
            }

            // Default to group message
            let action = 'send_group_msg';
            let params = {
                group_id: parseInt(target)
            };
            
            // Construct Message
            if (type === 'text') {
                const content = document.getElementById('mt-content').value;
                if (!content) {
                    resultEl.className = 'alert alert-danger';
                    resultEl.textContent = t.alert_enter_content;
                    return;
                }
                params.message = content;
            } else if (type === 'poke') {
                const qq = document.getElementById('mt-content').value;
                params.message = `[CQ:poke,qq=${qq || ''}]`;
            } else if (type === 'image' || type === 'record' || type === 'video') {
                const file = document.getElementById('mt-file-path').value;
                if (!file) {
                    resultEl.className = 'alert alert-danger';
                    resultEl.textContent = t.alert_enter_file_url;
                    return;
                }
                params.message = [
                    {
                        type: type,
                        data: { file: file }
                    }
                ];
            } else if (type === 'music') {
                const mType = document.getElementById('mt-music-type').value;
                const mId = document.getElementById('mt-music-id').value;
                if (!mId) {
                    resultEl.className = 'alert alert-danger';
                    resultEl.textContent = t.msg_input_song_id;
                    return;
                }
                params.message = [{
                    type: 'music',
                    data: {
                        type: mType,
                        id: mId
                    }
                }];
            } else if (type === 'share') {
                params.message = [{
                    type: 'share',
                    data: {
                        url: document.getElementById('mt-share-url').value,
                        title: document.getElementById('mt-share-title').value,
                        content: document.getElementById('mt-share-content').value,
                        image: document.getElementById('mt-share-image').value
                    }
                }];
            } else if (type === 'json' || type === 'xml') {
                const raw = document.getElementById('mt-raw-content').value;
                if (!raw) {
                    resultEl.className = 'alert alert-danger';
                    resultEl.textContent = t.msg_input_content;
                    return;
                }
                params.message = [{
                    type: type,
                    data: {
                        data: raw
                    }
                }];
            }

            try {
                const res = await callBotApi(action, params);
                resultEl.className = 'alert alert-success';
                resultEl.textContent = 'å‘é€æˆåŠŸ! MSG ID: ' + (res.data ? res.data.message_id : 'Unknown');
            } catch (e) {
                resultEl.className = 'alert alert-danger';
                resultEl.textContent = 'å‘é€å¤±è´¥: ' + e.message;
            }
        }

        function updateCodePreview() {
            const target = document.getElementById('mt-target').value;
            const type = document.getElementById('mt-type').value;
            let params = {
                group_id: target ? parseInt(target) : 0
            };
            
            if (type === 'text') {
                params.message = document.getElementById('mt-content').value;
            } else if (type === 'poke') {
                const qq = document.getElementById('mt-content').value;
                params.message = `[CQ:poke,qq=${qq || ''}]`;
            } else if (type === 'image' || type === 'record' || type === 'video') {
                params.message = [{
                    type: type,
                    data: { file: document.getElementById('mt-file-path').value }
                }];
            } else if (type === 'music') {
                params.message = [{
                    type: 'music',
                    data: {
                        type: document.getElementById('mt-music-type').value,
                        id: document.getElementById('mt-music-id').value
                    }
                }];
            } else if (type === 'share') {
                params.message = [{
                    type: 'share',
                    data: {
                        url: document.getElementById('mt-share-url').value,
                        title: document.getElementById('mt-share-title').value,
                        content: document.getElementById('mt-share-content').value,
                        image: document.getElementById('mt-share-image').value
                    }
                }];
            } else if (type === 'json' || type === 'xml') {
                const raw = document.getElementById('mt-raw-content').value;
                params.message = [{
                    type: type,
                    data: { data: raw }
                }];
            }

            const preview = {
                action: 'send_group_msg',
                params: params
            };
            
            document.getElementById('code-preview').textContent = JSON.stringify(preview, null, 2);
        }

        function copyCodePreview() {
            const t = translations[currentLang] || translations['zh-CN'];
            const content = document.getElementById('code-preview').textContent;
            navigator.clipboard.writeText(content).then(() => {
                const btn = document.querySelector('button[onclick="copyCodePreview()"]');
                if(btn) {
                    const original = btn.textContent;
                    btn.textContent = t.btn_copied;
                    setTimeout(() => btn.textContent = original, 2000);
                }
            });
        }

        // --- Log Selection Auto-Pause ---
        function checkLogSelectionAndPause() {
            const selection = window.getSelection();
            if (!selection || selection.toString().length === 0) return;

            // Check if selection intersects with log containers
            // We use commonAncestorContainer to check if the selection is inside the log container
            let node = selection.anchorNode;
            if (!node) return;
            if (node.nodeType === 3) node = node.parentNode; // text node -> element

            const container = document.getElementById('log-container');
            const containerFull = document.getElementById('log-container-full');
            
            // Check if the selection is within either container
            if ((container && container.contains(node)) || 
                (containerFull && containerFull.contains(node))) {
                 
                 const autoRefreshFull = document.getElementById('auto-refresh-logs-full');
                 if (autoRefreshFull && autoRefreshFull.checked) {
                     autoRefreshFull.checked = false;
                 }
                 
                 const autoRefreshWidget = document.getElementById('auto-refresh-logs');
                 if (autoRefreshWidget && autoRefreshWidget.checked) {
                     autoRefreshWidget.checked = false;
                 }
            }
        }
        
        document.addEventListener('mouseup', checkLogSelectionAndPause);
        document.addEventListener('keyup', (e) => {
             // Shift + Arrows usually select text
             if (e.shiftKey) checkLogSelectionAndPause();
        });

        // --- Docker Management ---
        let dockerContainers = []; // Cache for filtering

        function loadDockerContainers(isSilent = false) {
            const tbody = document.getElementById('docker-container-list');
            if (!tbody) return;
            
            // Only show loading indicator if not silent refresh
            if (!isSilent) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted" data-i18n="loading">Loading...</td></tr>';
            }
            
            fetchWithAuth('/api/docker/list')
                .then(r => r.json())
                .then(containers => {
                 // Check if the response is an error object instead of an array
                 if (containers && typeof containers === 'object' && !Array.isArray(containers)) {
                     if (containers.status === 'error' || containers.message) {
                         tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error: ${containers.message || 'Unknown error'}</td></tr>`;
                         return;
                     }
                 }

                 dockerContainers = Array.isArray(containers) ? containers : [];
                 renderDockerContainers(dockerContainers);
            })
            .catch(err => {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error: ${err}</td></tr>`;
            });
        }

        function renderDockerContainers(containers) {
            const tbody = document.getElementById('docker-container-list');
            if (!tbody) return;

            if (!containers || containers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted" data-i18n="no_data">No Data</td></tr>';
                return;
            }
            
            const t = translations[currentLang] || translations['zh-CN'];
            const searchTerm = document.getElementById('docker-search-input')?.value.toLowerCase() || '';
            
            const filtered = containers.filter(c => {
                const names = (c.Names || []).join(', ').toLowerCase();
                const image = (c.Image || '').toLowerCase();
                const id = (c.Id || '').toLowerCase();
                return names.includes(searchTerm) || image.includes(searchTerm) || id.includes(searchTerm);
            });

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">æ²¡æœ‰åŒ¹é…çš„ç»“æœ</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(c => {
                const isRunning = c.State === 'running';
                const shortId = c.Id.substring(0, 12);
                return `
                <tr>
                    <td><span class="font-monospace">${shortId}</span></td>
                    <td>${(c.Names || []).join(', ')}</td>
                    <td>${c.Image}</td>
                    <td><span class="badge bg-${isRunning ? 'success' : 'secondary'}">${c.State}</span></td>
                    <td>${c.Status}</td>
                    <td>
                        ${isRunning ? 
                            `<button class="btn btn-sm btn-outline-danger me-1" onclick="controlContainer('${c.Id}', 'stop')"><i class="bi bi-stop-fill"></i> ${t.docker_stop}</button>
                             <button class="btn btn-sm btn-outline-warning" onclick="controlContainer('${c.Id}', 'restart')"><i class="bi bi-arrow-repeat"></i> ${t.docker_restart}</button>` 
                            : 
                            `<button class="btn btn-sm btn-outline-success" onclick="controlContainer('${c.Id}', 'start')"><i class="bi bi-play-fill"></i> ${t.docker_start}</button>`
                        }
                    </td>
                </tr>
             `}).join('');
        }

        function filterDockerContainers() {
            renderDockerContainers(dockerContainers);
        }

        function controlContainer(id, action) {
            const t = translations[currentLang] || translations['zh-CN'];
            const actionText = t[`docker_${action}`] || action;
            const confirmMsg = t.docker_confirm_action
                .replace('{id}', id.substring(0, 12))
                .replace('{action}', actionText);
                
            if (!confirm(confirmMsg)) return;
            
            // Show loading state on the button itself? 
            // For now, simple alert or just proceed. 
            // Ideally we should disable the button.
            
            fetchWithAuth('/api/docker/action', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    container_id: id,
                    action: action
                })
            })
            .then(r => r.json())
            .then(res => {
                if (res.status === 'ok' || (res.id && !res.message)) { 
                    // Use silent refresh to avoid full table flicker
                    loadDockerContainers(true);
                } else {
                    alert(`${t.docker_action_failed}: ${res.message || JSON.stringify(res)}`);
                }
            })
            .catch(err => {
                alert('Error: ' + err);
            });
        }

        function addBotContainer() {
            const t = translations[currentLang] || translations['zh-CN'];
            if (!confirm("ç¡®å®šè¦éƒ¨ç½²æ–°çš„æœºå™¨äººå®¹å™¨å—ï¼Ÿ")) return;
            
            fetchWithAuth('/api/docker/add-bot', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(r => r.json())
            .then(res => {
                if (res.status === 'ok') {
                    alert("æœºå™¨äººå®¹å™¨å·²åœ¨åå°å¼€å§‹éƒ¨ç½²");
                    loadDockerContainers(true);
                } else {
                    alert(res.message || "éƒ¨ç½²è¯·æ±‚å¤±è´¥");
                }
            })
            .catch(err => alert("Error: " + err));
        }

        function addWorkerContainer() {
            const t = translations[currentLang] || translations['zh-CN'];
            if (!confirm("ç¡®å®šè¦éƒ¨ç½²æ–°çš„ Worker èŠ‚ç‚¹å®¹å™¨å—ï¼Ÿ")) return;
            
            fetchWithAuth('/api/docker/add-worker', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(r => r.json())
            .then(res => {
                if (res.status === 'ok') {
                    alert("Worker èŠ‚ç‚¹å®¹å™¨å·²åœ¨åå°å¼€å§‹éƒ¨ç½²");
                    loadDockerContainers(true);
                } else {
                    alert(res.message || "éƒ¨ç½²è¯·æ±‚å¤±è´¥");
                }
            })
            .catch(err => alert("Error: " + err));
        }

        // --- Routing Management ---
        let routingRules = [];

        async function fetchRoutingRules() {
            const container = document.getElementById('routing-list-container');
            if (!container) return;
            
            container.innerHTML = `
                <div class="col-12 text-center text-muted">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2" data-i18n="loading_routing_rules">æ­£åœ¨åŠ è½½è·¯ç”±è§„åˆ™...</p>
                </div>
            `;
            
            try {
                const response = await fetchWithAuth('/api/admin/routing');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                // Convert object format to array format for easier rendering
                routingRules = [];
                if (data.rules && typeof data.rules === 'object') {
                    for (const [key, workerID] of Object.entries(data.rules)) {
                        routingRules.push({
                            key: key,
                            worker_id: workerID
                        });
                    }
                }
                renderRoutingRules();
                
            } catch (error) {
                console.error('Failed to fetch routing rules:', error);
                const t = translations[currentLang] || translations['zh-CN'];
                container.innerHTML = `
                    <div class="col-12 text-center text-danger">
                        <i class="bi bi-exclamation-triangle fs-4"></i>
                        <p class="mt-2">${t.loading_failed || 'åŠ è½½å¤±è´¥'}: ${error.message}</p>
                        <button class="btn btn-sm btn-outline-primary" onclick="fetchRoutingRules()">
                            <i class="bi bi-arrow-clockwise"></i> ${t.retry || 'é‡è¯•'}
                        </button>
                    </div>
                `;
            }
        }

        function toggleRoutingHelp() {
            const helpSection = document.getElementById('routing-help-section');
            if (helpSection.style.display === 'none') {
                helpSection.style.display = 'block';
            } else {
                helpSection.style.display = 'none';
            }
        }

        function renderRoutingRules() {
            const container = document.getElementById('routing-list-container');
            if (!container) return;
            
            const t = translations[currentLang] || translations['zh-CN'];
            
            if (!routingRules || routingRules.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center text-muted">
                        <i class="bi bi-diagram-3 fs-1"></i>
                        <p class="mt-3" data-i18n="no_routing_rules">æš‚æ— è·¯ç”±è§„åˆ™</p>
                        <button class="btn btn-primary" onclick="showAddRoutingRuleDialog()">
                            <i class="bi bi-plus-lg"></i> <span data-i18n="routing_add_rule">æ·»åŠ è·¯ç”±è§„åˆ™</span>
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = routingRules.map(rule => `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0 text-truncate" title="${rule.key || ''}">${rule.key || 'æœªå‘½åè§„åˆ™'}</h6>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="editRoutingRule('${rule.key}')">
                                            <i class="bi bi-pencil"></i> ${t.edit || 'ç¼–è¾‘'}
                                        </a></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteRoutingRule('${rule.key}')">
                                            <i class="bi bi-trash"></i> ${t.delete || 'åˆ é™¤'}
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                            <p class="card-text small text-muted mb-2">
                                <i class="bi bi-arrow-right"></i> ${rule.worker_id || 'æœªè®¾ç½®ç›®æ ‡'}
                            </p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="bi bi-diagram-3"></i> ${t.target_worker || 'ç›®æ ‡å·¥ä½œèŠ‚ç‚¹'}: ${rule.worker_id || 'N/A'}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showAddRoutingRuleDialog() {
            // Reset form for new rule
            document.getElementById('routing-pattern').value = '';
            document.getElementById('routing-target').value = '';
            document.getElementById('routing-enabled').checked = true;
            
            // ç¡®ä¿è·å–æœ€æ–°çš„èŠ‚ç‚¹åˆ—è¡¨
            fetchWorkers();
            
            // Populate worker dropdown
            const dropdown = document.getElementById('worker-select-dropdown');
            if (dropdown) {
                const updateDropdown = () => {
                    if (!window.currentWorkers || window.currentWorkers.length === 0) {
                        dropdown.innerHTML = '<li><a class="dropdown-item disabled" href="#">æ— åœ¨çº¿èŠ‚ç‚¹</a></li>';
                    } else {
                        dropdown.innerHTML = window.currentWorkers.map(w => 
                            `<li><a class="dropdown-item" href="javascript:void(0)" onclick="document.getElementById('routing-target').value='${w.id}'">${w.id} (${w.addr})</a></li>`
                        ).join('');
                    }
                };
                updateDropdown();
                // ç›‘å¬ currentWorkers çš„å˜åŒ–å¯èƒ½å¤ªå¤æ‚ï¼Œè¿™é‡Œç®€å•å»¶è¿Ÿä¸€ä¸‹æˆ–è€…ä¾èµ– fetchWorkers çš„å›è°ƒ
                setTimeout(updateDropdown, 500); 
            }

            // Update modal title for adding new rule
            const modalTitle = document.querySelector('#routingRuleModal .modal-title');
            if (modalTitle) {
                modalTitle.textContent = 'æ·»åŠ è·¯ç”±è§„åˆ™';
                modalTitle.setAttribute('data-i18n', 'routing_add_rule');
            }
            
            // Update save button for adding new rule
            const saveButton = document.querySelector('#routingRuleModal .modal-footer .btn-primary');
            if (saveButton) {
                saveButton.textContent = 'ä¿å­˜';
                saveButton.setAttribute('data-i18n', 'save');
                saveButton.onclick = () => saveRoutingRule();
            }
            
            const modal = new bootstrap.Modal(document.getElementById('routingRuleModal'));
            modal.show();
        }

        async function saveRoutingRule() {
            const pattern = document.getElementById('routing-pattern').value.trim();
            const target = document.getElementById('routing-target').value.trim();
            const enabled = document.getElementById('routing-enabled').checked;
            
            if (!pattern || !target) {
                alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                return;
            }
            
            try {
                const response = await fetchWithAuth('/api/admin/routing', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        key: pattern,
                        worker_id: target
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'ä¿å­˜å¤±è´¥');
                }
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('routingRuleModal'));
                modal.hide();
                
                fetchRoutingRules(); // Refresh the list
                
            } catch (error) {
                console.error('Failed to save routing rule:', error);
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        async function deleteRoutingRule(ruleId) {
            const t = translations[currentLang] || translations['zh-CN'];
            if (!confirm(t.confirm_delete || 'ç¡®å®šè¦åˆ é™¤è¿™æ¡è·¯ç”±è§„åˆ™å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetchWithAuth(`/api/admin/routing?key=${encodeURIComponent(ruleId)}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || `HTTP ${response.status}`);
                }
                
                fetchRoutingRules(); // Refresh the list
                
            } catch (error) {
                console.error('Failed to delete routing rule:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        function editRoutingRule(ruleId) {
            const rule = routingRules.find(r => r.key === ruleId);
            if (!rule) {
                alert('è§„åˆ™ä¸å­˜åœ¨');
                return;
            }
            
            showAddRoutingRuleDialog();
            
            // Pre-fill the form after modal is shown
            setTimeout(() => {
                document.getElementById('routing-pattern').value = rule.key || '';
                document.getElementById('routing-target').value = rule.worker_id || '';
                document.getElementById('routing-enabled').checked = true;
                
                // Change modal title
                const modalTitle = document.querySelector('#routingRuleModal .modal-title');
                if (modalTitle) {
                    modalTitle.textContent = 'ç¼–è¾‘è·¯ç”±è§„åˆ™';
                    modalTitle.setAttribute('data-i18n', 'routing_edit_rule');
                }
                
                // Change save button to call saveRoutingRule (backend POST handles both)
                const saveButton = document.querySelector('#routingRuleModal .modal-footer .btn-primary');
                if (saveButton) {
                    saveButton.textContent = 'ä¿å­˜';
                    saveButton.setAttribute('data-i18n', 'save');
                    saveButton.onclick = () => saveRoutingRule();
                }
            }, 200);
        }

        async function updateRoutingRule(ruleId) {
            return saveRoutingRule();
        }
        
        // é¡µé¢åˆ·æ–°æ—¶çš„æ¸…ç†é€»è¾‘
        function cleanupBeforeUnload() {
            // æ¸…ç†WebSocketè¿æ¥
            if (window.wsSubscriber) {
                try {
                    window.wsSubscriber.close();
                    window.wsSubscriber = null;
                } catch (e) {
                    console.error('æ¸…ç†WebSocketå¤±è´¥:', e);
                }
            }
            
            // æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
            const intervals = [
                'updateInterval', 'systemStatsInterval', 'chatStatsInterval', 
                'botsInterval', 'workersInterval'
            ];
            
            intervals.forEach(intervalName => {
                if (window[intervalName]) {
                    clearInterval(window[intervalName]);
                    window[intervalName] = null;
                }
            });
            
            // æ¸…ç†æ‰€æœ‰å¾…å¤„ç†çš„è¯·æ±‚
            if (window.pendingRequests) {
                window.pendingRequests.clear();
            }
            
            console.log('é¡µé¢æ¸…ç†å®Œæˆ');
        }
        
        // ç›‘å¬é¡µé¢åˆ·æ–°å’Œå…³é—­äº‹ä»¶
        window.addEventListener('beforeunload', cleanupBeforeUnload);
        window.addEventListener('pagehide', cleanupBeforeUnload);
        
        function showCreateUserModal() {
            const modal = new bootstrap.Modal(document.getElementById('createUserModal'));
            modal.show();
        }

        async function createUser() {
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const isAdmin = document.getElementById('new-is-admin').checked;

            if (!username || !password) {
                alert('è¯·å¡«å†™ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }

            try {
                const response = await fetchWithAuth('/api/admin/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, is_admin: isAdmin })
                });
                const result = await response.json();
                if (result.success) {
                    showToast('ç”¨æˆ·åˆ›å»ºæˆåŠŸ', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
                    fetchUsers(); // åˆ·æ–°åˆ—è¡¨
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('new-username').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('new-is-admin').checked = false;
                } else {
                    alert('åˆ›å»ºå¤±è´¥: ' + result.message);
                }
            } catch (err) {
                console.error('Create user error:', err);
                alert('åˆ›å»ºç”¨æˆ·æ—¶å‡ºé”™');
            }
        }

        async function fetchUsers() {
            if (authRole !== 'admin' && authRole !== 'super') return;
            
            try {
                const response = await fetchWithAuth('/api/admin/users');
                const result = await response.json();
                if (result.success) {
                    renderUsers(result.users || []);
                }
            } catch (err) {
                console.error('Fetch users error:', err);
            }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td><span class="badge ${user.is_admin ? 'bg-danger' : 'bg-info'}">${user.is_admin ? 'Admin' : 'User'}</span></td>
                    <td>${new Date(user.created_at).toLocaleString()}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${user.username}')" ${user.username === 'admin' ? 'disabled' : ''}>
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function deleteUser(username) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${username} å—ï¼Ÿ`)) return;
            
            try {
                const response = await fetchWithAuth(`/api/admin/users?username=${encodeURIComponent(username)}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    showToast('ç”¨æˆ·åˆ é™¤æˆåŠŸ', 'success');
                    fetchUsers();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + result.message);
                }
            } catch (err) {
                console.error('Delete user error:', err);
            }
        }

        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œä¼˜åŒ–æ€§èƒ½
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // é¡µé¢éšè—æ—¶æš‚åœéƒ¨åˆ†å®šæ—¶å™¨
                console.log('é¡µé¢éšè—ï¼Œæš‚åœéƒ¨åˆ†å®šæ—¶å™¨');
            } else {
                // é¡µé¢æ˜¾ç¤ºæ—¶æ¢å¤å®šæ—¶å™¨
                console.log('é¡µé¢æ˜¾ç¤ºï¼Œæ¢å¤å®šæ—¶å™¨');
            }
        });
    </script>
</body>
</html>

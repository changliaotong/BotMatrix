<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BotMatrix Manager v1.1.84</title>
    <!-- Use Staticfile CDN (Reliable in China) -->
    <link href="https://cdn.staticfile.org/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.staticfile.org/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css" rel="stylesheet">
    <script src="https://cdn.staticfile.org/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.staticfile.org/Chart.js/3.7.1/chart.min.js"></script>
    <script src="https://cdn.staticfile.org/three.js/0.141.0/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.141.0/examples/js/controls/OrbitControls.js"></script>
    <script src="locales.js"></script>
    
    <!-- Error handling for external scripts -->
    <script>
        // Ignore external script errors (like browser extensions)
        window.addEventListener('error', function(e) {
            // Check if error is from external script
            if (e.filename && (e.filename.includes('index.ts') || e.filename.includes('.js'))) {
                console.warn('Ignored external script error:', e.message, 'from', e.filename);
                e.preventDefault();
                return true;
            }
        });
        
        // Handle MutationObserver errors from external scripts
        const originalObserve = MutationObserver.prototype.observe;
        MutationObserver.prototype.observe = function(target, options) {
            try {
                if (!target || typeof target.querySelector !== 'function') {
                    console.warn('MutationObserver called with invalid target, ignoring');
                    return;
                }
                return originalObserve.call(this, target, options);
            } catch (e) {
                console.warn('MutationObserver error ignored:', e.message);
            }
        };
    </script>
    <style>
        :root {
            --bg-body: #f8f9fa;
            --bg-sidebar: #ffffff;
            --bg-card: #ffffff;
            --text-main: #212529;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --primary-color: #0d6efd;
            
            --bg-console: #f8f9fa;
            --text-console: #212529;
            --color-log-time: #0d6efd;
            --color-log-info: #198754;
            --color-log-error: #dc3545;
            --color-log-debug: #6c757d;
            
            --bg-list-item: #f8f9fa;
        }

        [data-theme="dark"] {
            --bg-body: #121212;
            --bg-sidebar: #1e1e1e;
            --bg-card: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #adb5bd;
            --border-color: #333333;
            --primary-color: #3d8bfd;

            --bg-console: #1e1e1e;
            --text-console: #d4d4d4;
            --color-log-time: #569cd6;
            --color-log-info: #4ec9b0;
            --color-log-error: #f44747;
            --color-log-debug: #dcdcaa;
            
            --bg-list-item: #2c2c2c;
        }

        /* Dark Mode Overrides */
        [data-theme="dark"] .dropdown-menu {
            background-color: var(--bg-card);
            border-color: var(--border-color);
        }
        [data-theme="dark"] .dropdown-item {
            color: var(--text-main);
        }
        [data-theme="dark"] .dropdown-item:hover {
            background-color: var(--bg-list-item);
            color: var(--text-main);
        }
        [data-theme="dark"] .list-group-item {
            background-color: var(--bg-card);
            color: var(--text-main);
            border-color: var(--border-color);
        }
        /* Fix TAB title background in dark mode */
        [data-theme="dark"] .nav-tabs .nav-link.active {
            background-color: var(--bg-card) !important;
            color: var(--text-main) !important;
            border-color: var(--border-color) var(--border-color) var(--bg-body);
        }
        [data-theme="dark"] .card-header {
            background-color: rgba(255, 255, 255, 0.05) !important;
            border-bottom-color: var(--border-color);
            color: var(--text-main);
        }
        [data-theme="dark"] .bg-white {
            background-color: var(--bg-card) !important;
        }

        /* Dark Mode Modal & Table */
        [data-theme="dark"] .modal-content {
            background-color: var(--bg-card);
            color: var(--text-main);
            border-color: var(--border-color);
        }
        [data-theme="dark"] .modal-header,
        [data-theme="dark"] .modal-footer {
            border-color: var(--border-color);
        }
        [data-theme="dark"] .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        [data-theme="dark"] .table-striped > tbody > tr:nth-of-type(odd) {
            --bs-table-accent-bg: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
        }
        [data-theme="dark"] .table-hover > tbody > tr:hover {
            --bs-table-hover-bg: rgba(255, 255, 255, 0.1);
            color: var(--text-main);
        }
        [data-theme="dark"] .table thead.table-light th {
            background-color: var(--bg-sidebar) !important;
            color: var(--text-main) !important;
            border-color: var(--border-color);
        }
        [data-theme="dark"] .table > :not(caption) > * > * {
            border-color: var(--border-color);
        }

        body { background-color: var(--bg-body); color: var(--text-main); font-family: system-ui, -apple-system, sans-serif; transition: background-color 0.3s, color 0.3s; }
        .sidebar { display: flex; flex-direction: column; height: 100vh; position: fixed; top: 0; left: 0; width: 250px; background-color: var(--bg-sidebar); border-right: 1px solid var(--border-color); padding-top: 20px; z-index: 1000; transition: background-color 0.3s, border-color 0.3s; }
        .card { background-color: var(--bg-card); border: 1px solid var(--border-color); margin-bottom: 24px; box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); border-radius: 0.75rem; transition: background-color 0.3s, border-color 0.3s; }
        .form-control, .form-select { background-color: var(--bg-card); color: var(--text-main); border-color: var(--border-color); }
        .form-control:focus, .form-select:focus { background-color: var(--bg-card); color: var(--text-main); border-color: var(--primary-color); }
        .dropdown-menu { background-color: var(--bg-card); border-color: var(--border-color); }
        .dropdown-item { color: var(--text-main); }
        .dropdown-item:hover { background-color: rgba(255, 255, 255, 0.1); color: var(--text-main); }
        .list-group-item { background-color: var(--bg-card); color: var(--text-main); border-color: var(--border-color); }

        /* Visualization Styles */
        #visualization-container {
            width: 100%;
            height: calc(100vh - 160px);
            background: radial-gradient(circle at center, #1a1a2e 0%, #0f0f1a 100%);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            border: 1px solid #30363d;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
        }
        #viz-nodes {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }
        .viz-node {
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #00ff41;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #00ff41;
            font-size: 0.7rem;
            z-index: 2;
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.3);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            backdrop-filter: blur(4px);
            pointer-events: auto;
            text-align: center;
        }
        .viz-node i {
            font-size: 1.4rem;
            margin-bottom: 2px;
            color: #00ff41;
        }
        .viz-node span {
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 0 5px;
            color: #00ff41;
            font-family: 'Courier New', Courier, monospace;
            text-shadow: 0 0 5px #00ff41;
        }
        .viz-node img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid #00ff41;
            margin-bottom: 2px;
        }
        .viz-node.nexus {
            width: 100px;
            height: 100px;
            background: rgba(0, 0, 0, 0.8);
            border-color: #00ff41;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.4);
            font-weight: bold;
        }
        .viz-node.worker {
            background: rgba(0, 0, 0, 0.7);
            border-color: #00ff41;
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.3);
        }
        .viz-node.user {
            width: 60px;
            height: 60px;
            background: rgba(0, 0, 0, 0.6);
            border-color: #00ff41;
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.2);
        }
        .viz-stats {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #00ff41;
            color: #00ff41;
            padding: 5px 10px;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            z-index: 10;
            pointer-events: none;
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
        }
        .viz-msg-hint {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00ff41;
            color: #00ff41;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            pointer-events: none;
            z-index: 5;
            white-space: nowrap;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            font-family: 'Courier New', Courier, monospace;
            animation: fadeUp 2s forwards;
        }
        @keyframes fadeUp {
            0% { opacity: 0; transform: translateY(0); }
            20% { opacity: 1; transform: translateY(-20px); }
            80% { opacity: 1; transform: translateY(-40px); }
            100% { opacity: 0; transform: translateY(-60px); }
        }
        #viz-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }
        .viz-label {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            pointer-events: none;
            white-space: nowrap;
            z-index: 3;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -120%);
        }
        .viz-particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #fff;
            border-radius: 50%;
            pointer-events: none;
            z-index: 2;
            box-shadow: 0 0 10px #fff;
        }
        .table { color: var(--text-main); border-color: var(--border-color); }
        .nav-link { color: var(--text-muted); }
        
        .sidebar a { color: var(--text-muted); padding: 12px 24px; display: block; text-decoration: none; border-left: 3px solid transparent; }
        .sidebar a:hover, .sidebar a.active { color: var(--primary-color); background-color: rgba(13, 110, 253, 0.1); border-left-color: var(--primary-color); font-weight: 500; }
        .nav-section-label {
            padding: 1rem 1.5rem 0.5rem;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-muted);
            letter-spacing: 0.05rem;
            opacity: 0.7;
        }
        .main-content { margin-left: 250px; padding: 25px; padding-top: 10px; }
        .metric-label { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .log-box { background-color: var(--bg-console); color: var(--text-console); font-family: monospace; padding: 15px; overflow-y: auto; border-radius: 0.5rem; font-size: 0.85rem; border: 1px solid var(--border-color); }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid var(--border-color); padding-bottom: 2px; }
        .log-time { color: var(--color-log-time); margin-right: 10px; }
        .log-level-INFO { color: var(--color-log-info); }
        .log-level-ERROR { color: var(--color-log-error); }
        .log-level-DEBUG { color: var(--color-log-debug); }

        /* Login Page Styles */
        .login-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: none; /* ‰øÆÊîπÔºöÂàùÂßãÈöêËóèÔºåÈò≤Ê≠¢Èó™Áé∞ */
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: all 0.5s ease;
            opacity: 1;
            visibility: visible;
        }
        [data-theme="dark"] .login-page {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        .login-card {
            background: white;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 1rem 3rem rgba(0,0,0,0.175);
            width: 100%;
            max-width: 450px;
            animation: slideUp 0.5s ease-out;
            position: relative;
            z-index: 10000;
        }
        [data-theme="dark"] .login-card {
            background: var(--bg-card);
            color: var(--text-main);
            border: 1px solid var(--border-color);
        }
        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .login-logo {
            width: 80px;
            height: 80px;
            background: var(--primary-color);
            color: white;
            border-radius: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin: 0 auto 1rem;
            box-shadow: 0 0.5rem 1rem rgba(13, 110, 253, 0.3);
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .login-page.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        /* Mobile Responsive */
        .mobile-nav { display: none; }
        .overlay { display: none; }



        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                box-shadow: 0 0 15px rgba(0,0,0,0.2);
            }
            .sidebar.show {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
                padding-top: 80px; /* Space for navbar */
                padding-left: 15px;
                padding-right: 15px;
            }
            .mobile-nav {
                display: flex;
                position: fixed;
                top: 0; left: 0; right: 0;
                height: 60px;
                background: #fff;
                border-bottom: 1px solid var(--border-color);
                z-index: 900;
                align-items: center;
                padding: 0 15px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            .overlay {
                display: none;
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 999;
            }
            .overlay.show {
            display: block;
        }

        /* Group Management Mobile */
        .group-manage-container {
            height: auto !important;
        }
        .group-manage-col {
            height: 70vh !important;
            margin-bottom: 20px;
        }
    }
    
    /* Stats Card Slides */
    .stats-slide {
        transition: all 0.5s ease-in-out;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .stats-slide.fade-out {
        opacity: 0;
        transform: translateY(-10px);
    }
    .stats-slide.fade-in {
        opacity: 1;
        transform: translateY(0);
    }
    
    /* Custom Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    @media (max-width: 1400px) {
        .stats-grid { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 992px) {
        .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 576px) {
        .stats-grid { grid-template-columns: 1fr; }
    }
    .icon-circle {
        width: 42px;
        height: 42px;
        border-radius: 50% !important; /* Force circle */
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        flex-shrink: 0;
    }
    .stat-card {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        height: 100%;
        transition: transform 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .stat-info {
        overflow: hidden;
        margin-left: 0.75rem;
    }
    #combined-stats-container {
        min-height: 40px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .stat-label {
        font-size: 0.7rem;
        color: var(--text-muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 2px;
    }
    .stat-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-main);
        line-height: 1;
    }
    /* Message Flow Animation */
    @keyframes flowRight {
        0% { transform: translateX(-100%); opacity: 0; }
        50% { opacity: 1; }
        100% { transform: translateX(100%); opacity: 0; }
    }
    .message-flow-line {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
        animation: flowRight 2s infinite linear;
        pointer-events: none;
    }
    .stat-card {
        position: relative;
        overflow: hidden;
    }
    .stat-card.active-flow .message-flow-line {
        display: block;
    }
    .stat-card .message-flow-line {
        display: none;
    }
</style>
</head>
<body>


    <!-- Login Modal -->
    <div id="loginPage" class="login-page">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">
                    <i class="bi bi-robot"></i>
                </div>
                 <h3>BotMatrix</h3>
                <p class="text-muted" data-i18n="login_subtitle">Áªü‰∏ÄÁÆ°ÁêÜÂπ≥Âè∞</p>
            </div>
            <form id="loginForm">
                <div class="mb-3">
                    <label class="form-label" data-i18n="username">Áî®Êà∑Âêç</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-person"></i></span>
                        <input type="text" class="form-control" id="loginUser" required data-i18n-placeholder="login_placeholder_user" placeholder="admin">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label" data-i18n="password">ÂØÜÁ†Å</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-lock"></i></span>
                        <input type="password" class="form-control" id="loginPass" required data-i18n-placeholder="login_placeholder_pass" placeholder="******">
                    </div>
                </div>
                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <span id="loginBtnText" data-i18n="login_btn">ÁôªÂΩï</span>
                        <span id="loginBtnLoading" class="spinner-border spinner-border-sm d-none"></span>
                    </button>
                </div>
            </form>
            <div id="loginError" class="alert alert-danger mt-3 d-none"></div>
            <div class="login-footer mt-4 text-center">
                <small class="text-muted">&copy; 2025 BotMatrix Team. All Rights Reserved.</small>
            </div>
        </div>
    </div>

    <!-- ÁßªÈô§ÊóßÁöÑ loginModal -->

    <!-- Mobile Nav -->
    <div class="mobile-nav">
        <button class="btn btn-outline-secondary me-3" onclick="toggleSidebar()">
            <i class="bi bi-list fs-4"></i>
        </button>
        <h5 class="m-0">BotMatrix <small class="text-muted fs-6">v1.1.84</small></h5>
    </div>
    
    <!-- Overlay -->
    <div class="overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Stats Modal -->
    <div class="modal fade" id="statsModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statsModalTitle" data-i18n="modal_stats_title">ÁªüËÆ°ËØ¶ÊÉÖ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-light sticky-top" style="top: 0">
                            <tr>
                                <th scope="col" width="60">#</th>
                                <th scope="col" id="statsModalNameHeader" data-i18n="modal_col_name">ÂêçÁß∞</th>
                                <th scope="col" width="100" class="text-end" data-i18n="modal_col_count">Êï∞Èáè</th>
                            </tr>
                        </thead>
                        <tbody id="statsModalBody">
                            <!-- Data -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" data-i18n="modal_create_user_title">ÂàõÂª∫Êñ∞Áî®Êà∑</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createUserForm">
                        <div class="mb-3">
                            <label class="form-label" data-i18n="username">Áî®Êà∑Âêç</label>
                            <input type="text" class="form-control" id="new-username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" data-i18n="password">ÂØÜÁ†Å</label>
                            <input type="password" class="form-control" id="new-password" required>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="new-is-admin">
                            <label class="form-check-label" for="new-is-admin" data-i18n="is_admin_label">ÁÆ°ÁêÜÂëòÊùÉÈôê</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="cancel_btn">ÂèñÊ∂à</button>
                    <button type="button" class="btn btn-primary" onclick="createUser()" data-i18n="confirm_create_btn">Á°ÆËÆ§ÂàõÂª∫</button>
                </div>
            </div>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="px-3 mb-4">
            <h4>üöÄ BotMatrix</h4>
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted" data-i18n="sidebar_subtitle">Enterprise Bot Manager</small>
                <span class="badge bg-secondary" style="font-size: 0.7em;">v1.1.84</span>
            </div>
        </div>
        
        <!-- Bot Selector Removed -->
        
        <nav class="nav flex-column">
            <div class="nav-section-label" data-i18n="menu_group_overview">ÊÄªËßà</div>
            <a href="#dashboard" id="nav-dashboard" class="nav-link active" onclick="showTab('dashboard')"><i class="bi bi-speedometer2"></i> <span data-i18n="sidebar_dashboard">ËøêË°åÁä∂ÊÄÅ</span></a>
            
            <div class="nav-section-label" data-i18n="menu_group_management">‰∏öÂä°ÁÆ°ÁêÜ</div>
            <a href="#bots" id="nav-bots" class="nav-link" onclick="showTab('bots')"><i class="bi bi-robot"></i> <span data-i18n="sidebar_bots">‰∫ëÁ´ØÁü©Èòµ</span></a>
            <a href="#groups" id="nav-groups" class="nav-link" onclick="showTab('groups')"><i class="bi bi-people"></i> <span data-i18n="sidebar_groups">Áæ§ÁªÑÂ•ΩÂèã</span></a>
            <a href="#routing" id="nav-routing" class="nav-link" onclick="showTab('routing')"><i class="bi bi-diagram-3"></i> <span data-i18n="sidebar_routing">Ë∑ØÁî±ÁÆ°ÁêÜ</span></a>
            <a href="#visualization" id="nav-visualization" class="nav-link" onclick="showTab('visualization')"><i class="bi bi-broadcast"></i> <span data-i18n="sidebar_visualization">ËΩ¨ÂèëÂèØËßÜÂåñ</span></a>
            
            <div class="nav-section-label" data-i18n="menu_group_infrastructure">Âü∫Á°ÄËÆæÊñΩ</div>
            <a href="#docker" id="nav-docker" class="nav-link" onclick="showTab('docker')"><i class="bi bi-box"></i> <span data-i18n="sidebar_docker">DockerÁÆ°ÁêÜ</span></a>
            <a href="/overmind/" id="nav-overmind" class="nav-link" onclick="showOvermind(event)"><i class="bi bi-grid-3x3-gap"></i> <span data-i18n="sidebar_overmind">Overmind</span></a>
            
            <div class="nav-section-label" data-i18n="menu_group_system">Á≥ªÁªüÁª¥Êä§</div>
            <a href="#monitor" id="nav-monitor" class="nav-link" onclick="showTab('monitor')"><i class="bi bi-display"></i> <span data-i18n="sidebar_monitor">Á≥ªÁªüÁõëÊéß</span></a>
            <a href="#logs" id="nav-logs" class="nav-link" onclick="showTab('logs')"><i class="bi bi-journal-text"></i> <span data-i18n="sidebar_logs">Êó•Âøó‰∏≠ÂøÉ</span></a>
            <a href="#debug" id="nav-debug" class="nav-link" onclick="showTab('debug')"><i class="bi bi-bug"></i> <span data-i18n="sidebar_debug">Ë∞ÉËØïÊµãËØï</span></a>
            <a href="#users" id="nav-users" class="nav-link admin-only" onclick="showTab('users')"><i class="bi bi-people-fill"></i> <span data-i18n="sidebar_users">Áî®Êà∑ÁÆ°ÁêÜ</span></a>
            <a href="#settings" id="nav-settings" class="nav-link admin-only" onclick="showTab('settings')"><i class="bi bi-gear"></i> <span data-i18n="sidebar_settings">Á≥ªÁªüËÆæÁΩÆ</span></a>
        </nav>

        <div class="mt-auto p-3 border-top d-flex justify-content-around align-items-center flex-wrap">
             <button class="btn btn-outline-secondary rounded-circle theme-toggle-btn-sidebar mb-2" onclick="toggleTheme()" title="Toggle Theme" data-i18n-title="theme_toggle" style="width: 38px; height: 38px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-moon-stars"></i>
            </button>
            
            <div class="dropup mb-2">
                <button class="btn btn-outline-secondary rounded-circle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Language" style="width: 38px; height: 38px; display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-translate"></i>
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="setLanguage('zh-CN')">ÁÆÄ‰Ωì‰∏≠Êñá</a></li>
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="setLanguage('zh-TW')">ÁπÅÈ´î‰∏≠Êñá</a></li>
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="setLanguage('en')">English</a></li>
                </ul>
            </div>

            <a href="https://github.com/changliaotong/BotMatrix" target="_blank" class="btn btn-outline-secondary rounded-circle github-btn-sidebar mb-2" title="View on GitHub" style="width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; text-decoration: none; padding: 0;">
                <i class="bi bi-github"></i>
            </a>

            <button class="btn btn-outline-secondary rounded-circle mb-2" onclick="logout()" title="Logout" data-i18n-title="sidebar_logout" style="width: 38px; height: 38px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-box-arrow-right"></i>
            </button>
        </div>
    </div>

    <div class="main-content">
        <!-- Dashboard Tab -->
        <div id="tab-dashboard" class="tab-content" style="display: none;">
            <!-- Stats Grid -->
            <div class="stats-grid" id="dash-system-stats">
                <!-- 1. Bots -->
                <div class="stat-card">
                    <div class="icon-circle bg-primary bg-opacity-10 text-primary">
                        <i class="bi bi-robot"></i>
                    </div>
                    <div class="stat-info w-100">
                        <div class="stat-label" data-i18n="stat_bots">Êú∫Âô®‰∫∫ (Âú®Á∫ø/Á¶ªÁ∫ø/ÊÄªÊï∞)</div>
                        <div class="stat-value">
                            <span id="metric-bots">0</span>
                            <span class="text-muted fs-6 fw-normal">/</span>
                            <span id="metric-bots-offline" class="text-muted fs-6 fw-normal">0</span>
                            <span class="text-muted fs-6 fw-normal">/</span>
                            <span id="metric-bots-total" class="text-muted fs-6 fw-normal">0</span>
                        </div>
                    </div>
                </div>

                <!-- 1.1 Workers -->
                <div class="stat-card">
                    <div class="icon-circle bg-info bg-opacity-10 text-info">
                        <i class="bi bi-cpu"></i>
                    </div>
                    <div class="stat-info w-100">
                        <div class="stat-label" data-i18n="stat_workers">Â§ÑÁêÜÁ´Ø (Workers)</div>
                        <div class="stat-value">
                            <span id="metric-workers">0</span>
                        </div>
                    </div>
                </div>

                <!-- 2. System Resources (CPU, Memory Merged) -->
                <div class="stat-card" title="Á≥ªÁªüËµÑÊ∫êËØ¶ÊÉÖ">
                    <div class="icon-circle bg-warning bg-opacity-10 text-warning">
                        <i class="bi bi-cpu-fill"></i>
                    </div>
                    <div class="stat-info w-100">
                        <div class="stat-label" id="metric-cpu-model" data-i18n="system_resource_details">Á≥ªÁªüËµÑÊ∫ê</div>
                        <div class="d-flex flex-column gap-1 mt-1">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold" style="font-size: 0.85rem;"><span data-i18n="cpu_label">CPU:</span> <span id="metric-cpu">0%</span></span>
                                <div class="progress flex-grow-1 mx-2" style="height: 4px; background-color: rgba(0,0,0,0.05);">
                                    <div id="metric-cpu-bar" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                                </div>
                                <span style="font-size: 0.7rem; color: var(--text-muted);"><span id="metric-cpu-cores">0</span><span data-i18n="cores_label">Ê†∏</span></span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold" style="font-size: 0.85rem;"><span data-i18n="mem_label">ÂÜÖÂ≠ò:</span> <span id="metric-mem">0 MB</span></span>
                                <div class="progress flex-grow-1 mx-2" style="height: 4px; background-color: rgba(0,0,0,0.05);">
                                    <div id="metric-mem-bar" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                                </div>
                                <span id="metric-mem-total" style="font-size: 0.7rem; color: var(--text-muted);">0 GB</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2.1 Operating System -->
                <div class="stat-card" style="display: none;">
                    <div class="icon-circle bg-secondary bg-opacity-10 text-secondary">
                        <i class="bi bi-window"></i>
                    </div>
                    <div class="stat-info w-100">
                        <div class="stat-label">Êìç‰ΩúÁ≥ªÁªü</div>
                        <div class="d-flex flex-column" style="font-size: 0.75rem;">
                            <span id="metric-os-plat" class="fw-bold">...</span>
                            <span id="metric-os-ver" style="font-size: 0.65rem; color: var(--text-muted);">...</span>
                        </div>
                    </div>
                </div>

                <!-- 4. Combined Stats (Goroutines, Active, Messages) -->
                <div class="stat-card" id="combined-stats-card">
                    <div class="icon-circle bg-info bg-opacity-10 text-info" id="combined-stats-icon">
                        <i class="bi bi-activity"></i>
                    </div>
                    <div class="stat-info w-100" id="combined-stats-container">
                        <!-- Content will be rotated by JS -->
                        <div class="stats-slide active" id="slide-goroutines">
                            <div class="stat-label" data-i18n="stat_goroutines">Goroutines</div>
                            <div class="stat-value" id="metric-goroutines">0</div>
                        </div>
                        <div class="stats-slide" id="slide-active" style="display: none;">
                            <div class="stat-label" data-i18n="stat_active_groups_users">Ê¥ªË∑É (Áæ§ÁªÑ / Áî®Êà∑)</div>
                            <div class="stat-value" style="font-size: 0.95rem;">
                                <span id="metric-groups-today">0</span><small class="text-muted">/</small><span id="metric-groups-total" class="text-muted fw-normal">0</span>
                                <span class="mx-1 text-muted">|</span>
                                <span id="metric-users-today">0</span><small class="text-muted">/</small><span id="metric-users-total" class="text-muted fw-normal">0</span>
                            </div>
                        </div>
                        <div class="stats-slide" id="slide-messages" style="display: none;">
                            <div class="stat-label" data-i18n="stat_messages">Ê∂àÊÅØÁªüËÆ° (Êé•Êî∂/ÂèëÈÄÅ)</div>
                            <div class="stat-value" style="font-size: 0.95rem;">
                                <span id="metric-msgs-total">0</span>
                                <span class="text-muted mx-1">/</span>
                                <span id="metric-sent-total" class="text-muted fw-normal">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4.1 Time Info -->
                <div class="stat-card">
                    <div class="icon-circle bg-primary bg-opacity-10 text-primary">
                        <i class="bi bi-clock"></i>
                    </div>
                    <div class="stat-info w-100">
                        <div class="stat-label" data-i18n="stat_runtime">ËøêË°åÊó∂Èó¥ / ÂΩìÂâçÊó∂Èó¥</div>
                        <div class="stat-value" style="font-size: 0.85rem;">
                            <span id="metric-uptime">00:00:00</span>
                            <span class="text-muted fs-6 fw-normal mx-1">|</span>
                            <span id="metric-current-time" class="text-muted fs-6 fw-normal">00:00:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-md-8">
                     <!-- Charts Row -->
                     <div class="row g-3 mb-4" id="dash-charts-row">
                        <div class="col-md-4">
                            <div class="card h-100" style="cursor: pointer;" onclick="showSystemDetails('cpu')">
                                <div class="card-header py-2 small fw-bold d-flex justify-content-between align-items-center">
                                    <span data-i18n="chart_cpu_trend">CPU Ë∂ãÂäø</span>
                                    <i class="bi bi-arrows-angle-expand text-muted"></i>
                                </div>
                                <div class="card-body p-2" style="height: 200px; position: relative;">
                                    <canvas id="cpuChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100" style="cursor: pointer;" onclick="showSystemDetails('mem')">
                                <div class="card-header py-2 small fw-bold d-flex justify-content-between align-items-center">
                                    <span data-i18n="chart_mem_trend">ÂÜÖÂ≠òË∂ãÂäø</span>
                                    <i class="bi bi-arrows-angle-expand text-muted"></i>
                                </div>
                                <div class="card-body p-2" style="height: 200px; position: relative;">
                                    <canvas id="memChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100" style="cursor: pointer;" onclick="showSystemDetails('msg')">
                                <div class="card-header py-2 small fw-bold d-flex justify-content-between align-items-center">
                                    <span data-i18n="chart_msg_throughput">Ê∂àÊÅØÂêûÂêê (Msg/Min)</span>
                                    <i class="bi bi-arrows-angle-expand text-muted"></i>
                                </div>
                        <div class="card-body p-2" style="height: 200px; position: relative;">
                            <canvas id="msgChart"></canvas>
                        </div>
                            </div>
                        </div>
                     </div>
 
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span data-i18n="top_active_groups">üèÜ ‰ªäÊó•Ê¥ªË∑ÉÁæ§ÁªÑ</span>
                                    <div>
                                        <button class="btn btn-sm btn-link text-decoration-none p-0 me-2" onclick="showAllStats('Group')" data-i18n="more">Êõ¥Â§ö</button>
                                        <span class="badge bg-primary rounded-pill">Top 5</span>
                                    </div>
                                </div>
                                <ul class="list-group list-group-flush" id="top-groups">
                                    <li class="list-group-item text-muted text-center" data-i18n="no_data">ÊöÇÊó†Êï∞ÊçÆ</li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span data-i18n="top_active_users">üó£Ô∏è ‰ªäÊó•ÈæôÁéã</span>
                                    <div>
                                        <button class="btn btn-sm btn-link text-decoration-none p-0 me-2" onclick="showAllStats('User')" data-i18n="more">Êõ¥Â§ö</button>
                                        <span class="badge bg-warning text-dark rounded-pill">Top 5</span>
                                    </div>
                                </div>
                                <ul class="list-group list-group-flush" id="top-users">
                                    <li class="list-group-item text-muted text-center" data-i18n="no_data">ÊöÇÊó†Êï∞ÊçÆ</li>
                                </ul>
                            </div>
                        </div>
                    </div>
 
                    <div class="card mb-4" id="dash-process-card">
                        <div class="card-header" data-i18n="top_processes">
                            üî• È´òÂç†Áî®ËøõÁ®ã (Top 10)
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped mb-0">
                                <thead>
                                    <tr>
                                        <th data-i18n="col_pid">PID</th>
                                        <th data-i18n="col_process">ËøõÁ®ãÂêç</th>
                                        <th data-i18n="col_cpu">CPU %</th>
                                        <th data-i18n="col_mem">ÂÜÖÂ≠ò (MB)</th>
                                    </tr>
                                </thead>
                                <tbody id="process-list">
                                    <tr><td colspan="4" class="text-center" data-i18n="loading">Âä†ËΩΩ‰∏≠...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card mb-4" id="dash-actions-card">
                        <div class="card-header" data-i18n="quick_actions">
                            Âø´Êç∑Êìç‰Ωú
                        </div>
                        <div class="card-body">
                            <button class="btn btn-outline-primary me-2" onclick="callSystemAction('reload_plugins')">
                                <i class="bi bi-arrow-repeat"></i> <span data-i18n="action_reload_plugins">ÈáçËΩΩÊèí‰ª∂</span>
                            </button>
                            <button class="btn btn-outline-secondary me-2" onclick="callSystemAction('clean_logs')">
                                <i class="bi bi-trash"></i> <span data-i18n="action_clean_logs">Ê∏ÖÁêÜÊó•Âøó</span>
                            </button>
                        </div>
                    </div>
                </div>
 
                <div class="col-md-4">
                    <div class="card h-100" id="dash-logs-card" style="background-color: var(--bg-card); border-color: var(--border-color);">
                        <div class="card-header" data-i18n="recent_activity">
                            ÊúÄËøëÊ¥ªÂä®
                        </div>
                        <div class="card-body d-flex flex-column">
                            <div id="recent-logs" class="log-box flex-grow-1"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Details View -->
        <div id="tab-view-system-details" class="content-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0"><i class="bi bi-graph-up"></i> <span data-i18n="system_resource_details">Á≥ªÁªüËµÑÊ∫êËØ¶ÊÉÖ</span></h4>
                <div>
                    <div class="btn-group me-2">
                        <button class="btn btn-outline-secondary btn-sm active" onclick="updateDetailTimeRange('1h')" data-i18n="time_1h">1Â∞èÊó∂</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="updateDetailTimeRange('24h')" data-i18n="time_24h">24Â∞èÊó∂</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="updateDetailTimeRange('7d')" data-i18n="time_7d">7Â§©</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="updateDetailTimeRange('30d')" data-i18n="time_30d">30Â§©</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="updateDetailTimeRange('1y')" data-i18n="time_1y">ÂÖ®Âπ¥</button>
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="showTab('#dashboard')" data-i18n="back_to_dashboard">ËøîÂõû‰ª™Ë°®Áõò</button>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <ul class="nav nav-tabs card-header-tabs" id="system-detail-tabs">
                                <li class="nav-item">
                                    <a class="nav-link active" href="#" onclick="switchDetailTab('cpu', event)" data-i18n="tab_cpu_load">CPU & Ë¥üËΩΩ</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#" onclick="switchDetailTab('mem', event)" data-i18n="tab_mem_usage">ÂÜÖÂ≠ò‰ΩøÁî®</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#" onclick="switchDetailTab('msg', event)" data-i18n="tab_msg_throughput">Ê∂àÊÅØÂêûÂêê</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#" onclick="switchDetailTab('disk', event)" data-i18n="tab_disk_io">Á£ÅÁõò & I/O</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#" onclick="switchDetailTab('net', event)" data-i18n="tab_net_traffic">ÁΩëÁªúÊµÅÈáè</a>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <!-- Large Chart Container -->
                            <div style="height: 400px; position: relative;">
                                <canvas id="detailChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hardware Info Grid -->
            <div class="row" id="hardware-info-grid">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Groups & Friends Tab -->
        <div id="tab-groups" class="tab-content" style="display: none;">
            <div class="d-flex justify-content-start align-items-center mb-3 gap-2">
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle d-flex align-items-center justify-content-start" type="button" id="global-bot-dropdown" data-bs-toggle="dropdown" aria-expanded="false" style="min-width: 220px;">
                     <i class="bi bi-robot me-2"></i>
                     <span id="global-bot-selected-content" class="text-truncate text-start" style="max-width: 160px;" data-i18n="select_bot_placeholder">ÈÄâÊã©Êú∫Âô®‰∫∫...</span>
                </button>
                <ul class="dropdown-menu shadow-lg" id="global-bot-list" aria-labelledby="global-bot-dropdown" style="max-height: 400px; overflow-y: auto; width: 320px;">
                    <!-- Items populated by JS -->
                </ul>
            </div>
            <input type="hidden" id="global-bot-selector" value="">
            
            <button class="btn btn-primary" onclick="refreshCurrentTabList()" title="Âà∑Êñ∞ÂàóË°®" data-i18n-title="refresh_list">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
    </div>

            <ul class="nav nav-tabs mb-3" id="relation-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="tab-groups-list-tab" data-bs-toggle="tab" data-bs-target="#tab-pane-groups" type="button" role="tab" aria-selected="true" data-i18n="group_list_title">Áæ§ÁªÑÂàóË°®</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tab-friends-list-tab" data-bs-toggle="tab" data-bs-target="#tab-pane-friends" type="button" role="tab" aria-selected="false" onclick="ensureFriendListLoaded()" data-i18n="friend_list_title">Â•ΩÂèãÂàóË°®</button>
                </li>
            </ul>
            
            <div class="tab-content" style="height: calc(100vh - 200px);">
                <!-- Groups Pane -->
                <div class="tab-pane fade show active h-100" id="tab-pane-groups" role="tabpanel">
                    <div class="row h-100">
                        <!-- Left: Group List -->
                        <div class="col-md-4 h-100 group-manage-col">
                            <div class="card h-100 d-flex flex-column">
                                <div class="card-header">
                                    <input type="text" class="form-control mb-2" id="group-search" placeholder="ÊêúÁ¥¢Áæ§ÁªÑ..." data-i18n="search_groups_placeholder" onkeyup="filterGroups()">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted"><span data-i18n="sort_by">ÊéíÂ∫è:</span></small>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-secondary active" onclick="sortGroups('name')" id="btn-sort-group-name" data-i18n="sort_name">ÂêçÁß∞</button>
                                            <button class="btn btn-outline-secondary" onclick="sortGroups('count')" id="btn-sort-group-count" data-i18n="sort_count">‰∫∫Êï∞</button>
                                            <button class="btn btn-outline-secondary" onclick="sortGroups('msg_today')" id="btn-sort-group-msg_today" data-i18n="sort_today">‰ªäÊó•</button>
                                            <button class="btn btn-outline-secondary" onclick="sortGroups('id')" id="btn-sort-group-id" data-i18n="sort_id">ID</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body p-0" style="overflow-y: auto;">
                                    <div class="list-group list-group-flush" id="group-list">
                                        <div class="text-center p-4 text-muted" data-i18n="select_bot_first">ËØ∑ÂÖàÈÄâÊã©Êú∫Âô®‰∫∫Âπ∂Âà∑Êñ∞</div>
                                    </div>
                                </div>
                                <div class="card-footer text-muted small" id="group-count">
                                    <span data-i18n="total_groups_count">ÂÖ± 0 ‰∏™Áæ§ÁªÑ</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right: Group Details -->
                        <div class="col-md-8 h-100 group-manage-col">
                            <div class="card h-100" id="group-detail-empty">
                                <div class="card-body d-flex align-items-center justify-content-center text-muted">
                                    <div class="text-center">
                                        <i class="bi bi-chat-square-text fs-1"></i>
                                        <p class="mt-2" data-i18n="select_group_to_view">ËØ∑‰ªéÂ∑¶‰æßÈÄâÊã©‰∏Ä‰∏™Áæ§ÁªÑÊü•ÁúãËØ¶ÊÉÖ</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card h-100 d-flex flex-column" id="group-detail-content" style="display: none !important;">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <img id="current-group-avatar" src="" class="rounded-circle me-2" style="width: 32px; height: 32px; display: none;">
                                        <div class="d-flex flex-column">
                                            <h5 class="mb-0" id="current-group-name" data-i18n="group_name_default">Áæ§ÁªÑÂêçÁß∞</h5>
                                            <small class="text-muted" id="current-group-stats" style="font-size: 0.75rem;" data-i18n="group_stats_default">‰ªäÊó•: 0 / ÊÄªËÆ°: 0</small>
                                        </div>
                                    </div>
                                    <span class="badge bg-secondary" id="current-group-id">123456</span>
                                </div>
                                
                                <!-- Chat/Members Area -->
                                <div class="card-body d-flex flex-column p-0" style="overflow: hidden;">
                                    <ul class="nav nav-tabs nav-justified" id="group-tabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="members-tab" data-bs-toggle="tab" data-bs-target="#members-view" type="button" data-i18n="tab_members">ÊàêÂëòÂàóË°®</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="actions-tab" data-bs-toggle="tab" data-bs-target="#actions-view" type="button" data-i18n="tab_actions">Âø´Êç∑Êìç‰Ωú</button>
                                        </li>
                                    </ul>
                                    
                                    <div class="tab-content flex-grow-1" style="overflow-y: auto;">
                                        <!-- Members View -->
                                        <div class="tab-pane fade show active p-0" id="members-view">
                                            <div class="p-2 border-bottom bg-light">
                                                <input type="text" class="form-control form-control-sm" id="member-search" placeholder="ÊêúÁ¥¢ÊàêÂëò(ÊòµÁß∞/ÂêçÁâá/ID)..." data-i18n="search_members_placeholder" onkeyup="renderMembers()">
                                            </div>
                                            <table class="table table-hover mb-0">
                                                <thead class="table-light sticky-top">
                                                    <tr>
                                                        <th style="cursor: pointer;" onclick="sortMembers('card')"><span data-i18n="col_member_name">ÊòµÁß∞/Áæ§ÂêçÁâá</span> <i class="bi bi-sort-alpha-down" id="sort-icon-card"></i></th>
                                                        <th style="cursor: pointer;" onclick="sortMembers('id')"><span data-i18n="col_member_id">QQ/WXID</span> <i class="bi" id="sort-icon-id"></i></th>
                                                        <th style="cursor: pointer;" onclick="sortMembers('role')"><span data-i18n="col_member_role">ËßíËâ≤</span> <i class="bi" id="sort-icon-role"></i></th>
                                                        <th style="cursor: pointer;" onclick="sortMembers('msg_today')"><span data-i18n="col_member_msg">‰ªäÊó•/ÊÄªËÆ° (ÂÖ®Áæ§)</span> <i class="bi" id="sort-icon-msg_today"></i></th>
                                                        <th style="cursor: pointer;" onclick="sortMembers('time')"><span data-i18n="col_member_last_seen">ÊúÄÂêéÂèëË®Ä</span> <i class="bi" id="sort-icon-time"></i></th>
                                                        <th data-i18n="col_action">Êìç‰Ωú</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="member-list-body">
                                                    <!-- Members here -->
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                        <!-- Actions View -->
                                        <div class="tab-pane fade p-3" id="actions-view">
                                            <div class="mb-3">
                                                <label class="form-label" data-i18n="send_group_msg">ÂèëÈÄÅÁæ§Ê∂àÊÅØ</label>
                                                <textarea class="form-control" id="group-msg-input" rows="4" placeholder="Âú®Ê≠§ËæìÂÖ•Ê∂àÊÅØÂÜÖÂÆπ..." data-i18n="enter_msg_placeholder"></textarea>
                                                
                                                <div class="form-check mt-2">
                                                    <input class="form-check-input" type="checkbox" id="auto-recall-check" onchange="toggleAutoRecallInput()">
                                                    <label class="form-check-label" for="auto-recall-check" data-i18n="auto_recall_label">
                                                        ÂèëÈÄÅÂêéËá™Âä®Êí§Âõû
                                                    </label>
                                                </div>
                                                <div class="input-group input-group-sm mt-1 mb-2" id="auto-recall-input-group" style="display: none;">
                                                    <span class="input-group-text" data-i18n="recall_delay_label">Âª∂ËøüÊí§Âõû(Áßí)</span>
                                                    <input type="number" class="form-control" id="auto-recall-delay" value="0" min="0" max="120" placeholder="0 = Á´ãÂç≥Êí§Âõû" data-i18n-placeholder="recall_delay_placeholder">
                                                    <span class="input-group-text text-muted" style="font-size: 0.8em;" data-i18n="recall_limit_hint">È¢ëÈÅìÈôê120s</span>
                                                </div>

                                                <div class="d-flex gap-2 mt-2">
                                                    <button class="btn btn-primary" onclick="sendGroupMsg()">
                                                        <i class="bi bi-send"></i> <span data-i18n="btn_send">ÂèëÈÄÅ</span>
                                                    </button>
                                                    <button class="btn btn-info text-white" onclick="sendSmartGroupMsg()">
                                                        <i class="bi bi-lightning-charge"></i> <span data-i18n="btn_smart_send">Êô∫ËÉΩÂèëÈÄÅ (WakeUp)</span>
                                                    </button>
                                                </div>
                                                <small class="text-muted d-block mt-1">Êô∫ËÉΩÂèëÈÄÅ: ÂΩìÊú∫Âô®‰∫∫Êó†Ê≥ïÁõ¥Êé•ÂõûÂ§çÊó∂(Â¶ÇÈ¢ëÈÅìÊú∫Âô®‰∫∫ËøáÊúü)Ôºå‰ºöÂ∞ùËØïÂî§ÈÜíÂÖ∂‰ªñÊú∫Âô®‰∫∫ÂçèÂä©„ÄÇ</small>
                                            </div>
                                            <hr>
                                            <div class="mb-3">
                                                <label class="form-label" data-i18n="check_member_label">Êü•ËØ¢Áæ§ÊàêÂëò</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="check-member-input" placeholder="ËæìÂÖ•Áî®Êà∑ ID (QQÂè∑)" data-i18n-placeholder="check_member_placeholder">
                                                    <button class="btn btn-outline-primary" type="button" onclick="checkGroupMember()" data-i18n="btn_check">Êü•ËØ¢</button>
                                                </div>
                                                <div id="check-member-result" class="form-text mt-1" style="min-height: 20px;"></div>
                                            </div>
                                            <hr>
                                            <div class="mb-3">
                                                <label class="form-label text-danger" data-i18n="danger_zone">Âç±Èô©Êìç‰Ωú</label>
                                                <div>
                                                    <button class="btn btn-outline-danger btn-sm" onclick="leaveGroup()" data-i18n="btn_leave_group">ÈÄÄÂá∫ËØ•Áæ§</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Friends Pane -->
                <div class="tab-pane fade h-100" id="tab-pane-friends" role="tabpanel">
                    <div class="row h-100">
                        <!-- Left: Friend List -->
                        <div class="col-md-4 h-100">
                            <div class="card h-100 d-flex flex-column">
                                <div class="card-header bg-white">
                                    <input type="text" class="form-control mb-2" id="friend-search" placeholder="ÊêúÁ¥¢Â•ΩÂèã..." data-i18n="search_friends_placeholder" onkeyup="filterFriends()">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted"><span data-i18n="sort_by">ÊéíÂ∫è:</span></small>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-secondary active" onclick="sortFriends('name')" id="btn-sort-friend-name" data-i18n="sort_name">ÂêçÁß∞</button>
                                            <button class="btn btn-outline-secondary" onclick="sortFriends('id')" id="btn-sort-friend-id" data-i18n="sort_id">ID</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body p-0" style="overflow-y: auto;">
                                    <div class="list-group list-group-flush" id="friend-list">
                                        <div class="text-center p-4 text-muted" data-i18n="select_bot_first">ËØ∑ÂÖàÈÄâÊã©Êú∫Âô®‰∫∫Âπ∂Âà∑Êñ∞</div>
                                    </div>
                                </div>
                                <div class="card-footer text-muted small" id="friend-count">
                                    <span data-i18n="total_friends_count_default">ÂÖ± 0 ‰∏™Â•ΩÂèã</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right: Friend Details -->
                        <div class="col-md-8 h-100">
                            <div class="card h-100" id="friend-detail-empty">
                                <div class="card-body d-flex align-items-center justify-content-center text-muted">
                                    <div class="text-center">
                                        <i class="bi bi-person fs-1"></i>
                                        <p class="mt-2" data-i18n="select_friend_to_view">ËØ∑‰ªéÂ∑¶‰æßÈÄâÊã©‰∏Ä‰∏™Â•ΩÂèãÊü•ÁúãËØ¶ÊÉÖ</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card h-100 d-flex flex-column" id="friend-detail-content" style="display: none !important;">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0" id="current-friend-name" data-i18n="friend_name_default">Â•ΩÂèãÂêçÁß∞</h5>
                                    <span class="badge bg-secondary" id="current-friend-id">123456</span>
                                </div>
                                
                                <div class="card-body p-3">
                                    <div class="mb-3">
                                        <label class="form-label" data-i18n="send_private_msg">ÂèëÈÄÅÁßÅËÅäÊ∂àÊÅØ</label>
                                        <textarea class="form-control" id="friend-msg-input" rows="4" placeholder="Âú®Ê≠§ËæìÂÖ•Ê∂àÊÅØÂÜÖÂÆπ..." data-i18n-placeholder="input_message_content"></textarea>
                                        <button class="btn btn-primary mt-2" onclick="sendFriendMsg()">
                                            <i class="bi bi-send"></i> <span data-i18n="send">ÂèëÈÄÅ</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bots Tab -->
        <div id="tab-bots" class="content-section" style="display:none;">
            <div class="row g-4">
                <!-- Left Column: Bots -->
                <div class="col-xl-7 col-lg-6">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-robot me-2"></i><span data-i18n="tab_access_bots">Êé•ÂÖ•Á´Ø (Bots)</span> <span id="badge-bots" class="badge bg-secondary ms-1">0</span></h5>
                            <div class="d-flex gap-2">
                                <input type="text" class="form-control form-control-sm" placeholder="ÊêúÁ¥¢Êú∫Âô®‰∫∫..." data-i18n-placeholder="search_bots_placeholder" style="width: 150px;" onkeyup="filterBots(this.value)">
                                <button class="btn btn-sm btn-outline-primary" onclick="fetchBots()" data-i18n="refresh">Âà∑Êñ∞</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="d-flex flex-wrap gap-2 mb-3">
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary" onclick="sortBots('name')" id="btn-sort-bot-name" data-i18n="sort_name">ÂêçÁß∞</button>
                                    <button class="btn btn-outline-secondary" onclick="sortBots('id')" id="btn-sort-bot-id" data-i18n="sort_id">ID</button>
                                    <button class="btn btn-outline-secondary" onclick="sortBots('platform')" id="btn-sort-bot-platform" data-i18n="sort_protocol">ÂçèËÆÆ</button>
                                    <button class="btn btn-outline-secondary" onclick="sortBots('count')" id="btn-sort-bot-count" data-i18n="sort_group_count">Áæ§Êï∞</button>
                                    <button class="btn btn-outline-secondary" onclick="sortBots('msg')" id="btn-sort-bot-msg" data-i18n="sort_messages">Ê∂àÊÅØ</button>
                                    <button class="btn btn-outline-secondary" onclick="sortBots('time')" id="btn-sort-bot-time" data-i18n="sort_time">Êó∂Èó¥</button>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary active" id="btn-bot-view-detail" onclick="setBotViewMode('detail')" title="ËØ¶ÁªÜÊ®°Âºè" data-i18n-title="view_mode_detail"><i class="bi bi-card-text"></i></button>
                                    <button class="btn btn-outline-secondary" id="btn-bot-view-compact" onclick="setBotViewMode('compact')" title="Á≤æÁÆÄÊ®°Âºè" data-i18n-title="view_mode_compact"><i class="bi bi-grid-fill"></i></button>
                                </div>
                            </div>
                            <div class="row g-3" id="bot-list-container" style="max-height: calc(100vh - 350px); overflow-y: auto;">
                                <!-- Bot Cards -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Workers -->
                <div class="col-xl-5 col-lg-6">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-cpu me-2"></i><span data-i18n="tab_process_workers">Â§ÑÁêÜÁ´Ø (Workers)</span> <span id="badge-workers" class="badge bg-secondary ms-1">0</span></h5>
                            <div class="d-flex gap-2">
                                <input type="text" class="form-control form-control-sm" placeholder="ÊêúÁ¥¢Worker..." data-i18n-placeholder="search_workers_placeholder" style="width: 150px;" onkeyup="filterWorkers(this.value)">
                                <button class="btn btn-sm btn-outline-primary" onclick="fetchWorkers()" data-i18n="refresh">Âà∑Êñ∞</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="d-flex flex-wrap gap-2 mb-3">
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary" onclick="sortWorkers('addr')" id="btn-sort-worker-addr" data-i18n="sort_address">Âú∞ÂùÄ</button>
                                    <button class="btn btn-outline-secondary" onclick="sortWorkers('time')" id="btn-sort-worker-time" data-i18n="sort_time">Êó∂Èó¥</button>
                                    <button class="btn btn-outline-secondary" onclick="sortWorkers('msg')" id="btn-sort-worker-msg" data-i18n="sort_processed">Â§ÑÁêÜ</button>
                                    <button class="btn btn-outline-secondary" onclick="sortWorkers('status')" id="btn-sort-worker-status" data-i18n="sort_status">Áä∂ÊÄÅ</button>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary active" id="btn-worker-view-detail" onclick="setWorkerViewMode('detail')" title="ËØ¶ÁªÜÊ®°Âºè" data-i18n-title="view_mode_detail"><i class="bi bi-card-text"></i></button>
                                    <button class="btn btn-outline-secondary" id="btn-worker-view-compact" onclick="setWorkerViewMode('compact')" title="Á≤æÁÆÄÊ®°Âºè" data-i18n-title="view_mode_compact"><i class="bi bi-grid-fill"></i></button>
                                </div>
                            </div>
                            <div class="row g-3" id="worker-list-container" style="max-height: calc(100vh - 350px); overflow-y: auto;">
                                <!-- Worker Cards -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Monitor (Merged Events & Logs) -->
        <div id="tab-monitor" class="tab-content" style="display:none; height: calc(100vh - 80px);">
            <ul class="nav nav-tabs mb-3" id="monitor-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="monitor-events-tab" data-bs-toggle="tab" data-bs-target="#view-events" type="button" role="tab" data-i18n="monitor_events">ÂÆûÊó∂Ê∂àÊÅØ</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="monitor-logs-tab" data-bs-toggle="tab" data-bs-target="#view-logs" type="button" role="tab" onclick="fetchLogs()" data-i18n="monitor_logs">Á≥ªÁªüÊó•Âøó</button>
                </li>
            </ul>
            
            <div class="tab-content h-100">
                <!-- Real-time Events -->
                <div class="tab-pane fade show active h-100" id="view-events" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0" data-i18n="monitor_events_title">ÂÆûÊó∂Ê∂àÊÅØÁõëÊéß</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-danger" onclick="clearEvents()" data-i18n="clear">Ê∏ÖÁ©∫</button>
                            <div class="form-check form-switch d-inline-block ms-2">
                                <input class="form-check-input" type="checkbox" id="auto-scroll-events" checked>
                                <label class="form-check-label" for="auto-scroll-events" data-i18n="auto_scroll">Ëá™Âä®ÊªöÂä®</label>
                            </div>
                            <span id="ws-status" class="badge bg-secondary ms-2">Disconnected</span>
                        </div>
                    </div>
                    <div class="log-box" id="event-container" style="height: calc(100% - 60px);">
                        <div class="text-muted text-center mt-5" data-i18n="waiting_events_connection">Á≠âÂæÖ‰∫ã‰ª∂ËøûÊé•...</div>
                    </div>
                </div>

                <!-- Logs -->
                <div class="tab-pane fade h-100" id="view-logs" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0" data-i18n="system_logs_title">Á≥ªÁªüÊó•Âøó</h5>
                        <div class="d-flex align-items-center">
                            <select class="form-select form-select-sm me-2" id="log-bot-selector" style="width: auto; min-width: 150px;" onchange="fetchLogs()">
                                <option value="">ÂÖ®ÈÉ® (All)</option>
                                <option value="system">BotNexus System</option>
                            </select>
                            <button class="btn btn-sm btn-outline-secondary" onclick="fetchLogs()" data-i18n="refresh">Âà∑Êñ∞</button>
                            <div class="form-check form-switch d-inline-block ms-2">
                                <input class="form-check-input" type="checkbox" id="auto-refresh-logs" checked>
                                <label class="form-check-label" for="auto-refresh-logs" data-i18n="auto_refresh">Ëá™Âä®Âà∑Êñ∞</label>
                            </div>
                        </div>
                    </div>
                    <div class="log-box" id="log-container" style="height: calc(100% - 60px);">
                        <!-- Logs -->
                    </div>
                </div>
            </div>
        </div>


        <!-- Overmind Tab -->
        <div id="tab-overmind" class="content-section" style="display: none; height: calc(100vh - 100px);">
            <iframe id="overmind-iframe" src="" style="width: 100%; height: 100%; border: none; border-radius: 0.75rem;"></iframe>
        </div>

        <!-- Docker Tab -->
        <div id="tab-docker" class="content-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0" data-i18n="sidebar_docker">DockerÁÆ°ÁêÜ</h4>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="addBotContainer()">
                        <i class="bi bi-plus-lg"></i> <span data-i18n="docker_add_bot">Ê∑ªÂä†Êú∫Âô®‰∫∫</span>
                    </button>
                    <button class="btn btn-sm btn-outline-success me-2" onclick="addWorkerContainer()">
                        <i class="bi bi-plus-lg"></i> <span data-i18n="docker_add_node">Ê∑ªÂä†ËäÇÁÇπ</span>
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="loadDockerContainers()">
                        <i class="bi bi-arrow-clockwise"></i> <span data-i18n="refresh">Âà∑Êñ∞</span>
                    </button>
                </div>
            </div>
            <div class="card">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th data-i18n="docker_container_id">ID</th>
                                <th>Names</th>
                                <th data-i18n="docker_image">Image</th>
                                <th data-i18n="docker_status">State</th>
                                <th data-i18n="docker_status">Status</th>
                                <th data-i18n="docker_action">Action</th>
                            </tr>
                        </thead>
                        <tbody id="docker-container-list">
                            <tr><td colspan="6" class="text-center text-muted" data-i18n="loading">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Routing Tab -->
        <div id="tab-routing" class="content-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="d-flex align-items-center">
                    <h4 class="mb-0 me-2" data-i18n="sidebar_routing">Ë∑ØÁî±ÁÆ°ÁêÜ</h4>
                    <button class="btn btn-sm btn-outline-info" onclick="toggleRoutingHelp()" data-i18n-title="routing_help_tooltip" title="‰ΩøÁî®ËØ¥Êòé">
                        <i class="bi bi-question-circle"></i>
                    </button>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="showAddRoutingRuleDialog()">
                        <i class="bi bi-plus-lg"></i> <span data-i18n="routing_add_rule">Ê∑ªÂä†Ë∑ØÁî±ËßÑÂàô</span>
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="fetchRoutingRules()">
                        <i class="bi bi-arrow-clockwise"></i> <span data-i18n="refresh">Âà∑Êñ∞</span>
                    </button>
                </div>
            </div>

            <!-- Ë∑ØÁî±ËßÑÂàô‰ΩøÁî®ËØ¥Êòé -->
            <div class="alert alert-info mb-4" id="routing-help-section" style="display: none;">
                <div class="d-flex align-items-start">
                    <i class="bi bi-info-circle-fill me-2 mt-1"></i>
                    <div>
                        <h6 class="alert-heading mb-2" data-i18n="routing_usage_title">üìã Ë∑ØÁî±ËßÑÂàô‰ΩøÁî®ËØ¥Êòé</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong data-i18n="routing_pattern_format">üéØ ÂåπÈÖçÊ®°ÂºèÊ†ºÂºèÔºö</strong></p>
                                <ul class="small mb-2">
                                <li><code>user_123456</code> - Á≤æÁ°ÆÂåπÈÖçÁî®Êà∑IDÔºà123456Ôºâ</li>
                                <li><code>group_789012</code> - Á≤æÁ°ÆÂåπÈÖçÁæ§ÁªÑIDÔºà789012Ôºâ</li>
                                <li><code>*_test</code> - ÈÄöÈÖçÁ¨¶ÂåπÈÖçÔºà‰ª•_testÁªìÂ∞æÔºâ</li>
                                <li><code>123*</code> - ÈÄöÈÖçÁ¨¶ÂåπÈÖçÔºà‰ª•123ÂºÄÂ§¥Ôºâ</li>
                            </ul>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong data-i18n="routing_target_format">üîÑ ÁõÆÊ†áËäÇÁÇπÊ†ºÂºèÔºö</strong></p>
                            <ul class="small mb-2">
                                <li><code>worker_1</code> - ÊåáÂÆöÂ∑•‰ΩúËäÇÁÇπ</li>
                                <li><code>worker_2</code> - ÊåáÂÆöÂ∑•‰ΩúËäÇÁÇπ</li>
                                <li><code>default</code> - ÈªòËÆ§Â§ÑÁêÜËäÇÁÇπ</li>
                            </ul>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <p class="mb-1"><strong data-i18n="routing_priority_rules">‚ö° ‰ºòÂÖàÁ∫ßËßÑÂàôÔºö</strong></p>
                                <ul class="small mb-0">
                                    <li>Á≤æÁ°ÆÂåπÈÖç > ÈÄöÈÖçÁ¨¶ÂåπÈÖç</li>
                                    <li>ÂÖàÊ∑ªÂä†ÁöÑËßÑÂàô‰ºòÂÖàÂåπÈÖç</li>
                                    <li>Êó†ÂåπÈÖçÊó∂‰ΩøÁî®ÈªòËÆ§Â§ÑÁêÜ</li>
                                </ul>
                            </div>
                        </div>
                        <hr>
                        <p class="small mb-0" data-i18n="routing_example_usage">üí° Á§∫‰æãÔºöÂ∞ÜÁî®Êà∑123456ÁöÑÊ∂àÊÅØË∑ØÁî±Âà∞worker_1Â§ÑÁêÜÔºåËÆæÁΩÆÂåπÈÖçÊ®°Âºè‰∏∫"user_123456"ÔºåÁõÆÊ†áËäÇÁÇπ‰∏∫"worker_1"</p>
                    </div>
                </div>
            </div>
            
            <div class="row" id="routing-list-container">
                <!-- Routing Rule Cards -->
                <div class="col-12 text-center text-muted">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2" data-i18n="loading_routing_rules">Ê≠£Âú®Âä†ËΩΩË∑ØÁî±ËßÑÂàô...</p>
                </div>
            </div>
        </div>

        <!-- Visualization Tab -->
        <div id="tab-visualization" class="content-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0"><i class="bi bi-broadcast"></i> <span data-i18n="sidebar_visualization">ËΩ¨ÂèëÂèØËßÜÂåñ</span></h4>
                <div class="d-flex gap-3 align-items-center">
                    <div class="text-muted small">
                        <span class="badge bg-primary me-1" style="width: 12px; height: 12px; padding: 0; display: inline-block;"> </span> <span data-i18n="viz_bot">Bot</span>
                        <span class="badge bg-success ms-2 me-1" style="width: 12px; height: 12px; padding: 0; display: inline-block;"> </span> <span data-i18n="viz_nexus">Nexus</span>
                        <span class="badge bg-warning ms-2 me-1" style="width: 12px; height: 12px; padding: 0; display: inline-block;"> </span> <span data-i18n="viz_worker">Worker</span>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearVisualization()">
                        <i class="bi bi-trash"></i> <span data-i18n="clear">Ê∏ÖÈô§</span>
                    </button>
                </div>
            </div>
            <div id="visualization-container">
                <canvas id="viz-canvas"></canvas>
                <div id="viz-nodes"></div>
            </div>
        </div>

        <!-- Logs Tab (Full Page) -->
        <div id="tab-logs" class="content-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0" data-i18n="log_center">Êó•Âøó‰∏≠ÂøÉ</h4>
                <div class="d-flex align-items-center">
                    <select class="form-select form-select-sm me-2" id="log-bot-selector-full" style="width: auto; min-width: 200px;" onchange="fetchLogsFull()">
                        <option value="">ÂÖ®ÈÉ® (All)</option>
                        <option value="system">BotNexus System</option>
                    </select>
                    <button class="btn btn-sm btn-outline-secondary" onclick="fetchLogsFull()" data-i18n="refresh">Âà∑Êñ∞</button>
                    <div class="form-check form-switch d-inline-block ms-3">
                        <input class="form-check-input" type="checkbox" id="auto-refresh-logs-full" checked>
                        <label class="form-check-label" for="auto-refresh-logs-full" data-i18n="auto_refresh">Ëá™Âä®Âà∑Êñ∞</label>
                    </div>
                </div>
            </div>
            
            <div class="card h-100" style="height: calc(100vh - 150px) !important;">
                <div class="card-body p-0 d-flex flex-column h-100">
                    <div class="log-box flex-grow-1" id="log-container-full" style="border: none; border-radius: 0 0 0.75rem 0.75rem;">
                        <!-- Logs -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Debug & Test (Merged) -->
        <div id="tab-debug" class="content-section" style="display:none;">
            <h4 class="mb-4" data-i18n="debug_test_title">Ë∞ÉËØïÊµãËØï</h4>
            
            <ul class="nav nav-tabs mb-3" id="debug-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="debug-visual-tab" data-bs-toggle="tab" data-bs-target="#debug-visual" type="button" role="tab" data-i18n="debug_msg_builder">Ê∂àÊÅØÊûÑÈÄ†</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="debug-raw-tab" data-bs-toggle="tab" data-bs-target="#debug-raw" type="button" role="tab" data-i18n="debug_api_test">Êé•Âè£Ë∞ÉËØï</button>
                </li>
            </ul>

            <div class="tab-content">
                <!-- Visual Sender -->
                <div class="tab-pane fade show active" id="debug-visual" role="tabpanel">
                    <div class="row">
                        <div class="col-md-7">
                            <div class="card mb-3">
                                <div class="card-header" data-i18n="send_message_card_title">ÂèëÈÄÅÊ∂àÊÅØ</div>
                                <div class="card-body">
                                    <form id="msg-test-form" onsubmit="return false;">
                                        <div class="mb-3">
                                            <label class="form-label" data-i18n="target_uid_label">ÁõÆÊ†áÁî®Êà∑/Áæ§ÁªÑ UID</label>
                                            <div class="input-group mb-2">
                                                <select class="form-select" id="mt-group-select" onchange="onTestGroupSelectChange()">
                                                    <option value="" data-i18n="select_group_placeholder">-- ÈÄâÊã©Áæ§ÁªÑ (ÊàñÊâãÂä®ËæìÂÖ• UID) --</option>
                                                </select>
                                                <button class="btn btn-outline-secondary" type="button" onclick="loadTestGroups()" title="Âà∑Êñ∞Áæ§ÁªÑÂàóË°®"><i class="bi bi-arrow-clockwise"></i></button>
                                            </div>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="mt-target" placeholder="Áæ§Âè∑ (Group ID) Êàñ QQÂè∑ (User ID)" data-i18n-placeholder="target_uid_placeholder" oninput="updateCodePreview()">
                                                <button class="btn btn-outline-secondary" type="button" onclick="pasteTargetUid()" data-i18n="paste_selected">Á≤òË¥¥ÈÄâ‰∏≠</button>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label" data-i18n="message_type_label">Ê∂àÊÅØÁ±ªÂûã</label>
                                            <select class="form-select" id="mt-type" onchange="updateMsgForm(); updateCodePreview()">
                                                <option value="text" data-i18n="msg_type_text">ÊñáÊú¨ (Text / CQ Code)</option>
                                                <option value="image" data-i18n="msg_type_image">ÂõæÁâá (Image)</option>
                                                <option value="record" data-i18n="msg_type_record">ËØ≠Èü≥ (Record)</option>
                                                <option value="video" data-i18n="msg_type_video">ËßÜÈ¢ë (Video)</option>
                                                <option value="music" data-i18n="msg_type_music">Èü≥‰πêÂàÜ‰∫´ (Music)</option>
                                                <option value="share" data-i18n="msg_type_share">ÈìæÊé•ÂàÜ‰∫´ (Share)</option>
                                                <option value="poke" data-i18n="msg_type_poke">Êà≥‰∏ÄÊà≥ (Poke)</option>
                                                <option value="json" data-i18n="msg_type_json">JSON Âç°Áâá</option>
                                                <option value="xml" data-i18n="msg_type_xml">XML Âç°Áâá</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Text Input -->
                                        <div id="mt-group-text" class="mb-3">
                                            <label class="form-label" data-i18n="message_content_label">ÂÜÖÂÆπ</label>
                                            <textarea class="form-control" id="mt-content" rows="3" placeholder="ËæìÂÖ•ÊñáÊú¨ÂÜÖÂÆπ..." data-i18n-placeholder="enter_text_content_placeholder" oninput="updateCodePreview()"></textarea>
                                        </div>
                                        
                                        <!-- File/Image Input -->
                                        <div id="mt-group-file" class="mb-3" style="display:none;">
                                            <label class="form-label" id="mt-file-label" data-i18n="file_image_url_label">Êñá‰ª∂/ÂõæÁâá URL</label>
                                            <input type="text" class="form-control" id="mt-file-path" placeholder="http://... or file://..." data-i18n-placeholder="file_url_placeholder" oninput="updateCodePreview()">
                                        </div>
        
                                        <!-- Music Input -->
                                <div id="mt-group-music" class="mb-3" style="display:none;">
                                    <label class="form-label" data-i18n="music_share_label">Èü≥‰πêÂàÜ‰∫´</label>
                                    <div class="input-group mb-2">
                                        <span class="input-group-text" data-i18n="platform_label">Âπ≥Âè∞</span>
                                        <select class="form-select" id="mt-music-type" onchange="updateCodePreview()">
                                            <option value="qq" data-i18n="platform_qq">QQÈü≥‰πê</option>
                                            <option value="163" data-i18n="platform_163">ÁΩëÊòì‰∫ëÈü≥‰πê</option>
                                            <option value="migu" data-i18n="platform_migu">Âí™ÂíïÈü≥‰πê</option>
                                        </select>
                                    </div>
                                    <div class="input-group">
                                        <span class="input-group-text" data-i18n="song_id_label">Ê≠åÊõ≤ID</span>
                                        <input type="text" class="form-control" id="mt-music-id" placeholder="‰æãÂ¶Ç: 123456" oninput="updateCodePreview()">
                                    </div>
                                </div>
        
                                        <!-- Share Input -->
                                        <div id="mt-group-share" class="mb-3" style="display:none;">
                                            <label class="form-label" data-i18n="link_share_label">ÈìæÊé•ÂàÜ‰∫´</label>
                                            <input type="text" class="form-control mb-2" id="mt-share-url" placeholder="Ë∑≥ËΩ¨ URL" data-i18n-placeholder="redirect_url_placeholder" oninput="updateCodePreview()">
                                            <input type="text" class="form-control mb-2" id="mt-share-title" placeholder="Ê†áÈ¢ò" data-i18n-placeholder="title_placeholder" oninput="updateCodePreview()">
                                            <input type="text" class="form-control mb-2" id="mt-share-content" placeholder="ÂÜÖÂÆπÊèèËø∞" data-i18n-placeholder="content_desc_placeholder" oninput="updateCodePreview()">
                                            <input type="text" class="form-control" id="mt-share-image" placeholder="Â∞ÅÈù¢ÂõæÁâá URL" data-i18n-placeholder="cover_image_url_placeholder" oninput="updateCodePreview()">
                                        </div>
                                        
                                        <!-- JSON/XML Input -->
                                        <div id="mt-group-raw" class="mb-3" style="display:none;">
                                            <label class="form-label" id="mt-raw-label" data-i18n="raw_content_label">ÂÜÖÂÆπ</label>
                                            <textarea class="form-control font-monospace" id="mt-raw-content" rows="5" placeholder='{"app":"com.tencent.miniapp", ...}' oninput="updateCodePreview()"></textarea>
                                        </div>
                                        
                                        <div class="d-grid">
                                            <button class="btn btn-primary" onclick="submitTestMsg()" data-i18n="send_msg">ÂèëÈÄÅÊ∂àÊÅØ</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="card mb-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span data-i18n="code_preview_title">‰ª£Á†ÅÈ¢ÑËßà (JSON)</span>
                                    <button class="btn btn-sm btn-outline-secondary py-0" onclick="copyCodePreview()" data-i18n="copy">Â§çÂà∂</button>
                                </div>
                                <div class="card-body bg-light p-0 position-relative">
                                    <pre id="code-preview" class="p-3 mb-0" style="white-space: pre-wrap; font-size: 0.8rem; color: #d63384; max-height: 300px; overflow-y: auto;">{}</pre>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header" data-i18n="send_result_title">ÂèëÈÄÅÁªìÊûú</div>
                                <div class="card-body p-3">
                                     <div id="mt-result" class="alert alert-secondary mb-0" role="alert" style="display:none;"></div>
                                </div>
                            </div>
                            <div class="mt-3 text-muted small">
                                <ul>
                                    <li data-i18n="debug_help_1">Âú®Ê≠§È°µÈù¢ÂèØËßÜÂåñÁöÑÊûÑÈÄ†Ê∂àÊÅØÔºåÂπ∂ÂÆûÊó∂Êü•ÁúãÂØπÂ∫îÁöÑ JSON Êï∞ÊçÆÁªìÊûÑ„ÄÇ</li>
                                    <li data-i18n="debug_help_2">ÊîØÊåÅ OneBot 11 Ê†áÂáÜÊ∂àÊÅØÁ±ªÂûã„ÄÇ</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Raw API -->
                <div class="tab-pane fade" id="debug-raw" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header" data-i18n="send_action_title">ÂèëÈÄÅ Action</div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label" data-i18n="bot_id_label">Bot ID</label>
                                        <input type="text" class="form-control" id="action-bot-id" placeholder="ÁïôÁ©∫ÂàôÈöèÊú∫ÈÄâÊã©" data-i18n-placeholder="action_bot_id_placeholder">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label" data-i18n="action_name_label">Action Name</label>
                                        <input type="text" class="form-control" id="action-name" value="send_group_msg">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label" data-i18n="action_params_label">Params (JSON)</label>
                                        <textarea class="form-control font-monospace" id="action-params" rows="5">{"group_id": 123456, "message": "Hello from Go Manager"}</textarea>
                                    </div>
                                    <button class="btn btn-primary" onclick="sendAction()" data-i18n="send_request_btn">ÂèëÈÄÅËØ∑Ê±Ç</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header" data-i18n="response_result_title">ÂìçÂ∫îÁªìÊûú</div>
                                <div class="card-body bg-light">
                                    <pre id="action-result" class="mb-0" data-i18n="waiting_request">Á≠âÂæÖËØ∑Ê±Ç...</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Users Tab -->
        <div id="tab-users" class="content-section" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="m-0" data-i18n="users_title">Áî®Êà∑ÁÆ°ÁêÜ</h4>
                <button class="btn btn-primary" onclick="showCreateUserModal()">
                    <i class="bi bi-person-plus"></i> <span data-i18n="add_user_btn">Ê∑ªÂä†Áî®Êà∑</span>
                </button>
            </div>
            
            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th data-i18n="user_col_id">ID</th>
                                    <th data-i18n="user_col_username">Áî®Êà∑Âêç</th>
                                    <th data-i18n="user_col_role">ËßíËâ≤</th>
                                    <th data-i18n="user_col_created">ÂàõÂª∫Êó∂Èó¥</th>
                                    <th class="text-end" data-i18n="user_col_actions">Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <!-- Users list will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="tab-settings" class="content-section" style="display:none;">
            <h4 class="mb-4" data-i18n="settings_title">Á≥ªÁªüËÆæÁΩÆ</h4>
            
            <div class="row">
                <!-- Common Settings -->
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header" data-i18n="common_settings_title">Â∏∏Áî®ËÆæÁΩÆ</div>
                        <div class="card-body">
                            <form>
                                <div class="mb-3">
                                    <label class="form-label" data-i18n="theme_label">ÁïåÈù¢‰∏ªÈ¢ò</label>
                                    <select class="form-select" onchange="setTheme(this.value)">
                                        <option value="light" data-i18n="theme_light">ÊµÖËâ≤ (Light)</option>
                                        <option value="dark" data-i18n="theme_dark">Ê∑±Ëâ≤ (Dark)</option>
                                        <option value="auto" data-i18n="theme_auto">Ë∑üÈöèÁ≥ªÁªü (Auto)</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" data-i18n="refresh_rate_label">Êï∞ÊçÆÂà∑Êñ∞È¢ëÁéá</label>
                                    <select class="form-select">
                                        <option value="2000" data-i18n="rate_fast">2 Áßí (Âø´ÈÄü)</option>
                                        <option value="5000" data-i18n="rate_normal">5 Áßí (Ê≠£Â∏∏)</option>
                                        <option value="10000" data-i18n="rate_slow">10 Áßí (ÁúÅÊµÅ)</option>
                                    </select>
                                </div>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="setting-notify" checked>
                                    <label class="form-check-label" for="setting-notify" data-i18n="enable_notification_label">ÂêØÁî®Ê°åÈù¢ÈÄöÁü•</label>
                                </div>
                                <button type="button" class="btn btn-primary" data-i18n="save_common_settings_btn">‰øùÂ≠òÂ∏∏Áî®ËÆæÁΩÆ</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Personal Preferences -->
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header" data-i18n="personal_settings_title">‰∏™‰∫∫ÂÅèÂ•ΩËÆæÁΩÆ</div>
                        <div class="card-body">
                             <form>
                                <div class="mb-3">
                                    <label class="form-label" data-i18n="default_home_label">ÈªòËÆ§È¶ñÈ°µ</label>
                                    <select class="form-select">
                                        <option value="dashboard" data-i18n="dashboard_label">‰ª™Ë°®Áõò</option>
                                        <option value="bots" data-i18n="bot_list_label">Êú∫Âô®‰∫∫ÂàóË°®</option>
                                        <option value="groups" data-i18n="group_manage_label">Áæ§ÁªÑÁÆ°ÁêÜ</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" data-i18n="items_per_page_label">ÊØèÈ°µÊòæÁ§∫Êù°Êï∞</label>
                                    <input type="number" class="form-control" value="20">
                                </div>
                                <hr>
                                <div class="mb-3">
                                    <label class="form-label" data-i18n="change_password_label">‰øÆÊîπÂØÜÁ†Å</label>
                                    <input type="password" id="pwd-current" class="form-control mb-2" placeholder="ÂΩìÂâçÂØÜÁ†Å" data-i18n-placeholder="current_pwd_placeholder">
                                    <input type="password" id="pwd-new" class="form-control mb-2" placeholder="Êñ∞ÂØÜÁ†Å" data-i18n-placeholder="new_pwd_placeholder">
                                    <input type="password" id="pwd-confirm" class="form-control" placeholder="Á°ÆËÆ§Êñ∞ÂØÜÁ†Å" data-i18n-placeholder="confirm_pwd_placeholder">
                                </div>
                                <button type="button" class="btn btn-primary" onclick="updatePassword()" data-i18n="save_personal_settings_btn">‰øùÂ≠ò‰∏™‰∫∫ËÆæÁΩÆ</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Backend Configuration (Admin Only) -->
                <div class="col-md-12 admin-only" style="display:none;">
                    <div class="card mb-4 border-primary">
                        <div class="card-header bg-primary text-white">
                            <i class="bi bi-server me-2"></i> <span data-i18n="backend_config_title">ÂêéÁ´ØÊúçÂä°ÈÖçÁΩÆ (ÁÆ°ÁêÜÂëò)</span>
                        </div>
                        <div class="card-body">
                            <form id="backend-config-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label" data-i18n="config_ws_port">WebSocket ÊúçÂä°Á´ØÂè£</label>
                                            <input type="text" id="cfg-ws-port" class="form-control" placeholder=":3001">
                                            <div class="form-text" data-i18n="config_ws_port_help">Bot Âíå Worker ËøûÊé•‰ΩøÁî®ÁöÑÁ´ØÂè£ÔºåÈúÄÂåÖÂê´ÂÜíÂè∑ (‰æãÂ¶Ç :3001)</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label" data-i18n="config_webui_port">WebUI ÊúçÂä°Á´ØÂè£</label>
                                            <input type="text" id="cfg-webui-port" class="form-control" placeholder=":5000">
                                            <div class="form-text" data-i18n="config_webui_port_help">ÁÆ°ÁêÜÂêéÂè∞ÁïåÈù¢ËÆøÈóÆÁ´ØÂè£ÔºåÈúÄÂåÖÂê´ÂÜíÂè∑ (‰æãÂ¶Ç :5000)</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label" data-i18n="config_redis_addr">Redis Âú∞ÂùÄ</label>
                                            <input type="text" id="cfg-redis-addr" class="form-control" placeholder="127.0.0.1:6379">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label" data-i18n="config_redis_pwd">Redis ÂØÜÁ†Å</label>
                                            <input type="password" id="cfg-redis-pwd" class="form-control" placeholder="******">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label" data-i18n="config_admin_pwd">ÈªòËÆ§ÁÆ°ÁêÜÂëòÂØÜÁ†Å</label>
                                            <input type="text" id="cfg-admin-pwd" class="form-control" placeholder="admin123">
                                            <div class="form-text" data-i18n="config_admin_pwd_help">Êñ∞ÈÉ®ÁΩ≤Á≥ªÁªüÊó∂ÁöÑÈªòËÆ§ÂØÜÁ†Å</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label" data-i18n="config_stats_file">ÁªüËÆ°Êï∞ÊçÆÂ≠òÂÇ®Êñá‰ª∂</label>
                                            <input type="text" id="cfg-stats-file" class="form-control" placeholder="stats.json">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" data-i18n="config_jwt_secret">JWT ÂØÜÈí• (ÊÖéÊîπ)</label>
                                    <input type="text" id="cfg-jwt-secret" class="form-control">
                                    <div class="form-text" data-i18n="config_jwt_secret_help">‰øÆÊîπÊ≠§È°π‰ºöÂØºËá¥ÊâÄÊúâÂ∑≤ÁôªÂΩïÁî®Êà∑ Token Â§±Êïà</div>
                                </div>
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle me-2"></i> <span data-i18n="config_restart_warning">Ê≥®ÊÑèÔºö‰øÆÊîπÁ´ØÂè£Êàñ Redis ÈÖçÁΩÆÂêéÔºåÈÄöÂ∏∏ÈúÄË¶ÅÊâãÂä®ÈáçÂêØÂêéÁ´ØÊúçÂä°ÊâçËÉΩÂÆåÂÖ®ÁîüÊïà„ÄÇ</span>
                                </div>
                                <button type="button" class="btn btn-primary" onclick="updateBackendConfig()" data-i18n="config_save">‰øùÂ≠òÂêéÁ´ØÈÖçÁΩÆ</button>
                                <button type="button" class="btn btn-outline-secondary ms-2" onclick="loadBackendConfig()" data-i18n="config_reload">ÈáçÊñ∞Âä†ËΩΩ</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Routing Rule Modal -->
    <div class="modal fade" id="routingRuleModal" tabindex="-1" aria-labelledby="routingRuleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="routingRuleModalLabel" data-i18n="routing_add_rule">Ê∑ªÂä†Ë∑ØÁî±ËßÑÂàô</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="routing-rule-form">
                        <div class="mb-3">
                            <label for="routing-pattern" class="form-label" data-i18n="routing_pattern">ÂåπÈÖçÊ®°Âºè</label>
                            <input type="text" class="form-control" id="routing-pattern" placeholder="group_123, user_456, *" data-i18n-placeholder="routing_pattern_placeholder">
                            <div class="form-text" data-i18n="routing_pattern_help">ÊîØÊåÅÈÄöÈÖçÁ¨¶*ÔºåÂ§ö‰∏™Ê®°ÂºèÁî®ÈÄóÂè∑ÂàÜÈöî</div>
                        </div>
                        <div class="mb-3">
                            <label for="routing-target" class="form-label" data-i18n="routing_target">ÁõÆÊ†áÂú∞ÂùÄ</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="routing-target" placeholder="ws://localhost:8080, http://example.com" data-i18n-placeholder="routing_target_placeholder">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-i18n="select_worker">ÈÄâÊã©ËäÇÁÇπ</button>
                                <ul class="dropdown-menu dropdown-menu-end" id="worker-select-dropdown">
                                    <!-- Workers will be populated here -->
                                </ul>
                            </div>
                            <div class="form-text" data-i18n="routing_target_help">Ê∂àÊÅØËΩ¨ÂèëÁõÆÊ†áÂú∞ÂùÄ</div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="routing-enabled" checked>
                                <label class="form-check-label" for="routing-enabled" data-i18n="routing_enabled">ÂêØÁî®ËßÑÂàô</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="cancel">ÂèñÊ∂à</button>
                    <button type="button" class="btn btn-primary" onclick="saveRoutingRule()" data-i18n="save">‰øùÂ≠ò</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Language Management ---
        let currentLang = 'zh-CN';

        function initLanguage() {
            const savedLang = localStorage.getItem('language') || 'zh-CN';
            setLanguage(savedLang);
        }

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('language', lang);
            
            if (typeof translations === 'undefined') return;

            // Update document title
            if (translations[lang] && translations[lang].app_title) {
                document.title = translations[lang].app_title;
            }

            // Update elements with data-i18n (innerText)
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                     el.innerText = translations[lang][key];
                }
            });

            // Update elements with data-i18n-placeholder
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[lang] && translations[lang][key]) {
                     el.placeholder = translations[lang][key];
                }
            });
            
             // Update elements with data-i18n-title
            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                const key = el.getAttribute('data-i18n-title');
                if (translations[lang] && translations[lang][key]) {
                    el.title = translations[lang][key];
                }
            });
        }

        // --- Theme Management ---
        let themeListener = null;

        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'auto';
            applyTheme(savedTheme);
            
            // Sync with settings dropdown if exists
            const themeSelect = document.querySelector('select[onchange="setTheme(this.value)"]');
            if (themeSelect) themeSelect.value = savedTheme;
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
            const next = current === 'dark' ? 'light' : 'dark';
            applyTheme(next);
        }

        function applyTheme(theme) {
            // Remove existing listener if any
            if (themeListener) {
                window.matchMedia('(prefers-color-scheme: dark)').removeEventListener('change', themeListener);
                themeListener = null;
            }

            if (theme === 'auto') {
                const mq = window.matchMedia('(prefers-color-scheme: dark)');
                
                // Define listener
                themeListener = (e) => {
                     if (e.matches) {
                        document.documentElement.setAttribute('data-theme', 'dark');
                    } else {
                        document.documentElement.removeAttribute('data-theme');
                    }
                    updateThemeIcon();
                };
                
                // Add listener
                mq.addEventListener('change', themeListener);
                
                // Apply current
                themeListener(mq);
                
            } else if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                updateThemeIcon();
            } else {
                document.documentElement.removeAttribute('data-theme');
                updateThemeIcon();
            }
            
            localStorage.setItem('theme', theme);
        }

        function updateThemeIcon() {
            const btn = document.querySelector('.theme-toggle-btn-sidebar i');
            if (btn) {
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                btn.className = isDark ? 'bi bi-sun-fill' : 'bi bi-moon-stars';
            }
        }

        function setTheme(theme) {
            applyTheme(theme);
        }

        async function updatePassword() {
            const oldPwd = document.getElementById('pwd-current').value;
            const newPwd = document.getElementById('pwd-new').value;
            const confirmPwd = document.getElementById('pwd-confirm').value;

            const t = translations[currentLang] || translations['zh-CN'];

            if (!newPwd) return alert(t.enter_new_pwd || 'ËØ∑ËæìÂÖ•Êñ∞ÂØÜÁ†Å');
            if (newPwd !== confirmPwd) return alert(t.pwd_mismatch || '‰∏§Ê¨°ËæìÂÖ•ÁöÑÂØÜÁ†Å‰∏ç‰∏ÄËá¥');
            if (!oldPwd) return alert(t.enter_current_pwd || 'ËØ∑ËæìÂÖ•ÂΩìÂâçÂØÜÁ†Å');

            try {
                const res = await fetchWithAuth('/api/user/password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ old_password: oldPwd, new_password: newPwd })
                });

                if (!res.ok) {
                    const txt = await res.text();
                    throw new Error(txt);
                }

                alert(t.password_change_success || 'ÂØÜÁ†Å‰øÆÊîπÊàêÂäü');
                document.getElementById('pwd-current').value = '';
                document.getElementById('pwd-new').value = '';
                document.getElementById('pwd-confirm').value = '';
            } catch (e) {
                alert((t.password_change_fail || '‰øÆÊîπÂ§±Ë¥•: ') + e.message);
            }
        }

        async function loadBackendConfig() {
            if (authRole !== 'admin' && authRole !== 'super') return;
            
            try {
                const res = await fetchWithAuth('/api/admin/config');
                if (!res.ok) throw new Error('Failed to load config');
                
                const config = await res.json();
                document.getElementById('cfg-ws-port').value = config.ws_port || '';
                document.getElementById('cfg-webui-port').value = config.webui_port || '';
                document.getElementById('cfg-redis-addr').value = config.redis_addr || '';
                document.getElementById('cfg-redis-pwd').value = config.redis_pwd || '';
                document.getElementById('cfg-jwt-secret').value = config.jwt_secret || '';
                document.getElementById('cfg-admin-pwd').value = config.default_admin_password || '';
                document.getElementById('cfg-stats-file').value = config.stats_file || '';
            } catch (e) {
                console.error('Error loading backend config:', e);
            }
        }

        async function updateBackendConfig() {
            const config = {
                ws_port: document.getElementById('cfg-ws-port').value,
                webui_port: document.getElementById('cfg-webui-port').value,
                redis_addr: document.getElementById('cfg-redis-addr').value,
                redis_pwd: document.getElementById('cfg-redis-pwd').value,
                jwt_secret: document.getElementById('cfg-jwt-secret').value,
                default_admin_password: document.getElementById('cfg-admin-pwd').value,
                stats_file: document.getElementById('cfg-stats-file').value
            };

            if (!confirm('Á°ÆÂÆöË¶Å‰øùÂ≠òÂêéÁ´ØÈÖçÁΩÆÂêóÔºüÈÉ®ÂàÜ‰øÆÊîπÔºàÂ¶ÇÁ´ØÂè£ÔºâÈúÄË¶ÅÈáçÂêØÊúçÂä°ÂêéÁîüÊïà„ÄÇ')) return;

            try {
                const res = await fetchWithAuth('/api/admin/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                const data = await res.json();
                if (data.success) {
                    alert(data.message || 'ÈÖçÁΩÆÂ∑≤Êõ¥Êñ∞');
                } else {
                    alert('Êõ¥Êñ∞Â§±Ë¥•: ' + data.message);
                }
            } catch (e) {
                alert('Êõ¥Êñ∞Âá∫Èîô: ' + e.message);
            }
        }

        // --- Auth & Login ---
        let authToken = localStorage.getItem('wxbot_token');
        let authRole = localStorage.getItem('wxbot_role');
        let currentBotId = '';

        /**
         * Â∞ÅË£ÖÂ∏¶ËÆ§ËØÅÁöÑ fetch ËØ∑Ê±Ç
         */
        async function fetchWithAuth(url, options = {}) {
            if (!authToken) {
                console.error('No auth token found');
                throw new Error('Êú™ÁôªÂΩï');
            }
            
            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            };
            
            // ÂêàÂπ∂ options
            const mergedOptions = {
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...(options.headers || {})
                }
            };
            
            return fetch(url, mergedOptions);
        }

        // Check Auth on Load
        document.addEventListener('DOMContentLoaded', () => {
            try {
                initTheme(); // Initialize theme
                initLanguage(); // Initialize language

            // Force logout if requested via URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('logout') === '1') {
                localStorage.removeItem('wxbot_token');
                localStorage.removeItem('wxbot_role');
                // Clear the logout parameter from URL
                window.history.replaceState({}, document.title, window.location.pathname);
                alert('Â∑≤Âº∫Âà∂ÈÄÄÂá∫ÁôªÂΩï');
            }

            // Check for Magic Link
            const magicToken = urlParams.get('magic_token');

                // ‰øÆÊîπÔºöÂú®Ê£ÄÊü•ËÆ§ËØÅÂâçÔºåÂÖàÊ†πÊçÆÊòØÂê¶Êúâ token ÂÜ≥ÂÆöÊòØÂê¶ÊòæÁ§∫ÁôªÂΩïÈ°µ
                if (!magicToken && !authToken) {
                    document.getElementById('loginPage').style.display = 'flex';
                }

                if (magicToken) {
                // Attempt Magic Login
                fetch('/api/login/magic', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: magicToken })
                })
                .then(res => {
                    if (!res.ok) throw new Error('Magic login failed');
                    return res.json();
                })
                .then(data => {
                    authToken = data.token;
                    authRole = data.role;
                    localStorage.setItem('wxbot_token', authToken);
                    localStorage.setItem('wxbot_role', authRole);
                    
                    // Clear URL params
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    document.getElementById('loginPage').classList.add('hidden');
                    setTimeout(() => {
                        document.getElementById('loginPage').style.display = 'none';
                    }, 500);
                    startApp();
                })
                .catch(err => {
                    console.error(err);
                    const t = translations[currentLang] || translations['zh-CN'];
                    alert(t.magic_login_fail || 'ÂÖçÂØÜÁ†ÅÁôªÂΩïÂ§±Ë¥•ÔºåÈìæÊé•ÂèØËÉΩÂ∑≤ËøáÊúü„ÄÇËØ∑ÈáçÊñ∞Ëé∑ÂèñÊàñ‰ΩøÁî®ÂØÜÁ†ÅÁôªÂΩï„ÄÇ');
                    // Clean URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                    // Show login
                    document.getElementById('loginPage').classList.remove('hidden');
                    document.getElementById('loginPage').style.display = 'flex';
                });
                return;
            }

            if (!authToken) {
                document.getElementById('loginPage').classList.remove('hidden');
                document.getElementById('loginPage').style.display = 'flex';
            } else {
                document.getElementById('loginPage').classList.add('hidden');
                setTimeout(() => {
                    document.getElementById('loginPage').style.display = 'none';
                }, 500);
                startApp();
            }
            } catch (e) {
                console.error('DOMContentLoaded error:', e);
                document.getElementById('loginPage').style.display = 'flex';
            }
        });

        function applyRoleUI(role) {
            const isAdmin = (role === 'super' || role === 'admin');
            
            // Helper to toggle visibility
            const toggle = (id, show) => {
                const el = document.getElementById(id);
                if(el) el.style.display = show ? '' : 'none';
            };

            // Sidebar
            toggle('nav-debug', isAdmin);
            toggle('nav-users', isAdmin);
            toggle('nav-settings', isAdmin);
            toggle('nav-routing', isAdmin);
            toggle('nav-docker', isAdmin);
            toggle('nav-overmind', isAdmin);
            
            // Admin only sections by class
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = isAdmin ? '' : 'none';
            });
            
            // Monitor Tabs
            toggle('monitor-logs-tab', isAdmin);
            
            // Dashboard
            toggle('dash-system-stats', isAdmin); // CPU/Mem cards
            // Charts should be visible to everyone now (with limited/relevant data)
            toggle('dash-charts-row', true); 
            toggle('dash-process-card', isAdmin); // Process List
            toggle('dash-actions-card', isAdmin); // Quick Actions
            toggle('dash-logs-card', isAdmin); // Recent Logs
            
            // If user is not admin and is currently on a hidden tab, switch to dashboard
            if (!isAdmin) {
                const hash = window.location.hash;
                if (hash === '#debug') {
                    showTab('dashboard');
                }
            }
        }

        function showOvermind(e) {
            if (e) e.preventDefault();
            const lang = currentLang || 'zh-CN';
            window.open(`/overmind/?lang=${lang}`, '_blank');
        }

        let currentSlideIndex = 0;
        const totalSlides = 3;

        function rotateStatsSlide() {
            const container = document.getElementById('combined-stats-container');
            if (!container) return;

            const slides = container.querySelectorAll('.stats-slide');
            const icon = document.getElementById('combined-stats-icon').querySelector('i');
            if (!slides.length || !icon) return;
            
            // Fade out current
            slides[currentSlideIndex].classList.remove('fade-in');
            slides[currentSlideIndex].classList.add('fade-out');
            
            setTimeout(() => {
                slides[currentSlideIndex].style.display = 'none';
                slides[currentSlideIndex].classList.remove('fade-out');
                
                currentSlideIndex = (currentSlideIndex + 1) % totalSlides;
                
                // Update icon based on slide
                if (currentSlideIndex === 0) { // Goroutines
                    icon.className = 'bi bi-activity';
                } else if (currentSlideIndex === 1) { // Active
                    icon.className = 'bi bi-people';
                } else if (currentSlideIndex === 2) { // Messages
                    icon.className = 'bi bi-chat-text';
                }
                
                slides[currentSlideIndex].style.display = 'block';
                // Trigger reflow
                slides[currentSlideIndex].offsetHeight;
                slides[currentSlideIndex].classList.add('fade-in');
            }, 500);
        }

        // Start rotation every 5 seconds
        setInterval(rotateStatsSlide, 5000);

        // --- Visualization Engine ---
        class RoutingVisualizer {
            constructor() {
                this.container = document.getElementById('visualization-container');
                if (!this.container) return;

                // 3D Scene Setup
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(75, this.container.clientWidth / this.container.clientHeight, 0.1, 2000);
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(this.container.clientWidth, this.container.clientHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                this.container.appendChild(this.renderer.domElement);

                // Controls
                this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.controls.dampingFactor = 0.05;

                // Camera Position
                this.camera.position.z = 500;

                // Lights
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
                this.scene.add(ambientLight);
                const pointLight = new THREE.PointLight(0x00ff41, 1, 1000);
                pointLight.position.set(0, 0, 100);
                this.scene.add(pointLight);

                this.nodes = new Map(); // ID -> {mesh, type, label, lastActive, floatingOffset}
                this.particles = [];
                this.running = true;
                this.totalMessages = 0;

                // Add Stars
                this.addStars();
                
                // Add Nexus (Central Node)
                this.getOrCreateNode('nexus', 'nexus', 'Nexus');

                // Stats UI
                this.statsEl = document.createElement('div');
                this.statsEl.className = 'viz-stats';
                this.container.appendChild(this.statsEl);
                this.updateStatsUI();

                window.addEventListener('resize', () => this.resize());
                
                // Start Animation Loop
                this.animate();

                // Periodic cleanup
                this.cleanupInterval = setInterval(() => {
                    this.cleanupNodes();
                }, 10000);
            }

            addStars() {
                const starsGeometry = new THREE.BufferGeometry();
                const starsMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 1, transparent: true });
                const starsVertices = [];
                for (let i = 0; i < 8000; i++) {
                    const x = (Math.random() - 0.5) * 3000;
                    const y = (Math.random() - 0.5) * 3000;
                    const z = (Math.random() - 0.5) * 3000;
                    starsVertices.push(x, y, z);
                }
                starsGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starsVertices, 3));
                this.stars = new THREE.Points(starsGeometry, starsMaterial);
                this.scene.add(this.stars);
            }

            updateStatsUI() {
                const t = (typeof translations !== 'undefined') ? (translations[currentLang] || translations['zh-CN']) : {};
                const activeNodes = this.nodes.size;
                const activeParticles = this.particles.length;
                
                this.statsEl.innerHTML = `
                    <div style="font-size: 1.1rem; border-bottom: 1px solid rgba(0,255,65,0.3); margin-bottom: 5px; padding-bottom: 2px;">
                        ${t.viz_stats_title || 'SYSTEM STATUS'}
                    </div>
                    <div>${t.total_messages || 'Ê∂àÊÅØÊÄªÈáè'}: <span style="color: #fff; text-shadow: 0 0 5px #00ff41;">${this.totalMessages}</span></div>
                    <div>${t.viz_active_nodes || 'Ê¥ªÂä®ËäÇÁÇπ'}: ${activeNodes}</div>
                    <div>${t.viz_active_tasks || 'Â§ÑÁêÜ‰∏≠‰ªªÂä°'}: ${activeParticles}</div>
                `;
            }

            resize() {
                if (!this.container || !this.renderer) return;
                const width = this.container.clientWidth;
                const height = this.container.clientHeight;
                if (width <= 0 || height <= 0) return;
                this.camera.aspect = width / height;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(width, height);
            }

            getOrCreateNode(id, type, label, avatar) {
                if (this.nodes.has(id)) {
                    const node = this.nodes.get(id);
                    node.lastActive = Date.now();
                    
                    let needsUpdate = false;
                    // Update avatar if changed
                    if (avatar && node.avatar !== avatar) {
                        node.avatar = avatar;
                        needsUpdate = true;
                    }
                    // Update label if changed
                    if (label && node.label !== label) {
                        node.label = label;
                        needsUpdate = true;
                    }

                    if (needsUpdate) {
                        this.updateNodeTexture(node);
                    }
                    return node;
                }

                const node = {
                    id, type, label, avatar,
                    mesh: null,
                    lastActive: Date.now(),
                    floatingOffset: Math.random() * Math.PI * 2,
                    targetPos: new THREE.Vector3(0, 0, 0)
                };

                // 3D Space Partitioning (Hierarchy Layout)
                if (id === 'nexus') {
                    node.targetPos.set(0, 0, 0);
                } else if (type === 'worker') {
                    // Workers: Closest to Nexus
                    const angle = Math.random() * Math.PI * 2;
                    const radius = 150 + Math.random() * 100;
                    node.targetPos.set(
                        Math.cos(angle) * radius,
                        (Math.random() - 0.5) * 100,
                        Math.sin(angle) * radius
                    );
                } else if (type === 'bot') {
                    // Bots: Middle layer
                    const angle = Math.random() * Math.PI * 2;
                    const radius = 350 + Math.random() * 150;
                    node.targetPos.set(
                        Math.cos(angle) * radius,
                        (Math.random() - 0.5) * 150,
                        Math.sin(angle) * radius
                    );
                } else if (type === 'user') {
                    // Users: Outer layer
                    const angle = Math.random() * Math.PI * 2;
                    const radius = 700 + Math.random() * 300;
                    node.targetPos.set(
                        Math.cos(angle) * radius,
                        (Math.random() - 0.5) * 200,
                        Math.sin(angle) * radius
                    );
                }

                this.updateNodeTexture(node, true);
                this.nodes.set(id, node);
                return node;
            }

            updateNodeTexture(node, isNew = false) {
                const canvas = document.createElement('canvas');
                canvas.width = 256;
                canvas.height = 256;
                const ctx = canvas.getContext('2d');

                const draw = () => {
                    ctx.clearRect(0, 0, 256, 256);
                    
                    // Glow effect
                    const gradient = ctx.createRadialGradient(128, 128, 50, 128, 128, 120);
                    gradient.addColorStop(0, 'rgba(0, 255, 65, 0.15)');
                    gradient.addColorStop(1, 'rgba(0, 255, 65, 0)');
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, 256, 256);

                    // Avatar or Icon Circle
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(128, 100, 60, 0, Math.PI * 2);
                    ctx.clip();
                    
                    if (node.avatar) {
                        const img = new Image();
                        img.crossOrigin = "anonymous";
                        img.src = node.avatar;
                        img.onload = () => {
                            ctx.drawImage(img, 68, 40, 120, 120);
                            this.drawDetails(ctx, node);
                            this.finishTexture(node, canvas, isNew);
                        };
                        img.onerror = () => {
                            this.drawDefaultIcon(ctx, node.type);
                            this.drawDetails(ctx, node);
                            this.finishTexture(node, canvas, isNew);
                        };
                        return; // Async handling
                    } else {
                        this.drawDefaultIcon(ctx, node.type);
                    }
                    ctx.restore();

                    this.drawDetails(ctx, node);
                    this.finishTexture(node, canvas, isNew);
                };

                draw();
            }

            drawDetails(ctx, node) {
                // Background scanlines (Matrix style)
                ctx.strokeStyle = 'rgba(0, 255, 65, 0.1)';
                ctx.lineWidth = 1;
                for (let i = 0; i < 256; i += 4) {
                    ctx.beginPath();
                    ctx.moveTo(0, i);
                    ctx.lineTo(256, i);
                    ctx.stroke();
                }

                // Border
                ctx.beginPath();
                ctx.arc(128, 100, 60, 0, Math.PI * 2);
                ctx.strokeStyle = '#00ff41';
                ctx.lineWidth = 4;
                ctx.stroke();
                
                // Glow border
                ctx.strokeStyle = 'rgba(0, 255, 65, 0.5)';
                ctx.lineWidth = 8;
                ctx.stroke();

                // Text Info (Matrix Style)
                ctx.fillStyle = '#00ff41';
                ctx.shadowColor = '#00ff41';
                ctx.shadowBlur = 10;
                ctx.font = 'bold 24px monospace';
                ctx.textAlign = 'center';
                
                let displayLabel = node.label || node.id;
                if (node.id === 'nexus') {
                    const t = (typeof translations !== 'undefined') ? (translations[currentLang] || translations['zh-CN']) : {};
                    displayLabel = t.viz_nexus || 'Nexus';
                }
                ctx.fillText(displayLabel, 128, 190);
                
                ctx.font = '16px monospace';
                const idDisplay = node.id.length > 20 ? node.id.substring(0, 17) + '...' : node.id;
                ctx.fillText(idDisplay, 128, 215);
                
                if (node.type === 'bot' || node.type === 'worker') {
                    const typeLabel = node.type === 'worker' ? 'PROCESSOR' : 'MATRIX BOT';
                    ctx.font = 'bold 14px monospace';
                    ctx.fillText(typeLabel, 128, 235);
                } else if (node.type === 'user') {
                    const t = (typeof translations !== 'undefined') ? (translations[currentLang] || translations['zh-CN']) : {};
                    ctx.font = '14px monospace';
                    ctx.fillText(t.viz_user || 'USER', 128, 235);
                }
            }

            drawDefaultIcon(ctx, type) {
                ctx.fillStyle = '#0a0a0a';
                ctx.fillRect(0, 0, 256, 256);
                
                // Add some random binary code in background
                ctx.fillStyle = 'rgba(0, 255, 65, 0.15)';
                ctx.font = '10px monospace';
                for(let i=0; i<10; i++) {
                    const binary = Math.random() > 0.5 ? "1010101" : "0101010";
                    ctx.fillText(binary, Math.random() * 256, Math.random() * 256);
                }

                ctx.fillStyle = '#00ff41';
                ctx.font = '80px serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                let icon = 'üë§';
                if (type === 'nexus') icon = 'üï∏Ô∏è';
                if (type === 'bot') icon = 'ü§ñ';
                if (type === 'worker') icon = '‚öôÔ∏è';
                ctx.fillText(icon, 128, 100);
            }

            finishTexture(node, canvas, isNew) {
                const texture = new THREE.CanvasTexture(canvas);
                if (node.mesh) {
                    node.mesh.material.map = texture;
                    node.mesh.material.needsUpdate = true;
                } else {
                    const material = new THREE.SpriteMaterial({ map: texture, transparent: true });
                    const sprite = new THREE.Sprite(material);
                    const size = node.id === 'nexus' ? 120 : 80;
                    sprite.scale.set(size, size, 1);
                    sprite.position.copy(node.targetPos);
                    node.mesh = sprite;
                    this.scene.add(sprite);
                }
            }

            addEvent(event) {
                if (event.total_messages !== undefined) {
                    this.totalMessages = event.total_messages;
                    this.updateStatsUI();
                }

                const nexus = this.getOrCreateNode('nexus', 'nexus', 'Nexus');
                let startNode, endNode;

                // Try to find bot info from currentBots global or event platform
                const findBotInfo = (botId, platformFromEvent) => {
                    if (typeof currentBots !== 'undefined') {
                        const bot = currentBots.find(b => b.self_id === botId || b.id === botId);
                        if (bot) {
                            let avatarUrl = null;
                            const platform = (platformFromEvent || bot.platform || '').toUpperCase();
                            if (platform === 'QQ') {
                                avatarUrl = `https://q1.qlogo.cn/g?b=qq&nk=${bot.self_id}&s=100`;
                            } else if (platform === 'WECHAT' || platform === 'WX') {
                                avatarUrl = '/static/avatars/wechat_default.png';
                            } else if (bot.user_avatar) {
                                avatarUrl = bot.user_avatar;
                            }
                            return { nickname: bot.nickname || bot.name || botId, avatar: avatarUrl };
                        }
                    }
                    // Fallback using platform from event
                    if (platformFromEvent) {
                        const platform = platformFromEvent.toUpperCase();
                        if (platform === 'QQ') {
                            return { nickname: botId, avatar: `https://q1.qlogo.cn/g?b=qq&nk=${botId}&s=100` };
                        } else if (platform === 'WECHAT' || platform === 'WX') {
                            return { nickname: botId, avatar: '/static/avatars/wechat_default.png' };
                        }
                    }
                    return { nickname: botId, avatar: null };
                };

                if (event.direction === 'user_to_bot') {
                    startNode = this.getOrCreateNode(event.source, 'user', event.user_name || event.source, event.user_avatar);
                    const botInfo = findBotInfo(event.target, event.platform);
                    endNode = this.getOrCreateNode(event.target, 'bot', botInfo.nickname, botInfo.avatar);
                } else if (event.direction === 'bot_to_nexus') {
                    const botInfo = findBotInfo(event.source, event.platform);
                    startNode = this.getOrCreateNode(event.source, 'bot', botInfo.nickname, botInfo.avatar);
                    endNode = nexus;
                } else if (event.direction === 'nexus_to_worker') {
                    startNode = nexus;
                    endNode = this.getOrCreateNode(event.target, 'worker', event.target);
                } else if (event.direction === 'worker_to_nexus') {
                    startNode = this.getOrCreateNode(event.source, 'worker', event.source);
                    endNode = nexus;
                } else if (event.direction === 'nexus_to_bot') {
                    startNode = nexus;
                    const botInfo = findBotInfo(event.target, event.platform);
                    endNode = this.getOrCreateNode(event.target, 'bot', botInfo.nickname, botInfo.avatar);
                } else if (event.direction === 'worker_to_bot') {
                    startNode = this.getOrCreateNode(event.source, 'worker', event.source);
                    const botInfo = findBotInfo(event.target, event.platform);
                    endNode = this.getOrCreateNode(event.target, 'bot', botInfo.nickname, botInfo.avatar);
                }

                if (startNode && endNode) {
                    this.createParticle(startNode, endNode, event.msg_type, event.content);
                }
            }

            createParticle(start, end, msgType, content) {
                const colors = {
                    'message': 0x00ff41,
                    'request': 0x00d2ff,
                    'response': 0xff00ff,
                    'image': 0xffff00
                };
                const color = colors[msgType] || 0x00ff41;

                // Create Particle Mesh
                const geometry = new THREE.SphereGeometry(4, 8, 8);
                const material = new THREE.MeshBasicMaterial({ color: color });
                const mesh = new THREE.Mesh(geometry, material);
                
                // Add Glow to particle
                const light = new THREE.PointLight(color, 1, 50);
                mesh.add(light);
                
                mesh.position.copy(start.mesh.position);
                this.scene.add(mesh);

                let hintMesh = null;
                // Create floating hint if content exists
                if (content) {
                    hintMesh = this.createMessageHint(start.mesh.position, content, color);
                }

                this.particles.push({
                    mesh: mesh,
                    hintMesh: hintMesh,
                    startPos: start.mesh.position.clone(),
                    endPos: end.mesh.position.clone(),
                    progress: 0,
                    speed: 0.015,
                    content: content,
                    msgType: msgType
                });
            }

            createMessageHint(pos, content, color) {
                const canvas = document.createElement('canvas');
                canvas.width = 512;
                canvas.height = 128;
                const ctx = canvas.getContext('2d');
                
                // Holographic grid background
                ctx.strokeStyle = 'rgba(0, 255, 65, 0.1)';
                ctx.lineWidth = 1;
                for (let i = 0; i < 512; i += 20) {
                    ctx.beginPath();
                    ctx.moveTo(i, 0);
                    ctx.lineTo(i, 128);
                    ctx.stroke();
                }
                for (let i = 0; i < 128; i += 20) {
                    ctx.beginPath();
                    ctx.moveTo(0, i);
                    ctx.lineTo(512, i);
                    ctx.stroke();
                }

                // Draw background with holographic glow
                ctx.fillStyle = 'rgba(0, 15, 0, 0.85)';
                ctx.beginPath();
                ctx.roundRect(10, 10, 492, 108, 15);
                ctx.fill();
                
                // Double border for high-tech look
                const colorStr = '#' + color.toString(16).padStart(6, '0');
                ctx.strokeStyle = colorStr;
                ctx.lineWidth = 2;
                ctx.stroke();
                
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.roundRect(15, 15, 482, 98, 12);
                ctx.stroke();

                ctx.shadowColor = colorStr;
                ctx.shadowBlur = 20;

                // Text
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 24px monospace';
                ctx.textAlign = 'center';
                
                let text = content;
                if (text.length > 40) text = text.substring(0, 37) + '...';
                
                // Display text with subtle offset for "chromatic aberration" effect
                ctx.fillStyle = 'rgba(0, 255, 255, 0.5)';
                if (text.length > 20) {
                    ctx.fillText(text.substring(0, 20), 258, 57);
                    ctx.fillText(text.substring(20), 258, 87);
                } else {
                    ctx.fillText(text, 258, 72);
                }

                ctx.fillStyle = '#ffffff';
                if (text.length > 20) {
                    ctx.fillText(text.substring(0, 20), 256, 55);
                    ctx.fillText(text.substring(20), 256, 85);
                } else {
                    ctx.fillText(text, 256, 70);
                }

                const texture = new THREE.CanvasTexture(canvas);
                const material = new THREE.SpriteMaterial({ map: texture, transparent: true, blending: THREE.AdditiveBlending });
                const sprite = new THREE.Sprite(material);
                
                sprite.position.copy(pos);
                sprite.position.y += 80;
                sprite.scale.set(160, 40, 1);
                
                this.scene.add(sprite);
                return sprite;
            }

            animate() {
                if (!this.running) return;
                requestAnimationFrame(() => this.animate());

                const time = Date.now() * 0.001;

                // Rotate stars slowly
                if (this.stars) {
                    this.stars.rotation.y += 0.0002;
                    this.stars.rotation.x += 0.0001;
                }

                // Update Nodes Animation
                this.nodes.forEach(node => {
                    if (node.id === 'nexus') {
                        // Nexus: Stable center but shaking
                        const shakeFreq = 15;
                        const shakeAmp = 2;
                        node.mesh.position.set(
                            Math.sin(time * shakeFreq) * shakeAmp,
                            Math.cos(time * (shakeFreq + 1)) * shakeAmp,
                            Math.sin(time * (shakeFreq - 1)) * shakeAmp
                        );
                        
                        const scale = 120 + Math.sin(time * 2) * 5;
                        node.mesh.scale.set(scale, scale, 1);
                        node.mesh.material.rotation = Math.sin(time * 0.5) * 0.1;
                        return;
                    }

                    const offset = node.floatingOffset;
                    const inactivity = (Date.now() - node.lastActive) / 1000;

                    // Update target position based on inactivity and wandering
                    if (node.type === 'user') {
                        const targetRadius = (inactivity > 120) ? 1400 : 800;
                        const currentRadius = node.targetPos.length();
                        const lerpFactor = (inactivity > 120) ? 0.002 : 0.01;
                        
                        // Smoothly adjust radius
                        const nextRadius = currentRadius + (targetRadius - currentRadius) * lerpFactor;
                        if (currentRadius > 0.1) {
                            node.targetPos.multiplyScalar(nextRadius / currentRadius);
                        }
                    }

                    // Common wandering logic
                    const wanderSpeed = 0.2;
                    const wanderRadius = node.type === 'worker' ? 20 : (node.type === 'bot' ? 40 : 60);
                    
                    const wanderX = Math.sin(time * wanderSpeed + offset) * wanderRadius;
                    const wanderY = Math.cos(time * (wanderSpeed * 0.8) + offset) * wanderRadius;
                    const wanderZ = Math.sin(time * (wanderSpeed * 1.2) + offset) * wanderRadius;

                    node.mesh.position.x = node.targetPos.x + wanderX;
                    node.mesh.position.y = node.targetPos.y + wanderY;
                    node.mesh.position.z = node.targetPos.z + wanderZ;
                    
                    // Gentle swaying and pulsing
                    node.mesh.material.rotation = Math.sin(time * 0.3 + offset) * 0.2;
                    const baseScale = node.type === 'user' ? 70 : 90;
                    const pulse = 1 + Math.sin(time * 1.2 + offset) * 0.08;
                    node.mesh.scale.set(baseScale * pulse, baseScale * pulse, 1);
                });

                // Update Particles and Hints
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const p = this.particles[i];
                    p.progress += p.speed;
                    
                    if (p.progress >= 1) {
                        this.scene.remove(p.mesh);
                        if (p.hintMesh) {
                            this.scene.remove(p.hintMesh);
                            if (p.hintMesh.material.map) p.hintMesh.material.map.dispose();
                            p.hintMesh.material.dispose();
                        }
                        this.particles.splice(i, 1);
                        continue;
                    }

                    const t = p.progress;
                    const easedT = t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
                    
                    const pos = new THREE.Vector3().lerpVectors(p.startPos, p.endPos, easedT);
                    
                    // Arc height
                    const dist = p.startPos.distanceTo(p.endPos);
                    const arcHeight = Math.sin(Math.PI * t) * (dist * 0.15);
                    pos.y += arcHeight;
                    
                    p.mesh.position.copy(pos);
                    
                    // Update hint position to follow particle
                    if (p.hintMesh) {
                        p.hintMesh.position.copy(pos);
                        p.hintMesh.position.y += 50; // Offset above particle
                        p.hintMesh.material.opacity = Math.sin(Math.PI * t); // Fade in/out
                    }
                }

                this.controls.update();
                this.renderer.render(this.scene, this.camera);
            }

            cleanupNodes() {
                const now = Date.now();
                
                // Dynamic retention based on system load (node count)
                const nodeCount = this.nodes.size;
                let userIdleLimit = 300000; // Default 5 mins
                let serviceIdleLimit = 1800000; // Default 30 mins
                
                if (nodeCount > 100) {
                    // High load: clean up faster to keep performance
                    userIdleLimit = 120000; // 2 mins
                    serviceIdleLimit = 600000; // 10 mins
                } else if (nodeCount < 30) {
                    // Low load: keep nodes longer to make it look "busy"
                    userIdleLimit = 1200000; // 20 mins
                    serviceIdleLimit = 3600000; // 60 mins
                }

                // Use self_id for bots as that's what's used in events
                const activeBotIds = new Set(currentBots.filter(b => b.is_alive).map(b => b.self_id || b.id));
                const activeWorkerIds = new Set(currentWorkers.map(w => w.id));

                this.nodes.forEach((node, id) => {
                    if (id === 'nexus') return;
                    
                    let shouldRemove = false;
                    const idleTime = now - node.lastActive;

                    if (node.type === 'user') {
                        // Users never vanish
                        shouldRemove = false;
                    } else if (node.type === 'bot') {
                        // Service node: remove if offline AND inactive for long
                        if (activeBotIds.size > 0 && !activeBotIds.has(id) && idleTime > serviceIdleLimit) shouldRemove = true;
                    } else if (node.type === 'worker') {
                        if (activeWorkerIds.size > 0 && !activeWorkerIds.has(id) && idleTime > serviceIdleLimit) shouldRemove = true;
                    }

                    if (shouldRemove) {
                        if (node.mesh) {
                            this.scene.remove(node.mesh);
                            if (node.mesh.material.map) node.mesh.material.map.dispose();
                            node.mesh.material.dispose();
                        }
                        this.nodes.delete(id);
                    }
                });
            }

            clear() {
                this.nodes.forEach(node => {
                    if (node.id !== 'nexus') {
                        this.scene.remove(node.mesh);
                    }
                });
                const nexus = this.nodes.get('nexus');
                this.nodes.clear();
                if (nexus) this.nodes.set('nexus', nexus);
                
                this.particles.forEach(p => this.scene.remove(p.mesh));
                this.particles = [];
            }
        }

        let visualizer = null;
        function initVisualizer() {
            if (!visualizer) {
                visualizer = new RoutingVisualizer();
                visualizer.getOrCreateNode('nexus', 'nexus');
            }
        }

        function handleRoutingEvent(data) {
            if (visualizer) {
                visualizer.addEvent(data);
            }
        }

        function clearVisualization() {
            if (visualizer) visualizer.clear();
        }

        function showTab(tabId) {
            if (!tabId) return;

            // Handle visualization init
            if (tabId === 'visualization') {
                initVisualizer();
            }
            // Handle #hash
            if (tabId.startsWith('#')) tabId = tabId.substring(1);
            // Handle tab- prefix
            if (tabId.startsWith('tab-')) tabId = tabId.replace('tab-', '');
            
            try {
                // ÈöêËóèÊâÄÊúâÂÜÖÂÆπÂå∫Âüü
                const contentSections = document.querySelectorAll('.main-content > div[id^="tab-"]');
                contentSections.forEach(section => {
                    section.style.display = 'none';
                });
                
                // ÊòæÁ§∫ÁõÆÊ†áÂÜÖÂÆπÂå∫Âüü
                const targetTab = document.getElementById('tab-' + tabId);
                if (targetTab) {
                    targetTab.style.display = 'block';
                    
                    // Visualization resize after tab becomes visible
                    if (tabId === 'visualization' && visualizer) {
                        setTimeout(() => visualizer.resize(), 50);
                    }
                }
                
                // Êõ¥Êñ∞ÂØºËà™Áä∂ÊÄÅ
                const navLinks = document.querySelectorAll('.sidebar .nav-link');
                navLinks.forEach(link => {
                    link.classList.remove('active');
                });
                
                const targetNav = document.getElementById('nav-' + tabId) || 
                                  document.querySelector(`.sidebar .nav-link[href="#${tabId}"]`);
                if (targetNav) {
                    targetNav.classList.add('active');
                }
                
                // Êõ¥Êñ∞URL hash (‰ΩøÁî® replaceState ÈÅøÂÖçËß¶Âèë hashchange ‰∫ã‰ª∂)
                const newHash = '#' + tabId;
                if (window.location.hash !== newHash) {
                    window.history.replaceState(null, null, newHash);
                }
                
                // Ê†πÊçÆtabËß¶ÂèëÁõ∏Â∫îÁöÑÂàùÂßãÂåñÂáΩÊï∞
                switch(tabId) {
                    case 'dashboard':
                        // ‰ª™Ë°®ÊùøÊï∞ÊçÆÂú® startApp ‰∏≠ÂÆöÊó∂Êõ¥Êñ∞
                        break;
                    case 'bots':
                        if (typeof fetchBots === 'function') fetchBots(currentBots.length === 0);
                        if (typeof fetchWorkers === 'function') fetchWorkers(currentWorkers.length === 0);
                        break;
                    case 'groups':
                        if (typeof loadGroups === 'function') loadGroups();
                        const listEl = document.getElementById('group-list');
                        if (window.currentBotId && (!window.currentGroups || window.currentGroups.length === 0) && listEl && !listEl.innerHTML.includes('ÂàáÊç¢Êú∫Âô®‰∫∫‰∏≠')) {
                            if (typeof refreshGroupList === 'function') refreshGroupList();
                        }
                        break;
                    case 'monitor':
                        const activeMonitorTab = document.querySelector('#monitor-tabs .nav-link.active');
                        if (activeMonitorTab && activeMonitorTab.id === 'monitor-logs-tab') {
                            if (typeof fetchLogs === 'function') fetchLogs();
                        }
                        break;
                    case 'workers':
                        if (typeof fetchWorkers === 'function') fetchWorkers(currentWorkers.length === 0);
                        break;
                    case 'docker':
                        if (typeof loadDockerContainers === 'function') loadDockerContainers();
                        break;
                    case 'routing':
                        if (typeof fetchRoutingRules === 'function') fetchRoutingRules();
                        break;
                    case 'logs':
                        if (typeof fetchLogsFull === 'function') fetchLogsFull();
                        break;
                    case 'debug':
                        if (typeof loadTestGroups === 'function') loadTestGroups();
                        break;
                    case 'users':
                        if (typeof fetchUsers === 'function') fetchUsers();
                        break;
                    case 'settings':
                        if (typeof loadBackendConfig === 'function') loadBackendConfig();
                        break;
                }
                
                // ÁßªÂä®Á´ØÂÖ≥Èó≠‰æßËæπÊ†è
                if (window.innerWidth <= 768) {
                    const sidebar = document.getElementById('sidebar');
                    const overlay = document.getElementById('sidebar-overlay');
                    if (sidebar) sidebar.classList.remove('show');
                    if (overlay) overlay.classList.remove('show');
                }
                
                console.log('ÂàáÊç¢Âà∞Ê†áÁ≠æÈ°µ:', tabId);
                
            } catch (error) {
                console.error('ÂàáÊç¢Ê†áÁ≠æÈ°µÂ§±Ë¥•:', error);
                if (tabId !== 'dashboard') {
                    showTab('dashboard');
                }
            }
        }

        function startApp() {
            try {
                applyRoleUI(authRole);
                
                // Ëé∑ÂèñÂàùÂßãÊ†áÁ≠æÈ°µ
                let initialTab = 'dashboard';
                const hash = window.location.hash;
                if (hash) {
                    const tabId = hash.substring(1);
                    const validTabs = ['dashboard', 'bots', 'groups', 'monitor', 'workers', 'docker', 'routing', 'logs', 'debug', 'users', 'settings'];
                    const isValidTab = validTabs.includes(tabId) && document.getElementById('tab-' + tabId);
                    
                    if (isValidTab) {
                        const isAdmin = (authRole === 'super' || authRole === 'admin');
                        if (tabId === 'debug' && !isAdmin) {
                            initialTab = 'dashboard';
                        } else {
                            initialTab = tabId;
                        }
                    }
                }
                
                // Á´ãÂç≥ÊòæÁ§∫ÂàùÂßãÊ†áÁ≠æÈ°µÔºåÈò≤Ê≠¢Èó™ÁÉÅ
                showTab(initialTab);

                // Âª∂ËøüÂàùÂßãÂåñÂÖ∂‰ªñÁªÑ‰ª∂ÔºåÈò≤Ê≠¢È°µÈù¢Âç°Ê≠ª
                setTimeout(() => {
                    try {
                        initWebSocket();
                    } catch (wsError) {
                        console.error('WebSocketÂàùÂßãÂåñÂ§±Ë¥•:', wsError);
                    }
                }, 100);
                
                // ÂàÜÊâπÂä†ËΩΩÊï∞ÊçÆ
                setTimeout(() => {
                    try {
                        updateStats();
                        updateSystemStats();
                    } catch (error) {
                        console.error('Á≥ªÁªüÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•:', error);
                    }
                }, 200);
                
                setTimeout(() => {
                    try {
                        fetchBots();
                        fetchWorkers();
                    } catch (error) {
                        console.error('Êú∫Âô®‰∫∫Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•:', error);
                    }
                }, 400);
                
                setTimeout(() => {
                    try {
                        updateChatStats();
                    } catch (error) {
                        console.error('ËÅäÂ§©Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•:', error);
                    }
                }, 600);
                
                // ÂêØÂä®ÂÆöÊó∂Âô®
                const safeSetInterval = (fn, interval, name) => {
                    return setInterval(() => {
                        try {
                            fn();
                        } catch (error) {
                            console.error(`${name}ÂÆöÊó∂Âô®ÊâßË°åÂ§±Ë¥•:`, error);
                        }
                    }, interval);
                };
                
                window.updateInterval = safeSetInterval(updateStats, 2000, 'updateStats');
                window.systemStatsInterval = safeSetInterval(updateSystemStats, 2000, 'updateSystemStats');
                window.timeUpdateInterval = safeSetInterval(updateTimeDisplay, 500, 'updateTimeDisplay');
                window.chatStatsInterval = safeSetInterval(updateChatStats, 5000, 'updateChatStats');
                window.botsInterval = safeSetInterval(updateBots, 5000, 'updateBots');
                window.workersInterval = safeSetInterval(fetchWorkers, 5000, 'fetchWorkers');
                
                // Start combined stats rotation
                window.combinedStatsInterval = safeSetInterval(rotateCombinedStats, 3000, 'rotateCombinedStats');
                
            } catch (error) {
                console.error('startAppÂàùÂßãÂåñÂ§±Ë¥•:', error);
                try {
                    const t = translations[currentLang] || translations['zh-CN'];
                    alert(t.startup_error || 'Â∫îÁî®ÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                } catch (alertError) {
                    console.error('ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØÂ§±Ë¥•:', alertError);
                }
            }
        }

        let lastSystemStats = null;
        let serverStartTime = null;

        function updateTimeDisplay() {
            // Current Time & Date
            if (document.getElementById('metric-current-time')) {
                const now = new Date();
                const dateStr = now.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
                const timeStr = now.toLocaleTimeString('zh-CN', { hour12: false });
                document.getElementById('metric-current-time').innerText = `${dateStr} ${timeStr}`;
            }
            // Up Time
            if (document.getElementById('metric-uptime') && serverStartTime) {
                const uptimeSeconds = Math.floor(Date.now() / 1000 - serverStartTime);
                const h = Math.floor(uptimeSeconds / 3600);
                const m = Math.floor((uptimeSeconds % 3600) / 60);
                const s = uptimeSeconds % 60;
                document.getElementById('metric-uptime').innerText = 
                    `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }
        }

        async function fetchSystemStats(updateDetails = false) {
            if (!authToken) return;
            try {
                const res = await fetchWithAuth('/api/system/stats');
                if (!res.ok) throw new Error(res.statusText);
                const data = await res.json();
                lastSystemStats = data;
                window.lastSystemStats = data; // Ensure global access

                // Update Dashboard Cards
                if (document.getElementById('metric-cpu')) {
                    const cpu = (data.cpu_usage !== undefined && data.cpu_usage !== null) ? data.cpu_usage : 0;
                    document.getElementById('metric-cpu').innerText = cpu.toFixed(1) + '%';
                    if (document.getElementById('metric-cpu-bar')) {
                        document.getElementById('metric-cpu-bar').style.width = cpu.toFixed(1) + '%';
                    }
                }

                // OS Info
                if (data.os_platform || data.host_info) {
                    if (document.getElementById('metric-os-plat')) {
                        const plat = data.os_platform || (data.host_info ? data.host_info.platform : 'Unknown');
                        const ver = data.os_version || (data.host_info ? data.host_info.platformVersion : '');
                        const full = `${plat} ${ver}`.trim() || 'alpine 3.23.0'; // Fallback to user requested default if both missing
                        document.getElementById('metric-os-plat').innerText = full;
                        document.getElementById('metric-os-plat').title = full;
                    }
                    if (document.getElementById('metric-os-ver')) {
                         const kernel = data.host_info ? `ÂÜÖÊ†∏: ${data.host_info.kernelVersion}` : 'ÂÜÖÊ†∏: 6.8.0-86-generic';
                         document.getElementById('metric-os-ver').innerText = kernel;
                    }
                    if (document.getElementById('metric-os-arch')) {
                         document.getElementById('metric-os-arch').innerText = data.os_arch || (data.host_info ? data.host_info.kernelArch : '');
                    }
                }

                // Update Memory if provided in system stats
                if (data.mem_usage !== undefined && data.mem_usage !== null) {
                    // This might overlap with updateStats, but ensures system stats also update it
                    if (document.getElementById('metric-mem-percent')) {
                        document.getElementById('metric-mem-percent').innerText = data.mem_usage.toFixed(1) + '%';
                    }
                    if (document.getElementById('metric-mem-bar')) {
                        document.getElementById('metric-mem-bar').style.width = data.mem_usage.toFixed(1) + '%';
                    }
                }

                // Process List
                const procBody = document.getElementById('process-list');
                if (procBody && data.processes) {
                    if (data.processes.length === 0) {
                        procBody.innerHTML = '<tr><td colspan="4" class="text-center">ÊöÇÊó†Êï∞ÊçÆ</td></tr>';
                    } else {
                        procBody.innerHTML = data.processes.map(p => {
                            const cpu = (p.cpu !== undefined && p.cpu !== null) ? p.cpu : 0;
                            const mem = (p.memory !== undefined && p.memory !== null) ? p.memory : 0;
                            return `
                                <tr>
                                    <td>${p.pid}</td>
                                    <td class="text-truncate" style="max-width: 150px;" title="${p.name}">${p.name || 'unknown'}</td>
                                    <td>${cpu.toFixed(1)}%</td>
                                    <td>${(mem / 1024 / 1024).toFixed(1)}</td>
                                </tr>
                            `;
                        }).join('');
                    }
                }
                
                // Update Detail View if active
                if (updateDetails || (document.getElementById('tab-view-system-details') && document.getElementById('tab-view-system-details').style.display !== 'none')) {
                    updateDetailChart(); // This uses lastSystemStats
                }

            } catch (e) {
                console.error("Fetch system stats error:", e);
            }
        }

        function updateSystemStats() {
            fetchSystemStats();
        }

        // Handle Login Submit
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUser').value;
            const password = document.getElementById('loginPass').value;
            const errorBox = document.getElementById('loginError');
            const btnText = document.getElementById('loginBtnText');
            const btnLoading = document.getElementById('loginBtnLoading');
            
            errorBox.classList.add('d-none');
            btnText.classList.add('d-none');
            btnLoading.classList.remove('d-none');
            
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password})
                });
                
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.message || 'ÁôªÂΩïÂ§±Ë¥•ÔºöÁî®Êà∑ÂêçÊàñÂØÜÁ†ÅÈîôËØØ');
                }
                
                const data = await res.json();
                authToken = data.token;
                authRole = data.role;
                localStorage.setItem('wxbot_token', authToken);
                localStorage.setItem('wxbot_role', authRole);
                
                applyRoleUI(authRole);

                // Hide Login Page
                document.getElementById('loginPage').classList.add('hidden');
                setTimeout(() => {
                    document.getElementById('loginPage').style.display = 'none';
                }, 500);
                
                // Init
                startApp();
                
            } catch (err) {
                errorBox.innerText = err.message;
                errorBox.classList.remove('d-none');
            } finally {
                btnText.classList.remove('d-none');
                btnLoading.classList.add('d-none');
            }
        });

        function logout() {
            // Clear WebSocket connection if exists
            if (window.wsSubscriber) {
                try {
                    window.wsSubscriber.close();
                } catch (e) {
                    console.error('WebSocket close error:', e);
                }
                window.wsSubscriber = null;
            }
            
            // Clear all intervals
            if (window.updateInterval) clearInterval(window.updateInterval);
            if (window.systemStatsInterval) clearInterval(window.systemStatsInterval);
            if (window.chatStatsInterval) clearInterval(window.chatStatsInterval);
            if (window.botsInterval) clearInterval(window.botsInterval);
            if (window.workersInterval) clearInterval(window.workersInterval);
            
            // Clear localStorage
            localStorage.removeItem('wxbot_token');
            localStorage.removeItem('wxbot_role');
            
            // Clear session variables
            window.authToken = null;
            window.authRole = null;
            window.currentBotId = '';
            
            // Force reload with cache clear
            location.href = location.origin + location.pathname + '?logout=1';
        }

        // --- Navigation ---
        // Toggle Sidebar for Mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        }

        // --- Dashboard & Stats ---
        let memChart = null;
        let cpuChart = null;
        let msgChart = null;
        let lastMsgCount = 0;
        let lastSentCount = 0;
        let msgHistory = [];
        let sentHistory = [];
        let recvHistory = [];
        const MSG_HISTORY_SIZE = 30; // 30 * 2s = 60s
        const MAX_CHART_POINTS = 1800; // 1800 * 2s = 60 minutes

        function initCharts() {
            try {
                // Memory Chart
                const ctxMem = document.getElementById('memChart');
                if (ctxMem) {
                    memChart = new Chart(ctxMem.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Memory Alloc (MB)',
                                data: [],
                                borderColor: '#0d6efd',
                                tension: 0.4,
                                fill: true,
                                backgroundColor: 'rgba(13, 110, 253, 0.1)'
                            }]
                        },
                        options: {
                            responsive: true,
                            animation: false,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { 
                                y: { beginAtZero: true, grid: { display: true, drawBorder: false } },
                                x: { grid: { display: false } }
                            }
                        }
                    });
                }

                // CPU Chart
                const ctxCpu = document.getElementById('cpuChart');
                if (ctxCpu) {
                    cpuChart = new Chart(ctxCpu.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'CPU Usage (%)',
                                data: [],
                                borderColor: '#ffc107',
                                tension: 0.4,
                                fill: true,
                                backgroundColor: 'rgba(255, 193, 7, 0.1)'
                            }]
                        },
                        options: {
                            responsive: true,
                            animation: false,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { 
                                y: { beginAtZero: true, max: 100, grid: { display: true, drawBorder: false } },
                                x: { grid: { display: false } }
                            }
                        }
                    });
                }

                // Message Chart
                const ctxMsg = document.getElementById('msgChart');
                if (ctxMsg) {
                    msgChart = new Chart(ctxMsg.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [
                                {
                                    label: 'Êé•Êî∂',
                                    data: [],
                                    borderColor: '#198754', // Green
                                    tension: 0.4,
                                    fill: false,
                                    borderWidth: 2
                                },
                                {
                                    label: 'ÂèëÈÄÅ',
                                    data: [],
                                    borderColor: '#0d6efd', // Blue
                                    tension: 0.4,
                                    fill: false,
                                    borderWidth: 2
                                },
                                {
                                    label: 'ÊÄªÈáè',
                                    data: [],
                                    borderColor: '#6c757d', // Gray
                                    tension: 0.4,
                                    fill: false,
                                    borderDash: [5, 5],
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            animation: false,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            plugins: { 
                                legend: { display: true, position: 'top', labels: { boxWidth: 10, usePointStyle: true } },
                                tooltip: { mode: 'index', intersect: false }
                            },
                            scales: { 
                                y: { beginAtZero: true, grid: { display: true, drawBorder: false } },
                                x: { grid: { display: false } }
                            }
                        }
                    });
                }
            } catch (e) {
                console.error("Chart init error:", e);
            }
        }
        
        initCharts();

        function formatBytes(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            if (i < 0 || isNaN(i)) return '0 B';
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function rotateCombinedStats() {
            const container = document.getElementById('combined-stats-container');
            if (!container) return;
            
            const slides = container.querySelectorAll('.stats-slide');
            if (slides.length <= 1) return;
            
            let activeIndex = -1;
            for (let i = 0; i < slides.length; i++) {
                if (slides[i].classList.contains('active')) {
                    activeIndex = i;
                    break;
                }
            }
            
            if (activeIndex === -1) {
                slides[0].classList.add('active');
                slides[0].style.display = 'block';
                return;
            }
            
            // Hide current
            slides[activeIndex].classList.remove('active');
            slides[activeIndex].style.display = 'none';
            
            // Show next
            const nextIndex = (activeIndex + 1) % slides.length;
            slides[nextIndex].classList.add('active');
            slides[nextIndex].style.display = 'block';
            
            // Update icon
            const iconElement = document.querySelector('#combined-stats-icon i');
            if (iconElement) {
                const icons = ['bi-activity', 'bi-people', 'bi-chat-text'];
                iconElement.className = `bi ${icons[nextIndex]}`;
            }
        }

        function updateStats() {
            if (!authToken) return;
            fetchWithAuth('/api/stats')
                .then(r => r.json())
                .then(data => {
                    window.latestStats = data; // Store globally for details view
                    if (document.getElementById('metric-goroutines')) {
                        document.getElementById('metric-goroutines').innerText = data.goroutines !== undefined ? data.goroutines : '0';
                    }
                    if (document.getElementById('metric-mem')) {
                        const used = data.memory_used !== undefined ? data.memory_used : (data.memory_alloc !== undefined ? data.memory_alloc : 0);
                        document.getElementById('metric-mem').innerText = formatBytes(used);
                        if (data.memory_total && document.getElementById('metric-mem-bar')) {
                            const pct = (used / data.memory_total) * 100;
                            document.getElementById('metric-mem-bar').style.width = pct.toFixed(1) + '%';
                        }
                    }
                    if (document.getElementById('metric-mem-total')) {
                        document.getElementById('metric-mem-total').innerText = data.memory_total !== undefined ? formatBytes(data.memory_total) : '0 B';
                    }

                    if (document.getElementById('metric-bots')) {
                        document.getElementById('metric-bots').innerText = data.bot_count !== undefined ? data.bot_count : '0';
                    }
                    if (document.getElementById('metric-bots-offline')) {
                        document.getElementById('metric-bots-offline').innerText = data.bot_count_offline !== undefined ? data.bot_count_offline : '0';
                    }
                    if (document.getElementById('metric-bots-total')) {
                        document.getElementById('metric-bots-total').innerText = data.bot_count_total !== undefined ? data.bot_count_total : '0';
                    }
                    if (document.getElementById('metric-workers')) {
                        document.getElementById('metric-workers').innerText = data.worker_count !== undefined ? data.worker_count : '0';
                    }

                    // CPU & OS Details
                    if (document.getElementById('metric-cpu-model') && data.cpu_model) {
                         let model = data.cpu_model;
                         if (model.length > 25) model = model.substring(0, 25) + '...';
                         document.getElementById('metric-cpu-model').innerText = model;
                         const card = document.getElementById('metric-cpu-model').closest('.stat-card');
                         if (card) card.title = data.cpu_model;
                    }
                    if (document.getElementById('metric-cpu-cores')) {
                         document.getElementById('metric-cpu-cores').innerText = (data.cpu_cores_physical || 0) + 'P/' + (data.cpu_cores_logical || 0) + 'L';
                    }
                    if (document.getElementById('metric-cpu-freq')) {
                         document.getElementById('metric-cpu-freq').innerText = (data.cpu_freq || 0).toFixed(0) + ' MHz';
                    }
                    if (document.getElementById('metric-os-plat')) {
                        document.getElementById('metric-os-plat').innerText = data.os_platform || 'Unknown';
                    }
                    if (document.getElementById('metric-os-ver')) {
                        const t = translations[currentLang] || translations['zh-CN'];
                        document.getElementById('metric-os-ver').innerText = (t.version_label || 'ÁâàÊú¨: ') + (data.os_version || 'Unknown');
                    }

                    if (data.start_time) {
                        serverStartTime = data.start_time;
                    }

                    // New metrics
                    if (document.getElementById('metric-groups-today')) document.getElementById('metric-groups-today').innerText = (data.active_groups_today !== undefined && data.active_groups_today !== null) ? data.active_groups_today : 0;
                    if (document.getElementById('metric-groups-total')) document.getElementById('metric-groups-total').innerText = (data.active_groups !== undefined && data.active_groups !== null) ? data.active_groups : 0;
                    if (document.getElementById('metric-users-today')) document.getElementById('metric-users-today').innerText = (data.active_users_today !== undefined && data.active_users_today !== null) ? data.active_users_today : 0;
                    if (document.getElementById('metric-users-total')) document.getElementById('metric-users-total').innerText = (data.active_users !== undefined && data.active_users !== null) ? data.active_users : 0;
                    if (document.getElementById('metric-msgs-total')) document.getElementById('metric-msgs-total').innerText = (data.message_count !== undefined && data.message_count !== null) ? data.message_count : 0;
                    if (document.getElementById('metric-sent-total')) document.getElementById('metric-sent-total').innerText = (data.sent_message_count !== undefined && data.sent_message_count !== null) ? data.sent_message_count : 0;

                    const now = new Date().toLocaleTimeString();

                    let justInitialized = false;

                    // --- Init History (Once) ---
                    if (data.cpu_trend && cpuChart && cpuChart.data.labels.length === 0) {
                        data.cpu_trend.forEach(() => cpuChart.data.labels.push(''));
                        cpuChart.data.datasets[0].data = data.cpu_trend;
                        cpuChart.update();
                        justInitialized = true;
                    }
                    if (data.mem_trend && memChart && memChart.data.labels.length === 0) {
                        data.mem_trend.forEach(() => memChart.data.labels.push(''));
                        memChart.data.datasets[0].data = data.mem_trend.map(v => v / 1024 / 1024);
                        memChart.update();
                        justInitialized = true;
                    }
                    if (data.msg_trend && msgChart && msgChart.data.labels.length === 0) {
                        // Load history
                        msgHistory = [...data.msg_trend];
                        sentHistory = data.sent_trend ? [...data.sent_trend] : new Array(msgHistory.length).fill(0);
                        recvHistory = data.recv_trend ? [...data.recv_trend] : new Array(msgHistory.length).fill(0);

                        // Reconstruct chart data (Moving Sum)
                        const chartDataRecv = [];
                        const chartDataSent = [];
                        const chartDataTotal = [];
                        const labels = [];
                        
                        for (let i = 0; i < msgHistory.length; i++) {
                            let start = Math.max(0, i - MSG_HISTORY_SIZE + 1);
                            let sumTotal = 0, sumSent = 0, sumRecv = 0;
                            for (let j = start; j <= i; j++) {
                                sumTotal += msgHistory[j] || 0;
                                sumSent += sentHistory[j] || 0;
                                sumRecv += recvHistory[j] || 0;
                            }
                            chartDataRecv.push(sumRecv);
                            chartDataSent.push(sumSent);
                            chartDataTotal.push(sumTotal);
                            labels.push('');
                        }
                        msgChart.data.labels = labels;
                        msgChart.data.datasets[0].data = chartDataRecv;
                        msgChart.data.datasets[1].data = chartDataSent;
                        msgChart.data.datasets[2].data = chartDataTotal;
                        msgChart.update();
                        
                        // Sync counters
                        lastMsgCount = data.message_count || 0;
                        lastSentCount = data.sent_message_count || 0;
                        justInitialized = true;
                    }

                    // Update Memory Chart
                    if (memChart && !justInitialized) {
                        if (memChart.data.labels.length > MAX_CHART_POINTS) {
                            memChart.data.labels.shift();
                            memChart.data.datasets[0].data.shift();
                        }
                        memChart.data.labels.push(now);
                        memChart.data.datasets[0].data.push(data.memory_alloc / 1024 / 1024);
                        memChart.update();
                    }
                    
                    // Update Message Chart
                    if (msgChart && !justInitialized) {
                        const currentTotal = data.message_count || 0;
                        const currentSent = data.sent_message_count || 0;
                        
                        const diffTotal = currentTotal - lastMsgCount;
                        const diffSent = currentSent - lastSentCount;
                        
                        // Avoid spike on first load
                        const valTotal = lastMsgCount === 0 ? 0 : (diffTotal < 0 ? 0 : diffTotal);
                        const valSent = lastSentCount === 0 ? 0 : (diffSent < 0 ? 0 : diffSent);
                        const valRecv = (valTotal - valSent) < 0 ? 0 : (valTotal - valSent);
                        
                        lastMsgCount = currentTotal;
                        lastSentCount = currentSent;

                        // Add to history
                        msgHistory.push(valTotal);
                        sentHistory.push(valSent);
                        recvHistory.push(valRecv);

                        if (msgHistory.length > MSG_HISTORY_SIZE) msgHistory.shift();
                        if (sentHistory.length > MSG_HISTORY_SIZE) sentHistory.shift();
                        if (recvHistory.length > MSG_HISTORY_SIZE) recvHistory.shift();

                        const rateTotal = msgHistory.reduce((a, b) => a + b, 0);
                        const rateSent = sentHistory.reduce((a, b) => a + b, 0);
                        const rateRecv = recvHistory.reduce((a, b) => a + b, 0);

                        if (msgChart.data.labels.length > MAX_CHART_POINTS) {
                            msgChart.data.labels.shift();
                            msgChart.data.datasets.forEach(d => d.data.shift());
                        }
                        msgChart.data.labels.push(now);
                        msgChart.data.datasets[0].data.push(rateRecv);
                        msgChart.data.datasets[1].data.push(rateSent);
                        msgChart.data.datasets[2].data.push(rateTotal);
                        msgChart.update();
                    }

                    // Update CPU Chart
                    if (cpuChart && !justInitialized) {
                        if (cpuChart.data.labels.length > MAX_CHART_POINTS) {
                            cpuChart.data.labels.shift();
                            cpuChart.data.datasets[0].data.shift();
                        }
                        cpuChart.data.labels.push(now);
                        cpuChart.data.datasets[0].data.push(data.cpu_usage);
                        cpuChart.update();
                    }

                    // Save stats to cache
                    saveStatsToCache({
                        bot_count: data.bot_count,
                        bot_count_offline: data.bot_count_offline || 0,
                        bot_count_total: data.bot_count_total || 0,
                        // Cache other critical stats if needed
                        memory_total: data.memory_total,
                        cpu_model: data.cpu_model,
                        cpu_cores_physical: data.cpu_cores_physical,
                        cpu_cores_logical: data.cpu_cores_logical,
                        cpu_freq: data.cpu_freq
                    });

                })
                .catch(e => console.error("Update stats error:", e));
        }

        // --- Cache Logic ---
        function saveStatsToCache(stats) {
            localStorage.setItem('bot_stats_cache', JSON.stringify(stats));
        }

        function loadStatsFromCache() {
            const cached = localStorage.getItem('bot_stats_cache');
            if (cached) {
                try {
                    const stats = JSON.parse(cached);
                    if (document.getElementById('metric-bots')) {
                        document.getElementById('metric-bots').innerText = stats.bot_count || 0;
                    }
                    if (document.getElementById('metric-bots-offline')) {
                        document.getElementById('metric-bots-offline').innerText = stats.bot_count_offline || 0;
                    }
                    if (document.getElementById('metric-bots-total')) {
                        document.getElementById('metric-bots-total').innerText = stats.bot_count_total || 0;
                    }
                    if (document.getElementById('metric-workers')) {
                        document.getElementById('metric-workers').innerText = stats.worker_count || 0;
                    }
                    
                    if (document.getElementById('metric-mem-total') && stats.memory_total) {
                        document.getElementById('metric-mem-total').innerText = formatBytes(stats.memory_total);
                    }

                    // CPU Details Cache
                    if (document.getElementById('metric-cpu-model') && stats.cpu_model) {
                         let model = stats.cpu_model;
                         if (model.length > 25) model = model.substring(0, 25) + '...';
                         document.getElementById('metric-cpu-model').innerText = model;
                         const card = document.getElementById('metric-cpu-model').closest('.stat-card');
                         if (card) card.title = stats.cpu_model;
                    }
                    if (document.getElementById('metric-cpu-cores') && stats.cpu_cores_physical) {
                         document.getElementById('metric-cpu-cores').innerText = (stats.cpu_cores_physical || 0) + 'P/' + (stats.cpu_cores_logical || 0) + 'L Ê†∏';
                    }
                    if (document.getElementById('metric-cpu-freq') && stats.cpu_freq) {
                         document.getElementById('metric-cpu-freq').innerText = (stats.cpu_freq || 0).toFixed(0) + ' MHz';
                    }
                } catch (e) {
                    console.error("Failed to load cached stats", e);
                }
            }
        }
        
        // Load cache immediately
        loadStatsFromCache();
        
        // --- Bots & Workers ---
        let currentBots = [];
        let botSortBy = 'name'; // name, id, count, time
        let botSortAsc = true;
        let botFilterText = '';
        let botViewMode = localStorage.getItem('bot_view_mode') || 'detail';

        let currentWorkers = [];
        let workerSortBy = 'addr'; // addr, time, status
        let workerSortAsc = true;
        let workerFilterText = '';
        let workerViewMode = localStorage.getItem('worker_view_mode') || 'detail';

        // Update View Mode UI on Load
        document.addEventListener('DOMContentLoaded', () => {
             updateViewModeUI('bot', botViewMode);
             updateViewModeUI('worker', workerViewMode);
        });

        function setBotViewMode(mode) {
            botViewMode = mode;
            window._botViewModeManuallySet = true;
            localStorage.setItem('bot_view_mode', mode);
            updateViewModeUI('bot', mode);
            renderBots();
        }

        function setWorkerViewMode(mode) {
            workerViewMode = mode;
            window._workerViewModeManuallySet = true;
            localStorage.setItem('worker_view_mode', mode);
            updateViewModeUI('worker', mode);
            renderWorkers();
        }

        function updateViewModeUI(type, mode) {
            const btnDetail = document.getElementById(`btn-${type}-view-detail`);
            const btnCompact = document.getElementById(`btn-${type}-view-compact`);
            if (btnDetail && btnCompact) {
                if (mode === 'detail') {
                    btnDetail.classList.add('active');
                    btnCompact.classList.remove('active');
                } else {
                    btnDetail.classList.remove('active');
                    btnCompact.classList.add('active');
                }
            }
        }

        function timeAgo(date) {
            const t = translations[currentLang] || translations['zh-CN'];
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + t.time_ago_year;
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + t.time_ago_month;
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + t.time_ago_day;
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + t.time_ago_hour;
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + t.time_ago_minute;
            return Math.floor(seconds) + t.time_ago_second;
        }

        function updateBots() {
            fetchBots();
        }

        function fetchBots(showLoading = false) {
            if (!authToken) return;
            const t = translations[currentLang] || translations['zh-CN'];
            
            if (showLoading) {
                const container = document.getElementById('bot-list-container');
                if (container) {
                    container.innerHTML = `
                        <div class="col-12 text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="mt-2 text-muted">${t.loading || 'Âä†ËΩΩ‰∏≠...'}</div>
                        </div>
                    `;
                }
            }

            fetchWithAuth('/api/bots')
                .then(r => r.json())
                .then(bots => {
                    currentBots = bots;
                    const onlineCount = bots.filter(b => b.is_alive).length;
                    
                    // Update Badge
                    const badge = document.getElementById('badge-bots');
                    if (badge) badge.innerText = onlineCount + '/' + bots.length;

                    // Update Metrics
                    if (document.getElementById('metric-bots')) {
                        document.getElementById('metric-bots').innerText = onlineCount;
                    }

                    // Update Global Selector (Dropdown)
                    const selectorInput = document.getElementById('global-bot-selector');
                    const dropdownList = document.getElementById('global-bot-list');
                    const currentVal = selectorInput.value;
                    
                    if (bots.length === 0) {
                        dropdownList.innerHTML = `<li><span class="dropdown-item disabled">${t.no_bot_data_simple}</span></li>`;
                        document.getElementById('global-bot-selected-content').innerHTML = t.no_bot_data_simple;
                    } else {
                        dropdownList.innerHTML = bots.map(bot => {
                            const isOffline = !bot.is_alive;
                            const statusClass = isOffline ? 'text-muted' : 'text-success fw-bold';
                            const badge = isOffline ? `<span class="badge bg-secondary ms-auto">${t.bot_status_offline}</span>` : `<span class="badge bg-success ms-auto">${t.bot_status_online}</span>`;
                            const platform = bot.platform || 'QQ';
                            let avatarUrl = `https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/robot.svg`;
                            if (platform === 'QQ') {
                                avatarUrl = `https://q1.qlogo.cn/g?b=qq&nk=${bot.self_id}&s=100`;
                            }
                            
                            return `
                                <li>
                                    <a class="dropdown-item d-flex align-items-center p-2 ${isOffline ? 'disabled' : ''}" href="#" onclick="${isOffline ? 'return false;' : `selectBotFromDropdown('${bot.self_id}')`}">
                                        <div class="rounded-circle d-flex align-items-center justify-content-center me-2 flex-shrink-0" style="width: 32px; height: 32px; overflow: hidden; background: ${avatarBg};">
                                            <img src="${avatarUrl}" alt="" style="width: 100%; height: 100%; object-fit: cover;">
                                        </div>
                                        <div class="flex-grow-1 overflow-hidden">
                                            <div class="d-flex align-items-center">
                                                <div class="fw-bold text-truncate ${statusClass}" style="max-width: 120px;">${bot.nickname || bot.self_id}</div>
                                                ${badge}
                                            </div>
                                            <div class="text-muted small">${bot.self_id}</div>
                                        </div>
                                    </a>
                                </li>
                            `;
                        }).join('');
                        
                        // Restore selection or select first online
                        let targetId = currentVal;
                        if (!targetId || !bots.find(b => b.self_id === targetId && b.is_alive)) {
                            const firstOnline = bots.find(b => b.is_alive);
                            if (firstOnline) {
                                targetId = firstOnline.self_id;
                            }
                        }
                        
                        if (targetId) {
                            updateBotSelectorUI(targetId);
                            if (currentBotId !== targetId) {
                                currentBotId = targetId;
                            }
                        }
                    }

                    renderBots();
                    updateLogBotSelector(bots);
                    updateLogBotSelectorFull(bots);
                });
        }

        function updateLogBotSelector(bots) {
             const selector = document.getElementById('log-bot-selector');
             if (!selector) return;
             // Keep selection
             const current = selector.value;
             const t = translations[currentLang] || translations['zh-CN'];
             
             let html = `<option value="">${t.log_all}</option>`;
             html += `<option value="system">${t.log_system}</option>`;
             
             bots.forEach(b => {
                 const name = b.nickname || b.self_id;
                 const status = b.is_alive ? '' : ' (Offline)';
                 html += `<option value="${b.self_id}">${name} (${b.platform})${status}</option>`;
             });
             selector.innerHTML = html;
             selector.value = current;
        }

        function filterBots(text) {
            botFilterText = text.toLowerCase();
            renderBots();
        }

        function sortBots(field) {
            if (botSortBy === field) {
                botSortAsc = !botSortAsc;
            } else {
                botSortBy = field;
                botSortAsc = true;
                if (field === 'count' || field === 'time' || field === 'msg') botSortAsc = false;
            }

            const t = translations[currentLang] || translations['zh-CN'];

            // Update UI
            ['name', 'id', 'platform', 'count', 'time', 'msg'].forEach(f => {
                const btn = document.getElementById(`btn-sort-bot-${f}`);
                if (f === botSortBy) {
                    btn.classList.add('active');
                    let label = '';
                    switch(f) {
                        case 'name': label = t.sort_name; break;
                        case 'id': label = t.sort_id; break;
                        case 'platform': label = t.sort_platform; break;
                        case 'count': label = t.sort_group_count; break;
                        case 'time': label = t.sort_time; break;
                        case 'msg': label = t.sort_msg_count; break;
                    }
                    btn.innerHTML = label + (botSortAsc ? ' ‚Üë' : ' ‚Üì');
                } else {
                    btn.classList.remove('active');
                    let label = '';
                    switch(f) {
                        case 'name': label = t.sort_name; break;
                        case 'id': label = t.sort_id; break;
                        case 'platform': label = t.sort_platform; break;
                        case 'count': label = t.sort_group_count; break;
                        case 'time': label = t.sort_time; break;
                        case 'msg': label = t.sort_msg_count; break;
                    }
                    btn.innerHTML = label;
                }
            });

            renderBots();
        }

        function renderBots() {
            const container = document.getElementById('bot-list-container');
            let bots = currentBots.filter(b => {
                if (!botFilterText) return true;
                return (b.nickname || '').toLowerCase().includes(botFilterText) || 
                       (b.self_id || '').includes(botFilterText) ||
                       (b.platform || '').toLowerCase().includes(botFilterText);
            });

            // Auto switch to compact mode if many bots
            if (bots.length > 12 && botViewMode === 'detail' && !window._botViewModeManuallySet) {
                botViewMode = 'compact';
                document.getElementById('btn-bot-view-detail').classList.remove('active');
                document.getElementById('btn-bot-view-compact').classList.add('active');
            }

            // Sort
            bots.sort((a, b) => {
                // Always put online bots first
                if (a.is_alive !== b.is_alive) {
                    return a.is_alive ? -1 : 1;
                }

                let res = 0;
                if (botSortBy === 'name') {
                    res = (a.nickname || '').localeCompare(b.nickname || '', 'zh-CN');
                } else if (botSortBy === 'id') {
                    res = (a.self_id || '').localeCompare(b.self_id || '');
                } else if (botSortBy === 'count') {
                    res = (a.group_count || 0) - (b.group_count || 0);
                } else if (botSortBy === 'time') {
                    res = new Date(a.connected) - new Date(b.connected);
                } else if (botSortBy === 'platform') {
                    res = (a.platform || 'QQ').localeCompare(b.platform || 'QQ', 'zh-CN');
                } else if (botSortBy === 'msg') {
                    res = (a.msg_count || 0) - (b.msg_count || 0);
                }
                
                // Primary sort result
                if (res !== 0) {
                    return botSortAsc ? res : -res;
                }
                
                // Secondary sort: ID (Always Ascending)
                return (a.self_id || '').localeCompare(b.self_id || '');
            });

            const t = translations[currentLang] || translations['zh-CN'];
            if (bots.length === 0) {
                container.innerHTML = `<div class="col-12 text-center text-muted">${t.no_bot_data}</div>`;
            } else {
                container.innerHTML = bots.map(bot => {
                    const connDate = new Date(bot.connected);
                    const timeStr = timeAgo(bot.connected);
                    const isOffline = !bot.is_alive;
                    const cardStyle = isOffline ? 'filter: grayscale(100%); opacity: 0.8;' : '';
                    const statusBadge = isOffline ? `<span class="badge bg-secondary ms-2">${t.bot_status_offline}</span>` : `<span class="badge bg-success ms-2">${t.bot_status_online}</span>`;
                    const timeLabel = isOffline ? t.card_status_offline_since : t.card_status_connected_at;
                    const platform = bot.platform || 'QQ';
                    let avatarUrl = `https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/robot.svg`;
                    let avatarBg = 'var(--bg-list-item)';
                    
                    if (platform.toUpperCase() === 'QQ') {
                        avatarUrl = `https://q1.qlogo.cn/g?b=qq&nk=${bot.self_id}&s=640`;
                    } else if (platform.toUpperCase().includes('TELEGRAM') || platform.toUpperCase() === 'TG') {
                        avatarUrl = `https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/telegram.svg`;
                        avatarBg = '#0088cc22';
                    } else if (platform.toUpperCase().includes('DISCORD')) {
                        avatarUrl = `https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/discord.svg`;
                        avatarBg = '#5865F222';
                    } else if (platform.toUpperCase().includes('WECHAT') || platform.toUpperCase().includes('WX')) {
                        avatarUrl = `https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/wechat.svg`;
                        avatarBg = '#07C16022';
                    } else if (platform.toUpperCase().includes('FEISHU') || platform.toUpperCase().includes('LARK')) {
                        avatarUrl = `https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/chat-dots.svg`;
                        avatarBg = '#3370ff22';
                    } else if (platform.toUpperCase().includes('DING')) {
                        avatarUrl = `https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/lightning-charge.svg`;
                        avatarBg = '#007FFF22';
                    }
                    const platformBadge = `<span class="badge bg-info ms-1">${platform}</span>`;

                    if (botViewMode === 'compact') {
                         return `
                        <div class="col-sm-6 col-md-4 col-lg-3 col-xl-2 mb-3">
                            <div class="card p-2 h-100 shadow-sm" style="${cardStyle}">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="rounded-circle d-flex align-items-center justify-content-center me-2 flex-shrink-0" style="width: 32px; height: 32px; overflow: hidden; background: ${avatarBg};">
                                        <img src="${avatarUrl}" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/robot.svg';this.style.padding='4px';">
                                    </div>
                                    <div class="overflow-hidden w-100">
                                        <div class="d-flex align-items-center">
                                            <div class="fw-bold text-truncate" title="${bot.nickname || bot.self_id}" style="font-size: 0.85rem;">${bot.nickname || bot.self_id}</div>
                                            ${isOffline ? '<span class="badge bg-secondary ms-1" style="font-size: 0.6em;">OFF</span>' : '<span class="badge bg-success ms-1" style="font-size: 0.6em;">ON</span>'}
                                        </div>
                                        <div class="text-muted text-truncate" style="font-size: 0.7rem;">${platform} | ${bot.self_id}</div>
                                    </div>
                                </div>
                                <div class="rounded p-1 mb-2 flex-grow-1" style="background-color: var(--bg-list-item); font-size: 0.75rem;">
                                     <div class="d-flex justify-content-between">
                                        <span class="text-muted">${t.card_label_groups}: ${bot.group_count || 0}</span>
                                        <span class="text-muted">${t.card_label_friends}: ${bot.friend_count || 0}</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted">${t.card_label_msgs}:</span>
                                        <span class="text-primary fw-bold">${bot.msg_count || 0}</span>
                                    </div>
                                </div>
                                <div class="mt-auto">
                                    <button class="btn btn-sm btn-outline-primary w-100 py-0" style="font-size: 0.75rem;" onclick="setGlobalBot('${bot.self_id}')" ${isOffline ? 'disabled' : ''}>${t.btn_manage}</button>
                                </div>
                            </div>
                        </div>`;
                    }

                    return `
                        <div class="col-sm-12 col-md-6 col-lg-4 col-xl-4 col-xxl-3 mb-3">
                            <div class="card p-2 h-100 shadow-sm" style="${cardStyle}">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="rounded-circle d-flex align-items-center justify-content-center me-2 flex-shrink-0" style="width: 48px; height: 48px; overflow: hidden; background: ${avatarBg};">
                                        <img src="${avatarUrl}" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/robot.svg';this.style.padding='8px';">
                                    </div>
                                    <div class="overflow-hidden w-100">
                                        <div class="d-flex align-items-center">
                                            <div class="fw-bold text-truncate" title="${bot.nickname || bot.self_id}" style="font-size: 0.9rem;">${bot.nickname || bot.self_id}</div>
                                            ${statusBadge}
                                            ${platformBadge}
                                        </div>
                                        <div class="text-muted text-truncate" style="font-size: 0.7rem;">ID: ${bot.self_id}</div>
                                    </div>
                                </div>
                                <div class="rounded p-2 mb-2 flex-grow-1" style="background-color: var(--bg-list-item); font-size: 0.75rem;">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted">${t.card_label_groups}:</span>
                                        <span class="fw-bold text-primary">${bot.group_count || 0}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted">${t.card_label_friends}:</span>
                                        <span class="fw-bold text-success">${bot.friend_count || 0}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted">${t.card_label_msgs}:</span>
                                        <span><span class="fw-bold text-primary">${bot.msg_count || 0}</span> <span class="text-muted" style="font-size: 0.7em;">(${t.sort_today}:${bot.msg_count_today || 0})</span></span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted">${t.card_label_ip}:</span>
                                        <span class="text-truncate" style="max-width: 80px;" title="${bot.remote_addr}">${bot.remote_addr ? bot.remote_addr.split(':')[0] : 'N/A'}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted">${timeLabel}</span>
                                        <span title="${connDate.toLocaleString()}">${timeStr}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted">${t.card_label_protocol}:</span>
                                        <span class="fw-bold text-info">${platform}</span>
                                    </div>
                                    ${bot.owner ? `
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted">${t.card_label_owner}:</span>
                                        <span>${bot.owner}</span>
                                    </div>` : ''}
                                </div>
                                <div class="mt-auto">
                                    <button class="btn btn-sm btn-outline-primary w-100 py-1" style="font-size: 0.8rem;" onclick="setGlobalBot('${bot.self_id}')" ${isOffline ? 'disabled' : ''}>${t.btn_manage}</button>
                                </div>
                            </div>
                        </div>
                    `}).join('');
            }
        }

        function fetchWorkers(showLoading = false) {
            if (!authToken) return;
            const t = translations[currentLang] || translations['zh-CN'];

            if (showLoading) {
                const container = document.getElementById('worker-list-container');
                if (container) {
                    container.innerHTML = `
                        <div class="col-12 text-center py-5">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="mt-2 text-muted">${t.loading || 'Âä†ËΩΩ‰∏≠...'}</div>
                        </div>
                    `;
                }
            }

            fetchWithAuth('/api/workers')
                .then(r => r.json())
                .then(workers => {
                    currentWorkers = workers;
                    
                    // Update Badge
                    const badge = document.getElementById('badge-workers');
                    if (badge) badge.innerText = workers.length;

                    // Update Metrics
                    if (document.getElementById('metric-workers')) {
                        document.getElementById('metric-workers').innerText = workers.length;
                    }

                    renderWorkers();
                });
        }

        function filterWorkers(text) {
            workerFilterText = text.toLowerCase();
            renderWorkers();
        }

        function sortWorkers(field) {
            if (workerSortBy === field) {
                workerSortAsc = !workerSortAsc;
            } else {
                workerSortBy = field;
                workerSortAsc = true;
                if (field === 'time' || field === 'msg') workerSortAsc = false;
            }

            const t = translations[currentLang] || translations['zh-CN'];

            // Update UI
            ['addr', 'time', 'status', 'msg'].forEach(f => {
                const btn = document.getElementById(`btn-sort-worker-${f}`);
                if (f === workerSortBy) {
                    btn.classList.add('active');
                    let label = '';
                    switch(f) {
                        case 'addr': label = t.sort_address; break;
                        case 'time': label = t.sort_time; break;
                        case 'status': label = t.sort_status; break;
                        case 'msg': label = t.sort_processed; break;
                    }
                    btn.innerHTML = label + (workerSortAsc ? ' ‚Üë' : ' ‚Üì');
                } else {
                    btn.classList.remove('active');
                    let label = '';
                    switch(f) {
                        case 'addr': label = t.sort_address; break;
                        case 'time': label = t.sort_time; break;
                        case 'status': label = t.sort_status; break;
                        case 'msg': label = t.sort_processed; break;
                    }
                    btn.innerHTML = label;
                }
            });

            renderWorkers();
        }

        function renderWorkers() {
            const container = document.getElementById('worker-list-container');
            let workers = currentWorkers.filter(w => {
                if (!workerFilterText) return true;
                return (w.remote_addr || '').includes(workerFilterText) || 
                       (w.status || '').toLowerCase().includes(workerFilterText);
            });

            // Auto switch to compact mode if many workers
            if (workers.length > 8 && workerViewMode === 'detail' && !window._workerViewModeManuallySet) {
                workerViewMode = 'compact';
                updateViewModeUI('worker', 'compact');
            }

            // Sort
            workers.sort((a, b) => {
                let res = 0;
                if (workerSortBy === 'addr') {
                    res = (a.remote_addr || '').localeCompare(b.remote_addr || '');
                } else if (workerSortBy === 'time') {
                    res = new Date(a.connected) - new Date(b.connected);
                } else if (workerSortBy === 'status') {
                    res = (a.status || '').localeCompare(b.status || '');
                } else if (workerSortBy === 'msg') {
                    res = (a.handled_count || 0) - (b.handled_count || 0);
                }
                return workerSortAsc ? res : -res;
            });

            const t = translations[currentLang] || translations['zh-CN'];
            if (workers.length === 0) {
                container.innerHTML = `<div class="col-12 text-center text-muted">${t.no_workers}</div>`;
                return;
            }
            container.innerHTML = workers.map(w => {
                const connDate = new Date(w.connected);
                const timeStr = timeAgo(w.connected);
                const addr = w.remote_addr || w.id || 'Unknown';
                const status = w.status || 'Online';
                const addrDisplay = addr.includes(':') ? addr.split(':')[0] : addr;
                
                if (workerViewMode === 'compact') {
                    return `
                    <div class="col-sm-6 col-md-6 col-lg-4 col-xl-4 col-xxl-3 mb-3">
                        <div class="card p-2 h-100 shadow-sm">
                            <div class="d-flex align-items-center mb-2">
                                <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-2 flex-shrink-0" style="width: 32px; height: 32px;">
                                    <i class="bi bi-gear-wide-connected fs-6"></i>
                                </div>
                                <div class="overflow-hidden w-100">
                                    <div class="fw-bold text-truncate" style="font-size: 0.85rem;">${t.worker_node_title}</div>
                                    <div class="text-muted text-truncate" style="font-size: 0.7rem;">${addrDisplay}</div>
                                </div>
                            </div>
                            <div class="bg-light rounded p-1 mb-2 flex-grow-1" style="font-size: 0.75rem;">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">${t.card_label_status}:</span>
                                    <span class="text-success">${status}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">${t.card_label_latency}:</span>
                                    <span class="text-info fw-bold">${w.avg_rtt || '0s'}</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">${t.card_label_processed}:</span>
                                    <span class="text-primary fw-bold">${w.handled_count || 0}</span>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }

                return `
                    <div class="col-sm-12 col-md-6 col-lg-6 col-xl-6 col-xxl-4 mb-3">
                        <div class="card p-2 h-100 shadow-sm">
                            <div class="d-flex align-items-center mb-2">
                                <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-2 flex-shrink-0" style="width: 36px; height: 36px;">
                                    <i class="bi bi-gear-wide-connected fs-5"></i>
                                </div>
                                <div class="overflow-hidden w-100">
                                    <div class="fw-bold text-truncate" style="font-size: 0.9rem;">${t.worker_node}</div>
                                    <div class="text-muted text-truncate" style="font-size: 0.7rem;">${t.worker_node_title}</div>
                                </div>
                            </div>
                            <div class="bg-light rounded p-2 mb-2 flex-grow-1" style="font-size: 0.75rem;">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">${t.card_label_ip}:</span>
                                    <span class="text-truncate" style="max-width: 80px;" title="${addr}">${addrDisplay}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">${t.card_label_connected}:</span>
                                    <span title="${connDate.toLocaleString()}">${timeStr}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">${t.card_label_status}:</span>
                                    <span class="text-success">${status}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">${t.card_label_latency}:</span>
                                    <span class="text-info fw-bold">${w.avg_rtt || '0s'}</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">${t.card_label_processed_msgs}:</span>
                                    <span class="text-primary fw-bold">${w.handled_count || 0}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `}).join('');
        }

        // --- Log Truncation & Interaction ---
        function renderLogMessage(message) {
            const MAX_LEN = 300;
            if (!message || message.length <= MAX_LEN) return message;
            
            // Simple escape to prevent breaking HTML structure
            // We assume message is mostly text. If it contains HTML tags, this simple truncation might break them.
            // For safety, we treat it as text for the truncated part, but we must be careful not to double escape if the original was HTML.
            // Given the existing code uses ${log.message} directly, we assume it's raw text or safe HTML.
            
            const shortMsg = message.substring(0, MAX_LEN) + '...';
            const t = translations[currentLang] || translations['zh-CN'];
            
            return `<span class="log-short" style="cursor:pointer; text-decoration:underline dotted; color: inherit;" onclick="toggleLogExpand(this)" title="${t.log_expand}">${shortMsg}</span>` + 
                   `<span class="log-full" style="display:none; cursor:pointer; color: inherit;" onclick="toggleLogExpand(this)" title="${t.log_collapse}">${message}</span>`;
        }

        function toggleLogExpand(el) {
            const parent = el.parentElement;
            const shortSpan = parent.querySelector('.log-short');
            const fullSpan = parent.querySelector('.log-full');
            
            // Pause refresh when clicked
            const autoRefreshFull = document.getElementById('auto-refresh-logs-full');
            if (autoRefreshFull) autoRefreshFull.checked = false;
            
            const autoRefreshWidget = document.getElementById('auto-refresh-logs');
            if (autoRefreshWidget) autoRefreshWidget.checked = false;

            if (el.classList.contains('log-short')) {
                shortSpan.style.display = 'none';
                fullSpan.style.display = 'inline';
            } else {
                shortSpan.style.display = 'inline';
                fullSpan.style.display = 'none';
            }
        }

        // --- Logs (Full Page) ---
        function fetchLogsFull() {
            if (!authToken) return;
            const t = translations[currentLang] || translations['zh-CN'];
            const container = document.getElementById('log-container-full');
            if (!container) return;

            // Show loading if container is empty or we want to show it
            if (!container.innerHTML || container.innerHTML.trim() === '') {
                container.innerHTML = `<div class="text-center py-5 text-muted"><div class="spinner-border spinner-border-sm me-2"></div>${t.loading || 'Âä†ËΩΩ‰∏≠...'}</div>`;
            }

            const selector = document.getElementById('log-bot-selector-full');
            const botId = selector ? selector.value : '';

            fetchWithAuth(`/api/logs?bot_id=${botId}`)
                .then(r => r.json())
                .then(data => {
                    const logs = data.logs || [];
                    const container = document.getElementById('log-container-full');
                    if (!container) return;
                    
                    container.innerHTML = logs.map(log => `
                        <div class="log-entry">
                            <span class="log-time">[${log.time}]</span>
                            <span class="log-level-${log.level}">${log.level}</span>: 
                            ${renderLogMessage(log.message)}
                        </div>
                    `).join('');
                    // Scroll to bottom
                    container.scrollTop = container.scrollHeight;
                });
        }
        
        // Sync selectors
        function updateLogBotSelectorFull(bots) {
             const selector = document.getElementById('log-bot-selector-full');
             if (!selector) return;
             // Keep selection
             const current = selector.value;
             const t = translations[currentLang] || translations['zh-CN'];
             
             let html = `<option value="">${t.log_all}</option>`;
             html += `<option value="system">${t.log_system}</option>`;
             
             bots.forEach(b => {
                 const name = b.nickname || b.self_id;
                 const status = b.is_alive ? '' : ' (Offline)';
                 html += `<option value="${b.self_id}">${name} (${b.platform})${status}</option>`;
             });
             selector.innerHTML = html;
             selector.value = current;
        }

        // setInterval(() => {
        //     // Auto refresh full page logs - Disabled to prevent jumping, relying on WebSocket
        //     if (document.getElementById('tab-logs') && 
        //         document.getElementById('tab-logs').style.display !== 'none' && 
        //         document.getElementById('auto-refresh-logs-full').checked) {
        //         fetchLogsFull();
        //     }
        // }, 2000);

        // --- Logs (Widget) ---
        function fetchLogs() {
            if (!authToken) return;
            const t = translations[currentLang] || translations['zh-CN'];
            const container = document.getElementById('log-container');
            if (!container) return;

            // Show loading if container is empty
            if (!container.innerHTML || container.innerHTML.trim() === '') {
                container.innerHTML = `<div class="text-center py-4 text-muted small"><div class="spinner-border spinner-border-sm me-2" style="width: 1rem; height: 1rem;"></div>${t.loading || 'Âä†ËΩΩ‰∏≠...'}</div>`;
            }

            const selector = document.getElementById('log-bot-selector');
            const botId = selector ? selector.value : '';

            fetchWithAuth(`/api/logs?bot_id=${botId}`)
                .then(r => r.json())
                .then(data => {
                    const logs = data.logs || [];
                    const container = document.getElementById('log-container');
                    container.innerHTML = logs.map(log => `
                        <div class="log-entry">
                            <span class="log-time">[${log.time}]</span>
                            <span class="log-level-${log.level}">${log.level}</span>: 
                            ${renderLogMessage(log.message)}
                        </div>
                    `).join('');
                    // Scroll to bottom
                    container.scrollTop = container.scrollHeight;
                });
        }
        setInterval(() => {
            if (document.getElementById('tab-logs').style.display !== 'none' && 
                document.getElementById('auto-refresh-logs').checked) {
                fetchLogs();
            }
        }, 2000);

        // --- Debug/Actions ---
        function sendAction() {
            let botId = document.getElementById('action-bot-id').value;
            if (!botId && currentBotId) {
                botId = currentBotId;
            }
            
            const action = document.getElementById('action-name').value;
            let params = {};
            try {
                params = JSON.parse(document.getElementById('action-params').value);
            } catch (e) {
                alert(translations[currentLang].alert_json_error);
                return;
            }

            fetchWithAuth('/api/action', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    bot_id: botId,
                    action: action,
                    params: params
                })
            })
            .then(r => r.json())
            .then(res => {
                document.getElementById('action-result').innerText = JSON.stringify(res, null, 2);
            })
            .catch(err => {
                document.getElementById('action-result').innerText = 'Error: ' + err;
            });
        }

        // --- WebSocket Subscriber ---
        let wsSubscriber = null;
        const pendingRequests = new Map(); // echo -> {resolve, reject, timeout}

        let wsReconnectAttempts = 0;
        const MAX_WS_RECONNECT_ATTEMPTS = 5; // ÂáèÂ∞ëÈáçËøûÊ¨°Êï∞
        const WS_RECONNECT_DELAY = 5000; // Â¢ûÂä†ÈáçËøûÂª∂ËøüÂà∞5Áßí
        
        function initWebSocket() {
            // Èò≤Ê≠¢ÈáçÂ§çËøûÊé•
            if (wsSubscriber && wsSubscriber.readyState === WebSocket.CONNECTING) {
                console.log('WebSocketÊ≠£Âú®ËøûÊé•‰∏≠...');
                return;
            }
            
            if (wsReconnectAttempts >= MAX_WS_RECONNECT_ATTEMPTS) {
                console.error('WebSocketÈáçËøûÊ¨°Êï∞ËøáÂ§öÔºåÂÅúÊ≠¢ÈáçËøû');
                const t = translations[currentLang] || translations['zh-CN'];
                document.getElementById('ws-status').className = 'badge bg-danger ms-2';
                document.getElementById('ws-status').innerText = t.status_error || 'ËøûÊé•Â§±Ë¥•';
                addEventLog({type: 'system', message: 'WebSocketËøûÊé•Â§±Ë¥•Ê¨°Êï∞ËøáÂ§öÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñÊúçÂä°Âô®Áä∂ÊÄÅ'});
                return;
            }
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            // Use the same port as the current page and the correct path
            const wsPort = window.location.port ? `:${window.location.port}` : '';
            let wsUrl = `${protocol}//${window.location.hostname}${wsPort}/ws/subscriber?role=subscriber`;
            if (authToken) {
                wsUrl += `&token=${encodeURIComponent(authToken)}`;
            }
            
            try {
                wsSubscriber = new WebSocket(wsUrl);
                
                // ËøûÊé•Ë∂ÖÊó∂Â§ÑÁêÜ
                const connectTimeout = setTimeout(() => {
                    if (wsSubscriber && wsSubscriber.readyState === WebSocket.CONNECTING) {
                        console.warn('WebSocketËøûÊé•Ë∂ÖÊó∂');
                        wsSubscriber.close();
                    }
                }, 10000); // 10ÁßíË∂ÖÊó∂
                
                wsSubscriber.onopen = () => {
                    clearTimeout(connectTimeout);
                    wsReconnectAttempts = 0; // ÈáçÁΩÆÈáçËøûÊ¨°Êï∞
                    const t = translations[currentLang] || translations['zh-CN'];
                    document.getElementById('ws-status').className = 'badge bg-success ms-2';
                    document.getElementById('ws-status').innerText = t.status_connected;
                    addEventLog({type: 'system', message: t.ws_connected || 'WebSocket ËøûÊé•ÊàêÂäü'});
                    
                    // Refresh bots when connected
                    updateBots();
                };
                
                wsSubscriber.onerror = (error) => {
                    clearTimeout(connectTimeout);
                    const t = translations[currentLang] || translations['zh-CN'];
                    console.error('WebSocket error:', error);
                    document.getElementById('ws-status').className = 'badge bg-warning ms-2';
                    document.getElementById('ws-status').innerText = t.status_error || 'ËøûÊé•ÈîôËØØ';
                    addEventLog({type: 'system', message: t.ws_error || 'WebSocket ËøûÊé•ÈîôËØØ'});
                };
                
                wsSubscriber.onclose = () => {
                    clearTimeout(connectTimeout);
                    const t = translations[currentLang] || translations['zh-CN'];
                    document.getElementById('ws-status').className = 'badge bg-danger ms-2';
                    document.getElementById('ws-status').innerText = t.status_disconnected;
                    addEventLog({type: 'system', message: t.ws_disconnected_retry || 'WebSocket ËøûÊé•Êñ≠ÂºÄÔºå3ÁßíÂêéÈáçËøû...'});
                    
                    // Á°Æ‰øùÊ∏ÖÁêÜÂπ∂ÈáçËøû
                    if (wsSubscriber) {
                        wsSubscriber = null;
                    }
                    
                    wsReconnectAttempts++;
                    setTimeout(initWebSocket, WS_RECONNECT_DELAY);
                };

                wsSubscriber.onmessage = (evt) => {
                    try {
                        const data = JSON.parse(evt.data);
                        console.log("WS Recv:", data); // Debug Log
                        
                        if (data.type === 'routing_event') {
                            handleRoutingEvent(data);
                            return;
                        }

                        // Handle API Responses
                        if (data.echo && pendingRequests.has(data.echo)) {
                            const req = pendingRequests.get(data.echo);
                            clearTimeout(req.timeout);
                            pendingRequests.delete(data.echo);
                            req.resolve(data);
                            // Optional: Don't log API responses to event log to reduce noise
                            // return; 
                        }

                        // Auto-refresh bot list on connection/nickname update
                        if (data.echo === 'internal_get_login_info' || 
                            (data.post_type === 'meta_event' && data.meta_event_type === 'lifecycle')) {
                            setTimeout(updateBots, 500); // Wait a bit for state to settle
                        }

                        if (data.post_type === 'log') {
                            // Check filter
                            const selector = document.getElementById('log-bot-selector');
                            const filter = selector ? selector.value : '';
                            const log = data.data;
                            const selfId = data.self_id || '';
                            
                            // Auto-refresh bot list on client connection logs
                            if (log.message && log.message.includes('Client connected:')) {
                                setTimeout(updateBots, 1000); // Wait a bit longer for connection to settle
                            }

                            if (filter === '' || (filter === 'system' && !selfId) || filter === selfId) {
                                const container = document.getElementById('log-container');
                                if (container) {
                                    const div = document.createElement('div');
                                    div.className = 'log-entry';
                                    div.innerHTML = `<span class="log-time">[${log.time}]</span><span class="log-level-${log.level}">${log.level}</span>: ${renderLogMessage(log.message)}`;
                                    container.appendChild(div);
                                    if (container.children.length > 500) { // ÈôêÂà∂Êó•ÂøóÊù°ÁõÆÊï∞Èáè
                                        container.removeChild(container.firstChild);
                                    }
                                    if (document.getElementById('auto-refresh-logs').checked) {
                                        container.scrollTop = container.scrollHeight;
                                    }
                                }
                            }

                            // Full Page Log Update
                            const selectorFull = document.getElementById('log-bot-selector-full');
                            const filterFull = selectorFull ? selectorFull.value : '';
                            if (filterFull === '' || (filterFull === 'system' && !selfId) || filterFull === selfId) {
                                const containerFull = document.getElementById('log-container-full');
                                if (containerFull) {
                                    const div = document.createElement('div');
                                    div.className = 'log-entry';
                                    div.innerHTML = `<span class="log-time">[${log.time}]</span><span class="log-level-${log.level}">${log.level}</span>: ${renderLogMessage(log.message)}`;
                                    containerFull.appendChild(div);
                                    if (containerFull.children.length > 500) { // ÂáèÂ∞ëÊó•ÂøóÊù°ÁõÆÈôêÂà∂ÔºåËäÇÁúÅÂÜÖÂ≠ò
                                        containerFull.removeChild(containerFull.firstChild);
                                    }
                                    if (document.getElementById('auto-refresh-logs-full').checked) {
                                        containerFull.scrollTop = containerFull.scrollHeight;
                                    }
                                }
                            }
                            return;
                        }
                        addEventLog(data);
                    } catch (e) {
                        console.error('WS Parse Error', e);
                    }
                };
                
            } catch (error) {
                console.error('ÂàõÂª∫WebSocketÂ§±Ë¥•:', error);
                wsReconnectAttempts++;
                setTimeout(initWebSocket, WS_RECONNECT_DELAY);
            }
        }

        // --- API Helper ---
        async function callBotApi(action, params = {}) {
            if (!currentBotId) {
                const selector = document.getElementById('global-bot-selector');
                if (selector.value) {
                    currentBotId = selector.value;
                } else {
                    const t = translations[currentLang] || translations['zh-CN'];
                    throw new Error(t.alert_select_bot_first);
                }
            }

            const res = await fetchWithAuth('/api/action', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    bot_id: currentBotId,
                    action: action,
                    params: params
                })
            });
            
            if (res.status === 401) {
                localStorage.removeItem('wxbot_token');
                location.reload();
                throw new Error("Unauthorized");
            }

            const result = await res.json();
            if (result.error) throw new Error(result.error);
            if (!result.echo) return result; 

            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    pendingRequests.delete(result.echo);
                    reject(new Error("Request timed out (30s)"));
                }, 30000);
                
                pendingRequests.set(result.echo, { resolve, reject, timeout });
            });
        }

        // --- Global Bot Selector ---
        function updateBotSelectorUI(id) {
            const selector = document.getElementById('global-bot-selector');
            selector.value = id;
            const t = translations[currentLang] || translations['zh-CN'];
            
            const bot = currentBots.find(b => b.self_id == id);
            if (bot) {
                const platform = bot.platform || 'QQ';
                let avatarUrl = `https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/robot.svg`;
                if (platform === 'QQ') {
                    avatarUrl = `https://q1.qlogo.cn/g?b=qq&nk=${bot.self_id}&s=100`;
                }
                
                const statusBadge = bot.is_alive 
                    ? `<span class="badge bg-success ms-1" style="font-size: 0.6em; vertical-align: middle;">${t.status_online}</span>` 
                    : `<span class="badge bg-secondary ms-1" style="font-size: 0.6em; vertical-align: middle;">${t.status_offline}</span>`;
                
                const html = `
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle d-flex align-items-center justify-content-center me-2 flex-shrink-0" style="width: 28px; height: 28px; overflow: hidden; background: #f0f0f0;">
                            <img src="${avatarUrl}" alt="" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <div class="overflow-hidden text-start">
                            <div class="fw-bold text-truncate" style="font-size: 0.85rem; line-height: 1.2;">
                                ${bot.nickname || bot.self_id}
                                ${statusBadge}
                            </div>
                            <div class="text-muted text-truncate" style="font-size: 0.7rem; line-height: 1;">${bot.self_id}</div>
                        </div>
                    </div>
                `;
                document.getElementById('global-bot-selected-content').innerHTML = html;
            }
        }

        function selectBotFromDropdown(id) {
            updateBotSelectorUI(id);
            onBotChange();
        }

        function onBotChange() {
            currentBotId = document.getElementById('global-bot-selector').value;
            
            const t = translations[currentLang] || translations['zh-CN'];
            const loadingText = `<div class="text-center p-4 text-muted">${t.switching_bot}</div>`;

            // Clear group view
            document.getElementById('group-list').innerHTML = loadingText;
            document.getElementById('group-detail-content').style.setProperty('display', 'none', 'important');
            document.getElementById('group-detail-empty').style.display = 'block';
            
            // Clear friend view
            document.getElementById('friend-list').innerHTML = loadingText;
            document.getElementById('friend-detail-content').style.setProperty('display', 'none', 'important');
            document.getElementById('friend-detail-empty').style.display = 'block';
            
            currentGroups = [];
            currentFriends = [];
            
            // Auto refresh current tab
            setTimeout(refreshCurrentTabList, 500);
        }

        function setGlobalBot(id) {
            selectBotFromDropdown(id);
            showTab('groups'); // Jump to groups tab
        }

        function refreshCurrentTabList() {
             const activeTab = document.querySelector('#relation-tabs .nav-link.active');
             if (activeTab && activeTab.id === 'tab-friends-list-tab') {
                 refreshFriendList();
             } else {
                 refreshGroupList();
             }
        }

        function ensureFriendListLoaded() {
            if (currentFriends.length === 0) {
                refreshFriendList();
            }
        }

        // --- Friend Management ---
        let currentFriends = [];
        let currentFriendId = 0;
        let friendSortBy = 'name'; // name, id
        let friendSortAsc = true;

        async function refreshFriendList() {
            const listEl = document.getElementById('friend-list');
            listEl.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary"></div></div>';
            
            try {
                const response = await fetchWithAuth('/api/contacts');
                const text = await response.text();
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${text}`);
                }
                let contacts = [];
                try {
                    contacts = JSON.parse(text);
                    if (!Array.isArray(contacts)) contacts = [];
                } catch (e) {
                    console.error("Failed to parse contacts JSON:", e, "Raw text:", text);
                    throw new Error("JSON Ëß£ÊûêÈîôËØØ: " + e.message);
                }
                
                // Filter by current Bot and type private
                const friends = contacts.filter(c => c && c.bot_id === currentBotId && c.type === 'private');
                
                currentFriends = friends;
                renderFriends(friends);
                document.getElementById('friend-count').innerText = `ÂÖ± ${friends.length} ‰∏™Â•ΩÂèã`;
            } catch (e) {
                listEl.innerHTML = `<div class="text-center p-4 text-danger">Âä†ËΩΩÂ§±Ë¥•: ${e.message}</div>`;
            }
        }

        function renderFriends(friends = null) {
            if (!friends) friends = currentFriends;
            
            // Filter
            const keyword = (document.getElementById('friend-search').value || '').toLowerCase();
            let filtered = (friends || []).filter(f => {
                if (!f) return false;
                const name = (f.name || '').toLowerCase();
                const id = (f.id || '').toString();
                return name.includes(keyword) || id.includes(keyword);
            });
            
            // Sort
            filtered.sort((a, b) => {
                let res = 0;
                if (friendSortBy === 'name') {
                    const nameA = a ? (a.name || '') : '';
                    const nameB = b ? (b.name || '') : '';
                    res = nameA.localeCompare(nameB, 'zh');
                } else if (friendSortBy === 'id') {
                    res = String(a ? a.id : '').localeCompare(String(b ? b.id : ''));
                }
                return friendSortAsc ? res : -res;
            });
            
            const listEl = document.getElementById('friend-list');
            if (filtered.length === 0) {
                listEl.innerHTML = '<div class="text-center p-4 text-muted">Êú™ÊâæÂà∞Â•ΩÂèã</div>';
                return;
            }

            listEl.innerHTML = filtered.map(f => {
                const name = f.name || 'Unknown';
                const id = f.id;
                const avatar = `https://q1.qlogo.cn/g?b=qq&nk=${id}&s=100`;
                const safeName = (name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                
                return `
                <button class="list-group-item list-group-item-action ${id == currentFriendId ? 'active' : ''}" onclick="selectFriend('${id}', '${safeName}')">
                    <div class="d-flex w-100 align-items-center">
                         <div class="rounded-circle me-2" style="width: 32px; height: 32px; overflow: hidden; background: #f0f0f0;">
                            <img src="${avatar}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/person.svg'">
                        </div>
                        <div style="overflow: hidden;">
                            <h6 class="mb-0 text-truncate" style="max-width: 150px;">${name}</h6>
                            <small class="${id == currentFriendId ? 'text-light' : 'text-muted'}">${id}</small>
                        </div>
                    </div>
                </button>
                `;
            }).join('');
        }

        function filterFriends() {
            renderFriends();
        }

        function sortFriends(by) {
            if (friendSortBy === by) {
                friendSortAsc = !friendSortAsc;
            } else {
                friendSortBy = by;
                friendSortAsc = true;
            }
            
            // Update buttons
            document.querySelectorAll('[id^="btn-sort-friend-"]').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-sort-friend-${by}`).classList.add('active');
            
            renderFriends();
        }

        function selectFriend(id, name) {
            currentFriendId = id;
            document.getElementById('current-friend-name').innerText = name;
            document.getElementById('current-friend-id').innerText = id;
            
            // Show details
            document.getElementById('friend-detail-empty').style.display = 'none';
            document.getElementById('friend-detail-content').style.setProperty('display', 'flex', 'important');
            
            // Re-render list to highlight active
            renderFriends();
        }

        async function sendFriendMsg() {
            const text = document.getElementById('friend-msg-input').value;
            if (!text.trim()) return;
            
            try {
                await callBotApi('send_private_msg', {
                    user_id: currentFriendId,
                    message: text
                });
                alert('ÂèëÈÄÅÊàêÂäü');
                document.getElementById('friend-msg-input').value = '';
                addEventLog({type: 'message', message: `ÂèëÈÄÅÁªôÂ•ΩÂèã(${currentFriendId}): ${text}`});
            } catch (e) {
                alert('ÂèëÈÄÅÂ§±Ë¥•: ' + e.message);
            }
        }

        // --- System Details View Logic ---
        let detailChartInstance = null;
        let detailData = {
            cpu: [],
            mem: [],
            msg: [],
            disk: [],
            net: []
        };
        let currentDetailType = 'cpu';
        let currentDetailTimeRange = '1h';

        function showSystemDetails(type) {
            showTab('#view-system-details');
            currentDetailType = type || 'cpu';
            
            // Set active tab
            document.querySelectorAll('#system-detail-tabs .nav-link').forEach(el => el.classList.remove('active'));
            document.querySelector(`#system-detail-tabs .nav-link[onclick*="'${currentDetailType}'"]`).classList.add('active');

            updateDetailChart();
            fetchSystemStats(true); // Fetch immediately with details
        }

        function switchDetailTab(type, event) {
            if (event) event.preventDefault();
            currentDetailType = type;
            
            document.querySelectorAll('#system-detail-tabs .nav-link').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');

            updateDetailChart();
        }

        function updateDetailTimeRange(range) {
            currentDetailTimeRange = range;
            document.querySelectorAll('#tab-view-system-details .btn-group .btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`#tab-view-system-details .btn-group .btn[onclick*="'${range}'"]`).classList.add('active');
            
            // For now, we only have session data, so we can't really change the data source yet,
            // but we can adjust the chart X-axis scaling or label if we had timestamps.
            // Since we only have "last 1800 points (1 hour)", we will just show what we have.
            // In a real implementation, we would fetch historical data here.
            
            updateDetailChart();
        }

        function updateDetailChart() {
            const ctx = document.getElementById('detailChart').getContext('2d');
            
            if (detailChartInstance) {
                detailChartInstance.destroy();
            }

            // Fix: Retrieve data from global stats (server trend) or fallback to charts
            let cpuDataBuffer = [];
            let memDataBuffer = [];
            let recvDataBuffer = [];
            let sentDataBuffer = [];
            let msgDataBuffer = [];
            let netSentTrend = [];
            let netRecvTrend = [];
            let sourceIsRaw = false;

            if (window.latestStats) {
                cpuDataBuffer = window.latestStats.cpu_trend || [];
                memDataBuffer = window.latestStats.mem_trend || [];
                // Msg trends in latestStats are raw counts per interval
                msgDataBuffer = window.latestStats.msg_trend || [];
                sentDataBuffer = window.latestStats.sent_trend || [];
                recvDataBuffer = window.latestStats.recv_trend || [];
                netSentTrend = window.latestStats.net_sent_trend || [];
                netRecvTrend = window.latestStats.net_recv_trend || [];
                sourceIsRaw = true;
            } else {
                cpuDataBuffer = cpuChart ? cpuChart.data.datasets[0].data : [];
                memDataBuffer = memChart ? memChart.data.datasets[0].data : [];
                recvDataBuffer = msgChart ? msgChart.data.datasets[0].data : [];
                sentDataBuffer = msgChart ? msgChart.data.datasets[1].data : [];
                msgDataBuffer = msgChart ? msgChart.data.datasets[2].data : [];
            }

            let labels = [];
            let datasets = [];
            let type = 'line';
            let options = {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                plugins: {
                    legend: { display: true },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    x: { display: true, grid: { display: false } },
                    y: { display: true, beginAtZero: true }
                }
            };

            // Common Labels (Just index for now, should be time)
            // We use global stats buffers
            
            if (currentDetailType === 'cpu') {
                labels = Array.from({length: cpuDataBuffer.length}, (_, i) => i);
                datasets = [{
                    label: 'CPU Usage (%)',
                    data: cpuDataBuffer,
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    fill: true,
                    tension: 0.4
                }];
                options.scales.y.max = 100;
            } else if (currentDetailType === 'mem') {
                labels = Array.from({length: memDataBuffer.length}, (_, i) => i);
                // Convert to GB
                // If sourceIsRaw (from server), unit is Bytes -> /1024/1024/1024
                // If from Chart (memChart), unit is MB -> /1024
                const dataGB = memDataBuffer.map(v => sourceIsRaw ? (v / 1024 / 1024 / 1024) : (v / 1024));
                datasets = [{
                    label: 'Memory Usage (GB)',
                    data: dataGB,
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    fill: true,
                    tension: 0.4
                }];
            } else if (currentDetailType === 'msg') {
                labels = Array.from({length: msgDataBuffer.length}, (_, i) => i);
                datasets = [
                    {
                        label: 'Total Messages',
                        data: msgDataBuffer,
                        borderColor: '#198754',
                        backgroundColor: 'rgba(25, 135, 84, 0.1)',
                        fill: true
                    },
                    {
                        label: 'Sent Messages',
                        data: sentDataBuffer,
                        borderColor: '#0dcaf0',
                        borderDash: [5, 5],
                        fill: false
                    },
                    {
                        label: 'Recv Messages',
                        data: recvDataBuffer,
                        borderColor: '#ffc107',
                        borderDash: [2, 2],
                        fill: false
                    }
                ];
            } else if (currentDetailType === 'disk') {
                type = 'bar';
                // Disk data comes from latest stats fetch, not trend
                // We need to store it globally or fetch it.
                // For now, use global `lastSystemStats` if available
                if (window.lastSystemStats && window.lastSystemStats.disk_usage) {
                    labels = window.lastSystemStats.disk_usage.map(d => d.path);
                    const dataUsed = window.lastSystemStats.disk_usage.map(d => (d.used / 1024 / 1024 / 1024).toFixed(2));
                    const dataFree = window.lastSystemStats.disk_usage.map(d => (d.free / 1024 / 1024 / 1024).toFixed(2));
                    
                    datasets = [
                        {
                            label: 'Used (GB)',
                            data: dataUsed,
                            backgroundColor: '#dc3545'
                        },
                        {
                            label: 'Free (GB)',
                            data: dataFree,
                            backgroundColor: '#198754'
                        }
                    ];
                    options.scales.x = { stacked: true };
                    options.scales.y = { stacked: true, beginAtZero: true };
                } else {
                    labels = ['Loading...'];
                    datasets = [{label: 'No Data', data: []}];
                }
            } else if (currentDetailType === 'net') {
                 // Net IO Trend - showing throughput (diff between samples)
                 if (netSentTrend.length > 1) {
                     labels = Array.from({length: netSentTrend.length - 1}, (_, i) => i);
                     const sentThroughput = [];
                     const recvThroughput = [];
                     
                     for (let i = 1; i < netSentTrend.length; i++) {
                         // Bytes -> KB/s (assuming 5s interval)
                         const s = (netSentTrend[i] - netSentTrend[i-1]) / 1024 / 5;
                         const r = (netRecvTrend[i] - netRecvTrend[i-1]) / 1024 / 5;
                         sentThroughput.push(s.toFixed(2));
                         recvThroughput.push(r.toFixed(2));
                     }

                     datasets = [
                         {
                             label: 'Sent (KB/s)',
                             data: sentThroughput,
                             borderColor: '#0dcaf0',
                             backgroundColor: 'rgba(13, 202, 240, 0.1)',
                             fill: true,
                             tension: 0.4
                         },
                         {
                             label: 'Recv (KB/s)',
                             data: recvThroughput,
                             borderColor: '#ffc107',
                             backgroundColor: 'rgba(255, 193, 7, 0.1)',
                             fill: true,
                             tension: 0.4
                         }
                     ];
                 } else if (window.lastSystemStats && window.lastSystemStats.net_io && window.lastSystemStats.net_io.length > 0) {
                     type = 'bar';
                     const io = window.lastSystemStats.net_io[0];
                     labels = ['Total Sent', 'Total Recv'];
                     datasets = [{
                         label: 'Bytes (MB)',
                         data: [
                             (io.bytesSent / 1024 / 1024).toFixed(2), 
                             (io.bytesRecv / 1024 / 1024).toFixed(2)
                         ],
                         backgroundColor: ['#0dcaf0', '#ffc107']
                     }];
                 } else {
                    labels = ['Loading...'];
                    datasets = [{label: 'No Data', data: []}];
                 }
            }

            detailChartInstance = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: options
            });
            
            // Render Hardware Info Grid
            renderHardwareGrid();
        }

        function renderHardwareGrid() {
            const container = document.getElementById('hardware-info-grid');
            if (!window.lastSystemStats) return;
            
            const s = window.lastSystemStats;
            let html = '';
            
            // Host Info
            if (s.host_info) {
                 html += `
                    <div class="col-12 mb-3">
                        <div class="card h-100">
                            <div class="card-header fw-bold">‰∏ªÊú∫‰ø°ÊÅØ</div>
                            <div class="card-body small">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div><span class="text-muted">Hostname:</span> ${s.host_info.hostname}</div>
                                        <div><span class="text-muted">OS:</span> ${s.host_info.platform} ${s.host_info.platformVersion}</div>
                                        <div><span class="text-muted">Kernel:</span> ${s.host_info.kernelVersion}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <div><span class="text-muted">Arch:</span> ${s.host_info.kernelArch}</div>
                                        <div><span class="text-muted">Uptime:</span> ${(s.host_info.uptime / 3600).toFixed(1)} Hours</div>
                                        <div><span class="text-muted">Boot Time:</span> ${new Date(s.host_info.bootTime * 1000).toLocaleString()}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }
            
            // Disk Info
            if (s.disk_usage) {
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header fw-bold">Á£ÅÁõò‰ΩøÁî®</div>
                            <div class="card-body small" style="overflow-y: auto; max-height: 200px;">
                                ${s.disk_usage.map(d => `
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between">
                                            <span>${d.path}</span>
                                            <span>${d.usedPercent.toFixed(1)}%</span>
                                        </div>
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar bg-${d.usedPercent > 90 ? 'danger' : (d.usedPercent > 70 ? 'warning' : 'success')}" 
                                                 role="progressbar" style="width: ${d.usedPercent}%"></div>
                                        </div>
                                        <div class="text-muted" style="font-size: 0.8em;">
                                            ${(d.used/1024/1024/1024).toFixed(1)} GB / ${(d.total/1024/1024/1024).toFixed(1)} GB
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>`;
            }
            
            // Net Info
            if (s.net_interfaces) {
                 html += `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header fw-bold">ÁΩëÁªúÊé•Âè£</div>
                            <div class="card-body small" style="overflow-y: auto; max-height: 200px;">
                                ${s.net_interfaces.map(i => `
                                    <div class="mb-2 border-bottom pb-1">
                                        <div class="fw-bold text-primary">${i.name}</div>
                                        ${i.addrs.map(a => `<div>${a.addr}</div>`).join('')}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>`;
            }
            
            container.innerHTML = html;
        }

        // --- Group Management ---
        let currentGroups = [];
        let currentGroupId = 0;
        let groupSortBy = 'name'; // name, count, id
        let groupSortAsc = true;

        let currentMembers = [];
        let memberSortBy = 'card'; // card, id, role, time
        let memberSortAsc = true;

        async function refreshGroupList() {
            const listEl = document.getElementById('group-list');
            listEl.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary"></div></div>';
            
            try {
                // Fetch from new contacts API
                const response = await fetchWithAuth('/api/contacts');
                const text = await response.text();
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${text}`);
                }
                let contacts = [];
                try {
                    contacts = JSON.parse(text);
                    if (!Array.isArray(contacts)) contacts = [];
                } catch (e) {
                    console.error("Failed to parse contacts JSON:", e, "Raw text:", text);
                    throw new Error("JSON Ëß£ÊûêÈîôËØØ: " + e.message);
                }
                
                // Filter by current Bot
                const filtered = contacts.filter(c => c && c.bot_id === currentBotId);
                
                currentGroups = filtered;
                renderGroups(filtered);
                document.getElementById('group-count').innerText = `ÂÖ± ${filtered.length} ‰∏™‰ºöËØù`;
            } catch (e) {
                listEl.innerHTML = `<div class="text-center p-4 text-danger">Ëé∑ÂèñÂ§±Ë¥•: ${e.message}</div>`;
            }
        }

        function sortGroups(field) {
            if (groupSortBy === field) {
                groupSortAsc = !groupSortAsc;
            } else {
                groupSortBy = field;
                groupSortAsc = true; // Default asc for new field
                if (field === 'count' || field === 'msg_today') groupSortAsc = false; // Default desc for count/msg
            }
            
            const t = translations[currentLang] || translations['zh-CN'];

            // Update UI buttons
            ['name', 'count', 'id', 'msg_today'].forEach(f => {
                const btn = document.getElementById(`btn-sort-group-${f}`);
                if (f === groupSortBy) {
                    btn.classList.add('active');
                    let label = '';
                    switch(f) {
                        case 'name': label = t.sort_name; break;
                        case 'count': label = t.sort_count; break;
                        case 'id': label = t.sort_id; break;
                        case 'msg_today': label = t.sort_today; break;
                    }
                    btn.innerHTML = label + (groupSortAsc ? ' ‚Üë' : ' ‚Üì');
                } else {
                    btn.classList.remove('active');
                    let label = '';
                    switch(f) {
                        case 'name': label = t.sort_name; break;
                        case 'count': label = t.sort_count; break;
                        case 'id': label = t.sort_id; break;
                        case 'msg_today': label = t.sort_today; break;
                    }
                    btn.innerHTML = label;
                }
            });

            filterGroups(); // Re-render with sort
        }

        function renderGroups(groups) {
            const listEl = document.getElementById('group-list');
            const t = translations[currentLang] || translations['zh-CN'];
            if (!groups || groups.length === 0) {
                listEl.innerHTML = `<div class="text-center p-4 text-muted">${t.no_groups || 'Êú™ÊâæÂà∞‰ºöËØù'}</div>`;
                return;
            }

            // Sort logic
            const sortedGroups = [...groups].sort((a, b) => {
                let res = 0;
                if (!a || !b) return 0;
                if (groupSortBy === 'name') {
                    res = (a.name || '').localeCompare(b.name || '', 'zh-CN');
                } else if (groupSortBy === 'count') {
                    res = 0; // Not available in session
                } else if (groupSortBy === 'id') {
                    res = String(a.id || '').localeCompare(String(b.id || ''));
                } else if (groupSortBy === 'msg_today') {
                    const statA = latestChatStats.group_stats_today ? (latestChatStats.group_stats_today[a.id] || 0) : 0;
                    const statB = latestChatStats.group_stats_today ? (latestChatStats.group_stats_today[b.id] || 0) : 0;
                    res = statA - statB;
                }
                return groupSortAsc ? res : -res;
            });
            
            listEl.innerHTML = sortedGroups.map(g => {
                const todayMsg = latestChatStats.group_stats_today ? (latestChatStats.group_stats_today[g.id] || 0) : 0;
                const totalMsg = latestChatStats.group_stats ? (latestChatStats.group_stats[g.id] || 0) : 0;
                
                let typeBadge = '<span class="badge bg-secondary" style="font-size: 0.6rem;">Áæ§</span>';
                if (g.type === 'private') {
                    typeBadge = '<span class="badge bg-success" style="font-size: 0.6rem;">ÁßÅ</span>';
                } else if (g.type === 'guild') {
                    typeBadge = '<span class="badge bg-info" style="font-size: 0.6rem;">È¢ë</span>';
                }

                // Avatar URL logic
                let avatarUrl = '';
                if (g.type === 'group') {
                    avatarUrl = `https://p.qlogo.cn/gh/${g.id}/${g.id}/640/`;
                } else if (g.type === 'private') {
                    avatarUrl = `https://q1.qlogo.cn/g?b=qq&nk=${g.id}&s=100`;
                } else {
                    avatarUrl = 'https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/diagram-3.svg';
                }

                const safeName = (g.name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                return `
                <button class="list-group-item list-group-item-action ${g.id == currentGroupId ? 'active' : ''}" onclick="selectGroup('${g.id}', '${safeName}', '${g.type}', '${g.guild_id || ''}')">
                    <div class="d-flex w-100 align-items-center">
                        <div class="rounded-circle me-2 flex-shrink-0" style="width: 40px; height: 40px; overflow: hidden; background: #f0f0f0;">
                             <img src="${avatarUrl}" alt="${g.type}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/${g.type === 'private' ? 'person' : 'people'}.svg';this.style.padding='8px';">
                        </div>
                        <div class="flex-grow-1 overflow-hidden">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1 text-truncate" style="max-width: 140px;">${g.name || 'Unknown'}</h6>
                                <div>
                                    ${typeBadge}
                                </div>
                            </div>
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <small class="${g.id == currentGroupId ? 'text-light' : 'text-muted'}">ID: ${g.id}</small>
                                <span class="badge ${g.id == currentGroupId ? 'bg-light text-dark' : 'bg-secondary'} rounded-pill" title="‰ªäÊó•: ${todayMsg} / ÊÄªËÆ°: ${totalMsg}">${todayMsg}</span>
                            </div>
                        </div>
                    </div>
                </button>
            `}).join('');
        }

        function filterGroups() {
            const keyword = (document.getElementById('group-search').value || '').toLowerCase();
            const filtered = currentGroups.filter(g => 
                (g.name || '').toLowerCase().includes(keyword) || 
                String(g.id || '').includes(keyword)
            );
            renderGroups(filtered);
        }

        let currentContactType = 'group';
        let currentGuildId = '';

        async function selectGroup(id, name, type = 'group', guildId = '') {
            currentGroupId = id;
            currentContactType = type;
            currentGuildId = guildId;

            document.getElementById('current-group-name').innerText = name;
            document.getElementById('current-group-id').innerText = id;
            
            // Update Stats
            const todayMsg = latestChatStats.group_stats_today ? (latestChatStats.group_stats_today[id] || 0) : 0;
            const totalMsg = latestChatStats.group_stats ? (latestChatStats.group_stats[id] || 0) : 0;
            document.getElementById('current-group-stats').innerText = `‰ªäÊó•: ${todayMsg} / ÊÄªËÆ°: ${totalMsg}`;

            // Update Avatar
            const avatarEl = document.getElementById('current-group-avatar');
            if (type === 'group') {
                avatarEl.src = `https://p.qlogo.cn/gh/${id}/${id}/640/`;
            } else if (type === 'private') {
                avatarEl.src = `https://q1.qlogo.cn/g?b=qq&nk=${id}&s=100`;
            } else {
                 avatarEl.src = 'https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/diagram-3.svg';
            }
            avatarEl.style.display = 'block';
            avatarEl.onerror = function() {
                this.src = 'https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/people.svg';
                this.style.padding = '4px';
            };
            
            document.getElementById('group-detail-empty').style.display = 'none';
            document.getElementById('group-detail-content').style.setProperty('display', 'flex', 'important');
            
            // Highlight selection
            renderGroups(currentGroups.filter(g => {
                const keyword = (document.getElementById('group-search').value || '').toLowerCase();
                return (g.name || '').toLowerCase().includes(keyword) || String(g.id || '').includes(keyword);
            }));

            // Handle View switching
            const membersTabBtn = document.getElementById('members-tab');
            const actionsTabBtn = document.getElementById('actions-tab');
            
            if (type === 'group') {
                membersTabBtn.style.display = 'block';
                // Switch to members tab if not already active or if we just hid it previously
                const bsTab = new bootstrap.Tab(membersTabBtn);
                bsTab.show();
                loadGroupMembers(id);
            } else {
                membersTabBtn.style.display = 'none';
                // Switch to actions tab
                const bsTab = new bootstrap.Tab(actionsTabBtn);
                bsTab.show();
            }
        }

        async function loadGroupMembers(groupId) {
            const tbody = document.getElementById('member-list-body');
            tbody.innerHTML = '<tr><td colspan="4" class="text-center">Âä†ËΩΩ‰∏≠...</td></tr>';
            
            try {
                const response = await callBotApi('get_group_member_list', { group_id: groupId });
                currentMembers = response.data || [];
                renderMembers();
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">Âä†ËΩΩÂ§±Ë¥•: ${e.message}</td></tr>`;
            }
        }

        function sortMembers(field) {
            if (memberSortBy === field) {
                memberSortAsc = !memberSortAsc;
            } else {
                memberSortBy = field;
                memberSortAsc = true;
                if (field === 'time' || field === 'msg_today') memberSortAsc = false; // Default desc for time/msg
            }

            // Update Icons
            ['card', 'id', 'role', 'time', 'msg_today'].forEach(f => {
                const icon = document.getElementById(`sort-icon-${f}`);
                if (f === memberSortBy) {
                    icon.className = memberSortAsc ? 'bi bi-sort-alpha-down' : 'bi bi-sort-alpha-down-alt';
                    if (f === 'id' || f === 'time' || f === 'msg_today') icon.className = memberSortAsc ? 'bi bi-sort-numeric-down' : 'bi bi-sort-numeric-down-alt';
                } else {
                    icon.className = 'bi';
                }
            });

            renderMembers();
        }

        function renderMembers() {
            const tbody = document.getElementById('member-list-body');
            const searchInput = document.getElementById('member-search');
            const keyword = searchInput ? searchInput.value.toLowerCase() : '';
            const t = translations[currentLang] || translations['zh-CN'];

            if (!currentMembers || currentMembers.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center">${t.no_members}</td></tr>`;
                return;
            }

            // Filter
            const filteredMembers = currentMembers.filter(m => {
                if (!keyword) return true;
                const card = (m.card || '').toLowerCase();
                const nick = (m.nickname || '').toLowerCase();
                const uid = String(m.user_id);
                return card.includes(keyword) || nick.includes(keyword) || uid.includes(keyword);
            });
            
            if (filteredMembers.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="6" class="text-center">${t.no_match_members}</td></tr>`;
                 return;
            }

            // Sort
            const sortedMembers = [...filteredMembers].sort((a, b) => {
                let res = 0;
                if (memberSortBy === 'card') {
                    const nameA = a.card || a.nickname || '';
                    const nameB = b.card || b.nickname || '';
                    res = nameA.localeCompare(nameB, 'zh-CN');
                } else if (memberSortBy === 'id') {
                    res = a.user_id - b.user_id;
                } else if (memberSortBy === 'role') {
                    const roleWeight = { 'owner': 3, 'admin': 2, 'member': 1 };
                    res = (roleWeight[a.role] || 0) - (roleWeight[b.role] || 0);
                } else if (memberSortBy === 'time') {
                    res = (a.last_sent_time || 0) - (b.last_sent_time || 0);
                } else if (memberSortBy === 'msg_today') {
                    const statA = latestChatStats.user_stats_today ? (latestChatStats.user_stats_today[a.user_id] || 0) : 0;
                    const statB = latestChatStats.user_stats_today ? (latestChatStats.user_stats_today[b.user_id] || 0) : 0;
                    res = statA - statB;
                }
                return memberSortAsc ? res : -res;
            });

            tbody.innerHTML = sortedMembers.map(m => {
                const todayMsg = latestChatStats.user_stats_today ? (latestChatStats.user_stats_today[m.user_id] || 0) : 0;
                const totalMsg = latestChatStats.user_stats ? (latestChatStats.user_stats[m.user_id] || 0) : 0;
                
                const roleKey = 'role_' + m.role;
                const roleText = t[roleKey] || m.role;
                const statsTooltip = t.stats_title_tooltip.replace('{today}', todayMsg).replace('{total}', totalMsg);
                const safeName = (m.card || m.nickname || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');

                return `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <img src="https://q1.qlogo.cn/g?b=qq&nk=${m.user_id}&s=100" 
                                 class="rounded-circle me-2" 
                                 width="32" height="32" 
                                 onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(m.card || m.nickname)}&background=random'"
                                 alt="Avatar">
                            <div>
                                <div>${m.card || m.nickname}</div>
                                ${m.card && m.card !== m.nickname ? `<small class="text-muted">${m.nickname}</small>` : ''}
                            </div>
                        </div>
                    </td>
                    <td>${m.user_id}</td>
                    <td>
                        <span class="badge bg-${m.role === 'owner' ? 'warning' : (m.role === 'admin' ? 'success' : 'secondary')}">
                            ${roleText}
                        </span>
                    </td>
                    <td>
                        <div class="d-flex flex-column" title="${statsTooltip}">
                            <span class="badge bg-primary rounded-pill mb-1" style="width: fit-content;">${todayMsg}</span>
                            <small class="text-muted">${t.stats_total}${totalMsg}</small>
                        </div>
                    </td>
                    <td>
                        <small class="text-muted">${m.last_sent_time ? new Date(m.last_sent_time * 1000).toLocaleString() : '-'}</small>
                    </td>
                    <td>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                ${t.action_ops}
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="setCard(${currentGroupId}, ${m.user_id}, '${safeName}')">${t.action_set_card}</a></li>
                                <li><a class="dropdown-item" href="#" onclick="banMember(${currentGroupId}, ${m.user_id})">${t.action_ban}</a></li>
                                <li><a class="dropdown-item" href="#" onclick="unbanMember(${currentGroupId}, ${m.user_id})">${t.action_unban}</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="kickMember(${currentGroupId}, ${m.user_id})">${t.action_kick}</a></li>
                            </ul>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        // --- Member Actions ---
        function banMember(groupId, userId) {
            const t = translations[currentLang] || translations['zh-CN'];
            const duration = prompt(t.prompt_ban_duration, "30");
            if (duration === null) return;
            const minutes = parseInt(duration);
            if (isNaN(minutes)) {
                alert(t.alert_invalid_number);
                return;
            }

            callBotApi('set_group_ban', {
                group_id: groupId,
                user_id: userId,
                duration: minutes * 60
            }).then(() => {
                alert(minutes > 0 ? t.alert_banned : t.alert_unbanned);
            }).catch(e => alert(t.alert_op_failed + e.message));
        }

        function unbanMember(groupId, userId) {
            const t = translations[currentLang] || translations['zh-CN'];
            callBotApi('set_group_ban', {
                group_id: groupId,
                user_id: userId,
                duration: 0
            }).then(() => {
                alert(t.alert_unbanned);
            }).catch(e => alert(t.alert_op_failed + e.message));
        }

        function setCard(groupId, userId, currentCard) {
            const t = translations[currentLang] || translations['zh-CN'];
            const newCard = prompt(t.prompt_new_card, currentCard);
            if (newCard === null) return;

            callBotApi('set_group_card', {
                group_id: groupId,
                user_id: userId,
                card: newCard
            }).then(() => {
                alert(t.alert_card_set);
                loadGroupMembers(groupId); // Reload to show change
            }).catch(e => alert(t.alert_op_failed + e.message));
        }

        function toggleAutoRecallInput() {
            const checked = document.getElementById('auto-recall-check').checked;
            document.getElementById('auto-recall-input-group').style.display = checked ? 'flex' : 'none';
        }

        async function sendGroupMsg() {
            const t = translations[currentLang] || translations['zh-CN'];
            const input = document.getElementById('group-msg-input');
            const msg = input.value.trim();
            if (!msg) return;
            
            // Auto Recall Params
            let autoRecall = 0;
            if (document.getElementById('auto-recall-check').checked) {
                const delayStr = document.getElementById('auto-recall-delay').value;
                autoRecall = parseInt(delayStr);
                if (isNaN(autoRecall) || autoRecall < 0) autoRecall = 0;
            }

            try {
                let action = 'send_group_msg';
                let params = {
                    message: msg
                };

                if (currentContactType === 'group') {
                    action = 'send_group_msg';
                    params.group_id = currentGroupId;
                } else if (currentContactType === 'private') {
                    action = 'send_private_msg';
                    params.user_id = currentGroupId;
                } else if (currentContactType === 'guild') {
                    action = 'send_msg';
                    params.message_type = 'guild';
                    params.channel_id = currentGroupId;
                    params.guild_id = currentGuildId;
                }

                // Inject auto_recall into the request wrapper, not params (unless the API design changed, but usually it's top level for the manager)
                // Wait, callBotApi wraps params. 
                // We need to pass auto_recall to the manager.
                // callBotApi implementation:
                /*
                function callBotApi(action, params) {
                    return fetch('/api/action', {
                        body: JSON.stringify({
                            bot_id: currentBotId,
                            action: action,
                            params: params
                        })
                    })
                }
                */
                // The manager expects auto_recall at the top level of the JSON body.
                // callBotApi currently only supports bot_id, action, params.
                // We need to modify callBotApi or manually call fetch here.
                
                // Let's manually call fetch here to support auto_recall without changing callBotApi signature for everyone
                const body = {
                    bot_id: currentBotId,
                    action: action,
                    params: params,
                    auto_recall: autoRecall
                };

                const res = await fetchWithAuth('/api/action', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                
                const result = await res.json();
                if (result.error) throw new Error(result.error);

                alert(t.alert_send_success);
                input.value = '';
                addEventLog({type: 'system', message: `ÂèëÈÄÅÊ∂àÊÅØÂà∞ [${currentGroupId}]: ${msg}`});
            } catch (e) {
                alert(t.alert_op_failed + e.message);
            }
        }

        async function sendSmartGroupMsg() {
            if (!currentGroupId || !currentBotId) return;
            const content = document.getElementById('group-msg-input').value.trim();
            if (!content) return;
            
            // Auto Recall Params
            let autoRecall = 0;
            if (document.getElementById('auto-recall-check').checked) {
                const delayStr = document.getElementById('auto-recall-delay').value;
                autoRecall = parseInt(delayStr);
                if (isNaN(autoRecall) || autoRecall < 0) autoRecall = 0;
            }
            
            // UI Feedback
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ÂèëÈÄÅ‰∏≠...';
            btn.disabled = true;

            try {
                const res = await fetchWithAuth('/api/smart_action', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'send_group_msg',
                        params: {
                            group_id: currentGroupId,
                            message: content
                        },
                        self_id: currentBotId,
                        auto_recall: autoRecall
                    })
                });

                if (!res.ok) {
                    throw new Error('ËØ∑Ê±ÇÂ§±Ë¥•');
                }

                const data = await res.json();
                alert('Êô∫ËÉΩÂèëÈÄÅËØ∑Ê±ÇÂ∑≤Êèê‰∫§: ' + (data.detail || 'Success'));
                document.getElementById('group-msg-input').value = '';
            } catch (e) {
                alert('Êô∫ËÉΩÂèëÈÄÅÂ§±Ë¥•: ' + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        function kickMember(groupId, userId) {
            const t = translations[currentLang] || translations['zh-CN'];
            if (!confirm(t.confirm_kick_member.replace('{id}', userId))) return;
            callBotApi('set_group_kick', {
                group_id: groupId,
                user_id: userId
            }).then(() => {
                alert(t.alert_kicked);
                loadGroupMembers(groupId);
            }).catch(e => alert(t.alert_op_failed + e.message));
        }
        
        function leaveGroup() {
            const t = translations[currentLang] || translations['zh-CN'];
            if (!confirm(t.confirm_leave_group.replace('{id}', currentGroupId))) return;
             callBotApi('set_group_leave', {
                group_id: currentGroupId
            }).then(() => {
                alert(t.alert_left_group);
                refreshGroupList();
                document.getElementById('group-detail-empty').style.display = 'block';
                document.getElementById('group-detail-content').style.setProperty('display', 'none', 'important');
            }).catch(e => alert(t.alert_op_failed + e.message));
        }

        function checkGroupMember() {
            const userId = document.getElementById('check-member-input').value.trim();
            const resultEl = document.getElementById('check-member-result');
            const t = translations[currentLang] || translations['zh-CN'];
            
            if (!userId) {
                resultEl.innerHTML = `<span class="text-danger">${t.alert_invalid_number || 'Invalid ID'}</span>`;
                return;
            }

            resultEl.innerHTML = `<span class="text-muted">${t.loading || 'Loading...'}</span>`;
            
            callBotApi('get_group_member_info', {
                group_id: Number(currentGroupId),
                user_id: Number(userId),
                no_cache: true
            }).then(data => {
                if (data && (data.user_id || data.nickname)) {
                    // Found
                    let name = data.nickname || userId;
                    let card = data.card || '';
                    let text = t.member_found.replace('{name}', name).replace('{card}', card);
                    resultEl.innerHTML = `<span class="text-success"><i class="bi bi-check-circle"></i> ${text}</span>`;
                } else {
                    // Not found
                    resultEl.innerHTML = `<span class="text-warning">${t.member_not_found}</span>`;
                }
            }).catch(e => {
                console.error(e);
                // If 404 or other error, usually means not found or bot offline
                let msg = t.check_error + e.message;
                if (e.message.includes('not found') || e.message.includes('‰∏çÂ≠òÂú®')) {
                    msg = t.member_not_found;
                }
                resultEl.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle"></i> ${msg}</span>`;
            });
        }

        // --- System Actions ---
        async function callSystemAction(action) {
            const t = translations[currentLang] || translations['zh-CN'];
            if (action === 'clean_logs') {
                document.getElementById('recent-logs').innerHTML = '';
                addEventLog({type: 'system', message: t.log_cleaned});
                return;
            }
            
            try {
                const res = await callBotApi(action);
                alert(t.alert_op_success + JSON.stringify(res.data));
            } catch (e) {
                alert(t.alert_op_failed + e.message);
            }
        }

        function addEventLog(data) {
            const container = document.getElementById('event-container');
            if (container.children.length === 1 && container.children[0].classList.contains('text-muted')) {
                container.innerHTML = '';
            }
            
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.style.borderBottom = '1px solid var(--border-color)';
            div.style.padding = '8px 0';
            
            const time = new Date().toLocaleTimeString();
            
            // Format Content
            let content = '';
            if (data.type === 'system') {
                content = `<span class="text-info">[SYSTEM]</span> ${data.message}`;
            } else if (data.post_type === 'message' || data.post_type === 'message_sent') {
                const sender = data.sender ? (data.sender.nickname || data.sender.card || data.user_id) : data.user_id;
                const group = data.group_id ? `[Áæ§:${data.group_id}] ` : '[ÁßÅËÅä] ';
                let msg = data.message;
                if (typeof msg !== 'string') {
                    msg = JSON.stringify(msg);
                }
                content = `<span class="text-success">[MSG]</span> ${group}<span class="fw-bold text-warning">${sender}</span>: ${msg}`;
            } else if (data.post_type === 'meta_event') {
                if (data.meta_event_type === 'heartbeat') return; // Ignore heartbeat
                content = `<span class="text-secondary">[META]</span> ${data.meta_event_type}`;
            } else {
                content = `<span class="text-muted">[EVENT]</span> <pre class="d-inline m-0" style="font-size:0.8em">${JSON.stringify(data)}</pre>`;
            }
            
            div.innerHTML = `<span class="log-time">${time}</span> ${content}`;
            
            if (container) {
                container.appendChild(div);
                
                // Limit entries
                if (container.children.length > 200) {
                    container.removeChild(container.firstChild);
                }
                
                if (document.getElementById('auto-scroll-events') && document.getElementById('auto-scroll-events').checked) {
                    container.scrollTop = container.scrollHeight;
                }
            }

            // Update Dashboard Recent Logs
            const dashLog = document.getElementById('recent-logs');
            if (dashLog) {
                const clone = div.cloneNode(true);
                dashLog.appendChild(clone);
                if (dashLog.children.length > 50) {
                    dashLog.removeChild(dashLog.firstChild);
                }
                dashLog.scrollTop = dashLog.scrollHeight;
            }
        }

        function clearEvents() {
            document.getElementById('event-container').innerHTML = '<div class="text-muted text-center mt-5">Á≠âÂæÖ‰∫ã‰ª∂ËøûÊé•...</div>';
        }

        // --- Periodic Updates ---
        // Moved to startApp()
        
        let latestChatStats = {
            group_stats: {},
            user_stats: {},
            group_names: {},
            user_names: {}
        };

        function updateChatStats() {
            if (!authToken) return;
            fetchWithAuth('/api/stats/chat')
                .then(r => r.json())
                .then(data => {
                    latestChatStats = data;
                    // Fix: Use Today's stats for the dashboard top lists
                    renderTopList('top-groups', data.group_stats_today, data.group_names, 'Group');
                    renderTopList('top-users', data.user_stats_today, data.user_names, 'User');
                    
                    // Refresh lists if visible
                    const activeTab = document.querySelector('.nav-link.active').getAttribute('href');
                    if (activeTab === '#groups') {
                        // Only re-render if we have data to render, to avoid flickering or resetting scroll too often
                        // But since sorting might depend on stats, we should probably re-render.
                        // To be less intrusive, maybe only update if we are not dragging/selecting?
                        // For now, let's just re-render.
                        if (currentGroups && currentGroups.length > 0) {
                             renderGroups(currentGroups);
                        }
                        if (currentMembers && currentMembers.length > 0) {
                             renderMembers();
                        }
                    }
                })
                .catch(e => console.error("Update chat stats error:", e));
        }

        function getDisplayName(id, names, type) {
             if (names && names[id]) return names[id];
             if (type === 'Group') {
                 // Try to find in currentGroups loaded from bot
                 const g = currentGroups.find(x => x.group_id == id);
                 if (g) return g.group_name;
             }
             return `${type} ${id}`;
        }

        function renderTopList(elementId, stats, names, type) {
            const list = document.getElementById(elementId);
            if (!stats || Object.keys(stats).length === 0) {
                list.innerHTML = '<li class="list-group-item text-muted text-center">ÊöÇÊó†Êï∞ÊçÆ</li>';
                return;
            }

            const sorted = Object.entries(stats)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5);

            list.innerHTML = sorted.map(([id, count], index) => {
                const name = getDisplayName(id, names, type);
                // Optional: Fetch avatar if User or Group
                let avatar = '';
                if (type === 'User') {
                     avatar = `<img src="https://q1.qlogo.cn/g?b=qq&nk=${id}&s=100" class="rounded-circle me-2" width="20" height="20" onerror="this.style.display='none'">`;
                } else if (type === 'Group') {
                     avatar = `<img src="https://p.qlogo.cn/gh/${id}/${id}/100/" class="rounded-circle me-2" width="20" height="20" onerror="this.style.display='none'">`;
                }

                return `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div class="text-truncate" style="max-width: 70%;">
                            <span class="badge bg-light text-dark me-2">#${index + 1}</span>
                            ${avatar}
                            <span title="${id}">
                                ${name}
                                ${names && names[id] ? `<small class="text-muted ms-1" style="font-size:0.8em">(${id})</small>` : ''}
                            </span>
                        </div>
                        <span class="badge bg-primary rounded-pill">${count}</span>
                    </li>
                `;
            }).join('');
        }

        function showAllStats(type) {
            // Fix: Use Today's stats to match Dashboard
            const stats = type === 'Group' ? latestChatStats.group_stats_today : latestChatStats.user_stats_today;
            const names = type === 'Group' ? latestChatStats.group_names : latestChatStats.user_names;
            
            const t = translations[currentLang] || translations['zh-CN'];
            document.getElementById('statsModalTitle').innerText = type === 'Group' ? (t.top_active_groups || '‰ªäÊó•Ê¥ªË∑ÉÁæ§ÁªÑ') : (t.top_active_users || '‰ªäÊó•ÈæôÁéã');
            document.getElementById('statsModalNameHeader').innerText = type === 'Group' ? (t.group_name_default || 'Áæ§ÁªÑÂêçÁß∞') : (t.user_nickname || 'Áî®Êà∑ÊòµÁß∞');
            
            const tbody = document.getElementById('statsModalBody');
            if (!stats || Object.keys(stats).length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="text-center p-4">${t.no_data || 'ÊöÇÊó†Êï∞ÊçÆ'}</td></tr>`;
            } else {
                const sorted = Object.entries(stats).sort(([, a], [, b]) => b - a);
                tbody.innerHTML = sorted.map(([id, count], index) => {
                    const name = getDisplayName(id, names, type);
                    let avatar = '';
                    if (type === 'User') {
                         avatar = `<img src="https://q1.qlogo.cn/g?b=qq&nk=${id}&s=100" class="rounded-circle me-2 border" width="32" height="32" onerror="this.src='https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/person-circle.svg'">`;
                    } else {
                         avatar = `<img src="https://p.qlogo.cn/gh/${id}/${id}/100/" class="rounded-circle me-2 border" width="32" height="32" onerror="this.src='https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/people-fill.svg'">`;
                    }
                    
                    return `
                        <tr>
                            <td class="align-middle">${index + 1}</td>
                            <td class="text-truncate align-middle" style="max-width: 300px;" title="${id}">
                                <div class="d-flex align-items-center">
                                    ${avatar}
                                    <div class="overflow-hidden">
                                        <div class="text-truncate">${name}</div>
                                        <div class="text-muted small" style="font-size: 0.75rem;">${id}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="text-end align-middle fw-bold text-primary">${count}</td>
                        </tr>
                    `;
                }).join('');
            }
            
            new bootstrap.Modal(document.getElementById('statsModal')).show();
        }
        // --- Message Test ---
        async function loadTestGroups() {
            const select = document.getElementById('mt-group-select');
            select.innerHTML = '<option value="">Âä†ËΩΩ‰∏≠...</option>';
            
            try {
                const response = await callBotApi('get_group_list');
                const groups = response.data || [];
                
                // Sort by name
                groups.sort((a, b) => a.group_name.localeCompare(b.group_name, 'zh-CN'));
                
                let html = '<option value="">-- ÈÄâÊã©Áæ§ÁªÑ (ÊàñÊâãÂä®ËæìÂÖ• UID) --</option>';
                groups.forEach(g => {
                    html += `<option value="${g.group_id}">[${g.group_id}] ${g.group_name}</option>`;
                });
                select.innerHTML = html;
            } catch (e) {
                select.innerHTML = '<option value="">Âä†ËΩΩÂ§±Ë¥•: ' + e.message + '</option>';
            }
        }

        function onTestGroupSelectChange() {
            const select = document.getElementById('mt-group-select');
            const targetInput = document.getElementById('mt-target');
            if (select.value) {
                targetInput.value = select.value;
            }
        }
        
        function pasteTargetUid() {
            const select = document.getElementById('mt-group-select');
            if (select.value) {
                document.getElementById('mt-target').value = select.value;
            }
        }

        function updateMsgForm() {
            const t = translations[currentLang] || translations['zh-CN'];
            const type = document.getElementById('mt-type').value;
            
            // Hide all specific inputs
            document.getElementById('mt-group-text').style.display = 'none';
            document.getElementById('mt-group-file').style.display = 'none';
            document.getElementById('mt-group-music').style.display = 'none';
            document.getElementById('mt-group-share').style.display = 'none';
            document.getElementById('mt-group-raw').style.display = 'none';
            
            if (type === 'text' || type === 'poke') {
                document.getElementById('mt-group-text').style.display = 'block';
                document.getElementById('mt-content').placeholder = type === 'poke' ? t.placeholder_poke : t.placeholder_text_cq;
            } else if (type === 'image' || type === 'record' || type === 'video') {
                document.getElementById('mt-group-file').style.display = 'block';
                let label = t.label_file_url;
                if (type === 'image') label = t.label_image_url;
                else if (type === 'record') label = t.label_record_url;
                else if (type === 'video') label = t.label_video_url;
                document.getElementById('mt-file-label').textContent = label;
            } else if (type === 'music') {
                document.getElementById('mt-group-music').style.display = 'block';
            } else if (type === 'share') {
                document.getElementById('mt-group-share').style.display = 'block';
            } else if (type === 'json' || type === 'xml') {
                document.getElementById('mt-group-raw').style.display = 'block';
                document.getElementById('mt-raw-label').textContent = type.toUpperCase() + t.label_raw_content_suffix;
            }
        }

        async function submitTestMsg() {
            const t = translations[currentLang] || translations['zh-CN'];
            const resultEl = document.getElementById('mt-result');
            resultEl.style.display = 'none';
            resultEl.className = 'alert alert-secondary';
            resultEl.textContent = t.msg_sending;
            resultEl.style.display = 'block';
            
            const target = document.getElementById('mt-target').value;
            const type = document.getElementById('mt-type').value;
            
            if (!target) {
                resultEl.className = 'alert alert-danger';
                resultEl.textContent = t.alert_enter_target_uid;
                return;
            }

            // Default to group message
            let action = 'send_group_msg';
            let params = {
                group_id: parseInt(target)
            };
            
            // Construct Message
            if (type === 'text') {
                const content = document.getElementById('mt-content').value;
                if (!content) {
                    resultEl.className = 'alert alert-danger';
                    resultEl.textContent = t.alert_enter_content;
                    return;
                }
                params.message = content;
            } else if (type === 'poke') {
                const qq = document.getElementById('mt-content').value;
                params.message = `[CQ:poke,qq=${qq || ''}]`;
            } else if (type === 'image' || type === 'record' || type === 'video') {
                const file = document.getElementById('mt-file-path').value;
                if (!file) {
                    resultEl.className = 'alert alert-danger';
                    resultEl.textContent = t.alert_enter_file_url;
                    return;
                }
                params.message = [
                    {
                        type: type,
                        data: { file: file }
                    }
                ];
            } else if (type === 'music') {
                const mType = document.getElementById('mt-music-type').value;
                const mId = document.getElementById('mt-music-id').value;
                if (!mId) {
                    resultEl.className = 'alert alert-danger';
                    resultEl.textContent = t.msg_input_song_id;
                    return;
                }
                params.message = [{
                    type: 'music',
                    data: {
                        type: mType,
                        id: mId
                    }
                }];
            } else if (type === 'share') {
                params.message = [{
                    type: 'share',
                    data: {
                        url: document.getElementById('mt-share-url').value,
                        title: document.getElementById('mt-share-title').value,
                        content: document.getElementById('mt-share-content').value,
                        image: document.getElementById('mt-share-image').value
                    }
                }];
            } else if (type === 'json' || type === 'xml') {
                const raw = document.getElementById('mt-raw-content').value;
                if (!raw) {
                    resultEl.className = 'alert alert-danger';
                    resultEl.textContent = t.msg_input_content;
                    return;
                }
                params.message = [{
                    type: type,
                    data: {
                        data: raw
                    }
                }];
            }

            try {
                const res = await callBotApi(action, params);
                resultEl.className = 'alert alert-success';
                resultEl.textContent = 'ÂèëÈÄÅÊàêÂäü! MSG ID: ' + (res.data ? res.data.message_id : 'Unknown');
            } catch (e) {
                resultEl.className = 'alert alert-danger';
                resultEl.textContent = 'ÂèëÈÄÅÂ§±Ë¥•: ' + e.message;
            }
        }

        function updateCodePreview() {
            const target = document.getElementById('mt-target').value;
            const type = document.getElementById('mt-type').value;
            let params = {
                group_id: target ? parseInt(target) : 0
            };
            
            if (type === 'text') {
                params.message = document.getElementById('mt-content').value;
            } else if (type === 'poke') {
                const qq = document.getElementById('mt-content').value;
                params.message = `[CQ:poke,qq=${qq || ''}]`;
            } else if (type === 'image' || type === 'record' || type === 'video') {
                params.message = [{
                    type: type,
                    data: { file: document.getElementById('mt-file-path').value }
                }];
            } else if (type === 'music') {
                params.message = [{
                    type: 'music',
                    data: {
                        type: document.getElementById('mt-music-type').value,
                        id: document.getElementById('mt-music-id').value
                    }
                }];
            } else if (type === 'share') {
                params.message = [{
                    type: 'share',
                    data: {
                        url: document.getElementById('mt-share-url').value,
                        title: document.getElementById('mt-share-title').value,
                        content: document.getElementById('mt-share-content').value,
                        image: document.getElementById('mt-share-image').value
                    }
                }];
            } else if (type === 'json' || type === 'xml') {
                const raw = document.getElementById('mt-raw-content').value;
                params.message = [{
                    type: type,
                    data: { data: raw }
                }];
            }

            const preview = {
                action: 'send_group_msg',
                params: params
            };
            
            document.getElementById('code-preview').textContent = JSON.stringify(preview, null, 2);
        }

        function copyCodePreview() {
            const t = translations[currentLang] || translations['zh-CN'];
            const content = document.getElementById('code-preview').textContent;
            navigator.clipboard.writeText(content).then(() => {
                const btn = document.querySelector('button[onclick="copyCodePreview()"]');
                if(btn) {
                    const original = btn.textContent;
                    btn.textContent = t.btn_copied;
                    setTimeout(() => btn.textContent = original, 2000);
                }
            });
        }

        // --- Log Selection Auto-Pause ---
        function checkLogSelectionAndPause() {
            const selection = window.getSelection();
            if (!selection || selection.toString().length === 0) return;

            // Check if selection intersects with log containers
            // We use commonAncestorContainer to check if the selection is inside the log container
            let node = selection.anchorNode;
            if (!node) return;
            if (node.nodeType === 3) node = node.parentNode; // text node -> element

            const container = document.getElementById('log-container');
            const containerFull = document.getElementById('log-container-full');
            
            // Check if the selection is within either container
            if ((container && container.contains(node)) || 
                (containerFull && containerFull.contains(node))) {
                 
                 const autoRefreshFull = document.getElementById('auto-refresh-logs-full');
                 if (autoRefreshFull && autoRefreshFull.checked) {
                     autoRefreshFull.checked = false;
                 }
                 
                 const autoRefreshWidget = document.getElementById('auto-refresh-logs');
                 if (autoRefreshWidget && autoRefreshWidget.checked) {
                     autoRefreshWidget.checked = false;
                 }
            }
        }
        
        document.addEventListener('mouseup', checkLogSelectionAndPause);
        document.addEventListener('keyup', (e) => {
             // Shift + Arrows usually select text
             if (e.shiftKey) checkLogSelectionAndPause();
        });

        // --- Docker Management ---
        function loadDockerContainers(isSilent = false) {
            const tbody = document.getElementById('docker-container-list');
            if (!tbody) return;
            
            // Only show loading indicator if not silent refresh
            if (!isSilent) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted" data-i18n="loading">Loading...</td></tr>';
            }
            
            fetchWithAuth('/api/docker/list')
                .then(r => r.json())
                .then(containers => {
                 if (!containers || containers.length === 0) {
                     tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted" data-i18n="no_data">No Data</td></tr>';
                     return;
                 }
                 
                 const t = translations[currentLang] || translations['zh-CN'];
                 
                 tbody.innerHTML = containers.map(c => {
                    const isRunning = c.State === 'running';
                    const shortId = c.Id.substring(0, 12);
                    return `
                    <tr>
                        <td><span class="font-monospace">${shortId}</span></td>
                        <td>${(c.Names || []).join(', ')}</td>
                        <td>${c.Image}</td>
                        <td><span class="badge bg-${isRunning ? 'success' : 'secondary'}">${c.State}</span></td>
                        <td>${c.Status}</td>
                        <td>
                            ${isRunning ? 
                                `<button class="btn btn-sm btn-outline-danger me-1" onclick="controlContainer('${c.Id}', 'stop')"><i class="bi bi-stop-fill"></i> ${t.docker_stop}</button>
                                 <button class="btn btn-sm btn-outline-warning" onclick="controlContainer('${c.Id}', 'restart')"><i class="bi bi-arrow-repeat"></i> ${t.docker_restart}</button>` 
                                : 
                                `<button class="btn btn-sm btn-outline-success" onclick="controlContainer('${c.Id}', 'start')"><i class="bi bi-play-fill"></i> ${t.docker_start}</button>`
                            }
                        </td>
                    </tr>
                 `}).join('');
            })
            .catch(err => {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error: ${err}</td></tr>`;
            });
        }

        function controlContainer(id, action) {
            const t = translations[currentLang] || translations['zh-CN'];
            const actionText = t[`docker_${action}`] || action;
            const confirmMsg = t.docker_confirm_action
                .replace('{id}', id.substring(0, 12))
                .replace('{action}', actionText);
                
            if (!confirm(confirmMsg)) return;
            
            // Show loading state on the button itself? 
            // For now, simple alert or just proceed. 
            // Ideally we should disable the button.
            
            fetchWithAuth('/api/docker/action', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    container_id: id,
                    action: action
                })
            })
            .then(r => r.json())
            .then(res => {
                if (res.status === 'ok' || (res.id && !res.message)) { 
                    // Use silent refresh to avoid full table flicker
                    loadDockerContainers(true);
                } else {
                    alert(`${t.docker_action_failed}: ${res.message || JSON.stringify(res)}`);
                }
            })
            .catch(err => {
                alert('Error: ' + err);
            });
        }

        function addBotContainer() {
            const t = translations[currentLang] || translations['zh-CN'];
            if (!confirm("Á°ÆÂÆöË¶ÅÈÉ®ÁΩ≤Êñ∞ÁöÑÊú∫Âô®‰∫∫ÂÆπÂô®ÂêóÔºü")) return;
            
            fetchWithAuth('/api/docker/add-bot', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(r => r.json())
            .then(res => {
                if (res.status === 'ok') {
                    alert("Êú∫Âô®‰∫∫ÂÆπÂô®Â∑≤Âú®ÂêéÂè∞ÂºÄÂßãÈÉ®ÁΩ≤");
                    loadDockerContainers(true);
                } else {
                    alert(res.message || "ÈÉ®ÁΩ≤ËØ∑Ê±ÇÂ§±Ë¥•");
                }
            })
            .catch(err => alert("Error: " + err));
        }

        function addWorkerContainer() {
            const t = translations[currentLang] || translations['zh-CN'];
            if (!confirm("Á°ÆÂÆöË¶ÅÈÉ®ÁΩ≤Êñ∞ÁöÑ Worker ËäÇÁÇπÂÆπÂô®ÂêóÔºü")) return;
            
            fetchWithAuth('/api/docker/add-worker', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(r => r.json())
            .then(res => {
                if (res.status === 'ok') {
                    alert("Worker ËäÇÁÇπÂÆπÂô®Â∑≤Âú®ÂêéÂè∞ÂºÄÂßãÈÉ®ÁΩ≤");
                    loadDockerContainers(true);
                } else {
                    alert(res.message || "ÈÉ®ÁΩ≤ËØ∑Ê±ÇÂ§±Ë¥•");
                }
            })
            .catch(err => alert("Error: " + err));
        }

        // --- Routing Management ---
        let routingRules = [];

        async function fetchRoutingRules() {
            const container = document.getElementById('routing-list-container');
            if (!container) return;
            
            container.innerHTML = `
                <div class="col-12 text-center text-muted">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2" data-i18n="loading_routing_rules">Ê≠£Âú®Âä†ËΩΩË∑ØÁî±ËßÑÂàô...</p>
                </div>
            `;
            
            try {
                const response = await fetchWithAuth('/api/admin/routing');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                // Convert object format to array format for easier rendering
                routingRules = [];
                if (data.rules && typeof data.rules === 'object') {
                    for (const [key, workerID] of Object.entries(data.rules)) {
                        routingRules.push({
                            key: key,
                            worker_id: workerID
                        });
                    }
                }
                renderRoutingRules();
                
            } catch (error) {
                console.error('Failed to fetch routing rules:', error);
                const t = translations[currentLang] || translations['zh-CN'];
                container.innerHTML = `
                    <div class="col-12 text-center text-danger">
                        <i class="bi bi-exclamation-triangle fs-4"></i>
                        <p class="mt-2">${t.loading_failed || 'Âä†ËΩΩÂ§±Ë¥•'}: ${error.message}</p>
                        <button class="btn btn-sm btn-outline-primary" onclick="fetchRoutingRules()">
                            <i class="bi bi-arrow-clockwise"></i> ${t.retry || 'ÈáçËØï'}
                        </button>
                    </div>
                `;
            }
        }

        function toggleRoutingHelp() {
            const helpSection = document.getElementById('routing-help-section');
            if (helpSection.style.display === 'none') {
                helpSection.style.display = 'block';
            } else {
                helpSection.style.display = 'none';
            }
        }

        function renderRoutingRules() {
            const container = document.getElementById('routing-list-container');
            if (!container) return;
            
            const t = translations[currentLang] || translations['zh-CN'];
            
            if (!routingRules || routingRules.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center text-muted">
                        <i class="bi bi-diagram-3 fs-1"></i>
                        <p class="mt-3" data-i18n="no_routing_rules">ÊöÇÊó†Ë∑ØÁî±ËßÑÂàô</p>
                        <button class="btn btn-primary" onclick="showAddRoutingRuleDialog()">
                            <i class="bi bi-plus-lg"></i> <span data-i18n="routing_add_rule">Ê∑ªÂä†Ë∑ØÁî±ËßÑÂàô</span>
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = routingRules.map(rule => `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0 text-truncate" title="${rule.key || ''}">${rule.key || 'Êú™ÂëΩÂêçËßÑÂàô'}</h6>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="editRoutingRule('${rule.key}')">
                                            <i class="bi bi-pencil"></i> ${t.edit || 'ÁºñËæë'}
                                        </a></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteRoutingRule('${rule.key}')">
                                            <i class="bi bi-trash"></i> ${t.delete || 'Âà†Èô§'}
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                            <p class="card-text small text-muted mb-2">
                                <i class="bi bi-arrow-right"></i> ${rule.worker_id || 'Êú™ËÆæÁΩÆÁõÆÊ†á'}
                            </p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="bi bi-diagram-3"></i> ${t.target_worker || 'ÁõÆÊ†áÂ∑•‰ΩúËäÇÁÇπ'}: ${rule.worker_id || 'N/A'}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showAddRoutingRuleDialog() {
            // Reset form for new rule
            document.getElementById('routing-pattern').value = '';
            document.getElementById('routing-target').value = '';
            document.getElementById('routing-enabled').checked = true;
            
            // Populate worker dropdown
            const dropdown = document.getElementById('worker-select-dropdown');
            if (dropdown && window.currentWorkers) {
                if (window.currentWorkers.length === 0) {
                    dropdown.innerHTML = '<li><a class="dropdown-item disabled" href="#">Êó†Âú®Á∫øËäÇÁÇπ</a></li>';
                } else {
                    dropdown.innerHTML = window.currentWorkers.map(w => 
                        `<li><a class="dropdown-item" href="javascript:void(0)" onclick="document.getElementById('routing-target').value='${w.id}'">${w.id} (${w.addr})</a></li>`
                    ).join('');
                }
            }

            // Update modal title for adding new rule
            const modalTitle = document.querySelector('#routingRuleModal .modal-title');
            if (modalTitle) {
                modalTitle.textContent = 'Ê∑ªÂä†Ë∑ØÁî±ËßÑÂàô';
                modalTitle.setAttribute('data-i18n', 'routing_add_rule');
            }
            
            // Update save button for adding new rule
            const saveButton = document.querySelector('#routingRuleModal .modal-footer .btn-primary');
            if (saveButton) {
                saveButton.textContent = '‰øùÂ≠ò';
                saveButton.setAttribute('data-i18n', 'save');
                saveButton.onclick = () => saveRoutingRule();
            }
            
            const modal = new bootstrap.Modal(document.getElementById('routingRuleModal'));
            modal.show();
        }

        async function saveRoutingRule() {
            const pattern = document.getElementById('routing-pattern').value.trim();
            const target = document.getElementById('routing-target').value.trim();
            const enabled = document.getElementById('routing-enabled').checked;
            
            if (!pattern || !target) {
                alert('ËØ∑Â°´ÂÜôÂÆåÊï¥‰ø°ÊÅØ');
                return;
            }
            
            try {
                const response = await fetchWithAuth('/api/admin/routing', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        key: pattern,
                        worker_id: target
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || '‰øùÂ≠òÂ§±Ë¥•');
                }
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('routingRuleModal'));
                modal.hide();
                
                fetchRoutingRules(); // Refresh the list
                
            } catch (error) {
                console.error('Failed to save routing rule:', error);
                alert('‰øùÂ≠òÂ§±Ë¥•: ' + error.message);
            }
        }

        async function deleteRoutingRule(ruleId) {
            const t = translations[currentLang] || translations['zh-CN'];
            if (!confirm(t.confirm_delete || 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Ë∑ØÁî±ËßÑÂàôÂêóÔºü')) {
                return;
            }
            
            try {
                const response = await fetchWithAuth('/api/admin/routing', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        key: ruleId,
                        worker_id: '' // Empty worker_id means delete
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                fetchRoutingRules(); // Refresh the list
                
            } catch (error) {
                console.error('Failed to delete routing rule:', error);
                alert('Âà†Èô§Â§±Ë¥•: ' + error.message);
            }
        }

        function editRoutingRule(ruleId) {
            const rule = routingRules.find(r => r.key === ruleId);
            if (!rule) {
                alert('ËßÑÂàô‰∏çÂ≠òÂú®');
                return;
            }
            
            showAddRoutingRuleDialog();
            
            // Pre-fill the form after modal is shown
            setTimeout(() => {
                document.getElementById('routing-pattern').value = rule.key || '';
                document.getElementById('routing-target').value = rule.worker_id || '';
                document.getElementById('routing-enabled').checked = true;
                
                // Change modal title
                const modalTitle = document.querySelector('#routingRuleModal .modal-title');
                if (modalTitle) {
                    modalTitle.textContent = 'ÁºñËæëË∑ØÁî±ËßÑÂàô';
                    modalTitle.setAttribute('data-i18n', 'routing_edit_rule');
                }
                
                // Change save button to update
                const saveButton = document.querySelector('#routingRuleModal .modal-footer .btn-primary');
                if (saveButton) {
                    saveButton.textContent = 'Êõ¥Êñ∞';
                    saveButton.setAttribute('data-i18n', 'update');
                    saveButton.onclick = () => updateRoutingRule(ruleId);
                }
            }, 100);
        }

        async function updateRoutingRule(ruleId) {
            const pattern = document.getElementById('routing-pattern').value.trim();
            const target = document.getElementById('routing-target').value.trim();
            const enabled = document.getElementById('routing-enabled').checked;
            
            if (!pattern || !target) {
                alert('ËØ∑Â°´ÂÜôÂÆåÊï¥‰ø°ÊÅØ');
                return;
            }
            
            try {
                const response = await fetchWithAuth(`/api/admin/routing/${ruleId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pattern: pattern,
                        target: target,
                        enabled: enabled
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Êõ¥Êñ∞Â§±Ë¥•');
                }
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('routingRuleModal'));
                modal.hide();
                
                fetchRoutingRules(); // Refresh the list
                
            } catch (error) {
                console.error('Failed to update routing rule:', error);
                alert('Êõ¥Êñ∞Â§±Ë¥•: ' + error.message);
            }
        }
        
        // È°µÈù¢Âà∑Êñ∞Êó∂ÁöÑÊ∏ÖÁêÜÈÄªËæë
        function cleanupBeforeUnload() {
            // Ê∏ÖÁêÜWebSocketËøûÊé•
            if (window.wsSubscriber) {
                try {
                    window.wsSubscriber.close();
                    window.wsSubscriber = null;
                } catch (e) {
                    console.error('Ê∏ÖÁêÜWebSocketÂ§±Ë¥•:', e);
                }
            }
            
            // Ê∏ÖÁêÜÊâÄÊúâÂÆöÊó∂Âô®
            const intervals = [
                'updateInterval', 'systemStatsInterval', 'chatStatsInterval', 
                'botsInterval', 'workersInterval'
            ];
            
            intervals.forEach(intervalName => {
                if (window[intervalName]) {
                    clearInterval(window[intervalName]);
                    window[intervalName] = null;
                }
            });
            
            // Ê∏ÖÁêÜÊâÄÊúâÂæÖÂ§ÑÁêÜÁöÑËØ∑Ê±Ç
            if (window.pendingRequests) {
                window.pendingRequests.clear();
            }
            
            console.log('È°µÈù¢Ê∏ÖÁêÜÂÆåÊàê');
        }
        
        // ÁõëÂê¨È°µÈù¢Âà∑Êñ∞ÂíåÂÖ≥Èó≠‰∫ã‰ª∂
        window.addEventListener('beforeunload', cleanupBeforeUnload);
        window.addEventListener('pagehide', cleanupBeforeUnload);
        
        function showCreateUserModal() {
            const modal = new bootstrap.Modal(document.getElementById('createUserModal'));
            modal.show();
        }

        async function createUser() {
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const isAdmin = document.getElementById('new-is-admin').checked;

            if (!username || !password) {
                alert('ËØ∑Â°´ÂÜôÁî®Êà∑ÂêçÂíåÂØÜÁ†Å');
                return;
            }

            try {
                const response = await fetchWithAuth('/api/admin/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, is_admin: isAdmin })
                });
                const result = await response.json();
                if (result.success) {
                    showToast('Áî®Êà∑ÂàõÂª∫ÊàêÂäü', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
                    fetchUsers(); // Âà∑Êñ∞ÂàóË°®
                    // Ê∏ÖÁ©∫Ë°®Âçï
                    document.getElementById('new-username').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('new-is-admin').checked = false;
                } else {
                    alert('ÂàõÂª∫Â§±Ë¥•: ' + result.message);
                }
            } catch (err) {
                console.error('Create user error:', err);
                alert('ÂàõÂª∫Áî®Êà∑Êó∂Âá∫Èîô');
            }
        }

        async function fetchUsers() {
            if (currentUserRole !== 'admin') return;
            
            try {
                const response = await fetchWithAuth('/api/admin/users');
                const result = await response.json();
                if (result.success) {
                    renderUsers(result.users);
                }
            } catch (err) {
                console.error('Fetch users error:', err);
            }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td><span class="badge ${user.is_admin ? 'bg-danger' : 'bg-info'}">${user.is_admin ? 'Admin' : 'User'}</span></td>
                    <td>${new Date(user.created_at).toLocaleString()}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${user.username}')" ${user.username === 'admin' ? 'disabled' : ''}>
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function deleteUser(username) {
            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Áî®Êà∑ ${username} ÂêóÔºü`)) return;
            
            try {
                const response = await fetchWithAuth(`/api/admin/users?username=${encodeURIComponent(username)}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    showToast('Áî®Êà∑Âà†Èô§ÊàêÂäü', 'success');
                    fetchUsers();
                } else {
                    alert('Âà†Èô§Â§±Ë¥•: ' + result.message);
                }
            } catch (err) {
                console.error('Delete user error:', err);
            }
        }

        // ÁõëÂê¨È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñÔºå‰ºòÂåñÊÄßËÉΩ
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // È°µÈù¢ÈöêËóèÊó∂ÊöÇÂÅúÈÉ®ÂàÜÂÆöÊó∂Âô®
                console.log('È°µÈù¢ÈöêËóèÔºåÊöÇÂÅúÈÉ®ÂàÜÂÆöÊó∂Âô®');
            } else {
                // È°µÈù¢ÊòæÁ§∫Êó∂ÊÅ¢Â§çÂÆöÊó∂Âô®
                console.log('È°µÈù¢ÊòæÁ§∫ÔºåÊÅ¢Â§çÂÆöÊó∂Âô®');
            }
        });
    </script>
</body>
</html>

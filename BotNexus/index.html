<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BotMatrix Manager</title>
    <!-- Use Staticfile CDN (Reliable in China) -->
    <link href="https://cdn.staticfile.org/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.staticfile.org/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css" rel="stylesheet">
    <script src="https://cdn.staticfile.org/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.staticfile.org/Chart.js/3.7.1/chart.min.js"></script>
    <script src="locales.js"></script>
    <style>
        :root {
            --bg-body: #f8f9fa;
            --bg-sidebar: #ffffff;
            --bg-card: #ffffff;
            --text-main: #212529;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --primary-color: #0d6efd;
            
            --bg-console: #f8f9fa;
            --text-console: #212529;
            --color-log-time: #0d6efd;
            --color-log-info: #198754;
            --color-log-error: #dc3545;
            --color-log-debug: #6c757d;
            
            --bg-list-item: #f8f9fa;
        }

        [data-theme="dark"] {
            --bg-body: #121212;
            --bg-sidebar: #1e1e1e;
            --bg-card: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #adb5bd;
            --border-color: #333333;
            --primary-color: #3d8bfd;

            --bg-console: #1e1e1e;
            --text-console: #d4d4d4;
            --color-log-time: #569cd6;
            --color-log-info: #4ec9b0;
            --color-log-error: #f44747;
            --color-log-debug: #dcdcaa;
            
            --bg-list-item: #2c2c2c;
        }

        /* Dark Mode Overrides */
        [data-theme="dark"] .dropdown-menu {
            background-color: var(--bg-card);
            border-color: var(--border-color);
        }
        [data-theme="dark"] .dropdown-item {
            color: var(--text-main);
        }
        [data-theme="dark"] .dropdown-item:hover {
            background-color: var(--bg-list-item);
            color: var(--text-main);
        }
        [data-theme="dark"] .list-group-item {
            background-color: var(--bg-card);
            color: var(--text-main);
            border-color: var(--border-color);
        }
        /* Fix TAB title background in dark mode */
        [data-theme="dark"] .nav-tabs .nav-link.active {
            background-color: var(--bg-card) !important;
            color: var(--text-main) !important;
            border-color: var(--border-color) var(--border-color) var(--bg-body);
        }
        [data-theme="dark"] .card-header {
            background-color: rgba(255, 255, 255, 0.05) !important;
            border-bottom-color: var(--border-color);
            color: var(--text-main);
        }
        [data-theme="dark"] .bg-white {
            background-color: var(--bg-card) !important;
        }

        /* Dark Mode Modal & Table */
        [data-theme="dark"] .modal-content {
            background-color: var(--bg-card);
            color: var(--text-main);
            border-color: var(--border-color);
        }
        [data-theme="dark"] .modal-header,
        [data-theme="dark"] .modal-footer {
            border-color: var(--border-color);
        }
        [data-theme="dark"] .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        [data-theme="dark"] .table-striped > tbody > tr:nth-of-type(odd) {
            --bs-table-accent-bg: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
        }
        [data-theme="dark"] .table-hover > tbody > tr:hover {
            --bs-table-hover-bg: rgba(255, 255, 255, 0.1);
            color: var(--text-main);
        }
        [data-theme="dark"] .table thead.table-light th {
            background-color: var(--bg-sidebar) !important;
            color: var(--text-main) !important;
            border-color: var(--border-color);
        }
        [data-theme="dark"] .table > :not(caption) > * > * {
            border-color: var(--border-color);
        }

        body { background-color: var(--bg-body); color: var(--text-main); font-family: system-ui, -apple-system, sans-serif; transition: background-color 0.3s, color 0.3s; }
        .sidebar { display: flex; flex-direction: column; height: 100vh; position: fixed; top: 0; left: 0; width: 250px; background-color: var(--bg-sidebar); border-right: 1px solid var(--border-color); padding-top: 20px; z-index: 1000; transition: background-color 0.3s, border-color 0.3s; }
        .card { background-color: var(--bg-card); border: 1px solid var(--border-color); margin-bottom: 24px; box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); border-radius: 0.75rem; transition: background-color 0.3s, border-color 0.3s; }
        .form-control, .form-select { background-color: var(--bg-card); color: var(--text-main); border-color: var(--border-color); }
        .form-control:focus, .form-select:focus { background-color: var(--bg-card); color: var(--text-main); border-color: var(--primary-color); }
        .dropdown-menu { background-color: var(--bg-card); border-color: var(--border-color); }
        .dropdown-item { color: var(--text-main); }
        .dropdown-item:hover { background-color: rgba(255, 255, 255, 0.1); color: var(--text-main); }
        .list-group-item { background-color: var(--bg-card); color: var(--text-main); border-color: var(--border-color); }
        .table { color: var(--text-main); border-color: var(--border-color); }
        .nav-link { color: var(--text-muted); }
        
        .sidebar a { color: var(--text-muted); padding: 12px 24px; display: block; text-decoration: none; border-left: 3px solid transparent; }
        .sidebar a:hover, .sidebar a.active { color: var(--primary-color); background-color: rgba(13, 110, 253, 0.1); border-left-color: var(--primary-color); font-weight: 500; }
        .main-content { margin-left: 250px; padding: 25px; }
        .metric-label { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .log-box { background-color: var(--bg-console); color: var(--text-console); font-family: monospace; padding: 15px; overflow-y: auto; border-radius: 0.5rem; font-size: 0.85rem; border: 1px solid var(--border-color); }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid var(--border-color); padding-bottom: 2px; }
        .log-time { color: var(--color-log-time); margin-right: 10px; }
        .log-level-INFO { color: var(--color-log-info); }
        .log-level-ERROR { color: var(--color-log-error); }
        .log-level-DEBUG { color: var(--color-log-debug); }

        /* Mobile Responsive */
        .mobile-nav { display: none; }
        .overlay { display: none; }



        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                box-shadow: 0 0 15px rgba(0,0,0,0.2);
            }
            .sidebar.show {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
                padding-top: 80px; /* Space for navbar */
                padding-left: 15px;
                padding-right: 15px;
            }
            .mobile-nav {
                display: flex;
                position: fixed;
                top: 0; left: 0; right: 0;
                height: 60px;
                background: #fff;
                border-bottom: 1px solid var(--border-color);
                z-index: 900;
                align-items: center;
                padding: 0 15px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            .overlay {
                display: none;
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 999;
            }
            .overlay.show {
                display: block;
            }
            
            /* Group Management Mobile */
        .group-manage-container {
            height: auto !important;
        }
        .group-manage-col {
            height: 70vh !important;
            margin-bottom: 20px;
        }
    }
    
    /* Custom Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    @media (min-width: 768px) {
        .stats-grid { grid-template-columns: repeat(4, 1fr); }
    }
    @media (min-width: 1400px) {
        .stats-grid { grid-template-columns: repeat(8, 1fr); }
    }
    .icon-circle {
        width: 42px;
        height: 42px;
        border-radius: 50% !important; /* Force circle */
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        flex-shrink: 0;
    }
    .stat-card {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        height: 100%;
        transition: transform 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .stat-info {
        overflow: hidden;
        margin-left: 0.75rem;
    }
    .stat-label {
        font-size: 0.7rem;
        color: var(--text-muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 2px;
    }
    .stat-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-main);
        line-height: 1;
    }
</style>
</head>
<body>


    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" data-i18n="login_title">ç³»ç»Ÿç™»å½•</h5>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label class="form-label" data-i18n="username">ç”¨æˆ·å</label>
                            <input type="text" class="form-control" id="loginUser" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" data-i18n="password">å¯†ç </label>
                            <input type="password" class="form-control" id="loginPass" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary" data-i18n="login_btn">ç™»å½•</button>
                        </div>
                    </form>
                    <div id="loginError" class="alert alert-danger mt-3 d-none"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Nav -->
    <div class="mobile-nav">
        <button class="btn btn-outline-secondary me-3" onclick="toggleSidebar()">
            <i class="bi bi-list fs-4"></i>
        </button>
        <h5 class="m-0">BotMatrix</h5>
    </div>
    
    <!-- Overlay -->
    <div class="overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Stats Modal -->
    <div class="modal fade" id="statsModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statsModalTitle" data-i18n="modal_stats_title">ç»Ÿè®¡è¯¦æƒ…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-light sticky-top" style="top: 0">
                            <tr>
                                <th scope="col" width="60">#</th>
                                <th scope="col" id="statsModalNameHeader" data-i18n="modal_col_name">åç§°</th>
                                <th scope="col" width="100" class="text-end" data-i18n="modal_col_count">æ•°é‡</th>
                            </tr>
                        </thead>
                        <tbody id="statsModalBody">
                            <!-- Data -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="px-3 mb-4">
            <h4>ğŸš€ BotMatrix</h4>
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted" data-i18n="sidebar_subtitle">Enterprise Bot Manager</small>
                <span class="badge bg-secondary" style="font-size: 0.7em;">v1.1.62</span>
            </div>
        </div>
        
        <!-- Bot Selector Removed -->
        
        <nav class="nav flex-column">
            <a href="#dashboard" id="nav-dashboard" class="nav-link active" onclick="showTab('dashboard')"><i class="bi bi-speedometer2"></i> <span data-i18n="sidebar_dashboard">è¿è¡ŒçŠ¶æ€</span></a>
            <a href="#bots" id="nav-bots" class="nav-link" onclick="showTab('bots')"><i class="bi bi-robot"></i> <span data-i18n="sidebar_bots">äº‘ç«¯çŸ©é˜µ</span></a>
            <a href="#groups" id="nav-groups" class="nav-link" onclick="showTab('groups')"><i class="bi bi-people"></i> <span data-i18n="sidebar_groups">ç¾¤ç»„å¥½å‹</span></a>
            <a href="#monitor" id="nav-monitor" class="nav-link" onclick="showTab('monitor')"><i class="bi bi-display"></i> <span data-i18n="sidebar_monitor">ç³»ç»Ÿç›‘æ§</span></a>
            <a href="#logs" id="nav-logs" class="nav-link" onclick="showTab('logs')"><i class="bi bi-journal-text"></i> <span data-i18n="sidebar_logs">æ—¥å¿—ä¸­å¿ƒ</span></a>
            <a href="#debug" id="nav-debug" class="nav-link" onclick="showTab('debug')"><i class="bi bi-bug"></i> <span data-i18n="sidebar_debug">è°ƒè¯•æµ‹è¯•</span></a>
            <a href="#settings" id="nav-settings" class="nav-link" onclick="showTab('settings')"><i class="bi bi-gear"></i> <span data-i18n="sidebar_settings">ç³»ç»Ÿè®¾ç½®</span></a>
            <a href="javascript:void(0)" class="nav-link text-danger mt-3" onclick="logout()"><i class="bi bi-box-arrow-right"></i> <span data-i18n="sidebar_logout">é€€å‡ºç™»å½•</span></a>
        </nav>

        <div class="mt-auto p-3 border-top d-flex justify-content-around align-items-center">
             <button class="btn btn-outline-secondary rounded-circle theme-toggle-btn-sidebar" onclick="toggleTheme()" title="Toggle Theme" data-i18n-title="theme_toggle" style="width: 38px; height: 38px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-moon-stars"></i>
            </button>
            
            <div class="dropup">
                <button class="btn btn-outline-secondary rounded-circle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Language" style="width: 38px; height: 38px; display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-translate"></i>
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="setLanguage('zh-CN')">ç®€ä½“ä¸­æ–‡</a></li>
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="setLanguage('zh-TW')">ç¹é«”ä¸­æ–‡</a></li>
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="setLanguage('en')">English</a></li>
                </ul>
            </div>

            <a href="https://github.com/changliaotong/BotMatrix" target="_blank" class="btn btn-outline-secondary rounded-circle github-btn-sidebar" title="View on GitHub" style="width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; text-decoration: none; padding: 0;">
                <i class="bi bi-github"></i>
            </a>
        </div>
    </div>

    <div class="main-content">
        <!-- Dashboard Tab -->
        <div id="tab-dashboard" class="tab-content">
            <!-- Stats Grid -->
            <div class="stats-grid" id="dash-system-stats">
                <!-- 1. Bots -->
                <div class="stat-card">
                    <div class="icon-circle bg-primary bg-opacity-10 text-primary">
                        <i class="bi bi-robot"></i>
                    </div>
                    <div class="stat-info w-100">
                        <div class="stat-label" data-i18n="stat_bots">æœºå™¨äºº (åœ¨çº¿/ç¦»çº¿/æ€»æ•°)</div>
                        <div class="stat-value">
                            <span id="metric-bots">0</span>
                            <span class="text-muted fs-6 fw-normal">/</span>
                            <span id="metric-bots-offline" class="text-muted fs-6 fw-normal">0</span>
                            <span class="text-muted fs-6 fw-normal">/</span>
                            <span id="metric-bots-total" class="text-muted fs-6 fw-normal">0</span>
                        </div>
                    </div>
                </div>

                <!-- 2. CPU -->
                <div class="stat-card" title="CPUè¯¦æƒ…">
                    <div class="icon-circle bg-warning bg-opacity-10 text-warning">
                        <i class="bi bi-cpu-fill"></i>
                    </div>
                    <div class="stat-info w-100">
                        <div class="stat-label" id="metric-cpu-model">CPU ä½¿ç”¨ç‡</div>
                        <div class="stat-value" id="metric-cpu">0%</div>
                        <div class="d-flex justify-content-between mt-1" style="font-size: 0.65rem; color: var(--text-muted);">
                             <span id="metric-cpu-cores">0 æ ¸</span>
                             <span id="metric-cpu-freq">0 MHz</span>
                        </div>
                    </div>
                </div>

                <!-- 3. System Info (New) -->
                <div class="stat-card" title="ä¸»æœºç³»ç»Ÿ">
                    <div class="icon-circle bg-info bg-opacity-10 text-info">
                        <i class="bi bi-pc-display"></i>
                    </div>
                    <div class="stat-info w-100">
                        <div class="stat-label" data-i18n="stat_os">ä¸»æœºç³»ç»Ÿ</div>
                        <div class="stat-value" style="font-size: 0.9rem;" id="metric-os-plat">alpine 3.23.0</div>
                        <div class="d-flex justify-content-between mt-1" style="font-size: 0.65rem; color: var(--text-muted);">
                             <span id="metric-os-ver">å†…æ ¸: 6.8.0-86-generic</span>
                             <span id="metric-os-arch"></span>
                        </div>
                    </div>
                </div>

                <!-- 3. Mem -->
                <div class="stat-card">
                    <div class="icon-circle bg-success bg-opacity-10 text-success">
                        <i class="bi bi-memory"></i>
                    </div>
                    <div class="stat-info w-100">
                        <div class="stat-label" data-i18n="stat_mem">ç³»ç»Ÿå†…å­˜</div>
                        <div class="stat-value">
                            <span id="metric-mem">0 MB</span>
                            <span id="metric-mem-total" class="text-muted fs-6 fw-normal ms-1">0 GB</span>
                        </div>
                    </div>
                </div>

                <!-- 4. Goroutines -->
                <div class="stat-card">
                    <div class="icon-circle bg-info bg-opacity-10 text-info">
                        <i class="bi bi-activity"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label" data-i18n="stat_goroutines">Goroutines</div>
                        <div class="stat-value" id="metric-goroutines">0</div>
                    </div>
                </div>

                <!-- 5. Groups -->
                <div class="stat-card">
                    <div class="icon-circle bg-primary bg-opacity-10 text-primary">
                        <i class="bi bi-people"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label" data-i18n="stat_active_groups">æ´»è·ƒç¾¤ç»„ (ä»Šæ—¥/æ€»è®¡)</div>
                        <div class="stat-value">
                            <span id="metric-groups-today">0</span> <span class="text-muted fs-6 fw-normal">/</span> <span id="metric-groups-total" class="text-muted fs-6 fw-normal">0</span>
                        </div>
                    </div>
                </div>

                <!-- 6. Users -->
                <div class="stat-card">
                    <div class="icon-circle bg-success bg-opacity-10 text-success">
                        <i class="bi bi-person"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label" data-i18n="stat_active_users">æ´»è·ƒç”¨æˆ· (ä»Šæ—¥/æ€»è®¡)</div>
                        <div class="stat-value">
                             <span id="metric-users-today">0</span> <span class="text-muted fs-6 fw-normal">/</span> <span id="metric-users-total" class="text-muted fs-6 fw-normal">0</span>
                        </div>
                    </div>
                </div>

                <!-- 7. Messages (Merged) -->
                <div class="stat-card">
                    <div class="icon-circle bg-info bg-opacity-10 text-info">
                        <i class="bi bi-chat-text"></i>
                    </div>
                    <div class="stat-info w-100">
                        <div class="stat-label" data-i18n="stat_messages">æ¶ˆæ¯ç»Ÿè®¡ (æ¥æ”¶/å‘é€)</div>
                        <div class="stat-value">
                            <span id="metric-msgs-total">0</span>
                            <span class="text-muted fs-6 fw-normal">/</span>
                            <span id="metric-sent-total" class="text-muted fs-6 fw-normal">0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-md-8">
                     <!-- Charts Row -->
                     <div class="row g-3 mb-4" id="dash-charts-row">
                        <div class="col-md-4">
                            <div class="card h-100" style="cursor: pointer;" onclick="showSystemDetails('cpu')">
                                <div class="card-header py-2 small fw-bold d-flex justify-content-between align-items-center">
                                    <span data-i18n="chart_cpu_trend">CPU è¶‹åŠ¿</span>
                                    <i class="bi bi-arrows-angle-expand text-muted"></i>
                                </div>
                                <div class="card-body p-2" style="height: 200px; position: relative;">
                                    <canvas id="cpuChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100" style="cursor: pointer;" onclick="showSystemDetails('mem')">
                                <div class="card-header py-2 small fw-bold d-flex justify-content-between align-items-center">
                                    <span data-i18n="chart_mem_trend">å†…å­˜è¶‹åŠ¿</span>
                                    <i class="bi bi-arrows-angle-expand text-muted"></i>
                                </div>
                                <div class="card-body p-2" style="height: 200px; position: relative;">
                                    <canvas id="memChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100" style="cursor: pointer;" onclick="showSystemDetails('msg')">
                                <div class="card-header py-2 small fw-bold d-flex justify-content-between align-items-center">
                                    <span data-i18n="chart_msg_throughput">æ¶ˆæ¯åå (Msg/Min)</span>
                                    <i class="bi bi-arrows-angle-expand text-muted"></i>
                                </div>
                        <div class="card-body p-2" style="height: 200px; position: relative;">
                            <canvas id="msgChart"></canvas>
                        </div>
                            </div>
                        </div>
                     </div>
 
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span data-i18n="top_active_groups">ğŸ† ä»Šæ—¥æ´»è·ƒç¾¤ç»„</span>
                                    <div>
                                        <button class="btn btn-sm btn-link text-decoration-none p-0 me-2" onclick="showAllStats('Group')" data-i18n="more">æ›´å¤š</button>
                                        <span class="badge bg-primary rounded-pill">Top 5</span>
                                    </div>
                                </div>
                                <ul class="list-group list-group-flush" id="top-groups">
                                    <li class="list-group-item text-muted text-center" data-i18n="no_data">æš‚æ— æ•°æ®</li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span data-i18n="top_active_users">ğŸ—£ï¸ ä»Šæ—¥é¾™ç‹</span>
                                    <div>
                                        <button class="btn btn-sm btn-link text-decoration-none p-0 me-2" onclick="showAllStats('User')" data-i18n="more">æ›´å¤š</button>
                                        <span class="badge bg-warning text-dark rounded-pill">Top 5</span>
                                    </div>
                                </div>
                                <ul class="list-group list-group-flush" id="top-users">
                                    <li class="list-group-item text-muted text-center" data-i18n="no_data">æš‚æ— æ•°æ®</li>
                                </ul>
                            </div>
                        </div>
                    </div>
 
                    <div class="card mb-4" id="dash-process-card">
                        <div class="card-header" data-i18n="top_processes">
                            ğŸ”¥ é«˜å ç”¨è¿›ç¨‹ (Top 10)
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped mb-0">
                                <thead>
                                    <tr>
                                        <th data-i18n="col_pid">PID</th>
                                        <th data-i18n="col_process">è¿›ç¨‹å</th>
                                        <th data-i18n="col_cpu">CPU %</th>
                                        <th data-i18n="col_mem">å†…å­˜ (MB)</th>
                                    </tr>
                                </thead>
                                <tbody id="process-list">
                                    <tr><td colspan="4" class="text-center" data-i18n="loading">åŠ è½½ä¸­...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card mb-4" id="dash-actions-card">
                        <div class="card-header" data-i18n="quick_actions">
                            å¿«æ·æ“ä½œ
                        </div>
                        <div class="card-body">
                            <button class="btn btn-outline-primary me-2" onclick="callSystemAction('reload_plugins')">
                                <i class="bi bi-arrow-repeat"></i> <span data-i18n="action_reload_plugins">é‡è½½æ’ä»¶</span>
                            </button>
                            <button class="btn btn-outline-secondary me-2" onclick="callSystemAction('clean_logs')">
                                <i class="bi bi-trash"></i> <span data-i18n="action_clean_logs">æ¸…ç†æ—¥å¿—</span>
                            </button>
                        </div>
                    </div>
                </div>
 
                <div class="col-md-4">
                    <div class="card h-100" id="dash-logs-card" style="background-color: var(--bg-card); border-color: var(--border-color);">
                        <div class="card-header" data-i18n="recent_activity">
                            æœ€è¿‘æ´»åŠ¨
                        </div>
                        <div class="card-body d-flex flex-column">
                            <div id="recent-logs" class="log-box flex-grow-1"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Details View -->
        <div id="tab-view-system-details" class="content-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0"><i class="bi bi-graph-up"></i> <span data-i18n="system_resource_details">ç³»ç»Ÿèµ„æºè¯¦æƒ…</span></h4>
                <div>
                    <div class="btn-group me-2">
                        <button class="btn btn-outline-secondary btn-sm active" onclick="updateDetailTimeRange('1h')" data-i18n="time_1h">1å°æ—¶</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="updateDetailTimeRange('24h')" data-i18n="time_24h">24å°æ—¶</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="updateDetailTimeRange('7d')" data-i18n="time_7d">7å¤©</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="updateDetailTimeRange('30d')" data-i18n="time_30d">30å¤©</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="updateDetailTimeRange('1y')" data-i18n="time_1y">å…¨å¹´</button>
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="showTab('#dashboard')" data-i18n="back_to_dashboard">è¿”å›ä»ªè¡¨ç›˜</button>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <ul class="nav nav-tabs card-header-tabs" id="system-detail-tabs">
                                <li class="nav-item">
                                    <a class="nav-link active" href="#" onclick="switchDetailTab('cpu', event)" data-i18n="tab_cpu_load">CPU & è´Ÿè½½</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#" onclick="switchDetailTab('mem', event)" data-i18n="tab_mem_usage">å†…å­˜ä½¿ç”¨</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#" onclick="switchDetailTab('msg', event)" data-i18n="tab_msg_throughput">æ¶ˆæ¯åå</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#" onclick="switchDetailTab('disk', event)" data-i18n="tab_disk_io">ç£ç›˜ & I/O</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#" onclick="switchDetailTab('net', event)" data-i18n="tab_net_traffic">ç½‘ç»œæµé‡</a>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <!-- Large Chart Container -->
                            <div style="height: 400px; position: relative;">
                                <canvas id="detailChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hardware Info Grid -->
            <div class="row" id="hardware-info-grid">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Groups & Friends Tab -->
        <div id="tab-groups" class="tab-content" style="display: none;">
            <div class="d-flex justify-content-start align-items-center mb-3 gap-2">
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle d-flex align-items-center justify-content-start" type="button" id="global-bot-dropdown" data-bs-toggle="dropdown" aria-expanded="false" style="min-width: 220px;">
                     <i class="bi bi-robot me-2"></i>
                     <span id="global-bot-selected-content" class="text-truncate text-start" style="max-width: 160px;" data-i18n="select_bot_placeholder">é€‰æ‹©æœºå™¨äºº...</span>
                </button>
                <ul class="dropdown-menu shadow-lg" id="global-bot-list" aria-labelledby="global-bot-dropdown" style="max-height: 400px; overflow-y: auto; width: 320px;">
                    <!-- Items populated by JS -->
                </ul>
            </div>
            <input type="hidden" id="global-bot-selector" value="">
            
            <button class="btn btn-primary" onclick="refreshCurrentTabList()" title="åˆ·æ–°åˆ—è¡¨" data-i18n-title="refresh_list">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
    </div>

            <ul class="nav nav-tabs mb-3" id="relation-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="tab-groups-list-tab" data-bs-toggle="tab" data-bs-target="#tab-pane-groups" type="button" role="tab" aria-selected="true" data-i18n="group_list_title">ç¾¤ç»„åˆ—è¡¨</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tab-friends-list-tab" data-bs-toggle="tab" data-bs-target="#tab-pane-friends" type="button" role="tab" aria-selected="false" onclick="ensureFriendListLoaded()" data-i18n="friend_list_title">å¥½å‹åˆ—è¡¨</button>
                </li>
            </ul>
            
            <div class="tab-content" style="height: calc(100vh - 200px);">
                <!-- Groups Pane -->
                <div class="tab-pane fade show active h-100" id="tab-pane-groups" role="tabpanel">
                    <div class="row h-100">
                        <!-- Left: Group List -->
                        <div class="col-md-4 h-100 group-manage-col">
                            <div class="card h-100 d-flex flex-column">
                                <div class="card-header">
                                    <input type="text" class="form-control mb-2" id="group-search" placeholder="æœç´¢ç¾¤ç»„..." data-i18n="search_groups_placeholder" onkeyup="filterGroups()">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted"><span data-i18n="sort_by">æ’åº:</span></small>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-secondary active" onclick="sortGroups('name')" id="btn-sort-group-name" data-i18n="sort_name">åç§°</button>
                                            <button class="btn btn-outline-secondary" onclick="sortGroups('count')" id="btn-sort-group-count" data-i18n="sort_count">äººæ•°</button>
                                            <button class="btn btn-outline-secondary" onclick="sortGroups('msg_today')" id="btn-sort-group-msg_today" data-i18n="sort_today">ä»Šæ—¥</button>
                                            <button class="btn btn-outline-secondary" onclick="sortGroups('id')" id="btn-sort-group-id" data-i18n="sort_id">ID</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body p-0" style="overflow-y: auto;">
                                    <div class="list-group list-group-flush" id="group-list">
                                        <div class="text-center p-4 text-muted" data-i18n="select_bot_first">è¯·å…ˆé€‰æ‹©æœºå™¨äººå¹¶åˆ·æ–°</div>
                                    </div>
                                </div>
                                <div class="card-footer text-muted small" id="group-count">
                                    <span data-i18n="total_groups_count">å…± 0 ä¸ªç¾¤ç»„</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right: Group Details -->
                        <div class="col-md-8 h-100 group-manage-col">
                            <div class="card h-100" id="group-detail-empty">
                                <div class="card-body d-flex align-items-center justify-content-center text-muted">
                                    <div class="text-center">
                                        <i class="bi bi-chat-square-text fs-1"></i>
                                        <p class="mt-2" data-i18n="select_group_to_view">è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªç¾¤ç»„æŸ¥çœ‹è¯¦æƒ…</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card h-100 d-flex flex-column" id="group-detail-content" style="display: none !important;">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <img id="current-group-avatar" src="" class="rounded-circle me-2" style="width: 32px; height: 32px; display: none;">
                                        <div class="d-flex flex-column">
                                            <h5 class="mb-0" id="current-group-name" data-i18n="group_name_default">ç¾¤ç»„åç§°</h5>
                                            <small class="text-muted" id="current-group-stats" style="font-size: 0.75rem;" data-i18n="group_stats_default">ä»Šæ—¥: 0 / æ€»è®¡: 0</small>
                                        </div>
                                    </div>
                                    <span class="badge bg-secondary" id="current-group-id">123456</span>
                                </div>
                                
                                <!-- Chat/Members Area -->
                                <div class="card-body d-flex flex-column p-0" style="overflow: hidden;">
                                    <ul class="nav nav-tabs nav-justified" id="group-tabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="members-tab" data-bs-toggle="tab" data-bs-target="#members-view" type="button" data-i18n="tab_members">æˆå‘˜åˆ—è¡¨</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="actions-tab" data-bs-toggle="tab" data-bs-target="#actions-view" type="button" data-i18n="tab_actions">å¿«æ·æ“ä½œ</button>
                                        </li>
                                    </ul>
                                    
                                    <div class="tab-content flex-grow-1" style="overflow-y: auto;">
                                        <!-- Members View -->
                                        <div class="tab-pane fade show active p-0" id="members-view">
                                            <div class="p-2 border-bottom bg-light">
                                                <input type="text" class="form-control form-control-sm" id="member-search" placeholder="æœç´¢æˆå‘˜(æ˜µç§°/åç‰‡/ID)..." data-i18n="search_members_placeholder" onkeyup="renderMembers()">
                                            </div>
                                            <table class="table table-hover mb-0">
                                                <thead class="table-light sticky-top">
                                                    <tr>
                                                        <th style="cursor: pointer;" onclick="sortMembers('card')"><span data-i18n="col_member_name">æ˜µç§°/ç¾¤åç‰‡</span> <i class="bi bi-sort-alpha-down" id="sort-icon-card"></i></th>
                                                        <th style="cursor: pointer;" onclick="sortMembers('id')"><span data-i18n="col_member_id">QQ/WXID</span> <i class="bi" id="sort-icon-id"></i></th>
                                                        <th style="cursor: pointer;" onclick="sortMembers('role')"><span data-i18n="col_member_role">è§’è‰²</span> <i class="bi" id="sort-icon-role"></i></th>
                                                        <th style="cursor: pointer;" onclick="sortMembers('msg_today')"><span data-i18n="col_member_msg">ä»Šæ—¥/æ€»è®¡ (å…¨ç¾¤)</span> <i class="bi" id="sort-icon-msg_today"></i></th>
                                                        <th style="cursor: pointer;" onclick="sortMembers('time')"><span data-i18n="col_member_last_seen">æœ€åå‘è¨€</span> <i class="bi" id="sort-icon-time"></i></th>
                                                        <th data-i18n="col_action">æ“ä½œ</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="member-list-body">
                                                    <!-- Members here -->
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                        <!-- Actions View -->
                                        <div class="tab-pane fade p-3" id="actions-view">
                                            <div class="mb-3">
                                                <label class="form-label" data-i18n="send_group_msg">å‘é€ç¾¤æ¶ˆæ¯</label>
                                                <textarea class="form-control" id="group-msg-input" rows="4" placeholder="åœ¨æ­¤è¾“å…¥æ¶ˆæ¯å†…å®¹..." data-i18n="enter_msg_placeholder"></textarea>
                                                
                                                <div class="form-check mt-2">
                                                    <input class="form-check-input" type="checkbox" id="auto-recall-check" onchange="toggleAutoRecallInput()">
                                                    <label class="form-check-label" for="auto-recall-check" data-i18n="auto_recall_label">
                                                        å‘é€åè‡ªåŠ¨æ’¤å›
                                                    </label>
                                                </div>
                                                <div class="input-group input-group-sm mt-1 mb-2" id="auto-recall-input-group" style="display: none;">
                                                    <span class="input-group-text" data-i18n="recall_delay_label">å»¶è¿Ÿæ’¤å›(ç§’)</span>
                                                    <input type="number" class="form-control" id="auto-recall-delay" value="0" min="0" max="120" placeholder="0 = ç«‹å³æ’¤å›" data-i18n-placeholder="recall_delay_placeholder">
                                                    <span class="input-group-text text-muted" style="font-size: 0.8em;" data-i18n="recall_limit_hint">é¢‘é“é™120s</span>
                                                </div>

                                                <div class="d-flex gap-2 mt-2">
                                                    <button class="btn btn-primary" onclick="sendGroupMsg()">
                                                        <i class="bi bi-send"></i> <span data-i18n="btn_send">å‘é€</span>
                                                    </button>
                                                    <button class="btn btn-info text-white" onclick="sendSmartGroupMsg()">
                                                        <i class="bi bi-lightning-charge"></i> <span data-i18n="btn_smart_send">æ™ºèƒ½å‘é€ (WakeUp)</span>
                                                    </button>
                                                </div>
                                                <small class="text-muted d-block mt-1">æ™ºèƒ½å‘é€: å½“æœºå™¨äººæ— æ³•ç›´æ¥å›å¤æ—¶(å¦‚é¢‘é“æœºå™¨äººè¿‡æœŸ)ï¼Œä¼šå°è¯•å”¤é†’å…¶ä»–æœºå™¨äººååŠ©ã€‚</small>
                                            </div>
                                            <hr>
                                            <div class="mb-3">
                                                <label class="form-label text-danger" data-i18n="danger_zone">å±é™©æ“ä½œ</label>
                                                <div>
                                                    <button class="btn btn-outline-danger btn-sm" onclick="leaveGroup()" data-i18n="btn_leave_group">é€€å‡ºè¯¥ç¾¤</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Friends Pane -->
                <div class="tab-pane fade h-100" id="tab-pane-friends" role="tabpanel">
                    <div class="row h-100">
                        <!-- Left: Friend List -->
                        <div class="col-md-4 h-100">
                            <div class="card h-100 d-flex flex-column">
                                <div class="card-header bg-white">
                                    <input type="text" class="form-control mb-2" id="friend-search" placeholder="æœç´¢å¥½å‹..." data-i18n="search_friends_placeholder" onkeyup="filterFriends()">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted"><span data-i18n="sort_by">æ’åº:</span></small>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-secondary active" onclick="sortFriends('name')" id="btn-sort-friend-name" data-i18n="sort_name">åç§°</button>
                                            <button class="btn btn-outline-secondary" onclick="sortFriends('id')" id="btn-sort-friend-id" data-i18n="sort_id">ID</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body p-0" style="overflow-y: auto;">
                                    <div class="list-group list-group-flush" id="friend-list">
                                        <div class="text-center p-4 text-muted" data-i18n="select_bot_first">è¯·å…ˆé€‰æ‹©æœºå™¨äººå¹¶åˆ·æ–°</div>
                                    </div>
                                </div>
                                <div class="card-footer text-muted small" id="friend-count">
                                    <span data-i18n="total_friends_count_default">å…± 0 ä¸ªå¥½å‹</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right: Friend Details -->
                        <div class="col-md-8 h-100">
                            <div class="card h-100" id="friend-detail-empty">
                                <div class="card-body d-flex align-items-center justify-content-center text-muted">
                                    <div class="text-center">
                                        <i class="bi bi-person fs-1"></i>
                                        <p class="mt-2" data-i18n="select_friend_to_view">è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªå¥½å‹æŸ¥çœ‹è¯¦æƒ…</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card h-100 d-flex flex-column" id="friend-detail-content" style="display: none !important;">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0" id="current-friend-name" data-i18n="friend_name_default">å¥½å‹åç§°</h5>
                                    <span class="badge bg-secondary" id="current-friend-id">123456</span>
                                </div>
                                
                                <div class="card-body p-3">
                                    <div class="mb-3">
                                        <label class="form-label" data-i18n="send_private_msg">å‘é€ç§èŠæ¶ˆæ¯</label>
                                        <textarea class="form-control" id="friend-msg-input" rows="4" placeholder="åœ¨æ­¤è¾“å…¥æ¶ˆæ¯å†…å®¹..." data-i18n-placeholder="input_message_content"></textarea>
                                        <button class="btn btn-primary mt-2" onclick="sendFriendMsg()">
                                            <i class="bi bi-send"></i> <span data-i18n="send">å‘é€</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bots Tab -->
        <div id="tab-bots" style="display:none;">
            <ul class="nav nav-tabs mb-4">
                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#view-bots">
                        <span data-i18n="tab_access_bots">æ¥å…¥ç«¯ (Bots)</span> <span id="badge-bots" class="badge bg-secondary ms-1">0</span>
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#view-workers" onclick="fetchWorkers()">
                        <span data-i18n="tab_process_workers">å¤„ç†ç«¯ (Workers)</span> <span id="badge-workers" class="badge bg-secondary ms-1">0</span>
                    </button>
                </li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="view-bots">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex gap-2 align-items-center w-100">
                            <input type="text" class="form-control form-control-sm" placeholder="æœç´¢æœºå™¨äºº..." data-i18n-placeholder="search_bots_placeholder" style="width: 200px;" onkeyup="filterBots(this.value)">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" onclick="sortBots('name')" id="btn-sort-bot-name" data-i18n="sort_name">åç§°</button>
                                <button class="btn btn-outline-secondary" onclick="sortBots('id')" id="btn-sort-bot-id" data-i18n="sort_id">ID</button>
                                <button class="btn btn-outline-secondary" onclick="sortBots('platform')" id="btn-sort-bot-platform" data-i18n="sort_protocol">åè®®</button>
                                <button class="btn btn-outline-secondary" onclick="sortBots('count')" id="btn-sort-bot-count" data-i18n="sort_group_count">ç¾¤æ•°</button>
                                <button class="btn btn-outline-secondary" onclick="sortBots('msg')" id="btn-sort-bot-msg" data-i18n="sort_messages">æ¶ˆæ¯</button>
                                <button class="btn btn-outline-secondary" onclick="sortBots('time')" id="btn-sort-bot-time" data-i18n="sort_time">æ—¶é—´</button>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary active" id="btn-bot-view-detail" onclick="setBotViewMode('detail')" title="è¯¦ç»†æ¨¡å¼" data-i18n-title="view_mode_detail"><i class="bi bi-card-text"></i></button>
                                <button class="btn btn-outline-secondary" id="btn-bot-view-compact" onclick="setBotViewMode('compact')" title="ç²¾ç®€æ¨¡å¼" data-i18n-title="view_mode_compact"><i class="bi bi-grid-fill"></i></button>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="fetchBots()" data-i18n="refresh">åˆ·æ–°</button>
                        </div>
                    </div>
                    <div class="row" id="bot-list-container">
                        <!-- Bot Cards -->
                    </div>
                </div>
                
                <div class="tab-pane fade" id="view-workers">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex gap-2 align-items-center w-100">
                            <input type="text" class="form-control form-control-sm" placeholder="æœç´¢Worker..." data-i18n-placeholder="search_workers_placeholder" style="width: 200px;" onkeyup="filterWorkers(this.value)">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" onclick="sortWorkers('addr')" id="btn-sort-worker-addr" data-i18n="sort_address">åœ°å€</button>
                                <button class="btn btn-outline-secondary" onclick="sortWorkers('time')" id="btn-sort-worker-time" data-i18n="sort_time">æ—¶é—´</button>
                                <button class="btn btn-outline-secondary" onclick="sortWorkers('msg')" id="btn-sort-worker-msg" data-i18n="sort_processed">å¤„ç†</button>
                                <button class="btn btn-outline-secondary" onclick="sortWorkers('status')" id="btn-sort-worker-status" data-i18n="sort_status">çŠ¶æ€</button>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary active" id="btn-worker-view-detail" onclick="setWorkerViewMode('detail')" title="è¯¦ç»†æ¨¡å¼" data-i18n-title="view_mode_detail"><i class="bi bi-card-text"></i></button>
                                <button class="btn btn-outline-secondary" id="btn-worker-view-compact" onclick="setWorkerViewMode('compact')" title="ç²¾ç®€æ¨¡å¼" data-i18n-title="view_mode_compact"><i class="bi bi-grid-fill"></i></button>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="fetchWorkers()" data-i18n="refresh">åˆ·æ–°</button>
                        </div>
                    </div>
                    <div class="row" id="worker-list-container">
                        <!-- Worker Cards -->
                    </div>
                </div>
            </div>
        </div>

        <!-- System Monitor (Merged Events & Logs) -->
        <div id="tab-monitor" class="tab-content" style="display:none; height: calc(100vh - 80px);">
            <ul class="nav nav-tabs mb-3" id="monitor-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="monitor-events-tab" data-bs-toggle="tab" data-bs-target="#view-events" type="button" role="tab" data-i18n="monitor_events">å®æ—¶æ¶ˆæ¯</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="monitor-logs-tab" data-bs-toggle="tab" data-bs-target="#view-logs" type="button" role="tab" onclick="fetchLogs()" data-i18n="monitor_logs">ç³»ç»Ÿæ—¥å¿—</button>
                </li>
            </ul>
            
            <div class="tab-content h-100">
                <!-- Real-time Events -->
                <div class="tab-pane fade show active h-100" id="view-events" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0" data-i18n="monitor_events_title">å®æ—¶æ¶ˆæ¯ç›‘æ§</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-danger" onclick="clearEvents()" data-i18n="clear">æ¸…ç©º</button>
                            <div class="form-check form-switch d-inline-block ms-2">
                                <input class="form-check-input" type="checkbox" id="auto-scroll-events" checked>
                                <label class="form-check-label" for="auto-scroll-events" data-i18n="auto_scroll">è‡ªåŠ¨æ»šåŠ¨</label>
                            </div>
                            <span id="ws-status" class="badge bg-secondary ms-2">Disconnected</span>
                        </div>
                    </div>
                    <div class="log-box" id="event-container" style="height: calc(100% - 60px);">
                        <div class="text-muted text-center mt-5" data-i18n="waiting_events_connection">ç­‰å¾…äº‹ä»¶è¿æ¥...</div>
                    </div>
                </div>

                <!-- Logs -->
                <div class="tab-pane fade h-100" id="view-logs" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0" data-i18n="system_logs_title">ç³»ç»Ÿæ—¥å¿—</h5>
                        <div class="d-flex align-items-center">
                            <select class="form-select form-select-sm me-2" id="log-bot-selector" style="width: auto; min-width: 150px;" onchange="fetchLogs()">
                                <option value="">å…¨éƒ¨ (All)</option>
                                <option value="system">BotNexus System</option>
                            </select>
                            <button class="btn btn-sm btn-outline-secondary" onclick="fetchLogs()" data-i18n="refresh">åˆ·æ–°</button>
                            <div class="form-check form-switch d-inline-block ms-2">
                                <input class="form-check-input" type="checkbox" id="auto-refresh-logs" checked>
                                <label class="form-check-label" for="auto-refresh-logs" data-i18n="auto_refresh">è‡ªåŠ¨åˆ·æ–°</label>
                            </div>
                        </div>
                    </div>
                    <div class="log-box" id="log-container" style="height: calc(100% - 60px);">
                        <!-- Logs -->
                    </div>
                </div>
            </div>
        </div>


        <!-- Logs Tab (Full Page) -->
        <div id="tab-logs" class="content-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0" data-i18n="log_center">æ—¥å¿—ä¸­å¿ƒ</h4>
                <div class="d-flex align-items-center">
                    <select class="form-select form-select-sm me-2" id="log-bot-selector-full" style="width: auto; min-width: 200px;" onchange="fetchLogsFull()">
                        <option value="">å…¨éƒ¨ (All)</option>
                        <option value="system">BotNexus System</option>
                    </select>
                    <button class="btn btn-sm btn-outline-secondary" onclick="fetchLogsFull()" data-i18n="refresh">åˆ·æ–°</button>
                    <div class="form-check form-switch d-inline-block ms-3">
                        <input class="form-check-input" type="checkbox" id="auto-refresh-logs-full" checked>
                        <label class="form-check-label" for="auto-refresh-logs-full" data-i18n="auto_refresh">è‡ªåŠ¨åˆ·æ–°</label>
                    </div>
                </div>
            </div>
            
            <div class="card h-100" style="height: calc(100vh - 150px) !important;">
                <div class="card-body p-0 d-flex flex-column h-100">
                    <div class="log-box flex-grow-1" id="log-container-full" style="border: none; border-radius: 0 0 0.75rem 0.75rem;">
                        <!-- Logs -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Debug & Test (Merged) -->
        <div id="tab-debug" style="display:none;">
            <h4 class="mb-4" data-i18n="debug_test_title">è°ƒè¯•æµ‹è¯•</h4>
            
            <ul class="nav nav-tabs mb-3" id="debug-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="debug-visual-tab" data-bs-toggle="tab" data-bs-target="#debug-visual" type="button" role="tab" data-i18n="debug_msg_builder">æ¶ˆæ¯æ„é€ </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="debug-raw-tab" data-bs-toggle="tab" data-bs-target="#debug-raw" type="button" role="tab" data-i18n="debug_api_test">æ¥å£è°ƒè¯•</button>
                </li>
            </ul>

            <div class="tab-content">
                <!-- Visual Sender -->
                <div class="tab-pane fade show active" id="debug-visual" role="tabpanel">
                    <div class="row">
                        <div class="col-md-7">
                            <div class="card mb-3">
                                <div class="card-header" data-i18n="send_message_card_title">å‘é€æ¶ˆæ¯</div>
                                <div class="card-body">
                                    <form id="msg-test-form" onsubmit="return false;">
                                        <div class="mb-3">
                                            <label class="form-label" data-i18n="target_uid_label">ç›®æ ‡ç”¨æˆ·/ç¾¤ç»„ UID</label>
                                            <div class="input-group mb-2">
                                                <select class="form-select" id="mt-group-select" onchange="onTestGroupSelectChange()">
                                                    <option value="" data-i18n="select_group_placeholder">-- é€‰æ‹©ç¾¤ç»„ (æˆ–æ‰‹åŠ¨è¾“å…¥ UID) --</option>
                                                </select>
                                                <button class="btn btn-outline-secondary" type="button" onclick="loadTestGroups()" title="åˆ·æ–°ç¾¤ç»„åˆ—è¡¨"><i class="bi bi-arrow-clockwise"></i></button>
                                            </div>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="mt-target" placeholder="ç¾¤å· (Group ID) æˆ– QQå· (User ID)" data-i18n-placeholder="target_uid_placeholder" oninput="updateCodePreview()">
                                                <button class="btn btn-outline-secondary" type="button" onclick="pasteTargetUid()" data-i18n="paste_selected">ç²˜è´´é€‰ä¸­</button>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label" data-i18n="message_type_label">æ¶ˆæ¯ç±»å‹</label>
                                            <select class="form-select" id="mt-type" onchange="updateMsgForm(); updateCodePreview()">
                                                <option value="text" data-i18n="msg_type_text">æ–‡æœ¬ (Text / CQ Code)</option>
                                                <option value="image" data-i18n="msg_type_image">å›¾ç‰‡ (Image)</option>
                                                <option value="record" data-i18n="msg_type_record">è¯­éŸ³ (Record)</option>
                                                <option value="video" data-i18n="msg_type_video">è§†é¢‘ (Video)</option>
                                                <option value="music" data-i18n="msg_type_music">éŸ³ä¹åˆ†äº« (Music)</option>
                                                <option value="share" data-i18n="msg_type_share">é“¾æ¥åˆ†äº« (Share)</option>
                                                <option value="poke" data-i18n="msg_type_poke">æˆ³ä¸€æˆ³ (Poke)</option>
                                                <option value="json" data-i18n="msg_type_json">JSON å¡ç‰‡</option>
                                                <option value="xml" data-i18n="msg_type_xml">XML å¡ç‰‡</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Text Input -->
                                        <div id="mt-group-text" class="mb-3">
                                            <label class="form-label" data-i18n="message_content_label">å†…å®¹</label>
                                            <textarea class="form-control" id="mt-content" rows="3" placeholder="è¾“å…¥æ–‡æœ¬å†…å®¹..." data-i18n-placeholder="enter_text_content_placeholder" oninput="updateCodePreview()"></textarea>
                                        </div>
                                        
                                        <!-- File/Image Input -->
                                        <div id="mt-group-file" class="mb-3" style="display:none;">
                                            <label class="form-label" id="mt-file-label" data-i18n="file_image_url_label">æ–‡ä»¶/å›¾ç‰‡ URL</label>
                                            <input type="text" class="form-control" id="mt-file-path" placeholder="http://... or file://..." data-i18n-placeholder="file_url_placeholder" oninput="updateCodePreview()">
                                        </div>
        
                                        <!-- Music Input -->
                                <div id="mt-group-music" class="mb-3" style="display:none;">
                                    <label class="form-label" data-i18n="music_share_label">éŸ³ä¹åˆ†äº«</label>
                                    <div class="input-group mb-2">
                                        <span class="input-group-text" data-i18n="platform_label">å¹³å°</span>
                                        <select class="form-select" id="mt-music-type" onchange="updateCodePreview()">
                                            <option value="qq" data-i18n="platform_qq">QQéŸ³ä¹</option>
                                            <option value="163" data-i18n="platform_163">ç½‘æ˜“äº‘éŸ³ä¹</option>
                                            <option value="migu" data-i18n="platform_migu">å’ªå’•éŸ³ä¹</option>
                                        </select>
                                    </div>
                                    <div class="input-group">
                                        <span class="input-group-text" data-i18n="song_id_label">æ­Œæ›²ID</span>
                                        <input type="text" class="form-control" id="mt-music-id" placeholder="ä¾‹å¦‚: 123456" oninput="updateCodePreview()">
                                    </div>
                                </div>
        
                                        <!-- Share Input -->
                                        <div id="mt-group-share" class="mb-3" style="display:none;">
                                            <label class="form-label" data-i18n="link_share_label">é“¾æ¥åˆ†äº«</label>
                                            <input type="text" class="form-control mb-2" id="mt-share-url" placeholder="è·³è½¬ URL" data-i18n-placeholder="redirect_url_placeholder" oninput="updateCodePreview()">
                                            <input type="text" class="form-control mb-2" id="mt-share-title" placeholder="æ ‡é¢˜" data-i18n-placeholder="title_placeholder" oninput="updateCodePreview()">
                                            <input type="text" class="form-control mb-2" id="mt-share-content" placeholder="å†…å®¹æè¿°" data-i18n-placeholder="content_desc_placeholder" oninput="updateCodePreview()">
                                            <input type="text" class="form-control" id="mt-share-image" placeholder="å°é¢å›¾ç‰‡ URL" data-i18n-placeholder="cover_image_url_placeholder" oninput="updateCodePreview()">
                                        </div>
                                        
                                        <!-- JSON/XML Input -->
                                        <div id="mt-group-raw" class="mb-3" style="display:none;">
                                            <label class="form-label" id="mt-raw-label" data-i18n="raw_content_label">å†…å®¹</label>
                                            <textarea class="form-control font-monospace" id="mt-raw-content" rows="5" placeholder='{"app":"com.tencent.miniapp", ...}' oninput="updateCodePreview()"></textarea>
                                        </div>
                                        
                                        <div class="d-grid">
                                            <button class="btn btn-primary" onclick="submitTestMsg()" data-i18n="send_msg">å‘é€æ¶ˆæ¯</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="card mb-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span data-i18n="code_preview_title">ä»£ç é¢„è§ˆ (JSON)</span>
                                    <button class="btn btn-sm btn-outline-secondary py-0" onclick="copyCodePreview()" data-i18n="copy">å¤åˆ¶</button>
                                </div>
                                <div class="card-body bg-light p-0 position-relative">
                                    <pre id="code-preview" class="p-3 mb-0" style="white-space: pre-wrap; font-size: 0.8rem; color: #d63384; max-height: 300px; overflow-y: auto;">{}</pre>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header" data-i18n="send_result_title">å‘é€ç»“æœ</div>
                                <div class="card-body p-3">
                                     <div id="mt-result" class="alert alert-secondary mb-0" role="alert" style="display:none;"></div>
                                </div>
                            </div>
                            <div class="mt-3 text-muted small">
                                <ul>
                                    <li data-i18n="debug_help_1">åœ¨æ­¤é¡µé¢å¯è§†åŒ–çš„æ„é€ æ¶ˆæ¯ï¼Œå¹¶å®æ—¶æŸ¥çœ‹å¯¹åº”çš„ JSON æ•°æ®ç»“æ„ã€‚</li>
                                    <li data-i18n="debug_help_2">æ”¯æŒ OneBot 11 æ ‡å‡†æ¶ˆæ¯ç±»å‹ã€‚</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Raw API -->
                <div class="tab-pane fade" id="debug-raw" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header" data-i18n="send_action_title">å‘é€ Action</div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label" data-i18n="bot_id_label">Bot ID</label>
                                        <input type="text" class="form-control" id="action-bot-id" placeholder="ç•™ç©ºåˆ™éšæœºé€‰æ‹©" data-i18n-placeholder="action_bot_id_placeholder">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label" data-i18n="action_name_label">Action Name</label>
                                        <input type="text" class="form-control" id="action-name" value="send_group_msg">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label" data-i18n="action_params_label">Params (JSON)</label>
                                        <textarea class="form-control font-monospace" id="action-params" rows="5">{"group_id": 123456, "message": "Hello from Go Manager"}</textarea>
                                    </div>
                                    <button class="btn btn-primary" onclick="sendAction()" data-i18n="send_request_btn">å‘é€è¯·æ±‚</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header" data-i18n="response_result_title">å“åº”ç»“æœ</div>
                                <div class="card-body bg-light">
                                    <pre id="action-result" class="mb-0" data-i18n="waiting_request">ç­‰å¾…è¯·æ±‚...</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Settings -->
        <div id="tab-settings" style="display:none;">
            <h4 class="mb-4" data-i18n="settings_title">ç³»ç»Ÿè®¾ç½®</h4>
            
            <div class="row">
                <!-- Common Settings -->
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header" data-i18n="common_settings_title">å¸¸ç”¨è®¾ç½®</div>
                        <div class="card-body">
                            <form>
                                <div class="mb-3">
                                    <label class="form-label" data-i18n="theme_label">ç•Œé¢ä¸»é¢˜</label>
                                    <select class="form-select" onchange="setTheme(this.value)">
                                        <option value="light" data-i18n="theme_light">æµ…è‰² (Light)</option>
                                        <option value="dark" data-i18n="theme_dark">æ·±è‰² (Dark)</option>
                                        <option value="auto" data-i18n="theme_auto">è·Ÿéšç³»ç»Ÿ (Auto)</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" data-i18n="refresh_rate_label">æ•°æ®åˆ·æ–°é¢‘ç‡</label>
                                    <select class="form-select">
                                        <option value="2000" data-i18n="rate_fast">2 ç§’ (å¿«é€Ÿ)</option>
                                        <option value="5000" data-i18n="rate_normal">5 ç§’ (æ­£å¸¸)</option>
                                        <option value="10000" data-i18n="rate_slow">10 ç§’ (çœæµ)</option>
                                    </select>
                                </div>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="setting-notify" checked>
                                    <label class="form-check-label" for="setting-notify" data-i18n="enable_notification_label">å¯ç”¨æ¡Œé¢é€šçŸ¥</label>
                                </div>
                                <button type="button" class="btn btn-primary" data-i18n="save_common_settings_btn">ä¿å­˜å¸¸ç”¨è®¾ç½®</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Personal Preferences -->
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header" data-i18n="personal_settings_title">ä¸ªäººåå¥½è®¾ç½®</div>
                        <div class="card-body">
                             <form>
                                <div class="mb-3">
                                    <label class="form-label" data-i18n="default_home_label">é»˜è®¤é¦–é¡µ</label>
                                    <select class="form-select">
                                        <option value="dashboard" data-i18n="dashboard_label">ä»ªè¡¨ç›˜</option>
                                        <option value="bots" data-i18n="bot_list_label">æœºå™¨äººåˆ—è¡¨</option>
                                        <option value="groups" data-i18n="group_manage_label">ç¾¤ç»„ç®¡ç†</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" data-i18n="items_per_page_label">æ¯é¡µæ˜¾ç¤ºæ¡æ•°</label>
                                    <input type="number" class="form-control" value="20">
                                </div>
                                <hr>
                                <div class="mb-3">
                                    <label class="form-label" data-i18n="change_password_label">ä¿®æ”¹å¯†ç </label>
                                    <input type="password" id="pwd-current" class="form-control mb-2" placeholder="å½“å‰å¯†ç " data-i18n-placeholder="current_pwd_placeholder">
                                    <input type="password" id="pwd-new" class="form-control mb-2" placeholder="æ–°å¯†ç " data-i18n-placeholder="new_pwd_placeholder">
                                    <input type="password" id="pwd-confirm" class="form-control" placeholder="ç¡®è®¤æ–°å¯†ç " data-i18n-placeholder="confirm_pwd_placeholder">
                                </div>
                                <button type="button" class="btn btn-primary" onclick="updatePassword()" data-i18n="save_personal_settings_btn">ä¿å­˜ä¸ªäººè®¾ç½®</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Language Management ---
        let currentLang = 'zh-CN';

        function initLanguage() {
            const savedLang = localStorage.getItem('language') || 'zh-CN';
            setLanguage(savedLang);
        }

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('language', lang);
            
            if (typeof translations === 'undefined') return;

            // Update document title
            if (translations[lang] && translations[lang].app_title) {
                document.title = translations[lang].app_title;
            }

            // Update elements with data-i18n (innerText)
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                     el.innerText = translations[lang][key];
                }
            });

            // Update elements with data-i18n-placeholder
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[lang] && translations[lang][key]) {
                     el.placeholder = translations[lang][key];
                }
            });
            
             // Update elements with data-i18n-title
            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                const key = el.getAttribute('data-i18n-title');
                if (translations[lang] && translations[lang][key]) {
                    el.title = translations[lang][key];
                }
            });
        }

        // --- Theme Management ---
        let themeListener = null;

        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'auto';
            applyTheme(savedTheme);
            
            // Sync with settings dropdown if exists
            const themeSelect = document.querySelector('select[onchange="setTheme(this.value)"]');
            if (themeSelect) themeSelect.value = savedTheme;
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
            const next = current === 'dark' ? 'light' : 'dark';
            applyTheme(next);
        }

        function applyTheme(theme) {
            // Remove existing listener if any
            if (themeListener) {
                window.matchMedia('(prefers-color-scheme: dark)').removeEventListener('change', themeListener);
                themeListener = null;
            }

            if (theme === 'auto') {
                const mq = window.matchMedia('(prefers-color-scheme: dark)');
                
                // Define listener
                themeListener = (e) => {
                     if (e.matches) {
                        document.documentElement.setAttribute('data-theme', 'dark');
                    } else {
                        document.documentElement.removeAttribute('data-theme');
                    }
                    updateThemeIcon();
                };
                
                // Add listener
                mq.addEventListener('change', themeListener);
                
                // Apply current
                themeListener(mq);
                
            } else if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                updateThemeIcon();
            } else {
                document.documentElement.removeAttribute('data-theme');
                updateThemeIcon();
            }
            
            localStorage.setItem('theme', theme);
        }

        function updateThemeIcon() {
            const btn = document.querySelector('.theme-toggle-btn-sidebar i');
            if (btn) {
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                btn.className = isDark ? 'bi bi-sun-fill' : 'bi bi-moon-stars';
            }
        }

        function setTheme(theme) {
            applyTheme(theme);
        }

        async function updatePassword() {
            const oldPwd = document.getElementById('pwd-current').value;
            const newPwd = document.getElementById('pwd-new').value;
            const confirmPwd = document.getElementById('pwd-confirm').value;

            const t = translations[currentLang] || translations['zh-CN'];

            if (!newPwd) return alert(t.enter_new_pwd || 'è¯·è¾“å…¥æ–°å¯†ç ');
            if (newPwd !== confirmPwd) return alert(t.pwd_mismatch || 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
            if (!oldPwd) return alert(t.enter_current_pwd || 'è¯·è¾“å…¥å½“å‰å¯†ç ');

            try {
                const res = await fetch('/api/user/password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ old_password: oldPwd, new_password: newPwd })
                });

                if (!res.ok) {
                    const txt = await res.text();
                    throw new Error(txt);
                }

                alert(t.password_change_success || 'å¯†ç ä¿®æ”¹æˆåŠŸ');
                document.getElementById('pwd-current').value = '';
                document.getElementById('pwd-new').value = '';
                document.getElementById('pwd-confirm').value = '';
            } catch (e) {
                alert((t.password_change_fail || 'ä¿®æ”¹å¤±è´¥: ') + e.message);
            }
        }

        // --- Auth & Login ---
        let authToken = localStorage.getItem('wxbot_token');
        let authRole = localStorage.getItem('wxbot_role');
        let currentBotId = '';

        // Check Auth on Load
        document.addEventListener('DOMContentLoaded', () => {
            initTheme(); // Initialize theme
            initLanguage(); // Initialize language

            // Check for Magic Link
            const urlParams = new URLSearchParams(window.location.search);
            const magicToken = urlParams.get('magic_token');

            if (magicToken) {
                // Attempt Magic Login
                fetch('/api/login/magic', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: magicToken })
                })
                .then(res => {
                    if (!res.ok) throw new Error('Magic login failed');
                    return res.json();
                })
                .then(data => {
                    authToken = data.token;
                    authRole = data.role;
                    localStorage.setItem('wxbot_token', authToken);
                    localStorage.setItem('wxbot_role', authRole);
                    
                    // Clear URL params
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    startApp();
                })
                .catch(err => {
                    console.error(err);
                    const t = translations[currentLang] || translations['zh-CN'];
                    alert(t.magic_login_fail || 'å…å¯†ç ç™»å½•å¤±è´¥ï¼Œé“¾æ¥å¯èƒ½å·²è¿‡æœŸã€‚è¯·é‡æ–°è·å–æˆ–ä½¿ç”¨å¯†ç ç™»å½•ã€‚');
                    // Clean URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                    // Show login
                    const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
                    loginModal.show();
                });
                return;
            }

            if (!authToken) {
                const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
                loginModal.show();
            } else {
                startApp();
            }
        });

        function applyRoleUI(role) {
            const isAdmin = (role === 'super' || role === 'admin');
            
            // Helper to toggle visibility
            const toggle = (id, show) => {
                const el = document.getElementById(id);
                if(el) el.style.display = show ? '' : 'none';
            };

            // Sidebar
            toggle('nav-debug', isAdmin);
            
            // Monitor Tabs
            toggle('monitor-logs-tab', isAdmin);
            
            // Dashboard
            toggle('dash-system-stats', isAdmin); // CPU/Mem cards
            // Charts should be visible to everyone now (with limited/relevant data)
            toggle('dash-charts-row', true); 
            toggle('dash-process-card', isAdmin); // Process List
            toggle('dash-actions-card', isAdmin); // Quick Actions
            toggle('dash-logs-card', isAdmin); // Recent Logs
            
            // If user is not admin and is currently on a hidden tab, switch to dashboard
            if (!isAdmin) {
                const hash = window.location.hash;
                if (hash === '#debug') {
                    showTab('dashboard');
                }
            }
        }

        function startApp() {
            applyRoleUI(authRole);
            
            // Restore tab from hash
            const hash = window.location.hash;
            if (hash) {
                let tabId = hash.substring(1);
                if (document.getElementById('tab-' + tabId)) {
                    const isAdmin = (authRole === 'super' || authRole === 'admin');
                    if (tabId === 'debug' && !isAdmin) {
                        tabId = 'dashboard';
                    }
                    showTab(tabId);
                }
            }

            initWebSocket();
            // Load initial data
            updateStats();
            updateSystemStats();
            fetchBots();
            fetchWorkers();
            updateChatStats();
            
            // Start Timers
            setInterval(updateStats, 2000);
            setInterval(updateSystemStats, 2000);
            setInterval(updateChatStats, 5000);
            setInterval(updateBots, 5000);
            setInterval(fetchWorkers, 5000);
        }

        let lastSystemStats = null;

        async function fetchSystemStats(updateDetails = false) {
            if (!authToken) return;
            try {
                const res = await fetch('/api/system/stats', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!res.ok) throw new Error(res.statusText);
                const data = await res.json();
                lastSystemStats = data;
                window.lastSystemStats = data; // Ensure global access

                // Update Dashboard Cards
                if (document.getElementById('metric-cpu')) {
                    document.getElementById('metric-cpu').innerText = data.cpu_usage.toFixed(1) + '%';
                }

                // OS Info
                if (data.host_info) {
                    // Hardcoded per user request
                    if (document.getElementById('metric-os-plat')) {
                        document.getElementById('metric-os-plat').innerText = 'alpine 3.23.0';
                        document.getElementById('metric-os-plat').title = 'alpine 3.23.0';
                    }
                    if (document.getElementById('metric-os-ver')) {
                         document.getElementById('metric-os-ver').innerText = 'å†…æ ¸: 6.8.0-86-generic';
                    }
                    if (document.getElementById('metric-os-arch')) {
                         document.getElementById('metric-os-arch').innerText = data.host_info.kernelArch;
                    }
                }

                // Process List
                const procBody = document.getElementById('process-list');
                if (procBody && data.processes) {
                    if (data.processes.length === 0) {
                        procBody.innerHTML = '<tr><td colspan="4" class="text-center">æš‚æ— æ•°æ®</td></tr>';
                    } else {
                        procBody.innerHTML = data.processes.map(p => `
                            <tr>
                                <td>${p.pid}</td>
                                <td class="text-truncate" style="max-width: 150px;" title="${p.name}">${p.name}</td>
                                <td>${p.cpu.toFixed(1)}%</td>
                                <td>${(p.memory / 1024 / 1024).toFixed(1)}</td>
                            </tr>
                        `).join('');
                    }
                }
                
                // Update Detail View if active
                if (updateDetails || (document.getElementById('tab-view-system-details') && document.getElementById('tab-view-system-details').style.display !== 'none')) {
                    updateDetailChart(); // This uses lastSystemStats
                }

            } catch (e) {
                console.error("Fetch system stats error:", e);
            }
        }

        function updateSystemStats() {
            fetchSystemStats();
        }

        // Handle Login Submit
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUser').value;
            const password = document.getElementById('loginPass').value;
            const errorBox = document.getElementById('loginError');
            
            errorBox.classList.add('d-none');
            
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password})
                });
                
                if (!res.ok) {
                    throw new Error('ç™»å½•å¤±è´¥ï¼šç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
                }
                
                const data = await res.json();
                authToken = data.token;
                authRole = data.role;
                localStorage.setItem('wxbot_token', authToken);
                localStorage.setItem('wxbot_role', authRole);
                
                applyRoleUI(authRole);

                // Hide Modal
                const loginModalEl = document.getElementById('loginModal');
                const modal = bootstrap.Modal.getInstance(loginModalEl);
                modal.hide();
                
                // Init
                startApp();
                
            } catch (err) {
                errorBox.innerText = err.message;
                errorBox.classList.remove('d-none');
            }
        });

        function logout() {
            localStorage.removeItem('wxbot_token');
            localStorage.removeItem('wxbot_role');
            location.reload();
        }

        // --- Navigation ---
        // Toggle Sidebar for Mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        }

        function showTab(tabId) {
            // Handle #hash
            if (tabId.startsWith('#')) tabId = tabId.substring(1);

            document.querySelectorAll('.main-content > div[id^="tab-"]').forEach(el => el.style.display = 'none');
            document.getElementById('tab-' + tabId).style.display = 'block';
            document.querySelectorAll('.sidebar .nav-link').forEach(el => el.classList.remove('active'));
            const activeLink = document.querySelector(`.sidebar .nav-link[href="#${tabId}"]`);
            if (activeLink) activeLink.classList.add('active');
            
            if (tabId === 'logs') fetchLogsFull();
            if (tabId === 'bots') {
                fetchBots();
                fetchWorkers();
            }
            if (tabId === 'groups') {
                 // If we have a bot selected but no data loaded, try to load
                 // Avoid double-fetch if we are currently switching bots (indicated by "åˆ‡æ¢æœºå™¨äººä¸­" in the list)
                 const listEl = document.getElementById('group-list');
                 if (currentBotId && currentGroups.length === 0 && listEl && !listEl.innerHTML.includes('åˆ‡æ¢æœºå™¨äººä¸­')) {
                     refreshGroupList();
                 }
            }

            // Close sidebar on mobile
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                if (sidebar) sidebar.classList.remove('show');
                if (overlay) overlay.classList.remove('show');
            }

            // Update URL hash
            if (window.location.hash !== '#' + tabId) {
                window.history.replaceState(null, null, '#' + tabId);
            }
        }

        // --- Dashboard & Stats ---
        let memChart = null;
        let cpuChart = null;
        let msgChart = null;
        let lastMsgCount = 0;
        let lastSentCount = 0;
        let msgHistory = [];
        let sentHistory = [];
        let recvHistory = [];
        const MSG_HISTORY_SIZE = 30; // 30 * 2s = 60s
        const MAX_CHART_POINTS = 1800; // 1800 * 2s = 60 minutes

        function initCharts() {
            try {
                // Memory Chart
                const ctxMem = document.getElementById('memChart');
                if (ctxMem) {
                    memChart = new Chart(ctxMem.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Memory Alloc (MB)',
                                data: [],
                                borderColor: '#0d6efd',
                                tension: 0.4,
                                fill: true,
                                backgroundColor: 'rgba(13, 110, 253, 0.1)'
                            }]
                        },
                        options: {
                            responsive: true,
                            animation: false,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { 
                                y: { beginAtZero: true, grid: { display: true, drawBorder: false } },
                                x: { grid: { display: false } }
                            }
                        }
                    });
                }

                // CPU Chart
                const ctxCpu = document.getElementById('cpuChart');
                if (ctxCpu) {
                    cpuChart = new Chart(ctxCpu.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'CPU Usage (%)',
                                data: [],
                                borderColor: '#ffc107',
                                tension: 0.4,
                                fill: true,
                                backgroundColor: 'rgba(255, 193, 7, 0.1)'
                            }]
                        },
                        options: {
                            responsive: true,
                            animation: false,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { 
                                y: { beginAtZero: true, max: 100, grid: { display: true, drawBorder: false } },
                                x: { grid: { display: false } }
                            }
                        }
                    });
                }

                // Message Chart
                const ctxMsg = document.getElementById('msgChart');
                if (ctxMsg) {
                    msgChart = new Chart(ctxMsg.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [
                                {
                                    label: 'æ¥æ”¶',
                                    data: [],
                                    borderColor: '#198754', // Green
                                    tension: 0.4,
                                    fill: false,
                                    borderWidth: 2
                                },
                                {
                                    label: 'å‘é€',
                                    data: [],
                                    borderColor: '#0d6efd', // Blue
                                    tension: 0.4,
                                    fill: false,
                                    borderWidth: 2
                                },
                                {
                                    label: 'æ€»é‡',
                                    data: [],
                                    borderColor: '#6c757d', // Gray
                                    tension: 0.4,
                                    fill: false,
                                    borderDash: [5, 5],
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            animation: false,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            plugins: { 
                                legend: { display: true, position: 'top', labels: { boxWidth: 10, usePointStyle: true } },
                                tooltip: { mode: 'index', intersect: false }
                            },
                            scales: { 
                                y: { beginAtZero: true, grid: { display: true, drawBorder: false } },
                                x: { grid: { display: false } }
                            }
                        }
                    });
                }
            } catch (e) {
                console.error("Chart init error:", e);
            }
        }
        
        initCharts();

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateStats() {
            if (!authToken) return;
            fetch('/api/stats', {
                headers: { 'Authorization': `Bearer ${authToken}` }
            })
                .then(r => r.json())
                .then(data => {
                    window.latestStats = data; // Store globally for details view
                    if (document.getElementById('metric-goroutines')) {
                        document.getElementById('metric-goroutines').innerText = data.goroutines;
                    }
                    if (document.getElementById('metric-mem')) {
                        document.getElementById('metric-mem').innerText = formatBytes(data.memory_alloc);
                    }
                    if (document.getElementById('metric-mem-total') && data.memory_total) {
                        document.getElementById('metric-mem-total').innerText = formatBytes(data.memory_total);
                    }

                    if (document.getElementById('metric-bots')) {
                        document.getElementById('metric-bots').innerText = data.bot_count;
                    }
                    if (document.getElementById('metric-bots-offline')) {
                        document.getElementById('metric-bots-offline').innerText = data.bot_count_offline || 0;
                    }
                    if (document.getElementById('metric-bots-total')) {
                        document.getElementById('metric-bots-total').innerText = data.bot_count_total || 0;
                    }

                    // CPU Details
                    if (document.getElementById('metric-cpu-model') && data.cpu_model) {
                         let model = data.cpu_model;
                         // Keep it reasonably short for the label
                         if (model.length > 25) model = model.substring(0, 25) + '...';
                         document.getElementById('metric-cpu-model').innerText = model;
                         // Set title on the card container (grandparent)
                         const card = document.getElementById('metric-cpu-model').closest('.stat-card');
                         if (card) card.title = data.cpu_model;
                    }
                    if (document.getElementById('metric-cpu-cores')) {
                         document.getElementById('metric-cpu-cores').innerText = (data.cpu_cores_physical || 0) + 'P/' + (data.cpu_cores_logical || 0) + 'L æ ¸';
                    }
                    if (document.getElementById('metric-cpu-freq')) {
                         document.getElementById('metric-cpu-freq').innerText = (data.cpu_freq || 0).toFixed(0) + ' MHz';
                    }

                    // New metrics
                    if (document.getElementById('metric-groups-today')) document.getElementById('metric-groups-today').innerText = data.active_groups_today;
                    if (document.getElementById('metric-groups-total')) document.getElementById('metric-groups-total').innerText = data.active_groups;
                    if (document.getElementById('metric-users-today')) document.getElementById('metric-users-today').innerText = data.active_users_today;
                    if (document.getElementById('metric-users-total')) document.getElementById('metric-users-total').innerText = data.active_users;
                    if (document.getElementById('metric-msgs-total')) document.getElementById('metric-msgs-total').innerText = data.message_count;
                    if (document.getElementById('metric-sent-total')) document.getElementById('metric-sent-total').innerText = data.sent_message_count;

                    const now = new Date().toLocaleTimeString();

                    let justInitialized = false;

                    // --- Init History (Once) ---
                    if (data.cpu_trend && cpuChart && cpuChart.data.labels.length === 0) {
                        data.cpu_trend.forEach(() => cpuChart.data.labels.push(''));
                        cpuChart.data.datasets[0].data = data.cpu_trend;
                        cpuChart.update();
                        justInitialized = true;
                    }
                    if (data.mem_trend && memChart && memChart.data.labels.length === 0) {
                        data.mem_trend.forEach(() => memChart.data.labels.push(''));
                        memChart.data.datasets[0].data = data.mem_trend.map(v => v / 1024 / 1024);
                        memChart.update();
                        justInitialized = true;
                    }
                    if (data.msg_trend && msgChart && msgChart.data.labels.length === 0) {
                        // Load history
                        msgHistory = [...data.msg_trend];
                        sentHistory = data.sent_trend ? [...data.sent_trend] : new Array(msgHistory.length).fill(0);
                        recvHistory = data.recv_trend ? [...data.recv_trend] : new Array(msgHistory.length).fill(0);

                        // Reconstruct chart data (Moving Sum)
                        const chartDataRecv = [];
                        const chartDataSent = [];
                        const chartDataTotal = [];
                        const labels = [];
                        
                        for (let i = 0; i < msgHistory.length; i++) {
                            let start = Math.max(0, i - MSG_HISTORY_SIZE + 1);
                            let sumTotal = 0, sumSent = 0, sumRecv = 0;
                            for (let j = start; j <= i; j++) {
                                sumTotal += msgHistory[j] || 0;
                                sumSent += sentHistory[j] || 0;
                                sumRecv += recvHistory[j] || 0;
                            }
                            chartDataRecv.push(sumRecv);
                            chartDataSent.push(sumSent);
                            chartDataTotal.push(sumTotal);
                            labels.push('');
                        }
                        msgChart.data.labels = labels;
                        msgChart.data.datasets[0].data = chartDataRecv;
                        msgChart.data.datasets[1].data = chartDataSent;
                        msgChart.data.datasets[2].data = chartDataTotal;
                        msgChart.update();
                        
                        // Sync counters
                        lastMsgCount = data.message_count || 0;
                        lastSentCount = data.sent_message_count || 0;
                        justInitialized = true;
                    }

                    // Update Memory Chart
                    if (memChart && !justInitialized) {
                        if (memChart.data.labels.length > MAX_CHART_POINTS) {
                            memChart.data.labels.shift();
                            memChart.data.datasets[0].data.shift();
                        }
                        memChart.data.labels.push(now);
                        memChart.data.datasets[0].data.push(data.memory_alloc / 1024 / 1024);
                        memChart.update();
                    }
                    
                    // Update Message Chart
                    if (msgChart && !justInitialized) {
                        const currentTotal = data.message_count || 0;
                        const currentSent = data.sent_message_count || 0;
                        
                        const diffTotal = currentTotal - lastMsgCount;
                        const diffSent = currentSent - lastSentCount;
                        
                        // Avoid spike on first load
                        const valTotal = lastMsgCount === 0 ? 0 : (diffTotal < 0 ? 0 : diffTotal);
                        const valSent = lastSentCount === 0 ? 0 : (diffSent < 0 ? 0 : diffSent);
                        const valRecv = (valTotal - valSent) < 0 ? 0 : (valTotal - valSent);
                        
                        lastMsgCount = currentTotal;
                        lastSentCount = currentSent;

                        // Add to history
                        msgHistory.push(valTotal);
                        sentHistory.push(valSent);
                        recvHistory.push(valRecv);

                        if (msgHistory.length > MSG_HISTORY_SIZE) msgHistory.shift();
                        if (sentHistory.length > MSG_HISTORY_SIZE) sentHistory.shift();
                        if (recvHistory.length > MSG_HISTORY_SIZE) recvHistory.shift();

                        const rateTotal = msgHistory.reduce((a, b) => a + b, 0);
                        const rateSent = sentHistory.reduce((a, b) => a + b, 0);
                        const rateRecv = recvHistory.reduce((a, b) => a + b, 0);

                        if (msgChart.data.labels.length > MAX_CHART_POINTS) {
                            msgChart.data.labels.shift();
                            msgChart.data.datasets.forEach(d => d.data.shift());
                        }
                        msgChart.data.labels.push(now);
                        msgChart.data.datasets[0].data.push(rateRecv);
                        msgChart.data.datasets[1].data.push(rateSent);
                        msgChart.data.datasets[2].data.push(rateTotal);
                        msgChart.update();
                    }

                    // Update CPU Chart
                    if (cpuChart && !justInitialized) {
                        if (cpuChart.data.labels.length > MAX_CHART_POINTS) {
                            cpuChart.data.labels.shift();
                            cpuChart.data.datasets[0].data.shift();
                        }
                        cpuChart.data.labels.push(now);
                        cpuChart.data.datasets[0].data.push(data.cpu_usage);
                        cpuChart.update();
                    }

                    // Save stats to cache
                    saveStatsToCache({
                        bot_count: data.bot_count,
                        bot_count_offline: data.bot_count_offline || 0,
                        bot_count_total: data.bot_count_total || 0,
                        // Cache other critical stats if needed
                        memory_total: data.memory_total,
                        cpu_model: data.cpu_model,
                        cpu_cores_physical: data.cpu_cores_physical,
                        cpu_cores_logical: data.cpu_cores_logical,
                        cpu_freq: data.cpu_freq
                    });

                })
                .catch(e => console.error("Update stats error:", e));
        }

        // --- Cache Logic ---
        function saveStatsToCache(stats) {
            localStorage.setItem('bot_stats_cache', JSON.stringify(stats));
        }

        function loadStatsFromCache() {
            const cached = localStorage.getItem('bot_stats_cache');
            if (cached) {
                try {
                    const stats = JSON.parse(cached);
                    if (document.getElementById('metric-bots')) {
                        document.getElementById('metric-bots').innerText = stats.bot_count || 0;
                    }
                    if (document.getElementById('metric-bots-offline')) {
                        document.getElementById('metric-bots-offline').innerText = stats.bot_count_offline || 0;
                    }
                    if (document.getElementById('metric-bots-total')) {
                        document.getElementById('metric-bots-total').innerText = stats.bot_count_total || 0;
                    }
                    
                    if (document.getElementById('metric-mem-total') && stats.memory_total) {
                        document.getElementById('metric-mem-total').innerText = formatBytes(stats.memory_total);
                    }

                    // CPU Details Cache
                    if (document.getElementById('metric-cpu-model') && stats.cpu_model) {
                         let model = stats.cpu_model;
                         if (model.length > 25) model = model.substring(0, 25) + '...';
                         document.getElementById('metric-cpu-model').innerText = model;
                         const card = document.getElementById('metric-cpu-model').closest('.stat-card');
                         if (card) card.title = stats.cpu_model;
                    }
                    if (document.getElementById('metric-cpu-cores') && stats.cpu_cores_physical) {
                         document.getElementById('metric-cpu-cores').innerText = (stats.cpu_cores_physical || 0) + 'P/' + (stats.cpu_cores_logical || 0) + 'L æ ¸';
                    }
                    if (document.getElementById('metric-cpu-freq') && stats.cpu_freq) {
                         document.getElementById('metric-cpu-freq').innerText = (stats.cpu_freq || 0).toFixed(0) + ' MHz';
                    }
                } catch (e) {
                    console.error("Failed to load cached stats", e);
                }
            }
        }
        
        // Load cache immediately
        loadStatsFromCache();
        
        // --- Bots & Workers ---
        let currentBots = [];
        let botSortBy = 'name'; // name, id, count, time
        let botSortAsc = true;
        let botFilterText = '';
        let botViewMode = localStorage.getItem('bot_view_mode') || 'detail';

        let currentWorkers = [];
        let workerSortBy = 'addr'; // addr, time, status
        let workerSortAsc = true;
        let workerFilterText = '';
        let workerViewMode = localStorage.getItem('worker_view_mode') || 'detail';

        // Update View Mode UI on Load
        document.addEventListener('DOMContentLoaded', () => {
             updateViewModeUI('bot', botViewMode);
             updateViewModeUI('worker', workerViewMode);
        });

        function setBotViewMode(mode) {
            botViewMode = mode;
            localStorage.setItem('bot_view_mode', mode);
            updateViewModeUI('bot', mode);
            renderBots();
        }

        function setWorkerViewMode(mode) {
            workerViewMode = mode;
            localStorage.setItem('worker_view_mode', mode);
            updateViewModeUI('worker', mode);
            renderWorkers();
        }

        function updateViewModeUI(type, mode) {
            const btnDetail = document.getElementById(`btn-${type}-view-detail`);
            const btnCompact = document.getElementById(`btn-${type}-view-compact`);
            if (btnDetail && btnCompact) {
                if (mode === 'detail') {
                    btnDetail.classList.add('active');
                    btnCompact.classList.remove('active');
                } else {
                    btnDetail.classList.remove('active');
                    btnCompact.classList.add('active');
                }
            }
        }

        function timeAgo(date) {
            const t = translations[currentLang] || translations['zh-CN'];
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + t.time_ago_year;
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + t.time_ago_month;
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + t.time_ago_day;
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + t.time_ago_hour;
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + t.time_ago_minute;
            return Math.floor(seconds) + t.time_ago_second;
        }

        function updateBots() {
            fetchBots();
        }

        function fetchBots() {
            if (!authToken) return;
            const t = translations[currentLang] || translations['zh-CN'];
            fetch('/api/bots', {
                headers: { 'Authorization': `Bearer ${authToken}` }
            })
                .then(r => r.json())
                .then(bots => {
                    currentBots = bots;
                    const onlineCount = bots.filter(b => b.is_alive).length;
                    
                    // Update Badge
                    const badge = document.getElementById('badge-bots');
                    if (badge) badge.innerText = onlineCount + '/' + bots.length;

                    // Update Metrics
                    if (document.getElementById('metric-bots')) {
                        document.getElementById('metric-bots').innerText = onlineCount;
                    }

                    // Update Global Selector (Dropdown)
                    const selectorInput = document.getElementById('global-bot-selector');
                    const dropdownList = document.getElementById('global-bot-list');
                    const currentVal = selectorInput.value;
                    
                    if (bots.length === 0) {
                        dropdownList.innerHTML = `<li><span class="dropdown-item disabled">${t.no_bot_data_simple}</span></li>`;
                        document.getElementById('global-bot-selected-content').innerHTML = t.no_bot_data_simple;
                    } else {
                        dropdownList.innerHTML = bots.map(bot => {
                            const isOffline = !bot.is_alive;
                            const statusClass = isOffline ? 'text-muted' : 'text-success fw-bold';
                            const badge = isOffline ? `<span class="badge bg-secondary ms-auto">${t.bot_status_offline}</span>` : `<span class="badge bg-success ms-auto">${t.bot_status_online}</span>`;
                            const platform = bot.platform || 'QQ';
                            let avatarUrl = `https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/robot.svg`;
                            if (platform === 'QQ') {
                                avatarUrl = `https://q1.qlogo.cn/g?b=qq&nk=${bot.self_id}&s=100`;
                            }
                            
                            return `
                                <li>
                                    <a class="dropdown-item d-flex align-items-center p-2 ${isOffline ? 'disabled' : ''}" href="#" onclick="${isOffline ? 'return false;' : `selectBotFromDropdown('${bot.self_id}')`}">
                                        <div class="rounded-circle d-flex align-items-center justify-content-center me-2 flex-shrink-0" style="width: 32px; height: 32px; overflow: hidden; background: var(--bg-list-item);">
                                            <img src="${avatarUrl}" alt="" style="width: 100%; height: 100%; object-fit: cover;">
                                        </div>
                                        <div class="flex-grow-1 overflow-hidden">
                                            <div class="d-flex align-items-center">
                                                <div class="fw-bold text-truncate ${statusClass}" style="max-width: 120px;">${bot.nickname || bot.self_id}</div>
                                                ${badge}
                                            </div>
                                            <div class="text-muted small">${bot.self_id}</div>
                                        </div>
                                    </a>
                                </li>
                            `;
                        }).join('');
                        
                        // Restore selection or select first online
                        let targetId = currentVal;
                        if (!targetId || !bots.find(b => b.self_id === targetId && b.is_alive)) {
                            const firstOnline = bots.find(b => b.is_alive);
                            if (firstOnline) {
                                targetId = firstOnline.self_id;
                            }
                        }
                        
                        if (targetId) {
                            updateBotSelectorUI(targetId);
                            if (currentBotId !== targetId) {
                                currentBotId = targetId;
                            }
                        }
                    }

                    renderBots();
                    updateLogBotSelector(bots);
                    updateLogBotSelectorFull(bots);
                });
        }

        function updateLogBotSelector(bots) {
             const selector = document.getElementById('log-bot-selector');
             if (!selector) return;
             // Keep selection
             const current = selector.value;
             const t = translations[currentLang] || translations['zh-CN'];
             
             let html = `<option value="">${t.log_all}</option>`;
             html += `<option value="system">${t.log_system}</option>`;
             
             bots.forEach(b => {
                 const name = b.nickname || b.self_id;
                 const status = b.is_alive ? '' : ' (Offline)';
                 html += `<option value="${b.self_id}">${name} (${b.platform})${status}</option>`;
             });
             selector.innerHTML = html;
             selector.value = current;
        }

        function filterBots(text) {
            botFilterText = text.toLowerCase();
            renderBots();
        }

        function sortBots(field) {
            if (botSortBy === field) {
                botSortAsc = !botSortAsc;
            } else {
                botSortBy = field;
                botSortAsc = true;
                if (field === 'count' || field === 'time' || field === 'msg') botSortAsc = false;
            }

            const t = translations[currentLang] || translations['zh-CN'];

            // Update UI
            ['name', 'id', 'platform', 'count', 'time', 'msg'].forEach(f => {
                const btn = document.getElementById(`btn-sort-bot-${f}`);
                if (f === botSortBy) {
                    btn.classList.add('active');
                    let label = '';
                    switch(f) {
                        case 'name': label = t.sort_name; break;
                        case 'id': label = t.sort_id; break;
                        case 'platform': label = t.sort_platform; break;
                        case 'count': label = t.sort_group_count; break;
                        case 'time': label = t.sort_time; break;
                        case 'msg': label = t.sort_msg_count; break;
                    }
                    btn.innerHTML = label + (botSortAsc ? ' â†‘' : ' â†“');
                } else {
                    btn.classList.remove('active');
                    let label = '';
                    switch(f) {
                        case 'name': label = t.sort_name; break;
                        case 'id': label = t.sort_id; break;
                        case 'platform': label = t.sort_platform; break;
                        case 'count': label = t.sort_group_count; break;
                        case 'time': label = t.sort_time; break;
                        case 'msg': label = t.sort_msg_count; break;
                    }
                    btn.innerHTML = label;
                }
            });

            renderBots();
        }

        function renderBots() {
            const container = document.getElementById('bot-list-container');
            let bots = currentBots.filter(b => {
                if (!botFilterText) return true;
                return (b.nickname || '').toLowerCase().includes(botFilterText) || 
                       (b.self_id || '').includes(botFilterText) ||
                       (b.platform || '').toLowerCase().includes(botFilterText);
            });

            // Sort
            bots.sort((a, b) => {
                // Always put online bots first
                if (a.is_alive !== b.is_alive) {
                    return a.is_alive ? -1 : 1;
                }

                let res = 0;
                if (botSortBy === 'name') {
                    res = (a.nickname || '').localeCompare(b.nickname || '', 'zh-CN');
                } else if (botSortBy === 'id') {
                    res = (a.self_id || '').localeCompare(b.self_id || '');
                } else if (botSortBy === 'count') {
                    res = (a.group_count || 0) - (b.group_count || 0);
                } else if (botSortBy === 'time') {
                    res = new Date(a.connected) - new Date(b.connected);
                } else if (botSortBy === 'platform') {
                    res = (a.platform || 'QQ').localeCompare(b.platform || 'QQ', 'zh-CN');
                } else if (botSortBy === 'msg') {
                    res = (a.msg_count || 0) - (b.msg_count || 0);
                }
                
                // Primary sort result
                if (res !== 0) {
                    return botSortAsc ? res : -res;
                }
                
                // Secondary sort: ID (Always Ascending)
                return (a.self_id || '').localeCompare(b.self_id || '');
            });

            const t = translations[currentLang] || translations['zh-CN'];
            if (bots.length === 0) {
                container.innerHTML = `<div class="col-12 text-center text-muted">${t.no_bot_data}</div>`;
            } else {
                container.innerHTML = bots.map(bot => {
                    const connDate = new Date(bot.connected);
                    const timeStr = timeAgo(bot.connected);
                    const isOffline = !bot.is_alive;
                    const cardStyle = isOffline ? 'filter: grayscale(100%); opacity: 0.8;' : '';
                    const statusBadge = isOffline ? `<span class="badge bg-secondary ms-2">${t.bot_status_offline}</span>` : `<span class="badge bg-success ms-2">${t.bot_status_online}</span>`;
                    const timeLabel = isOffline ? t.card_status_offline_since : t.card_status_connected_at;
                    const platform = bot.platform || 'QQ';
                    let avatarUrl = `https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/robot.svg`;
                    if (platform === 'QQ') {
                        avatarUrl = `https://q1.qlogo.cn/g?b=qq&nk=${bot.self_id}&s=640`;
                    }
                    const platformBadge = `<span class="badge bg-info ms-1">${platform}</span>`;

                    if (botViewMode === 'compact') {
                         return `
                        <div class="col-sm-6 col-md-4 col-lg-3 col-xl-2 mb-3">
                            <div class="card p-2 h-100 shadow-sm" style="${cardStyle}">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="rounded-circle d-flex align-items-center justify-content-center me-2 flex-shrink-0" style="width: 32px; height: 32px; overflow: hidden; background: var(--bg-list-item);">
                                        <img src="${avatarUrl}" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/robot.svg';this.style.padding='4px';">
                                    </div>
                                    <div class="overflow-hidden w-100">
                                        <div class="d-flex align-items-center">
                                            <div class="fw-bold text-truncate" title="${bot.nickname || bot.self_id}" style="font-size: 0.85rem;">${bot.nickname || bot.self_id}</div>
                                            ${isOffline ? '<span class="badge bg-secondary ms-1" style="font-size: 0.6em;">OFF</span>' : '<span class="badge bg-success ms-1" style="font-size: 0.6em;">ON</span>'}
                                        </div>
                                        <div class="text-muted text-truncate" style="font-size: 0.7rem;">${platform} | ${bot.self_id}</div>
                                    </div>
                                </div>
                                <div class="rounded p-1 mb-2 flex-grow-1" style="background-color: var(--bg-list-item); font-size: 0.75rem;">
                                     <div class="d-flex justify-content-between">
                                        <span class="text-muted">${t.card_label_groups}: ${bot.group_count || 0}</span>
                                        <span class="text-muted">${t.card_label_friends}: ${bot.friend_count || 0}</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted">${t.card_label_msgs}:</span>
                                        <span class="text-primary fw-bold">${bot.msg_count || 0}</span>
                                    </div>
                                </div>
                                <div class="mt-auto">
                                    <button class="btn btn-sm btn-outline-primary w-100 py-0" style="font-size: 0.75rem;" onclick="setGlobalBot('${bot.self_id}')" ${isOffline ? 'disabled' : ''}>${t.btn_manage}</button>
                                </div>
                            </div>
                        </div>`;
                    }

                    return `
                        <div class="col-sm-6 col-md-4 col-lg-3 col-xl-2 mb-3">
                            <div class="card p-2 h-100 shadow-sm" style="${cardStyle}">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="rounded-circle d-flex align-items-center justify-content-center me-2 flex-shrink-0" style="width: 48px; height: 48px; overflow: hidden; background: var(--bg-list-item);">
                                        <img src="${avatarUrl}" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/robot.svg';this.style.padding='8px';">
                                    </div>
                                    <div class="overflow-hidden w-100">
                                        <div class="d-flex align-items-center">
                                            <div class="fw-bold text-truncate" title="${bot.nickname || bot.self_id}" style="font-size: 0.9rem;">${bot.nickname || bot.self_id}</div>
                                            ${statusBadge}
                                            ${platformBadge}
                                        </div>
                                        <div class="text-muted text-truncate" style="font-size: 0.7rem;">ID: ${bot.self_id}</div>
                                    </div>
                                </div>
                                <div class="rounded p-2 mb-2 flex-grow-1" style="background-color: var(--bg-list-item); font-size: 0.75rem;">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted">${t.card_label_groups}:</span>
                                        <span class="fw-bold text-primary">${bot.group_count || 0}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted">${t.card_label_friends}:</span>
                                        <span class="fw-bold text-success">${bot.friend_count || 0}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted">${t.card_label_msgs}:</span>
                                        <span><span class="fw-bold text-primary">${bot.msg_count || 0}</span> <span class="text-muted" style="font-size: 0.7em;">(${t.sort_today}:${bot.msg_count_today || 0})</span></span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted">${t.card_label_ip}:</span>
                                        <span class="text-truncate" style="max-width: 80px;" title="${bot.remote_addr}">${bot.remote_addr ? bot.remote_addr.split(':')[0] : 'N/A'}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted">${timeLabel}</span>
                                        <span title="${connDate.toLocaleString()}">${timeStr}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted">${t.card_label_protocol}:</span>
                                        <span class="fw-bold text-info">${platform}</span>
                                    </div>
                                    ${bot.owner ? `
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted">${t.card_label_owner}:</span>
                                        <span>${bot.owner}</span>
                                    </div>` : ''}
                                </div>
                                <div class="mt-auto">
                                    <button class="btn btn-sm btn-outline-primary w-100 py-1" style="font-size: 0.8rem;" onclick="setGlobalBot('${bot.self_id}')" ${isOffline ? 'disabled' : ''}>${t.btn_manage}</button>
                                </div>
                            </div>
                        </div>
                    `}).join('');
            }
        }

        function fetchWorkers() {
            if (!authToken) return;
            fetch('/api/workers', {
                headers: { 'Authorization': `Bearer ${authToken}` }
            })
                .then(r => r.json())
                .then(workers => {
                    currentWorkers = workers;
                    
                    // Update Badge
                    const badge = document.getElementById('badge-workers');
                    if (badge) badge.innerText = workers.length;

                    renderWorkers();
                });
        }

        function filterWorkers(text) {
            workerFilterText = text.toLowerCase();
            renderWorkers();
        }

        function sortWorkers(field) {
            if (workerSortBy === field) {
                workerSortAsc = !workerSortAsc;
            } else {
                workerSortBy = field;
                workerSortAsc = true;
                if (field === 'time' || field === 'msg') workerSortAsc = false;
            }

            const t = translations[currentLang] || translations['zh-CN'];

            // Update UI
            ['addr', 'time', 'status', 'msg'].forEach(f => {
                const btn = document.getElementById(`btn-sort-worker-${f}`);
                if (f === workerSortBy) {
                    btn.classList.add('active');
                    let label = '';
                    switch(f) {
                        case 'addr': label = t.sort_address; break;
                        case 'time': label = t.sort_time; break;
                        case 'status': label = t.sort_status; break;
                        case 'msg': label = t.sort_processed; break;
                    }
                    btn.innerHTML = label + (workerSortAsc ? ' â†‘' : ' â†“');
                } else {
                    btn.classList.remove('active');
                    let label = '';
                    switch(f) {
                        case 'addr': label = t.sort_address; break;
                        case 'time': label = t.sort_time; break;
                        case 'status': label = t.sort_status; break;
                        case 'msg': label = t.sort_processed; break;
                    }
                    btn.innerHTML = label;
                }
            });

            renderWorkers();
        }

        function renderWorkers() {
            const container = document.getElementById('worker-list-container');
            let workers = currentWorkers.filter(w => {
                if (!workerFilterText) return true;
                return (w.remote_addr || '').includes(workerFilterText) || 
                       (w.status || '').toLowerCase().includes(workerFilterText);
            });

            // Sort
            workers.sort((a, b) => {
                let res = 0;
                if (workerSortBy === 'addr') {
                    res = (a.remote_addr || '').localeCompare(b.remote_addr || '');
                } else if (workerSortBy === 'time') {
                    res = new Date(a.connected) - new Date(b.connected);
                } else if (workerSortBy === 'status') {
                    res = (a.status || '').localeCompare(b.status || '');
                } else if (workerSortBy === 'msg') {
                    res = (a.handled_count || 0) - (b.handled_count || 0);
                }
                return workerSortAsc ? res : -res;
            });

            const t = translations[currentLang] || translations['zh-CN'];
            if (workers.length === 0) {
                container.innerHTML = `<div class="col-12 text-center text-muted">${t.no_workers}</div>`;
                return;
            }
            container.innerHTML = workers.map(w => {
                const connDate = new Date(w.connected);
                const timeStr = timeAgo(w.connected);
                
                if (workerViewMode === 'compact') {
                    return `
                    <div class="col-sm-6 col-md-4 col-lg-3 col-xl-2 mb-3">
                        <div class="card p-2 h-100 shadow-sm">
                            <div class="d-flex align-items-center mb-2">
                                <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-2 flex-shrink-0" style="width: 32px; height: 32px;">
                                    <i class="bi bi-gear-wide-connected fs-6"></i>
                                </div>
                                <div class="overflow-hidden w-100">
                                    <div class="fw-bold text-truncate" style="font-size: 0.85rem;">${t.worker_node_title}</div>
                                    <div class="text-muted text-truncate" style="font-size: 0.7rem;">${w.remote_addr.split(':')[0]}</div>
                                </div>
                            </div>
                            <div class="bg-light rounded p-1 mb-2 flex-grow-1" style="font-size: 0.75rem;">
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">${t.card_label_status}:</span>
                                    <span class="text-success">${w.status}</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">${t.card_label_processed}:</span>
                                    <span class="text-primary fw-bold">${w.handled_count || 0}</span>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }

                return `
                    <div class="col-sm-6 col-md-4 col-lg-3 col-xl-2 mb-3">
                        <div class="card p-2 h-100 shadow-sm">
                            <div class="d-flex align-items-center mb-2">
                                <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-2 flex-shrink-0" style="width: 36px; height: 36px;">
                                    <i class="bi bi-gear-wide-connected fs-5"></i>
                                </div>
                                <div class="overflow-hidden w-100">
                                    <div class="fw-bold text-truncate" style="font-size: 0.9rem;">${t.worker_node}</div>
                                    <div class="text-muted text-truncate" style="font-size: 0.7rem;">${t.worker_node_title}</div>
                                </div>
                            </div>
                            <div class="bg-light rounded p-2 mb-2 flex-grow-1" style="font-size: 0.75rem;">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">${t.card_label_ip}:</span>
                                    <span class="text-truncate" style="max-width: 80px;" title="${w.remote_addr}">${w.remote_addr.split(':')[0]}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">${t.card_label_connected}:</span>
                                    <span title="${connDate.toLocaleString()}">${timeStr}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted">${t.card_label_status}:</span>
                                    <span class="text-success">${w.status}</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">${t.card_label_processed_msgs}:</span>
                                    <span class="text-primary fw-bold">${w.handled_count || 0}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `}).join('');
        }

        // --- Log Truncation & Interaction ---
        function renderLogMessage(message) {
            const MAX_LEN = 300;
            if (!message || message.length <= MAX_LEN) return message;
            
            // Simple escape to prevent breaking HTML structure
            // We assume message is mostly text. If it contains HTML tags, this simple truncation might break them.
            // For safety, we treat it as text for the truncated part, but we must be careful not to double escape if the original was HTML.
            // Given the existing code uses ${log.message} directly, we assume it's raw text or safe HTML.
            
            const shortMsg = message.substring(0, MAX_LEN) + '...';
            const t = translations[currentLang] || translations['zh-CN'];
            
            return `<span class="log-short" style="cursor:pointer; text-decoration:underline dotted; color: inherit;" onclick="toggleLogExpand(this)" title="${t.log_expand}">${shortMsg}</span>` + 
                   `<span class="log-full" style="display:none; cursor:pointer; color: inherit;" onclick="toggleLogExpand(this)" title="${t.log_collapse}">${message}</span>`;
        }

        function toggleLogExpand(el) {
            const parent = el.parentElement;
            const shortSpan = parent.querySelector('.log-short');
            const fullSpan = parent.querySelector('.log-full');
            
            // Pause refresh when clicked
            const autoRefreshFull = document.getElementById('auto-refresh-logs-full');
            if (autoRefreshFull) autoRefreshFull.checked = false;
            
            const autoRefreshWidget = document.getElementById('auto-refresh-logs');
            if (autoRefreshWidget) autoRefreshWidget.checked = false;

            if (el.classList.contains('log-short')) {
                shortSpan.style.display = 'none';
                fullSpan.style.display = 'inline';
            } else {
                shortSpan.style.display = 'inline';
                fullSpan.style.display = 'none';
            }
        }

        // --- Logs (Full Page) ---
        function fetchLogsFull() {
            if (!authToken) return;
            const selector = document.getElementById('log-bot-selector-full');
            const botId = selector ? selector.value : '';

            fetch(`/api/logs?bot_id=${botId}`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            })
                .then(r => r.json())
                .then(logs => {
                    const container = document.getElementById('log-container-full');
                    if (!container) return;
                    
                    container.innerHTML = logs.map(log => `
                        <div class="log-entry">
                            <span class="log-time">[${log.time}]</span>
                            <span class="log-level-${log.level}">${log.level}</span>: 
                            ${renderLogMessage(log.message)}
                        </div>
                    `).join('');
                    // Scroll to bottom
                    container.scrollTop = container.scrollHeight;
                });
        }
        
        // Sync selectors
        function updateLogBotSelectorFull(bots) {
             const selector = document.getElementById('log-bot-selector-full');
             if (!selector) return;
             // Keep selection
             const current = selector.value;
             const t = translations[currentLang] || translations['zh-CN'];
             
             let html = `<option value="">${t.log_all}</option>`;
             html += `<option value="system">${t.log_system}</option>`;
             
             bots.forEach(b => {
                 const name = b.nickname || b.self_id;
                 const status = b.is_alive ? '' : ' (Offline)';
                 html += `<option value="${b.self_id}">${name} (${b.platform})${status}</option>`;
             });
             selector.innerHTML = html;
             selector.value = current;
        }

        // setInterval(() => {
        //     // Auto refresh full page logs - Disabled to prevent jumping, relying on WebSocket
        //     if (document.getElementById('tab-logs') && 
        //         document.getElementById('tab-logs').style.display !== 'none' && 
        //         document.getElementById('auto-refresh-logs-full').checked) {
        //         fetchLogsFull();
        //     }
        // }, 2000);

        // --- Logs (Widget) ---
        function fetchLogs() {
            if (!authToken) return;
            const selector = document.getElementById('log-bot-selector');
            const botId = selector ? selector.value : '';

            fetch(`/api/logs?bot_id=${botId}`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            })
                .then(r => r.json())
                .then(logs => {
                    const container = document.getElementById('log-container');
                    container.innerHTML = logs.map(log => `
                        <div class="log-entry">
                            <span class="log-time">[${log.time}]</span>
                            <span class="log-level-${log.level}">${log.level}</span>: 
                            ${renderLogMessage(log.message)}
                        </div>
                    `).join('');
                    // Scroll to bottom
                    container.scrollTop = container.scrollHeight;
                });
        }
        setInterval(() => {
            if (document.getElementById('tab-logs').style.display !== 'none' && 
                document.getElementById('auto-refresh-logs').checked) {
                fetchLogs();
            }
        }, 2000);

        // --- Debug/Actions ---
        function sendAction() {
            let botId = document.getElementById('action-bot-id').value;
            if (!botId && currentBotId) {
                botId = currentBotId;
            }
            
            const action = document.getElementById('action-name').value;
            let params = {};
            try {
                params = JSON.parse(document.getElementById('action-params').value);
            } catch (e) {
                alert(translations[currentLang].alert_json_error);
                return;
            }

            fetch('/api/action', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({
                    bot_id: botId,
                    action: action,
                    params: params
                })
            })
            .then(r => r.json())
            .then(res => {
                document.getElementById('action-result').innerText = JSON.stringify(res, null, 2);
            })
            .catch(err => {
                document.getElementById('action-result').innerText = 'Error: ' + err;
            });
        }

        // --- WebSocket Subscriber ---
        let wsSubscriber = null;
        const pendingRequests = new Map(); // echo -> {resolve, reject, timeout}

        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            // Use the same port as the page (external mapped port) instead of hardcoded 3001
            // Because docker maps 3005:3001, we should connect to window.location.port (which is 3005 if accessing via 3005, or whatever nginx sets)
            // But wait, the web dashboard is served on 5000.
            // The user accesses dashboard via 5000.
            // The WS is on 3005 (external) / 3001 (internal).
            // We must explicitly use 3005 for WS connection from browser.
            let wsUrl = `${protocol}//${window.location.hostname}:3005/?role=subscriber`;
            if (authToken) {
                wsUrl += `&token=${encodeURIComponent(authToken)}`;
            }
            
            wsSubscriber = new WebSocket(wsUrl);
            
            wsSubscriber.onopen = () => {
                const t = translations[currentLang] || translations['zh-CN'];
                document.getElementById('ws-status').className = 'badge bg-success ms-2';
                document.getElementById('ws-status').innerText = t.status_connected;
                addEventLog({type: 'system', message: t.ws_connected || 'WebSocket è¿æ¥æˆåŠŸ'});
                
                // Refresh bots when connected
                updateBots();
            };
            
            wsSubscriber.onclose = () => {
                const t = translations[currentLang] || translations['zh-CN'];
                document.getElementById('ws-status').className = 'badge bg-danger ms-2';
                document.getElementById('ws-status').innerText = t.status_disconnected;
                addEventLog({type: 'system', message: t.ws_disconnected_retry || 'WebSocket è¿æ¥æ–­å¼€ï¼Œ3ç§’åé‡è¿...'});
                setTimeout(initWebSocket, 3000);
            };
            
            wsSubscriber.onmessage = (evt) => {
            try {
                const data = JSON.parse(evt.data);
                console.log("WS Recv:", data); // Debug Log

                // Handle API Responses
                    if (data.echo && pendingRequests.has(data.echo)) {
                        const req = pendingRequests.get(data.echo);
                        clearTimeout(req.timeout);
                        pendingRequests.delete(data.echo);
                        req.resolve(data);
                        // Optional: Don't log API responses to event log to reduce noise
                        // return; 
                    }

                    // Auto-refresh bot list on connection/nickname update
                    if (data.echo === 'internal_get_login_info' || 
                        (data.post_type === 'meta_event' && data.meta_event_type === 'lifecycle')) {
                        setTimeout(updateBots, 500); // Wait a bit for state to settle
                    }

                    if (data.post_type === 'log') {
                        // Check filter
                        const selector = document.getElementById('log-bot-selector');
                        const filter = selector ? selector.value : '';
                        const log = data.data;
                        const selfId = data.self_id || '';

                        if (filter === '' || (filter === 'system' && !selfId) || filter === selfId) {
                            const container = document.getElementById('log-container');
                            if (container) {
                                const div = document.createElement('div');
                                div.className = 'log-entry';
                                div.innerHTML = `<span class="log-time">[${log.time}]</span><span class="log-level-${log.level}">${log.level}</span>: ${renderLogMessage(log.message)}`;
                                container.appendChild(div);
                                if (document.getElementById('auto-refresh-logs').checked) {
                                    container.scrollTop = container.scrollHeight;
                                }
                            }
                        }

                        // Full Page Log Update
                        const selectorFull = document.getElementById('log-bot-selector-full');
                        const filterFull = selectorFull ? selectorFull.value : '';
                        if (filterFull === '' || (filterFull === 'system' && !selfId) || filterFull === selfId) {
                            const containerFull = document.getElementById('log-container-full');
                            if (containerFull) {
                                const div = document.createElement('div');
                                div.className = 'log-entry';
                                div.innerHTML = `<span class="log-time">[${log.time}]</span><span class="log-level-${log.level}">${log.level}</span>: ${renderLogMessage(log.message)}`;
                                containerFull.appendChild(div);
                                if (containerFull.children.length > 2000) {
                                    containerFull.removeChild(containerFull.firstChild);
                                }
                                if (document.getElementById('auto-refresh-logs-full').checked) {
                                    containerFull.scrollTop = containerFull.scrollHeight;
                                }
                            }
                        }
                        return;
                    }
                    addEventLog(data);
                } catch (e) {
                    console.error('WS Parse Error', e);
                }
            };
        }

        // --- API Helper ---
        async function callBotApi(action, params = {}) {
            if (!currentBotId) {
                const selector = document.getElementById('global-bot-selector');
                if (selector.value) {
                    currentBotId = selector.value;
                } else {
                    const t = translations[currentLang] || translations['zh-CN'];
                    throw new Error(t.alert_select_bot_first);
                }
            }

            const headers = {
                'Content-Type': 'application/json'
            };
            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }

            const res = await fetch('/api/action', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({
                    bot_id: currentBotId,
                    action: action,
                    params: params
                })
            });
            
            if (res.status === 401) {
                localStorage.removeItem('wxbot_token');
                location.reload();
                throw new Error("Unauthorized");
            }

            const result = await res.json();
            if (result.error) throw new Error(result.error);
            if (!result.echo) return result; 

            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    pendingRequests.delete(result.echo);
                    reject(new Error("Request timed out (30s)"));
                }, 30000);
                
                pendingRequests.set(result.echo, { resolve, reject, timeout });
            });
        }

        // --- Global Bot Selector ---
        function updateBotSelectorUI(id) {
            const selector = document.getElementById('global-bot-selector');
            selector.value = id;
            const t = translations[currentLang] || translations['zh-CN'];
            
            const bot = currentBots.find(b => b.self_id == id);
            if (bot) {
                const platform = bot.platform || 'QQ';
                let avatarUrl = `https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/robot.svg`;
                if (platform === 'QQ') {
                    avatarUrl = `https://q1.qlogo.cn/g?b=qq&nk=${bot.self_id}&s=100`;
                }
                
                const statusBadge = bot.is_alive 
                    ? `<span class="badge bg-success ms-1" style="font-size: 0.6em; vertical-align: middle;">${t.status_online}</span>` 
                    : `<span class="badge bg-secondary ms-1" style="font-size: 0.6em; vertical-align: middle;">${t.status_offline}</span>`;
                
                const html = `
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle d-flex align-items-center justify-content-center me-2 flex-shrink-0" style="width: 28px; height: 28px; overflow: hidden; background: #f0f0f0;">
                            <img src="${avatarUrl}" alt="" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <div class="overflow-hidden text-start">
                            <div class="fw-bold text-truncate" style="font-size: 0.85rem; line-height: 1.2;">
                                ${bot.nickname || bot.self_id}
                                ${statusBadge}
                            </div>
                            <div class="text-muted text-truncate" style="font-size: 0.7rem; line-height: 1;">${bot.self_id}</div>
                        </div>
                    </div>
                `;
                document.getElementById('global-bot-selected-content').innerHTML = html;
            }
        }

        function selectBotFromDropdown(id) {
            updateBotSelectorUI(id);
            onBotChange();
        }

        function onBotChange() {
            currentBotId = document.getElementById('global-bot-selector').value;
            
            const t = translations[currentLang] || translations['zh-CN'];
            const loadingText = `<div class="text-center p-4 text-muted">${t.switching_bot}</div>`;

            // Clear group view
            document.getElementById('group-list').innerHTML = loadingText;
            document.getElementById('group-detail-content').style.setProperty('display', 'none', 'important');
            document.getElementById('group-detail-empty').style.display = 'block';
            
            // Clear friend view
            document.getElementById('friend-list').innerHTML = loadingText;
            document.getElementById('friend-detail-content').style.setProperty('display', 'none', 'important');
            document.getElementById('friend-detail-empty').style.display = 'block';
            
            currentGroups = [];
            currentFriends = [];
            
            // Auto refresh current tab
            setTimeout(refreshCurrentTabList, 500);
        }

        function setGlobalBot(id) {
            selectBotFromDropdown(id);
            showTab('groups'); // Jump to groups tab
        }

        function refreshCurrentTabList() {
             const activeTab = document.querySelector('#relation-tabs .nav-link.active');
             if (activeTab && activeTab.id === 'tab-friends-list-tab') {
                 refreshFriendList();
             } else {
                 refreshGroupList();
             }
        }

        function ensureFriendListLoaded() {
            if (currentFriends.length === 0) {
                refreshFriendList();
            }
        }

        // --- Friend Management ---
        let currentFriends = [];
        let currentFriendId = 0;
        let friendSortBy = 'name'; // name, id
        let friendSortAsc = true;

        async function refreshFriendList() {
            const listEl = document.getElementById('friend-list');
            listEl.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary"></div></div>';
            
            try {
                const response = await fetch('/api/contacts');
                const contacts = await response.json();
                
                // Filter by current Bot and type private
                const friends = contacts.filter(c => c.bot_id === currentBotId && c.type === 'private');
                
                currentFriends = friends;
                renderFriends(friends);
                document.getElementById('friend-count').innerText = `å…± ${friends.length} ä¸ªå¥½å‹`;
            } catch (e) {
                listEl.innerHTML = `<div class="text-center p-4 text-danger">åŠ è½½å¤±è´¥: ${e.message}</div>`;
            }
        }

        function renderFriends(friends = null) {
            if (!friends) friends = currentFriends;
            
            // Filter
            const keyword = document.getElementById('friend-search').value.toLowerCase();
            let filtered = friends.filter(f => {
                const name = (f.name || '').toLowerCase();
                const id = (f.id || '').toString();
                return name.includes(keyword) || id.includes(keyword);
            });
            
            // Sort
            filtered.sort((a, b) => {
                let res = 0;
                if (friendSortBy === 'name') {
                    const nameA = a.name || '';
                    const nameB = b.name || '';
                    res = nameA.localeCompare(nameB, 'zh');
                } else if (friendSortBy === 'id') {
                    res = String(a.id).localeCompare(String(b.id));
                }
                return friendSortAsc ? res : -res;
            });
            
            const listEl = document.getElementById('friend-list');
            if (filtered.length === 0) {
                listEl.innerHTML = '<div class="text-center p-4 text-muted">æœªæ‰¾åˆ°å¥½å‹</div>';
                return;
            }

            listEl.innerHTML = filtered.map(f => {
                const name = f.name || 'Unknown';
                const id = f.id;
                const avatar = `https://q1.qlogo.cn/g?b=qq&nk=${id}&s=100`;
                
                return `
                <button class="list-group-item list-group-item-action ${id == currentFriendId ? 'active' : ''}" onclick="selectFriend('${id}', '${name.replace(/'/g, "\\'")}')">
                    <div class="d-flex w-100 align-items-center">
                         <div class="rounded-circle me-2" style="width: 32px; height: 32px; overflow: hidden; background: #f0f0f0;">
                            <img src="${avatar}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/person.svg'">
                        </div>
                        <div style="overflow: hidden;">
                            <h6 class="mb-0 text-truncate" style="max-width: 150px;">${name}</h6>
                            <small class="${id == currentFriendId ? 'text-light' : 'text-muted'}">${id}</small>
                        </div>
                    </div>
                </button>
                `;
            }).join('');
        }

        function filterFriends() {
            renderFriends();
        }

        function sortFriends(by) {
            if (friendSortBy === by) {
                friendSortAsc = !friendSortAsc;
            } else {
                friendSortBy = by;
                friendSortAsc = true;
            }
            
            // Update buttons
            document.querySelectorAll('[id^="btn-sort-friend-"]').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-sort-friend-${by}`).classList.add('active');
            
            renderFriends();
        }

        function selectFriend(id, name) {
            currentFriendId = id;
            document.getElementById('current-friend-name').innerText = name;
            document.getElementById('current-friend-id').innerText = id;
            
            // Show details
            document.getElementById('friend-detail-empty').style.display = 'none';
            document.getElementById('friend-detail-content').style.setProperty('display', 'flex', 'important');
            
            // Re-render list to highlight active
            renderFriends();
        }

        async function sendFriendMsg() {
            const text = document.getElementById('friend-msg-input').value;
            if (!text.trim()) return;
            
            try {
                await callBotApi('send_private_msg', {
                    user_id: currentFriendId,
                    message: text
                });
                alert('å‘é€æˆåŠŸ');
                document.getElementById('friend-msg-input').value = '';
                addEventLog({type: 'message', message: `å‘é€ç»™å¥½å‹(${currentFriendId}): ${text}`});
            } catch (e) {
                alert('å‘é€å¤±è´¥: ' + e.message);
            }
        }

        // --- System Details View Logic ---
        let detailChartInstance = null;
        let detailData = {
            cpu: [],
            mem: [],
            msg: [],
            disk: [],
            net: []
        };
        let currentDetailType = 'cpu';
        let currentDetailTimeRange = '1h';

        function showSystemDetails(type) {
            showTab('#view-system-details');
            currentDetailType = type || 'cpu';
            
            // Set active tab
            document.querySelectorAll('#system-detail-tabs .nav-link').forEach(el => el.classList.remove('active'));
            document.querySelector(`#system-detail-tabs .nav-link[onclick*="'${currentDetailType}'"]`).classList.add('active');

            updateDetailChart();
            fetchSystemStats(true); // Fetch immediately with details
        }

        function switchDetailTab(type, event) {
            if (event) event.preventDefault();
            currentDetailType = type;
            
            document.querySelectorAll('#system-detail-tabs .nav-link').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');

            updateDetailChart();
        }

        function updateDetailTimeRange(range) {
            currentDetailTimeRange = range;
            document.querySelectorAll('#tab-view-system-details .btn-group .btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`#tab-view-system-details .btn-group .btn[onclick*="'${range}'"]`).classList.add('active');
            
            // For now, we only have session data, so we can't really change the data source yet,
            // but we can adjust the chart X-axis scaling or label if we had timestamps.
            // Since we only have "last 1800 points (1 hour)", we will just show what we have.
            // In a real implementation, we would fetch historical data here.
            
            updateDetailChart();
        }

        function updateDetailChart() {
            const ctx = document.getElementById('detailChart').getContext('2d');
            
            if (detailChartInstance) {
                detailChartInstance.destroy();
            }

            // Fix: Retrieve data from global stats (server trend) or fallback to charts
            let cpuDataBuffer = [];
            let memDataBuffer = [];
            let recvDataBuffer = [];
            let sentDataBuffer = [];
            let msgDataBuffer = [];
            let sourceIsRaw = false;

            if (window.latestStats) {
                cpuDataBuffer = window.latestStats.cpu_trend || [];
                memDataBuffer = window.latestStats.mem_trend || [];
                // Msg trends in latestStats are raw counts per interval
                msgDataBuffer = window.latestStats.msg_trend || [];
                sentDataBuffer = window.latestStats.sent_trend || [];
                recvDataBuffer = window.latestStats.recv_trend || [];
                sourceIsRaw = true;
            } else {
                cpuDataBuffer = cpuChart ? cpuChart.data.datasets[0].data : [];
                memDataBuffer = memChart ? memChart.data.datasets[0].data : [];
                recvDataBuffer = msgChart ? msgChart.data.datasets[0].data : [];
                sentDataBuffer = msgChart ? msgChart.data.datasets[1].data : [];
                msgDataBuffer = msgChart ? msgChart.data.datasets[2].data : [];
            }

            let labels = [];
            let datasets = [];
            let type = 'line';
            let options = {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                plugins: {
                    legend: { display: true },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    x: { display: true, grid: { display: false } },
                    y: { display: true, beginAtZero: true }
                }
            };

            // Common Labels (Just index for now, should be time)
            // We use global stats buffers
            
            if (currentDetailType === 'cpu') {
                labels = Array.from({length: cpuDataBuffer.length}, (_, i) => i);
                datasets = [{
                    label: 'CPU Usage (%)',
                    data: cpuDataBuffer,
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    fill: true,
                    tension: 0.4
                }];
                options.scales.y.max = 100;
            } else if (currentDetailType === 'mem') {
                labels = Array.from({length: memDataBuffer.length}, (_, i) => i);
                // Convert to GB
                // If sourceIsRaw (from server), unit is Bytes -> /1024/1024/1024
                // If from Chart (memChart), unit is MB -> /1024
                const dataGB = memDataBuffer.map(v => sourceIsRaw ? (v / 1024 / 1024 / 1024) : (v / 1024));
                datasets = [{
                    label: 'Memory Usage (GB)',
                    data: dataGB,
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    fill: true,
                    tension: 0.4
                }];
            } else if (currentDetailType === 'msg') {
                labels = Array.from({length: msgDataBuffer.length}, (_, i) => i);
                datasets = [
                    {
                        label: 'Total Messages',
                        data: msgDataBuffer,
                        borderColor: '#198754',
                        backgroundColor: 'rgba(25, 135, 84, 0.1)',
                        fill: true
                    },
                    {
                        label: 'Sent Messages',
                        data: sentDataBuffer,
                        borderColor: '#0dcaf0',
                        borderDash: [5, 5],
                        fill: false
                    },
                    {
                        label: 'Recv Messages',
                        data: recvDataBuffer,
                        borderColor: '#ffc107',
                        borderDash: [2, 2],
                        fill: false
                    }
                ];
            } else if (currentDetailType === 'disk') {
                type = 'bar';
                // Disk data comes from latest stats fetch, not trend
                // We need to store it globally or fetch it.
                // For now, use global `lastSystemStats` if available
                if (window.lastSystemStats && window.lastSystemStats.disk_usage) {
                    labels = window.lastSystemStats.disk_usage.map(d => d.path);
                    const dataUsed = window.lastSystemStats.disk_usage.map(d => (d.used / 1024 / 1024 / 1024).toFixed(2));
                    const dataFree = window.lastSystemStats.disk_usage.map(d => (d.free / 1024 / 1024 / 1024).toFixed(2));
                    
                    datasets = [
                        {
                            label: 'Used (GB)',
                            data: dataUsed,
                            backgroundColor: '#dc3545'
                        },
                        {
                            label: 'Free (GB)',
                            data: dataFree,
                            backgroundColor: '#198754'
                        }
                    ];
                    options.scales.x = { stacked: true };
                    options.scales.y = { stacked: true, beginAtZero: true };
                } else {
                    labels = ['Loading...'];
                    datasets = [{label: 'No Data', data: []}];
                }
            } else if (currentDetailType === 'net') {
                 // Net IO - currently we don't have trend for Net IO in backend
                 // We can show current cumulative counters
                 if (window.lastSystemStats && window.lastSystemStats.net_io && window.lastSystemStats.net_io.length > 0) {
                     type = 'bar';
                     const io = window.lastSystemStats.net_io[0];
                     labels = ['Total Sent', 'Total Recv'];
                     datasets = [{
                         label: 'Bytes (MB)',
                         data: [
                             (io.bytesSent / 1024 / 1024).toFixed(2), 
                             (io.bytesRecv / 1024 / 1024).toFixed(2)
                         ],
                         backgroundColor: ['#0dcaf0', '#ffc107']
                     }];
                 } else {
                    labels = ['Loading...'];
                    datasets = [{label: 'No Data', data: []}];
                 }
            }

            detailChartInstance = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: options
            });
            
            // Render Hardware Info Grid
            renderHardwareGrid();
        }

        function renderHardwareGrid() {
            const container = document.getElementById('hardware-info-grid');
            if (!window.lastSystemStats) return;
            
            const s = window.lastSystemStats;
            let html = '';
            
            // Host Info
            if (s.host_info) {
                 html += `
                    <div class="col-12 mb-3">
                        <div class="card h-100">
                            <div class="card-header fw-bold">ä¸»æœºä¿¡æ¯</div>
                            <div class="card-body small">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div><span class="text-muted">Hostname:</span> ${s.host_info.hostname}</div>
                                        <div><span class="text-muted">OS:</span> ${s.host_info.platform} ${s.host_info.platformVersion}</div>
                                        <div><span class="text-muted">Kernel:</span> ${s.host_info.kernelVersion}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <div><span class="text-muted">Arch:</span> ${s.host_info.kernelArch}</div>
                                        <div><span class="text-muted">Uptime:</span> ${(s.host_info.uptime / 3600).toFixed(1)} Hours</div>
                                        <div><span class="text-muted">Boot Time:</span> ${new Date(s.host_info.bootTime * 1000).toLocaleString()}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }
            
            // Disk Info
            if (s.disk_usage) {
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header fw-bold">ç£ç›˜ä½¿ç”¨</div>
                            <div class="card-body small" style="overflow-y: auto; max-height: 200px;">
                                ${s.disk_usage.map(d => `
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between">
                                            <span>${d.path}</span>
                                            <span>${d.usedPercent.toFixed(1)}%</span>
                                        </div>
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar bg-${d.usedPercent > 90 ? 'danger' : (d.usedPercent > 70 ? 'warning' : 'success')}" 
                                                 role="progressbar" style="width: ${d.usedPercent}%"></div>
                                        </div>
                                        <div class="text-muted" style="font-size: 0.8em;">
                                            ${(d.used/1024/1024/1024).toFixed(1)} GB / ${(d.total/1024/1024/1024).toFixed(1)} GB
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>`;
            }
            
            // Net Info
            if (s.net_interfaces) {
                 html += `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header fw-bold">ç½‘ç»œæ¥å£</div>
                            <div class="card-body small" style="overflow-y: auto; max-height: 200px;">
                                ${s.net_interfaces.map(i => `
                                    <div class="mb-2 border-bottom pb-1">
                                        <div class="fw-bold text-primary">${i.name}</div>
                                        ${i.addrs.map(a => `<div>${a.addr}</div>`).join('')}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>`;
            }
            
            container.innerHTML = html;
        }

        // --- Group Management ---
        let currentGroups = [];
        let currentGroupId = 0;
        let groupSortBy = 'name'; // name, count, id
        let groupSortAsc = true;

        let currentMembers = [];
        let memberSortBy = 'card'; // card, id, role, time
        let memberSortAsc = true;

        async function refreshGroupList() {
            const listEl = document.getElementById('group-list');
            listEl.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary"></div></div>';
            
            try {
                // Fetch from new contacts API
                const response = await fetch('/api/contacts');
                const contacts = await response.json();
                
                // Filter by current Bot
                const filtered = contacts.filter(c => c.bot_id === currentBotId);
                
                currentGroups = filtered;
                renderGroups(filtered);
                document.getElementById('group-count').innerText = `å…± ${filtered.length} ä¸ªä¼šè¯`;
            } catch (e) {
                listEl.innerHTML = `<div class="text-center p-4 text-danger">è·å–å¤±è´¥: ${e.message}</div>`;
            }
        }

        function sortGroups(field) {
            if (groupSortBy === field) {
                groupSortAsc = !groupSortAsc;
            } else {
                groupSortBy = field;
                groupSortAsc = true; // Default asc for new field
                if (field === 'count' || field === 'msg_today') groupSortAsc = false; // Default desc for count/msg
            }
            
            const t = translations[currentLang] || translations['zh-CN'];

            // Update UI buttons
            ['name', 'count', 'id', 'msg_today'].forEach(f => {
                const btn = document.getElementById(`btn-sort-group-${f}`);
                if (f === groupSortBy) {
                    btn.classList.add('active');
                    let label = '';
                    switch(f) {
                        case 'name': label = t.sort_name; break;
                        case 'count': label = t.sort_count; break;
                        case 'id': label = t.sort_id; break;
                        case 'msg_today': label = t.sort_today; break;
                    }
                    btn.innerHTML = label + (groupSortAsc ? ' â†‘' : ' â†“');
                } else {
                    btn.classList.remove('active');
                    let label = '';
                    switch(f) {
                        case 'name': label = t.sort_name; break;
                        case 'count': label = t.sort_count; break;
                        case 'id': label = t.sort_id; break;
                        case 'msg_today': label = t.sort_today; break;
                    }
                    btn.innerHTML = label;
                }
            });

            filterGroups(); // Re-render with sort
        }

        function renderGroups(groups) {
            const listEl = document.getElementById('group-list');
            const t = translations[currentLang] || translations['zh-CN'];
            if (groups.length === 0) {
                listEl.innerHTML = `<div class="text-center p-4 text-muted">${t.no_groups}</div>`;
                return;
            }

            // Sort logic
            const sortedGroups = [...groups].sort((a, b) => {
                let res = 0;
                if (groupSortBy === 'name') {
                    res = a.name.localeCompare(b.name, 'zh-CN');
                } else if (groupSortBy === 'count') {
                    res = 0; // Not available in session
                } else if (groupSortBy === 'id') {
                    res = String(a.id).localeCompare(String(b.id));
                } else if (groupSortBy === 'msg_today') {
                    const statA = latestChatStats.group_stats_today ? (latestChatStats.group_stats_today[a.id] || 0) : 0;
                    const statB = latestChatStats.group_stats_today ? (latestChatStats.group_stats_today[b.id] || 0) : 0;
                    res = statA - statB;
                }
                return groupSortAsc ? res : -res;
            });
            
            listEl.innerHTML = sortedGroups.map(g => {
                const todayMsg = latestChatStats.group_stats_today ? (latestChatStats.group_stats_today[g.id] || 0) : 0;
                const totalMsg = latestChatStats.group_stats ? (latestChatStats.group_stats[g.id] || 0) : 0;
                
                let typeBadge = '<span class="badge bg-secondary" style="font-size: 0.6rem;">ç¾¤</span>';
                if (g.type === 'private') {
                    typeBadge = '<span class="badge bg-success" style="font-size: 0.6rem;">ç§</span>';
                } else if (g.type === 'guild') {
                    typeBadge = '<span class="badge bg-info" style="font-size: 0.6rem;">é¢‘</span>';
                }

                // Avatar URL logic
                let avatarUrl = '';
                if (g.type === 'group') {
                    avatarUrl = `https://p.qlogo.cn/gh/${g.id}/${g.id}/640/`;
                } else if (g.type === 'private') {
                    avatarUrl = `https://q1.qlogo.cn/g?b=qq&nk=${g.id}&s=100`;
                } else {
                    avatarUrl = 'https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/diagram-3.svg';
                }

                return `
                <button class="list-group-item list-group-item-action ${g.id == currentGroupId ? 'active' : ''}" onclick="selectGroup('${g.id}', '${g.name.replace(/'/g, "\\'")}', '${g.type}', '${g.guild_id || ''}')">
                    <div class="d-flex w-100 align-items-center">
                        <div class="rounded-circle me-2 flex-shrink-0" style="width: 40px; height: 40px; overflow: hidden; background: #f0f0f0;">
                             <img src="${avatarUrl}" alt="${g.type}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/${g.type === 'private' ? 'person' : 'people'}.svg';this.style.padding='8px';">
                        </div>
                        <div class="flex-grow-1 overflow-hidden">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1 text-truncate" style="max-width: 140px;">${g.name}</h6>
                                <div>
                                    ${typeBadge}
                                </div>
                            </div>
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <small class="${g.id == currentGroupId ? 'text-light' : 'text-muted'}">ID: ${g.id}</small>
                                <span class="badge ${g.id == currentGroupId ? 'bg-light text-dark' : 'bg-secondary'} rounded-pill" title="ä»Šæ—¥: ${todayMsg} / æ€»è®¡: ${totalMsg}">${todayMsg}</span>
                            </div>
                        </div>
                    </div>
                </button>
            `}).join('');
        }

        function filterGroups() {
            const keyword = document.getElementById('group-search').value.toLowerCase();
            const filtered = currentGroups.filter(g => 
                g.name.toLowerCase().includes(keyword) || 
                String(g.id).includes(keyword)
            );
            renderGroups(filtered);
        }

        let currentContactType = 'group';
        let currentGuildId = '';

        async function selectGroup(id, name, type = 'group', guildId = '') {
            currentGroupId = id;
            currentContactType = type;
            currentGuildId = guildId;

            document.getElementById('current-group-name').innerText = name;
            document.getElementById('current-group-id').innerText = id;
            
            // Update Stats
            const todayMsg = latestChatStats.group_stats_today ? (latestChatStats.group_stats_today[id] || 0) : 0;
            const totalMsg = latestChatStats.group_stats ? (latestChatStats.group_stats[id] || 0) : 0;
            document.getElementById('current-group-stats').innerText = `ä»Šæ—¥: ${todayMsg} / æ€»è®¡: ${totalMsg}`;

            // Update Avatar
            const avatarEl = document.getElementById('current-group-avatar');
            if (type === 'group') {
                avatarEl.src = `https://p.qlogo.cn/gh/${id}/${id}/640/`;
            } else if (type === 'private') {
                avatarEl.src = `https://q1.qlogo.cn/g?b=qq&nk=${id}&s=100`;
            } else {
                 avatarEl.src = 'https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/diagram-3.svg';
            }
            avatarEl.style.display = 'block';
            avatarEl.onerror = function() {
                this.src = 'https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/people.svg';
                this.style.padding = '4px';
            };
            
            document.getElementById('group-detail-empty').style.display = 'none';
            document.getElementById('group-detail-content').style.setProperty('display', 'flex', 'important');
            
            // Highlight selection
            renderGroups(currentGroups.filter(g => {
                const keyword = document.getElementById('group-search').value.toLowerCase();
                return g.name.toLowerCase().includes(keyword) || String(g.id).includes(keyword);
            }));

            // Handle View switching
            const membersTabBtn = document.getElementById('members-tab');
            const actionsTabBtn = document.getElementById('actions-tab');
            
            if (type === 'group') {
                membersTabBtn.style.display = 'block';
                // Switch to members tab if not already active or if we just hid it previously
                const bsTab = new bootstrap.Tab(membersTabBtn);
                bsTab.show();
                loadGroupMembers(id);
            } else {
                membersTabBtn.style.display = 'none';
                // Switch to actions tab
                const bsTab = new bootstrap.Tab(actionsTabBtn);
                bsTab.show();
            }
        }

        async function loadGroupMembers(groupId) {
            const tbody = document.getElementById('member-list-body');
            tbody.innerHTML = '<tr><td colspan="4" class="text-center">åŠ è½½ä¸­...</td></tr>';
            
            try {
                const response = await callBotApi('get_group_member_list', { group_id: groupId });
                currentMembers = response.data || [];
                renderMembers();
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">åŠ è½½å¤±è´¥: ${e.message}</td></tr>`;
            }
        }

        function sortMembers(field) {
            if (memberSortBy === field) {
                memberSortAsc = !memberSortAsc;
            } else {
                memberSortBy = field;
                memberSortAsc = true;
                if (field === 'time' || field === 'msg_today') memberSortAsc = false; // Default desc for time/msg
            }

            // Update Icons
            ['card', 'id', 'role', 'time', 'msg_today'].forEach(f => {
                const icon = document.getElementById(`sort-icon-${f}`);
                if (f === memberSortBy) {
                    icon.className = memberSortAsc ? 'bi bi-sort-alpha-down' : 'bi bi-sort-alpha-down-alt';
                    if (f === 'id' || f === 'time' || f === 'msg_today') icon.className = memberSortAsc ? 'bi bi-sort-numeric-down' : 'bi bi-sort-numeric-down-alt';
                } else {
                    icon.className = 'bi';
                }
            });

            renderMembers();
        }

        function renderMembers() {
            const tbody = document.getElementById('member-list-body');
            const searchInput = document.getElementById('member-search');
            const keyword = searchInput ? searchInput.value.toLowerCase() : '';
            const t = translations[currentLang] || translations['zh-CN'];

            if (!currentMembers || currentMembers.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center">${t.no_members}</td></tr>`;
                return;
            }

            // Filter
            const filteredMembers = currentMembers.filter(m => {
                if (!keyword) return true;
                const card = (m.card || '').toLowerCase();
                const nick = (m.nickname || '').toLowerCase();
                const uid = String(m.user_id);
                return card.includes(keyword) || nick.includes(keyword) || uid.includes(keyword);
            });
            
            if (filteredMembers.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="6" class="text-center">${t.no_match_members}</td></tr>`;
                 return;
            }

            // Sort
            const sortedMembers = [...filteredMembers].sort((a, b) => {
                let res = 0;
                if (memberSortBy === 'card') {
                    const nameA = a.card || a.nickname || '';
                    const nameB = b.card || b.nickname || '';
                    res = nameA.localeCompare(nameB, 'zh-CN');
                } else if (memberSortBy === 'id') {
                    res = a.user_id - b.user_id;
                } else if (memberSortBy === 'role') {
                    const roleWeight = { 'owner': 3, 'admin': 2, 'member': 1 };
                    res = (roleWeight[a.role] || 0) - (roleWeight[b.role] || 0);
                } else if (memberSortBy === 'time') {
                    res = (a.last_sent_time || 0) - (b.last_sent_time || 0);
                } else if (memberSortBy === 'msg_today') {
                    const statA = latestChatStats.user_stats_today ? (latestChatStats.user_stats_today[a.user_id] || 0) : 0;
                    const statB = latestChatStats.user_stats_today ? (latestChatStats.user_stats_today[b.user_id] || 0) : 0;
                    res = statA - statB;
                }
                return memberSortAsc ? res : -res;
            });

            tbody.innerHTML = sortedMembers.map(m => {
                const todayMsg = latestChatStats.user_stats_today ? (latestChatStats.user_stats_today[m.user_id] || 0) : 0;
                const totalMsg = latestChatStats.user_stats ? (latestChatStats.user_stats[m.user_id] || 0) : 0;
                
                const roleKey = 'role_' + m.role;
                const roleText = t[roleKey] || m.role;
                const statsTooltip = t.stats_title_tooltip.replace('{today}', todayMsg).replace('{total}', totalMsg);

                return `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <img src="https://q1.qlogo.cn/g?b=qq&nk=${m.user_id}&s=100" 
                                 class="rounded-circle me-2" 
                                 width="32" height="32" 
                                 onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(m.card || m.nickname)}&background=random'"
                                 alt="Avatar">
                            <div>
                                <div>${m.card || m.nickname}</div>
                                ${m.card && m.card !== m.nickname ? `<small class="text-muted">${m.nickname}</small>` : ''}
                            </div>
                        </div>
                    </td>
                    <td>${m.user_id}</td>
                    <td>
                        <span class="badge bg-${m.role === 'owner' ? 'warning' : (m.role === 'admin' ? 'success' : 'secondary')}">
                            ${roleText}
                        </span>
                    </td>
                    <td>
                        <div class="d-flex flex-column" title="${statsTooltip}">
                            <span class="badge bg-primary rounded-pill mb-1" style="width: fit-content;">${todayMsg}</span>
                            <small class="text-muted">${t.stats_total}${totalMsg}</small>
                        </div>
                    </td>
                    <td>
                        <small class="text-muted">${m.last_sent_time ? new Date(m.last_sent_time * 1000).toLocaleString() : '-'}</small>
                    </td>
                    <td>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                ${t.action_ops}
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="setCard(${currentGroupId}, ${m.user_id}, '${m.card || m.nickname}')">${t.action_set_card}</a></li>
                                <li><a class="dropdown-item" href="#" onclick="banMember(${currentGroupId}, ${m.user_id})">${t.action_ban}</a></li>
                                <li><a class="dropdown-item" href="#" onclick="unbanMember(${currentGroupId}, ${m.user_id})">${t.action_unban}</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="kickMember(${currentGroupId}, ${m.user_id})">${t.action_kick}</a></li>
                            </ul>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        // --- Member Actions ---
        function banMember(groupId, userId) {
            const t = translations[currentLang] || translations['zh-CN'];
            const duration = prompt(t.prompt_ban_duration, "30");
            if (duration === null) return;
            const minutes = parseInt(duration);
            if (isNaN(minutes)) {
                alert(t.alert_invalid_number);
                return;
            }

            callBotApi('set_group_ban', {
                group_id: groupId,
                user_id: userId,
                duration: minutes * 60
            }).then(() => {
                alert(minutes > 0 ? t.alert_banned : t.alert_unbanned);
            }).catch(e => alert(t.alert_op_failed + e.message));
        }

        function unbanMember(groupId, userId) {
            const t = translations[currentLang] || translations['zh-CN'];
            callBotApi('set_group_ban', {
                group_id: groupId,
                user_id: userId,
                duration: 0
            }).then(() => {
                alert(t.alert_unbanned);
            }).catch(e => alert(t.alert_op_failed + e.message));
        }

        function setCard(groupId, userId, currentCard) {
            const t = translations[currentLang] || translations['zh-CN'];
            const newCard = prompt(t.prompt_new_card, currentCard);
            if (newCard === null) return;

            callBotApi('set_group_card', {
                group_id: groupId,
                user_id: userId,
                card: newCard
            }).then(() => {
                alert(t.alert_card_set);
                loadGroupMembers(groupId); // Reload to show change
            }).catch(e => alert(t.alert_op_failed + e.message));
        }

        function toggleAutoRecallInput() {
            const checked = document.getElementById('auto-recall-check').checked;
            document.getElementById('auto-recall-input-group').style.display = checked ? 'flex' : 'none';
        }

        async function sendGroupMsg() {
            const t = translations[currentLang] || translations['zh-CN'];
            const input = document.getElementById('group-msg-input');
            const msg = input.value.trim();
            if (!msg) return;
            
            // Auto Recall Params
            let autoRecall = 0;
            if (document.getElementById('auto-recall-check').checked) {
                const delayStr = document.getElementById('auto-recall-delay').value;
                autoRecall = parseInt(delayStr);
                if (isNaN(autoRecall) || autoRecall < 0) autoRecall = 0;
            }

            try {
                let action = 'send_group_msg';
                let params = {
                    message: msg
                };

                if (currentContactType === 'group') {
                    action = 'send_group_msg';
                    params.group_id = currentGroupId;
                } else if (currentContactType === 'private') {
                    action = 'send_private_msg';
                    params.user_id = currentGroupId;
                } else if (currentContactType === 'guild') {
                    action = 'send_msg';
                    params.message_type = 'guild';
                    params.channel_id = currentGroupId;
                    params.guild_id = currentGuildId;
                }

                // Inject auto_recall into the request wrapper, not params (unless the API design changed, but usually it's top level for the manager)
                // Wait, callBotApi wraps params. 
                // We need to pass auto_recall to the manager.
                // callBotApi implementation:
                /*
                function callBotApi(action, params) {
                    return fetch('/api/action', {
                        body: JSON.stringify({
                            bot_id: currentBotId,
                            action: action,
                            params: params
                        })
                    })
                }
                */
                // The manager expects auto_recall at the top level of the JSON body.
                // callBotApi currently only supports bot_id, action, params.
                // We need to modify callBotApi or manually call fetch here.
                
                // Let's manually call fetch here to support auto_recall without changing callBotApi signature for everyone
                const body = {
                    bot_id: currentBotId,
                    action: action,
                    params: params,
                    auto_recall: autoRecall
                };

                const res = await fetch('/api/action', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(body)
                });
                
                const result = await res.json();
                if (result.error) throw new Error(result.error);

                alert(t.alert_send_success);
                input.value = '';
                addEventLog({type: 'system', message: `å‘é€æ¶ˆæ¯åˆ° [${currentGroupId}]: ${msg}`});
            } catch (e) {
                alert(t.alert_op_failed + e.message);
            }
        }

        async function sendSmartGroupMsg() {
            if (!currentGroupId || !currentBotId) return;
            const content = document.getElementById('group-msg-input').value.trim();
            if (!content) return;
            
            // Auto Recall Params
            let autoRecall = 0;
            if (document.getElementById('auto-recall-check').checked) {
                const delayStr = document.getElementById('auto-recall-delay').value;
                autoRecall = parseInt(delayStr);
                if (isNaN(autoRecall) || autoRecall < 0) autoRecall = 0;
            }
            
            // UI Feedback
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> å‘é€ä¸­...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/smart_action', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + authToken
                    },
                    body: JSON.stringify({
                        action: 'send_group_msg',
                        params: {
                            group_id: currentGroupId,
                            message: content
                        },
                        self_id: currentBotId,
                        auto_recall: autoRecall
                    })
                });

                if (!res.ok) {
                    throw new Error('è¯·æ±‚å¤±è´¥');
                }

                const data = await res.json();
                alert('æ™ºèƒ½å‘é€è¯·æ±‚å·²æäº¤: ' + (data.detail || 'Success'));
                document.getElementById('group-msg-input').value = '';
            } catch (e) {
                alert('æ™ºèƒ½å‘é€å¤±è´¥: ' + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        function kickMember(groupId, userId) {
            const t = translations[currentLang] || translations['zh-CN'];
            if (!confirm(t.confirm_kick_member.replace('{id}', userId))) return;
            callBotApi('set_group_kick', {
                group_id: groupId,
                user_id: userId
            }).then(() => {
                alert(t.alert_kicked);
                loadGroupMembers(groupId);
            }).catch(e => alert(t.alert_op_failed + e.message));
        }
        
        function leaveGroup() {
            const t = translations[currentLang] || translations['zh-CN'];
            if (!confirm(t.confirm_leave_group.replace('{id}', currentGroupId))) return;
             callBotApi('set_group_leave', {
                group_id: currentGroupId
            }).then(() => {
                alert(t.alert_left_group);
                refreshGroupList();
                document.getElementById('group-detail-empty').style.display = 'block';
                document.getElementById('group-detail-content').style.setProperty('display', 'none', 'important');
            }).catch(e => alert(t.alert_op_failed + e.message));
        }

        // --- System Actions ---
        async function callSystemAction(action) {
            const t = translations[currentLang] || translations['zh-CN'];
            if (action === 'clean_logs') {
                document.getElementById('recent-logs').innerHTML = '';
                addEventLog({type: 'system', message: t.log_cleaned});
                return;
            }
            
            try {
                const res = await callBotApi(action);
                alert(t.alert_op_success + JSON.stringify(res.data));
            } catch (e) {
                alert(t.alert_op_failed + e.message);
            }
        }

        function addEventLog(data) {
            const container = document.getElementById('event-container');
            if (container.children.length === 1 && container.children[0].classList.contains('text-muted')) {
                container.innerHTML = '';
            }
            
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.style.borderBottom = '1px solid var(--border-color)';
            div.style.padding = '8px 0';
            
            const time = new Date().toLocaleTimeString();
            
            // Format Content
            let content = '';
            if (data.type === 'system') {
                content = `<span class="text-info">[SYSTEM]</span> ${data.message}`;
            } else if (data.post_type === 'message' || data.post_type === 'message_sent') {
                const sender = data.sender ? (data.sender.nickname || data.sender.card || data.user_id) : data.user_id;
                const group = data.group_id ? `[ç¾¤:${data.group_id}] ` : '[ç§èŠ] ';
                let msg = data.message;
                if (typeof msg !== 'string') {
                    msg = JSON.stringify(msg);
                }
                content = `<span class="text-success">[MSG]</span> ${group}<span class="fw-bold text-warning">${sender}</span>: ${msg}`;
            } else if (data.post_type === 'meta_event') {
                if (data.meta_event_type === 'heartbeat') return; // Ignore heartbeat
                content = `<span class="text-secondary">[META]</span> ${data.meta_event_type}`;
            } else {
                content = `<span class="text-muted">[EVENT]</span> <pre class="d-inline m-0" style="font-size:0.8em">${JSON.stringify(data)}</pre>`;
            }
            
            div.innerHTML = `<span class="log-time">${time}</span> ${content}`;
            
            if (container) {
                container.appendChild(div);
                
                // Limit entries
                if (container.children.length > 200) {
                    container.removeChild(container.firstChild);
                }
                
                if (document.getElementById('auto-scroll-events') && document.getElementById('auto-scroll-events').checked) {
                    container.scrollTop = container.scrollHeight;
                }
            }

            // Update Dashboard Recent Logs
            const dashLog = document.getElementById('recent-logs');
            if (dashLog) {
                const clone = div.cloneNode(true);
                dashLog.appendChild(clone);
                if (dashLog.children.length > 50) {
                    dashLog.removeChild(dashLog.firstChild);
                }
                dashLog.scrollTop = dashLog.scrollHeight;
            }
        }

        function clearEvents() {
            document.getElementById('event-container').innerHTML = '<div class="text-muted text-center mt-5">ç­‰å¾…äº‹ä»¶è¿æ¥...</div>';
        }

        // --- Periodic Updates ---
        // Moved to startApp()
        
        let latestChatStats = {
            group_stats: {},
            user_stats: {},
            group_names: {},
            user_names: {}
        };

        function updateChatStats() {
            if (!authToken) return;
            fetch('/api/stats/chat', {
                headers: { 'Authorization': `Bearer ${authToken}` }
            })
                .then(r => r.json())
                .then(data => {
                    latestChatStats = data;
                    // Fix: Use Today's stats for the dashboard top lists
                    renderTopList('top-groups', data.group_stats_today, data.group_names, 'Group');
                    renderTopList('top-users', data.user_stats_today, data.user_names, 'User');
                    
                    // Refresh lists if visible
                    const activeTab = document.querySelector('.nav-link.active').getAttribute('href');
                    if (activeTab === '#groups') {
                        // Only re-render if we have data to render, to avoid flickering or resetting scroll too often
                        // But since sorting might depend on stats, we should probably re-render.
                        // To be less intrusive, maybe only update if we are not dragging/selecting?
                        // For now, let's just re-render.
                        if (currentGroups && currentGroups.length > 0) {
                             renderGroups(currentGroups);
                        }
                        if (currentMembers && currentMembers.length > 0) {
                             renderMembers();
                        }
                    }
                })
                .catch(e => console.error("Update chat stats error:", e));
        }

        function getDisplayName(id, names, type) {
             if (names && names[id]) return names[id];
             if (type === 'Group') {
                 // Try to find in currentGroups loaded from bot
                 const g = currentGroups.find(x => x.group_id == id);
                 if (g) return g.group_name;
             }
             return `${type} ${id}`;
        }

        function renderTopList(elementId, stats, names, type) {
            const list = document.getElementById(elementId);
            if (!stats || Object.keys(stats).length === 0) {
                list.innerHTML = '<li class="list-group-item text-muted text-center">æš‚æ— æ•°æ®</li>';
                return;
            }

            const sorted = Object.entries(stats)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5);

            list.innerHTML = sorted.map(([id, count], index) => {
                const name = getDisplayName(id, names, type);
                // Optional: Fetch avatar if User or Group
                let avatar = '';
                if (type === 'User') {
                     avatar = `<img src="https://q1.qlogo.cn/g?b=qq&nk=${id}&s=100" class="rounded-circle me-2" width="20" height="20" onerror="this.style.display='none'">`;
                } else if (type === 'Group') {
                     avatar = `<img src="https://p.qlogo.cn/gh/${id}/${id}/100/" class="rounded-circle me-2" width="20" height="20" onerror="this.style.display='none'">`;
                }

                return `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div class="text-truncate" style="max-width: 70%;">
                            <span class="badge bg-light text-dark me-2">#${index + 1}</span>
                            ${avatar}
                            <span title="${id}">
                                ${name}
                                ${names && names[id] ? `<small class="text-muted ms-1" style="font-size:0.8em">(${id})</small>` : ''}
                            </span>
                        </div>
                        <span class="badge bg-primary rounded-pill">${count}</span>
                    </li>
                `;
            }).join('');
        }

        function showAllStats(type) {
            // Fix: Use Today's stats to match Dashboard
            const stats = type === 'Group' ? latestChatStats.group_stats_today : latestChatStats.user_stats_today;
            const names = type === 'Group' ? latestChatStats.group_names : latestChatStats.user_names;
            
            const t = translations[currentLang] || translations['zh-CN'];
            document.getElementById('statsModalTitle').innerText = type === 'Group' ? (t.top_active_groups || 'ä»Šæ—¥æ´»è·ƒç¾¤ç»„') : (t.top_active_users || 'ä»Šæ—¥é¾™ç‹');
            document.getElementById('statsModalNameHeader').innerText = type === 'Group' ? (t.group_name_default || 'ç¾¤ç»„åç§°') : (t.user_nickname || 'ç”¨æˆ·æ˜µç§°');
            
            const tbody = document.getElementById('statsModalBody');
            if (!stats || Object.keys(stats).length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="text-center p-4">${t.no_data || 'æš‚æ— æ•°æ®'}</td></tr>`;
            } else {
                const sorted = Object.entries(stats).sort(([, a], [, b]) => b - a);
                tbody.innerHTML = sorted.map(([id, count], index) => {
                    const name = getDisplayName(id, names, type);
                    let avatar = '';
                    if (type === 'User') {
                         avatar = `<img src="https://q1.qlogo.cn/g?b=qq&nk=${id}&s=100" class="rounded-circle me-2 border" width="32" height="32" onerror="this.src='https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/person-circle.svg'">`;
                    } else {
                         avatar = `<img src="https://p.qlogo.cn/gh/${id}/${id}/100/" class="rounded-circle me-2 border" width="32" height="32" onerror="this.src='https://cdn.staticfile.org/bootstrap-icons/1.8.1/icons/people-fill.svg'">`;
                    }
                    
                    return `
                        <tr>
                            <td class="align-middle">${index + 1}</td>
                            <td class="text-truncate align-middle" style="max-width: 300px;" title="${id}">
                                <div class="d-flex align-items-center">
                                    ${avatar}
                                    <div class="overflow-hidden">
                                        <div class="text-truncate">${name}</div>
                                        <div class="text-muted small" style="font-size: 0.75rem;">${id}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="text-end align-middle fw-bold text-primary">${count}</td>
                        </tr>
                    `;
                }).join('');
            }
            
            new bootstrap.Modal(document.getElementById('statsModal')).show();
        }
        // --- Message Test ---
        async function loadTestGroups() {
            const select = document.getElementById('mt-group-select');
            select.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
            
            try {
                const response = await callBotApi('get_group_list');
                const groups = response.data || [];
                
                // Sort by name
                groups.sort((a, b) => a.group_name.localeCompare(b.group_name, 'zh-CN'));
                
                let html = '<option value="">-- é€‰æ‹©ç¾¤ç»„ (æˆ–æ‰‹åŠ¨è¾“å…¥ UID) --</option>';
                groups.forEach(g => {
                    html += `<option value="${g.group_id}">[${g.group_id}] ${g.group_name}</option>`;
                });
                select.innerHTML = html;
            } catch (e) {
                select.innerHTML = '<option value="">åŠ è½½å¤±è´¥: ' + e.message + '</option>';
            }
        }

        function onTestGroupSelectChange() {
            const select = document.getElementById('mt-group-select');
            const targetInput = document.getElementById('mt-target');
            if (select.value) {
                targetInput.value = select.value;
            }
        }
        
        function pasteTargetUid() {
            const select = document.getElementById('mt-group-select');
            if (select.value) {
                document.getElementById('mt-target').value = select.value;
            }
        }

        function updateMsgForm() {
            const t = translations[currentLang] || translations['zh-CN'];
            const type = document.getElementById('mt-type').value;
            
            // Hide all specific inputs
            document.getElementById('mt-group-text').style.display = 'none';
            document.getElementById('mt-group-file').style.display = 'none';
            document.getElementById('mt-group-music').style.display = 'none';
            document.getElementById('mt-group-share').style.display = 'none';
            document.getElementById('mt-group-raw').style.display = 'none';
            
            if (type === 'text' || type === 'poke') {
                document.getElementById('mt-group-text').style.display = 'block';
                document.getElementById('mt-content').placeholder = type === 'poke' ? t.placeholder_poke : t.placeholder_text_cq;
            } else if (type === 'image' || type === 'record' || type === 'video') {
                document.getElementById('mt-group-file').style.display = 'block';
                let label = t.label_file_url;
                if (type === 'image') label = t.label_image_url;
                else if (type === 'record') label = t.label_record_url;
                else if (type === 'video') label = t.label_video_url;
                document.getElementById('mt-file-label').textContent = label;
            } else if (type === 'music') {
                document.getElementById('mt-group-music').style.display = 'block';
            } else if (type === 'share') {
                document.getElementById('mt-group-share').style.display = 'block';
            } else if (type === 'json' || type === 'xml') {
                document.getElementById('mt-group-raw').style.display = 'block';
                document.getElementById('mt-raw-label').textContent = type.toUpperCase() + t.label_raw_content_suffix;
            }
        }

        async function submitTestMsg() {
            const t = translations[currentLang] || translations['zh-CN'];
            const resultEl = document.getElementById('mt-result');
            resultEl.style.display = 'none';
            resultEl.className = 'alert alert-secondary';
            resultEl.textContent = t.msg_sending;
            resultEl.style.display = 'block';
            
            const target = document.getElementById('mt-target').value;
            const type = document.getElementById('mt-type').value;
            
            if (!target) {
                resultEl.className = 'alert alert-danger';
                resultEl.textContent = t.alert_enter_target_uid;
                return;
            }

            // Default to group message
            let action = 'send_group_msg';
            let params = {
                group_id: parseInt(target)
            };
            
            // Construct Message
            if (type === 'text') {
                const content = document.getElementById('mt-content').value;
                if (!content) {
                    resultEl.className = 'alert alert-danger';
                    resultEl.textContent = t.alert_enter_content;
                    return;
                }
                params.message = content;
            } else if (type === 'poke') {
                const qq = document.getElementById('mt-content').value;
                params.message = `[CQ:poke,qq=${qq || ''}]`;
            } else if (type === 'image' || type === 'record' || type === 'video') {
                const file = document.getElementById('mt-file-path').value;
                if (!file) {
                    resultEl.className = 'alert alert-danger';
                    resultEl.textContent = t.alert_enter_file_url;
                    return;
                }
                params.message = [
                    {
                        type: type,
                        data: { file: file }
                    }
                ];
            } else if (type === 'music') {
                const mType = document.getElementById('mt-music-type').value;
                const mId = document.getElementById('mt-music-id').value;
                if (!mId) {
                    resultEl.className = 'alert alert-danger';
                    resultEl.textContent = t.msg_input_song_id;
                    return;
                }
                params.message = [{
                    type: 'music',
                    data: {
                        type: mType,
                        id: mId
                    }
                }];
            } else if (type === 'share') {
                params.message = [{
                    type: 'share',
                    data: {
                        url: document.getElementById('mt-share-url').value,
                        title: document.getElementById('mt-share-title').value,
                        content: document.getElementById('mt-share-content').value,
                        image: document.getElementById('mt-share-image').value
                    }
                }];
            } else if (type === 'json' || type === 'xml') {
                const raw = document.getElementById('mt-raw-content').value;
                if (!raw) {
                    resultEl.className = 'alert alert-danger';
                    resultEl.textContent = t.msg_input_content;
                    return;
                }
                params.message = [{
                    type: type,
                    data: {
                        data: raw
                    }
                }];
            }

            try {
                const res = await callBotApi(action, params);
                resultEl.className = 'alert alert-success';
                resultEl.textContent = 'å‘é€æˆåŠŸ! MSG ID: ' + (res.data ? res.data.message_id : 'Unknown');
            } catch (e) {
                resultEl.className = 'alert alert-danger';
                resultEl.textContent = 'å‘é€å¤±è´¥: ' + e.message;
            }
        }

        function updateCodePreview() {
            const target = document.getElementById('mt-target').value;
            const type = document.getElementById('mt-type').value;
            let params = {
                group_id: target ? parseInt(target) : 0
            };
            
            if (type === 'text') {
                params.message = document.getElementById('mt-content').value;
            } else if (type === 'poke') {
                const qq = document.getElementById('mt-content').value;
                params.message = `[CQ:poke,qq=${qq || ''}]`;
            } else if (type === 'image' || type === 'record' || type === 'video') {
                params.message = [{
                    type: type,
                    data: { file: document.getElementById('mt-file-path').value }
                }];
            } else if (type === 'music') {
                params.message = [{
                    type: 'music',
                    data: {
                        type: document.getElementById('mt-music-type').value,
                        id: document.getElementById('mt-music-id').value
                    }
                }];
            } else if (type === 'share') {
                params.message = [{
                    type: 'share',
                    data: {
                        url: document.getElementById('mt-share-url').value,
                        title: document.getElementById('mt-share-title').value,
                        content: document.getElementById('mt-share-content').value,
                        image: document.getElementById('mt-share-image').value
                    }
                }];
            } else if (type === 'json' || type === 'xml') {
                const raw = document.getElementById('mt-raw-content').value;
                params.message = [{
                    type: type,
                    data: { data: raw }
                }];
            }

            const preview = {
                action: 'send_group_msg',
                params: params
            };
            
            document.getElementById('code-preview').textContent = JSON.stringify(preview, null, 2);
        }

        function copyCodePreview() {
            const t = translations[currentLang] || translations['zh-CN'];
            const content = document.getElementById('code-preview').textContent;
            navigator.clipboard.writeText(content).then(() => {
                const btn = document.querySelector('button[onclick="copyCodePreview()"]');
                if(btn) {
                    const original = btn.textContent;
                    btn.textContent = t.btn_copied;
                    setTimeout(() => btn.textContent = original, 2000);
                }
            });
        }

        // --- Log Selection Auto-Pause ---
        function checkLogSelectionAndPause() {
            const selection = window.getSelection();
            if (!selection || selection.toString().length === 0) return;

            // Check if selection intersects with log containers
            // We use commonAncestorContainer to check if the selection is inside the log container
            let node = selection.anchorNode;
            if (!node) return;
            if (node.nodeType === 3) node = node.parentNode; // text node -> element

            const container = document.getElementById('log-container');
            const containerFull = document.getElementById('log-container-full');
            
            // Check if the selection is within either container
            if ((container && container.contains(node)) || 
                (containerFull && containerFull.contains(node))) {
                 
                 const autoRefreshFull = document.getElementById('auto-refresh-logs-full');
                 if (autoRefreshFull && autoRefreshFull.checked) {
                     autoRefreshFull.checked = false;
                 }
                 
                 const autoRefreshWidget = document.getElementById('auto-refresh-logs');
                 if (autoRefreshWidget && autoRefreshWidget.checked) {
                     autoRefreshWidget.checked = false;
                 }
            }
        }
        
        document.addEventListener('mouseup', checkLogSelectionAndPause);
        document.addEventListener('keyup', (e) => {
             // Shift + Arrows usually select text
             if (e.shiftKey) checkLogSelectionAndPause();
        });
    </script>
</body>
</html>

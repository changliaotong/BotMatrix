# BotMatrix 插件架构与拆分最佳实践

本文档旨在指导如何将单体机器人程序拆分为微插件架构，并定义插件之间的交互模式。

## 1. 插件分类 (Responsibilities)

为了保持系统的可维护性，建议将插件分为以下三类：

| 类型 | 职责 | 订阅建议 |
| :--- | :--- | :--- |
| **基础插件 (Foundation)** | 日志、审计、全局权限校验、上下文注入、积分/货币系统底层。 | `*` 或 `on_message` |
| **业务插件 (Feature)** | 具体的业务逻辑，如：签到、猜拳、天气、AI 问答。 | 精准 `Intents` |
| **管理插件 (Admin)** | 禁言、踢人、群设置、插件热重载管理。 | 指令前缀 或 `request` 事件 |

## 2. 消息分发模式 (Message Routing)

BotMatrix 支持多种消息处理模式，可根据场景选择：

### A. 广播模式 (Broadcast)
- **行为**：所有订阅了该事件的插件都会收到副本。
- **场景**：日志记录器、关键词敏感词监控。
- **最佳实践**：此类插件应尽量“只听不写”，避免多个插件对同一消息产生冲突回复。

### B. 意图路由 (Intent Routing) [推荐]
- **行为**：插件在 `plugin.json` 中声明关键词或正则意图。BotWorker 预匹配成功后才转发。
- **场景**：绝大多数业务功能（如：发送“签到”触发签到插件）。
- **优势**：减少无效的跨进程通信，降低系统负载。

### C. 拦截器/职责链 (Interceptor)
- **行为**：通过 `Priority` 属性决定处理顺序。
- **场景**：权限校验插件可以在业务插件之前拦截非法请求。

## 3. 跨插件协作：技能调用 (Skill System)

插件之间不应直接读取对方的数据库，而应通过 `call_skill` 进行通信：

```json
// 调用示例：游戏插件调用积分插件扣除金币
{
  "type": "call_skill",
  "payload": {
    "target_plugin": "com.sz84.credit",
    "skill_name": "deduct_credit",
    "payload": { "user_id": "123", "amount": 10 }
  }
}
```

## 4. 极致重载体验 (Zero-Downtime)

BotMatrix 已实现以下机制保证开发体验：
1. **Shadow Copy (影子拷贝)**：插件在独立的 `.runtime` 目录下运行，不锁定原始二进制文件，支持边运行边编译。
2. **消息缓存 (Message Buffering)**：插件热更新期间（几秒钟的启动耗时内），所有收到的消息会进入内存队列，待新版本就绪后立即补发，确保不漏掉任何用户指令。

## 5. 拆分建议步骤

1. **抽象公共库**：将数据库连接、通用工具类提取到 SDK 或共享插件中。
2. **按功能解耦**：将 `sz84.mibot` 中的各个业务模块提取为独立的子目录。
3. **定义接口**：确定哪些功能需要作为 `Skill` 暴露给其他插件。

# ğŸ§© BotMatrix æ’ä»¶å¼€å‘å…¨æ™¯æŒ‡å— (Plugin Development Guide)

> [â¬…ï¸ è¿”å›æ–‡æ¡£ä¸­å¿ƒ](../README.md) | [ğŸ  è¿”å›é¡¹ç›®ä¸»é¡µ](../../README.md)

BotMatrix æ’ä»¶ç³»ç»Ÿæ˜¯ä¸€ä¸ª**è·¨å¹³å°ã€é«˜æ€§èƒ½ã€è¿›ç¨‹çº§éš”ç¦»**çš„æ‰©å±•æ¶æ„ã€‚å®ƒæ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€ï¼Œå…è®¸å¼€å‘è€…é€šè¿‡æ ‡å‡†åŒ–çš„ JSON åè®®æˆ–å°è£…å¥½çš„ SDK å¿«é€Ÿæ‰©å±•æœºå™¨äººçš„èƒ½åŠ›ã€‚

---

## 1. æ ¸å¿ƒæ¶æ„è®¾è®¡ (Architecture)

### 1.1 è¿›ç¨‹çº§éš”ç¦» (Process-level Isolation)
æ¯ä¸ªæ’ä»¶ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹è¿è¡Œã€‚è¿™ç§è®¾è®¡ç¡®ä¿äº†ï¼š
- **å®‰å…¨æ€§**ï¼šæ’ä»¶å´©æºƒä¸ä¼šå½±å“ä¸»ç¨‹åºã€‚
- **å¤šè¯­è¨€æ”¯æŒ**ï¼šåªè¦èƒ½å¤„ç†æ ‡å‡†è¾“å…¥è¾“å‡º (STDIN/STDOUT) å’Œ JSONï¼Œä»»ä½•è¯­è¨€éƒ½èƒ½å¼€å‘æ’ä»¶ã€‚
- **èµ„æºé™åˆ¶**ï¼šå¯ä»¥ç‹¬ç«‹ä¸ºæ’ä»¶åˆ†é… CPU å’Œå†…å­˜é…é¢ã€‚

### 1.2 é€šä¿¡åè®®
æ’ä»¶ä¸ BotWorker ä¹‹é—´é€šè¿‡æ ‡å‡† I/O æµè¿›è¡Œ JSON é€šä¿¡ã€‚
- **è¾“å…¥ (Input)**: æ’ä»¶ä» `stdin` è¯»å–æ¥è‡ªæ ¸å¿ƒç³»ç»Ÿçš„äº‹ä»¶ (Events)ã€‚
- **è¾“å‡º (Output)**: æ’ä»¶å‘ `stdout` å†™å…¥æ‰§è¡Œçš„åŠ¨ä½œ (Actions)ã€‚

### 1.3 æ’ä»¶ç›®å½•ç»“æ„
```text
src/plugins/your_plugin/
â”œâ”€â”€ your_plugin.go      # æºä»£ç 
â”œâ”€â”€ plugin.json         # æ ¸å¿ƒé…ç½®æ–‡ä»¶
â””â”€â”€ tests.json          # è‡ªåŠ¨åŒ–æµ‹è¯•ç”¨ä¾‹
```

---

## 2. æ’ä»¶é…ç½®å£°æ˜ (plugin.json)

æ¯ä¸ªæ’ä»¶å¿…é¡»åŒ…å« `plugin.json`ï¼Œç”¨äºå®šä¹‰èº«ä»½ã€æƒé™å’Œè§¦å‘é€»è¾‘ã€‚

```json
{
  "id": "com.botmatrix.weather",
  "name": "å¤©æ°”åŠ©æ‰‹",
  "version": "1.0.0",
  "entry_point": "weather.exe",
  "permissions": ["send_message", "call_skill"],
  "events": ["on_message"],
  "intents": [
    {
      "name": "get_weather",
      "keywords": ["å¤©æ°”", "æ°”æ¸©"],
      "regex": "^æŸ¥è¯¢.*å¤©æ°”$"
    }
  ]
}
```

- **id**: å…¨å±€å”¯ä¸€æ ‡è¯†ã€‚
- **permissions**: å£°æ˜æ’ä»¶éœ€è¦è°ƒç”¨çš„ Actionï¼ˆç™½åå•æ¨¡å¼ï¼Œæœªå£°æ˜å°†è¢«æ‹¦æˆªï¼‰ã€‚
- **intents**: æ„å›¾è¯†åˆ«é…ç½®ï¼Œæ”¯æŒå…³é”®å­—å’Œæ­£åˆ™è¡¨è¾¾å¼ï¼Œç”¨äºæ— å‰ç¼€æŒ‡ä»¤è§¦å‘ã€‚

---

## 3. ä½¿ç”¨ SDK å¼€å‘ (æ¨è)

æˆ‘ä»¬ä¸º **Go**, **Python**, å’Œ **C#** æä¾›äº†ç»Ÿä¸€è®¾è®¡çš„ SDKã€‚

### 3.1 æ ¸å¿ƒç‰¹æ€§
- **äº¤äº’å¼ Ask**: åƒå†™åŒæ­¥ä»£ç ä¸€æ ·å¤„ç†å¼‚æ­¥å¯¹è¯ï¼ˆé˜»å¡ç­‰å¾…ç”¨æˆ·å›å¤ï¼‰ã€‚
- **åˆ†å¸ƒå¼ä¼šè¯**: åŸºäº Redis/DB çš„ `SessionStore`ï¼Œæ”¯æŒå¤š Worker è´Ÿè½½å‡è¡¡ã€‚
- **æŠ€èƒ½å¯¼å‡º**: æ’ä»¶å¯ä»¥å¯¼å‡º Skill ä¾›å…¶ä»–æ’ä»¶è°ƒç”¨ã€‚

### 3.2 ç¤ºä¾‹ï¼šå¤šè½®å¯¹è¯ä¸ç¡®è®¤ (C#)
```csharp
public async Task<string> HandleClearData(IPluginContext ctx, string[] args)
{
    // 1. æ£€æŸ¥æ˜¯å¦å·²ç¡®è®¤
    if (ctx.IsConfirmed && ctx.SessionAction == "ClearData")
    {
        await _db.ClearAsync();
        return "âœ… æ•°æ®å·²æ¸…ç©ºã€‚";
    }

    // 2. å‘èµ·ä¸‰ä½éªŒè¯ç ç¡®è®¤æµç¨‹
    var code = await _robot.Sessions.StartConfirmationAsync(
        ctx.UserId, ctx.GroupId, "my.plugin", "ClearData");
        
    return $"âš ï¸ å±é™©æ“ä½œï¼è¯·è¾“å…¥éªŒè¯ç ã€{code}ã€‘ç¡®è®¤ã€‚";
}
```

### 3.3 ç¤ºä¾‹ï¼šè·¨æ’ä»¶è°ƒç”¨ (Python)
```python
# è°ƒç”¨ç‚¹æ­Œæ’ä»¶
result = await ctx.call_skill("com.botmatrix.music", "order", {"name": "ä¸ƒé‡Œé¦™"})
```

---

## 4. å…³é”®å¼€å‘æœºåˆ¶

### 4.1 æ„å›¾è·¯ç”±ä¼˜å…ˆçº§
1. **æ´»è·ƒä¼šè¯æ‹¦æˆª** (Session Interception): å¤„äº `Ask` æˆ– `Confirmation` æµç¨‹ä¸­çš„æ¶ˆæ¯ã€‚
2. **ç›´æ¥æŒ‡ä»¤** (Command Prefix): åŒ¹é… `!` æˆ– `/` å¼€å¤´çš„æŒ‡ä»¤ã€‚
3. **æ„å›¾åŒ¹é…** (Intent Routing): æ ¹æ® `plugin.json` ä¸­çš„ `keywords` æˆ– `regex` åŒ¹é…ã€‚
4. **AI è¯­ä¹‰è§£æ**: è‹¥ä»¥ä¸Šçš†æœªå‘½ä¸­ï¼Œäº¤ç”± LLM è¿›è¡Œæ„å›¾åˆ†å‘ã€‚

### 4.2 åˆ†å¸ƒå¼çŠ¶æ€ç®¡ç†
ç”±äº Worker æ˜¯æ— çŠ¶æ€çš„ï¼Œå¿…é¡»ä½¿ç”¨ `Context.Session` å­˜å–çŠ¶æ€ã€‚
- **Key**: è‡ªåŠ¨åŸºäº `(GroupId, UserId)` ç”Ÿæˆã€‚
- **å­˜å‚¨**: ä¼˜å…ˆä½¿ç”¨ Redisï¼Œå›é€€è‡³æ•°æ®åº“ `sessions` è¡¨ã€‚

---

## 5. å¼€å‘å·¥å…·é“¾ (bm-cli)

`bm-cli` æ˜¯æ’ä»¶å¼€å‘çš„å¿…å¤‡å·¥å…·ï¼Œæ”¯æŒä»åˆ›å»ºåˆ°å‘å¸ƒçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸã€‚

### 5.1 å¸¸ç”¨å‘½ä»¤
- **åˆå§‹åŒ–**: `./bm-cli init my_plugin --lang go`
- **æœ¬åœ°è°ƒè¯•**: `./bm-cli debug ./my_plugin` (æ‹¦æˆªæ‰€æœ‰ Action å¹¶æ‰“å°æ—¥å¿—)
- **è¿è¡Œæµ‹è¯•**: `./bm-cli test ./my_plugin` (æ‰§è¡Œ `tests.json` è„šæœ¬)
- **æ‰“åŒ…**: `./bm-cli pack ./my_plugin` (ç”Ÿæˆ `.bmpk` å®‰è£…åŒ…)

### 5.2 è‡ªåŠ¨åŒ–æµ‹è¯• (tests.json)
```json
[
  {
    "name": "Ping-Pong æµ‹è¯•",
    "input": { "type": "on_message", "payload": { "text": "ping" } },
    "expect": [ { "type": "send_text", "text": "pong!" } ]
  }
]
```

---

## 6. è°ƒè¯•ä¸æ’é”™ (Troubleshooting)

### 6.1 Windows ç¼–è¯‘é™åˆ¶
- **æ³¨æ„**: Go çš„ `-buildmode=plugin` åœ¨ Windows ä¸‹ä¸å—æ”¯æŒã€‚
- **è§£å†³æ–¹æ¡ˆ**: 
  1. å¼€å‘æ—¶ç›´æ¥è¿è¡Œæºç ã€‚
  2. ç”Ÿäº§ç¯å¢ƒå»ºè®®åœ¨ Linux ä¸‹ç¼–è¯‘ã€‚
  3. ä½¿ç”¨ `bm-cli debug` è¿›è¡Œè·¨å¹³å°åè®®æ¨¡æ‹Ÿè°ƒè¯•ã€‚

### 6.2 å¸¸è§é”™è¯¯
- **Type Mismatch**: `int64` ID ä¸å­—ç¬¦ä¸²æ¯”è¾ƒã€‚åº”ç»Ÿä¸€è½¬æ¢ä¸ºå­—ç¬¦ä¸²æˆ–ä½¿ç”¨ `0` åˆ¤æ–­ã€‚
- **Map Concurrent Write**: åœ¨æ’ä»¶å†…ä½¿ç”¨ `map` è®°å½•çŠ¶æ€æ—¶æœªåŠ é”ã€‚åº”æ”¹ç”¨ `sync.Map` æˆ– `SessionStore`ã€‚
- **Action Blocked**: å¿˜è®°åœ¨ `plugin.json` çš„ `permissions` ä¸­æ·»åŠ å¯¹åº”æƒé™ã€‚

---
*æœ€åæ›´æ–°æ—¥æœŸï¼š2026-01-13*

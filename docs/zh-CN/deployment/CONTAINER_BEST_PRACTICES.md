# BotMatrix å®¹å™¨åŒ–éƒ¨ç½²ä¸æ’ä»¶ç®¡ç†æœ€ä½³å®è·µ

> [ç®€ä½“ä¸­æ–‡](CONTAINER_BEST_PRACTICES.md) | [ğŸŒ English](../../en-US/deployment/CONTAINER_BEST_PRACTICES.md)
> [â¬…ï¸ è¿”å›æ–‡æ¡£ä¸­å¿ƒ](../README.md) | [ğŸ  è¿”å›é¡¹ç›®ä¸»é¡µ](../../../README.md)

æœ¬æ–‡æ¡£æ—¨åœ¨ä¸ºå¼€å‘è€…å’Œè¿ç»´äººå‘˜æä¾› BotWorker åŠæ’ä»¶ç³»ç»Ÿåœ¨å®¹å™¨åŒ–ç¯å¢ƒï¼ˆDocker/K8sï¼‰ä¸‹çš„æœ€ä½³éƒ¨ç½²å®è·µæŒ‡å—ã€‚

## 1. æ ¸å¿ƒç†å¿µï¼šStateless Worker + Stateful Plugins

ä¸ºäº†å®ç°é«˜å¯ç”¨å’Œå¼¹æ€§æ‰©ç¼©å®¹ï¼ŒBotWorker ä¿æŒ **æ— çŠ¶æ€ (Stateless)**ï¼Œè€Œæ’ä»¶å’Œç”¨æˆ·ä¼šè¯çŠ¶æ€é€šè¿‡å¤–éƒ¨ç³»ç»Ÿå’ŒæŒä¹…åŒ–å­˜å‚¨è¿›è¡Œç®¡ç†ã€‚

### 1.1 æ¶æ„å›¾ç¤º
```text
[ User ] -> [ Reverse Proxy (Nginx) ] 
                 |
        [ BotWorker Cluster (Replicas: N) ]
          /            |            \
 [ Redis Session ] [ Shared Storage ] [ BotNexus Center ]
    (State)         (Plugins)          (Control)
```

## 2. æ’ä»¶ç®¡ç†æœ€ä½³å®è·µ

åœ¨å®¹å™¨åŒ–ç¯å¢ƒä¸­ï¼Œæ’ä»¶å‡çº§çš„ç—›ç‚¹åœ¨äºâ€œæ›´æ–°ä¸é‡å¯â€å’Œâ€œå¤šå®ä¾‹åŒæ­¥â€ã€‚

### 2.1 ç›®å½•ç»“æ„
æ¨èä½¿ç”¨ç‰ˆæœ¬åŒ–ç›®å½•ç»“æ„ï¼Œç”± `PluginManager` è‡ªåŠ¨æ‰«æï¼š
```text
/app/plugins/
  â”œâ”€â”€ weather_plugin/
  â”‚   â”œâ”€â”€ v1.0.0/ (manifest.json, main.py)
  â”‚   â””â”€â”€ v1.1.0/ (manifest.json, main.py)
  â””â”€â”€ translator_plugin/
      â””â”€â”€ v2.0.1/
```

### 2.2 ç°åº¦å‘å¸ƒ (Canary Release)
åˆ©ç”¨ `PluginConfig` ä¸­çš„ `canary_weight`ï¼š
1.  **ä¸Šä¼ æ–°ç‰ˆæœ¬**: å°†æ’ä»¶æ–°ç‰ˆæœ¬æ”¾å…¥ `/app/plugins/id/new_version/`ã€‚
2.  **è®¾ç½®æƒé‡**: åœ¨ `plugin.json` ä¸­è®¾ç½® `canary_weight: 10`ã€‚
3.  **Core è‡ªåŠ¨è·¯ç”±**: `PluginManager` ä¼šæ ¹æ® `CorrelationId` (Session ç²˜æ») å°† 10% çš„æµé‡å¯¼å‘æ–°ç‰ˆæœ¬ã€‚
4.  **å…¨é‡åˆ‡æ¢**: éªŒè¯æ— è¯¯åï¼Œå°†æ—§ç‰ˆæœ¬åœç”¨ï¼Œæ–°ç‰ˆæœ¬æƒé‡è®¾ä¸º 0 (æˆ–ç§»é™¤æ—§ç‰ˆæœ¬ç›®å½•)ã€‚

### 2.3 åŠ¨æ€åŒæ­¥ (Market Sync)
å®¹å™¨å¯åŠ¨æ—¶ï¼Œå¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡æˆ– API è§¦å‘æ’ä»¶åŒæ­¥ï¼š
-   **æ–¹æ³• A**: åœ¨ `docker-compose` ä¸­æŒ‚è½½å…±äº«å· (NFS/Ceph/HostPath)ã€‚
-   **æ–¹æ³• B**: è°ƒç”¨ `SyncFromMarket(url)` APIï¼Œè®©æ¯ä¸ª Worker è‡ªåŠ¨ä¸‹è½½å¹¶çƒ­åŠ è½½æ’ä»¶ã€‚

## 3. éƒ¨ç½²æŒ‡å—

### 3.1 Dockerfile ä¼˜åŒ–
-   **å¤šé˜¶æ®µæ„å»º**: å‡å°é•œåƒä½“ç§¯ï¼Œæé«˜å¯åŠ¨é€Ÿåº¦ã€‚
-   **é¢„è£…è¿è¡Œç¯å¢ƒ**: é•œåƒä¸­åº”åŒ…å« Python, .NET Runtime ç­‰æ’ä»¶ä¾èµ–ã€‚
-   **å¥åº·æ£€æŸ¥**: é…ç½® `HEALTHCHECK` ç¡®ä¿æ•…éšœå®ä¾‹èƒ½è¢«è‡ªåŠ¨é‡å¯ã€‚

### 3.2 Docker Compose ç¤ºä¾‹
å‚è€ƒé¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ [docker-compose.yml](../../docker-compose.yml)ã€‚å…³é”®ç‚¹ï¼š
-   ä½¿ç”¨ `deploy.replicas` å®ç°æ°´å¹³æ‰©å±•ã€‚
-   ä½¿ç”¨ `update_config.order: start-first` å®ç°é›¶åœæœºæ»šåŠ¨æ›´æ–°ã€‚

## 4. å¸¸è§é—®é¢˜ (FAQ)

**Q: æ’ä»¶å‡çº§éœ€è¦é‡å¯ Worker å®¹å™¨å—ï¼Ÿ**
A: ä¸éœ€è¦ã€‚`PluginManager` æ”¯æŒçƒ­åŠ è½½å’Œçƒ­æ›´æ–°ã€‚åªéœ€å°†æ–°æ’ä»¶åŒ…è§£å‹åˆ°æŒ‚è½½çš„ç›®å½•ï¼Œå¹¶è°ƒç”¨çƒ­æ›´æ–°æ¥å£å³å¯ã€‚

**Q: å¤šä¸ª Worker å®ä¾‹å¦‚ä½•ä¿è¯æ’ä»¶ä¸€è‡´ï¼Ÿ**
A: 
1.  **ä¸­å¿ƒåŒ–åˆ†å‘**: ç”± BotNexus ç»Ÿä¸€ä¸‹å‘æŒ‡ä»¤ï¼ŒWorker æ¥æ”¶åˆ°æŒ‡ä»¤åæ‰§è¡Œ `SyncFromMarket`ã€‚
2.  **å…±äº«å­˜å‚¨**: æ‰€æœ‰ Worker æŒ‚è½½åŒä¸€ä¸ªåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿå·ã€‚

**Q: æ’ä»¶äº§ç”Ÿçš„ä¸´æ—¶æ–‡ä»¶æ”¾åœ¨å“ªé‡Œï¼Ÿ**
A: ä¸¥ç¦æ”¾åœ¨æ’ä»¶ç›®å½•ä¸‹ã€‚åº”ä½¿ç”¨ `/tmp` æˆ–é…ç½®ä¸“é—¨çš„æŒä¹…åŒ– `data` ç›®å½•ã€‚

---
*Last Updated: 2025-12-28*

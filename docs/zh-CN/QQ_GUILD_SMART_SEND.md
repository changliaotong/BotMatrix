# QQ 频道/群组机器人智能协作逻辑说明

> [🌐 English](../en-US/QQ_GUILD_SMART_SEND.md) | [简体中文](QQ_GUILD_SMART_SEND.md)
> [⬅️ 返回文档中心](README.md) | [🏠 返回项目主页](../../README.md)

本文档详细说明了 BotNexus 系统中针对腾讯 QQ 频道机器人（Guild Bot）在群组场景下的特殊限制处理方案，即“智能发送（Smart Send）”与“协作唤醒（WakeUp）”机制。

## 1. 背景与限制

腾讯官方 QQ 频道机器人（Guild Bot）接入 QQ 群时存在严格的安全限制：

1.  **无法主动发送消息**：机器人不能像普通 QQ 用户或旧版机器人那样随意在群里主动发言。
2.  **只能回复消息**：机器人必须针对一条存在的用户消息进行“回复”。
3.  **消息 ID (MsgID) 有效期**：
    *   回复时必须携带用户的 `message_id`。
    *   该 `message_id` 的有效期仅为 **5分钟**。
    *   超过 5 分钟，或该消息已被回复超过 5 次（部分场景限制），该 ID 失效。

**痛点**：如果用户长时间未在群里说话，或者机器人需要定时/主动推送消息，由于缺乏有效的 `message_id`，发送会失败。

## 2. 解决方案：智能协作 (Smart Send)

为了突破上述限制，我们设计了一套基于 **BotNexus 会话状态管理** 和 **多机器人协作** 的机制。

### 核心原理

利用群里存在的 **其他普通机器人**（如 NapCat/OneBot11 协议的普通 QQ 号机器人）作为“辅助唤醒者”。

1.  **缓存有效凭证**：系统持续记录每个群最新的一条消息 ID。
2.  **判断有效期**：发送前检查最新消息 ID 是否在 5 分钟安全期内。
3.  **协作唤醒**：如果 ID 过期，让普通机器人发一条 `@频道机器人 [WakeUp]` 的消息。
4.  **捕获新凭证**：频道机器人收到被艾特的消息，系统自动更新该群的 `LastMsgID`。
5.  **重试发送**：使用刚获取的新鲜 `message_id` 完成消息发送。

## 3. 详细逻辑流程

### 3.1 会话状态维护 (State Management)

BotNexus 的 `ContactSession` 结构体维护了以下关键信息：
*   `LastMsgID`: 该群最新收到的消息 ID。
*   `LastMsgTime`: 收到该消息的时间戳。
*   `ActiveBots`: 记录在该群里活跃过的其他机器人列表（用于寻找辅助者）。

每当群里有新消息产生（无论是用户发的，还是其他机器人发的），系统都会更新这些状态。

### 3.2 智能发送流程 (Smart Action)

当调用 `/api/smart_action` 接口尝试发送群消息时，系统执行以下判断：

1.  **检查缓存**：
    *   获取目标群的 `LastMsgTime`。
    *   计算 `当前时间 - LastMsgTime`。

2.  **分支 A：凭证有效 (Time < 290s)**
    *   直接使用缓存的 `LastMsgID` 作为 `message_id` 参数。
    *   调用底层发送接口。
    *   **结果**：消息立即发出。

3.  **分支 B：凭证过期 (Time >= 290s)**
    *   **寻找辅助者**：在 `ActiveBots` 列表中查找一个非当前发送者的机器人（普通 QQ 机器人）。
    *   **执行唤醒**：
        *   向辅助机器人发送指令：`send_group_msg(group_id, message="@频道机器人 [WakeUp]")`。
    *   **等待传播**：
        *   系统挂起等待（默认 2 秒），等待腾讯服务器将这条艾特消息推送到频道机器人。
        *   频道机器人收到消息 -> BotNexus 更新 `LastMsgID`。
    *   **重载凭证**：
        *   重新读取会话状态。
        *   检查 `LastMsgID` 是否已更新。
    *   **最终发送**：
        *   使用（希望是）更新后的 `LastMsgID` 发送原消息。

## 4. 如何使用

### Web 控制台

1.  进入 **调试/动作 (Actions)** 面板。
2.  选择目标 **频道机器人** 和 **群组**。
3.  输入消息内容。
4.  点击蓝色按钮 **"智能发送 (WakeUp)"**。

### 注意事项

*   **前置条件**：目标群里必须至少有一个 **普通 QQ 机器人** (如 NapCat) 也在 BotNexus 管理之下，且该普通机器人曾在该群活跃过（发过消息或收到过事件）。
*   **延迟**：触发唤醒机制时，会有约 2-3 秒的发送延迟。
*   **频率**：虽然实现了“无限”发送，但请遵守腾讯风控规则，避免高频刷屏。

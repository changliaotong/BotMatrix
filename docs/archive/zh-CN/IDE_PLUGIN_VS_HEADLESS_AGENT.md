# 架构决策：IDE 插件 vs. 无头代理 (Headless Agent)

## 1. 背景与目标
我们的核心目标是 **"完全自动化，减少人工干预，各个环节增加数字员工介入"**。
基于此目标，我们需要评估目前两种主流的代码生成/修改技术路线：
1.  **IDE 插件/改造模式** (如 GitHub Copilot, Cursor, Trae)
2.  **无头代理模式 (Headless Agent)** (如 AutoGPT, Devin, MetaGPT)

## 2. 对比分析

| 特性 | IDE 插件模式 (Interactive) | 无头代理模式 (Headless/Autonomous) |
| :--- | :--- | :--- |
| **运行环境** | 依赖用户打开 IDE (VS Code 等) | 运行在服务器/后台容器 (Docker/K8s) |
| **触发方式** | 用户主动提问或补全 | 事件触发 (JIRA 工单, CI/CD 失败, 定时任务) |
| **人工干预** | **高** (Human-in-the-loop) | **低** (Human-on-the-loop) |
| **适用场景** | 辅助编程、解释代码、局部重构 | 批量修 Bug、版本升级、自动化测试、文档生成 |
| **扩展性** | 受限于单机性能和用户时间 | 可水平扩展 (开启 1000 个数字员工并发工作) |
| **上下文** | 局限于当前打开的项目 | 可访问整个企业代码库、知识库、外部文档 |

## 3. 核心优缺点

### 3.1 直接写代码 (Headless Agent - 我们目前的路线)
**优点：**
*   **真正的自动化**：不需要人盯着屏幕。数字员工可以在凌晨 2 点自动拉取代码，修复 CI 报错，提交 PR。
*   **标准化流程**：通过 SOP (Standard Operating Procedure) 强制执行规范（如必须先写测试再改代码），不受人类开发者习惯影响。
*   **规模化效应**：可以同时处理 50 个微服务的依赖升级，这是人类在 IDE 中无法完成的。

**缺点：**
*   **调试困难**：当 AI 陷入死循环或改坏代码时，不如在 IDE 里直接看到那么直观。
*   **冲突处理**：如果 AI 和人类同时修改同一个文件，Git 冲突解决比较复杂。

### 3.2 IDE 插件/改造 (Interactive)
**优点：**
*   **即时反馈**：人类可以立刻纠正 AI 的错误。
*   **体验平滑**：无缝融入开发者的现有工作流。

**缺点：**
*   **无法独立工作**：关闭 IDE，AI 就停止工作了。
*   **难以管理**：企业很难统一管理每个开发者 IDE 里的 AI 行为和 Prompt。

## 4. 架构建议

鉴于我们的目标是 **"数字员工 (Digital Employee)"** 而不仅仅是 **"编程助手 (Coding Assistant)"**，建议采取以下架构：

### **核心路线：Server-Side Headless Agent (服务端无头代理)**
*   **基石**：继续完善目前的 MCP (Model Context Protocol) 架构，赋予 Agent 文件读写、命令行执行、Git 操作的能力。
*   **部署**：Agent 运行在独立的 Docker 沙箱中，通过 Git 协议与代码仓库交互。
*   **交互**：通过 Chat 界面、工单系统 (Jira) 或 CI/CD 流水线与人类交互，而不是通过 IDE 插件。

### **可选扩展：IDE 插件作为"客户端"**
*   我们 **不需要** 开发一个像 Copilot 那样复杂的代码补全插件。
*   但我们可以开发一个 **轻量级 VS Code 插件**，作为 **"数字员工的任务控制台"**。
    *   功能：开发者在 IDE 里选中一段代码，右键 -> "派发给数字员工修复"。
    *   实现：插件只负责发送指令给我们的后端服务，后端 Agent 异步拉取代码进行修改，然后提交 PR。开发者在 IDE 里只需要 `git pull` 即可看到结果。

## 5. 结论

**不要模仿 Cursor 或 Copilot 做编辑器改造。** 那是红海市场，且不符合"完全自动化"的目标。

**坚持做服务端 Agent。** 让数字员工成为团队的"隐形战友"，在后台默默处理繁琐任务。如果需要 IDE 集成，仅将其作为下发指令的入口。

## 6. 行动计划
1.  **完善 MCP 工具链**：刚刚已补充 `dev_git_clone`，确保 Agent 能独立下载代码库。
2.  **增强沙箱安全**：确保 Agent 的 `run_cmd` 不会破坏宿主机。
3.  **开发 Web 管理台**：让管理者能看到所有数字员工的实时工作状态（比 IDE 插件更重要）。

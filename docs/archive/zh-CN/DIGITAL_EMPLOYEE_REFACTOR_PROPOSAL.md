# 👔 数字员工系统架构重构提议：基于 Agent 核心设计模式

> **状态**: 提议 (Draft)
> **日期**: 2026-01-09
> **关联文档**: [DIGITAL_EMPLOYEE_SYSTEM.md](../core/DIGITAL_EMPLOYEE_SYSTEM.md), [DIGITAL_EMPLOYEE_OPERATIONAL_BLUEPRINT.md](../core/DIGITAL_EMPLOYEE_OPERATIONAL_BLUEPRINT.md)

## 1. 背景与目标

当前的数字员工系统已实现了基础的身份管理、认知记忆和 KPI 考核。然而，随着任务复杂度的提升，单一的认知循环（Cognitive Loop）在处理长链路任务、高可靠性要求以及多轮迭代场景时显现出局限性。

本提议旨在引入 Agent 设计的五大核心模式，对数字员工的执行层进行深度重构，以提升系统的鲁棒性、可维护性和复杂任务处理能力。

---

## 2. 核心模式重构方案

### 2.1 委托模式与 Evaluator-Optimizer (Orchestrator-Workers)

**当前现状**: 任务通常由单个数字员工直接执行，虽然有协作委派，但缺乏标准化的调度控制。

**重构建议**:
- **引入调度者 (Orchestrator)**: 每个复杂任务由一个调度者 Agent 统筹。它不参与具体搬砖，只负责任务分发和最终审查。
- **子员工细分 (Sub-Agents)**:
    - **Plan Agent**: 专门负责将原始需求拆解为结构化的任务列表。
    - **Workers Agent**: 专注于执行具体的子任务（如搜索、写代码、查报表）。
- **独立上下文**: 每个 Sub-Agent 拥有独立的 `Short-term Memory`，有效避免上下文爆炸，提升响应速度。
- **评估优化器 (Evaluator-Optimizer)**: 调度者兼任评估者角色，对 Workers 的输出进行质量核验。如果质量不达标，则打回重做（Optimizer 逻辑）。

### 2.2 流水线模式 (Pipeline)

**当前现状**: 任务执行逻辑较为扁平。

**重构建议**:
- **标准化流水线**: 将数字员工的工作流程标准化。例如，一个“文案创作”任务的 Pipeline：
    `需求分析 -> 资料检索 (Research) -> 章节初稿 -> 内容审查 -> 润色交付`
- **中间审查机制**: 每个环节结束后，由调度者 Agent 进行审查。
- **局部迭代**: 一旦审查不通过（如：真实性校验失败），仅需重做该环节对应的 Agent 任务，无需从头开始，极大节省 Token 消耗和执行时间。

### 2.3 断路器模式 (Circuit Breaker)

**当前现状**: 当 AI 进入逻辑死循环或持续生成错误内容时，系统可能陷入无效的重复调用。

**重构建议**:
- **迭代计数器**: 在调度者 Agent 中维护一个迭代计数。
- **阈值熔断**: 当针对同一个子任务的重做请求超过设定阈值（如 3 次）时，触发“断路器”。
- **人工介入 (HITL)**: 系统暂停所有 Agent 活动，并向管理端（移动 App）推送困境陈述，由人类管理者决定是“调整 Prompt”、“手动修正”还是“终止任务”。

### 2.4 状态机模式 (State Machine)

**当前现状**: 任务状态分散在各个数据库表和内存中，故障恢复能力较弱。

**重构建议**:
- **集中状态管理**: 引入状态机存储任务的所有中间变量、执行结果和计数信息。
- **状态钩子 (Hooks)**: 任务的流转完全依赖状态机。只有调度者 Agent 拥有更新状态机的权限。
- **现场恢复能力**: 状态机持久化存储。如果 `BotWorker` 意外崩溃，重启后可基于状态机记录的最后有效状态，由调度者 Agent 继续未竟的任务，实现真正的“长时任务可靠性”。

---

## 3. 演进路线

1. **第一阶段**: 在 [DIGITAL_EMPLOYEE_OPERATIONAL_BLUEPRINT.md](../core/DIGITAL_EMPLOYEE_OPERATIONAL_BLUEPRINT.md) 的基础上，正式定义 `Orchestrator` 类和任务状态机模型。
2. **第二阶段**: 重构 `TaskEngine`，支持基于 Pipeline 的任务编排。
3. **第三阶段**: 集成断路器机制和人工干预逻辑。
4. **第四阶段**: 将现有技能（MCP Toolset）适配到新的 Orchestrator 架构中。

---

## 4. 结论

通过引入上述模式，数字员工系统将从“被动执行者”进化为“主动调度与自我审计”的智能团队。这不仅能显著提升任务完成质量，也为未来大规模、高并发的 Agent 协作网格打下坚实的架构基础。

# RAG 系统设计方案 (用户上传文档支持)

## 1. 概述
本文档记录了 BotMatrix RAG 系统中关于用户上传文档、多格式解析以及机器人维度知识共享的设计与实现方案。

## 2. 核心模型设计
为了支持多租户和灵活的知识共享，对 `KnowledgeDoc` 及其关联表进行了重构：

### 2.1 KnowledgeDoc (文档主表)
- `UploaderID`: 记录上传者 ID，拥有对该文档的生命周期管理权（启用、暂停、删除）。
- `Status`: 状态位（`active`, `paused`），支持灵活控制知识库内容的生效。
- `Hash`: 文档内容的 SHA256 哈希，用于在上传时检测重复并避免冗余的向量化计算。

### 2.2 KnowledgeDocAccess (权限关联表)
采用 **RBAC + ACL** 混合模型，支持以下维度的知识共享：
- `system`: **全局大脑**，所有机器人和用户均可访问。
- `user`: **私人笔记本**，仅上传者本人在任何场景中可访问，保护绝对隐私。
- `group`: **团队共享盘**，群成员共同喂养机器人，群内共享智慧。
- `bot`: **机器人人格/技能**，机器人自学成才，在所有服务的群组中保持知识连贯性。

## 3. 多格式解析与多模态支持 (全能识别)
系统采用插件化解析器模式，支持根据文件后缀自动选择解析逻辑：

- **PDF 深度解析**: 不仅提取文字，还能自动抓取内嵌图片，通过视觉模型描述图表、插图内容，让机器人“看懂”复杂的 PDF 报告。
- **Excel 智能表格**: 完美保留行列结构，机器人可以像分析师一样根据表格数据回答同比、环比或特定数值查询。
- **图片即知识**: 直接发送截图、照片，机器人自动总结图片关键信息。不管是手写便签还是网页截图，都能搜得到。
- **Markdown/Word/TXT**: 传统文档自然不在话下，按语义智能分片，拒绝断章取义。
- **代码库索引**: 程序员的福音，支持 Go/Python 等代码结构化索引，问逻辑、找函数信手拈来。

## 4. 给普通用户带来的好处 (为什么好用？)
- **零成本上手**: 像传文件一样简单。不需要学习复杂后台，发给机器人，它就记住了。
- **隐私绝对安全**: 私聊发给机器人的秘密，它在群里绝对不会乱说。
- **跨场景记忆**: 你在手机上发给机器人的文档，回到电脑端问它，它依然记得。
- **告别大海捞针**: 几百个 PDF、几千行 Excel？问机器人一句，它直接给你答案并定位到原文。

## 5. 酷炫玩法示例 (你可以这样玩)
- **【群聊-项目助理】**: 把项目进度 Excel 发到项目群，全员随时艾特机器人问“目前进度最慢的任务是谁？”。
- **【私聊-个人图书馆】**: 丢一堆技术 PDF 进去，机器人秒变你的 24 小时在线私教，甚至能根据 PDF 里的流程图画出思维导图。
- **【财务-智能对账】**: 发送对账单图片，直接问“上个月在餐饮上花了多少钱？”，机器人自动识别图片数字并求和。
- **【开发者-代码助手】**: 整个工程目录丢进去，问它“这个鉴权逻辑在哪实现的？”，机器人直接给出代码片段。

## 6. RAG 2.0 核心能力 (已上线)
系统已全面进化为 **RAG 2.0 (Agentic RAG)** 架构，通过 AI 自主策略大幅提升回答的精准度：

### 6.1 Query Refinement (查询重写)
- **原理**: 当用户提问过于简短或模糊时（如“怎么安装？”），系统会自动调用 AI 将其重写为更具搜索价值的关键词（如“Postgres pgvector 插件安装步骤与环境要求”）。
- **好处**: 显著提高向量检索的召回率，让机器人更懂你的潜台词。

### 6.2 Self-Reflection (相关性自检)
- **原理**: 在将检索结果喂给 AI 生成答案前，系统会先进行一轮“自省”。AI 会逐一检查每个检索到的片段是否真的与问题相关。
- **好处**: 过滤掉噪音信息，防止机器人因为检索到无关片段而“一本正经地胡说八道”。

### 6.3 GraphRAG (知识图谱增强)
- **原理**: 系统在索引文档时，会自动提取其中的关键**实体**（如人名、项目名、技术术语）及其**关系**（如“依赖于”、“属于”、“位于”）。
- **好处**: 
  - **跨文档关联**: 能够回答跨越多个文档的复杂逻辑问题（例如：“项目 A 的技术栈中，哪些组件是由开发者 B 维护的？”）。
  - **知识漫游**: 检索时不仅给你文字片段，还能告诉你相关的背景知识，防止“只见树木不见森林”。

## 7. 未来实验室 (持续演进中)
我们正在探索更深层次的知识融合技术：

### 7.1 Long-Context Synergy (长上下文协同)
- **目标**: 结合 LLM 的超长上下文窗口，实现“检索整章 -> 深度推理”的模式。
- **场景**: 彻底解决“断章取义”问题，适用于法律条文、长篇合同的深度分析。

## 8. 高级酷炫玩法 (你可以这样玩)
- **【多级深度研究】**: 艾特机器人“帮我写一份关于 RAG 2.0 的调研报告”，机器人会启动 Agentic 流程：先搜本地文档 -> 发现知识缺口 -> 自动联网搜索补充 -> 最后汇总生成。
- **【知识图谱漫游】**: 问机器人“我的知识库里还有哪些和‘pgvector’相关的技术？”机器人通过图关系带你发现可能被遗忘的相关文档。
- **【自动纠错对话】**: 用户问了一个基于错误前提的问题，机器人通过检索发现事实不符，会先纠正用户：“根据文档，pgvector 并不是一个独立数据库，而是 Postgres 的插件，您是想问它的安装方法吗？”

## 9. 检索流程 (Hybrid Search + Graph Search)
1. **Query Refinement**: AI 自动优化原始提问，生成精准搜索词。
2. **权限过滤**: 根据当前上下文（BotID, UserID, GroupID）构建 SQL 过滤条件，确保权限隔离。
3. **混合检索**: 
   - **向量检索**: 计算 Embedding，利用 `pgvector` 进行语义相似度匹配。
   - **关键词检索**: 利用 `LIKE` 模糊匹配捕捉专有名词。
4. **图谱检索 (Graph Search)**: 
   - 根据搜索词定位相关实体及其一度、二度关系。
   - 提取实体描述与关系链，作为补充上下文。
5. **Self-Reflection**: AI 对检索到的 Top-K 片段（包含图谱背景）进行相关性评估，剔除无关干扰项。
6. **结果合并**: 对精炼后的结果进行去重，返回高质量参考上下文。

## 10. 存储架构
- **核心数据库**: PostgreSQL + `pgvector` 插件。
- **存储表结构**:
  - `knowledge_docs`: 文档元数据。
  - `knowledge_chunks`: 文本切片及向量。
  - `knowledge_entities`: 知识图谱实体（支持向量搜索）。
  - `knowledge_relations`: 实体间的逻辑关系链。
  - `knowledge_doc_access`: 多租户权限控制表。
- **向量维度**: 默认支持 2048 维（适配 Doubao 等高性能视觉/文本模型）。

## 11. 操作与使用
- **聊天指令管理**: 用户可以通过 `/kb` 系列指令直接在聊天窗口管理知识库。
- **操作指南**: 详见 [RAG 聊天指令使用指南](file:///d:/projects/BotMatrix/docs/zh-CN/core/RAG_CHAT_USAGE_GUIDE.md)。

# RAG 与机器人自举 (Bootstrap) 架构文档

## 1. 概述
本项目引入了基于 RAG (Retrieval-Augmented Generation) 的机器人“自举”机制。通过将机器人的身份认知、功能指南与外部知识库结合，使 AI 能够具备自我意识，并能根据详细的系统文档回答复杂问题。

## 2. 核心功能与使用指南 (Nexus RAG)
Nexus 不仅仅是一个聊天机器人，它是您的**第二大脑**。它支持通过聊天窗口直接添加、查询和管理知识库。

### 2.1 知识库管理指令
| 指令 | 参数 | 说明 | 权限 |
| :--- | :--- | :--- | :--- |
| `/kb list` | 无 | 查看当前场景（个人/群组）下的文档列表 | 所有用户 |
| `/kb del` | `<ID>` | 删除指定 ID 的文档 | 文档所有者/管理员 |
| `/kb status` | 无 | 查看知识库存储引擎及当前运行状态 | 所有用户 |
| `/kb add` | 无 | 获取添加文档的引导提示 | 所有用户 |
| `/kb sync` | 无 | 手动触发系统设计文档的全量同步 | 管理员 |

### 2.2 自动文档索引 (发什么它都懂)
您无需输入复杂命令即可添加知识。只需在聊天窗口中**直接发送**：
- **支持格式**：
   - **📄 文档**: PDF (含图片提取), Word, Markdown, TXT。
   - **📊 表格**: Excel (.xlsx/.xls)，机器人变身专业数据分析师。
   - **🖼️ 图片**: 截图、照片、海报，系统自动识别图中关键信息。
   - **💻 代码**: Go, Python, C++, JS 等，问逻辑不再难。
- **空间隔离**：
   - **🛡️ 个人私有空间**：私聊中上传的一切，仅您本人可见。
   - **🤝 群组共享空间**：在群聊中上传，全群成员共享集体智慧。

---

## 3. RAG 架构选型 (Naive RAG)
- **开发语言**: Go (与 BotNexus 核心保持一致)
- **向量数据库**: PostgreSQL + [pgvector](https://github.com/pgvector/pgvector)
  - 支持 `L2 distance (<->)` 和 `Cosine distance (<=>)` 搜索。
- **向量化模型**: 推荐使用开源模型 [BGE-M3](https://huggingface.co/BAAI/bge-m3) (1024 维)
  - 部署方式：通过 [Ollama](https://ollama.com/) 本地运行 `ollama run bge-m3`。
- **数据流**:
  1. **Indexer**: 扫描 `DOCS.md` 及代码注释，进行 Markdown 分片。
  2. **Storage**: 存储分片内容及其向量。
  3. **Retriever**: 根据用户输入，执行向量相似度检索。

---

## 4. 机器人自举 (Bootstrap) 机制
自举是指机器人通过内置的身份清单和能力描述，逐步建立起对自身功能的认知过程。

### 4.1 核心组件
- **BotIdentity**: 定义机器人的基本属性（名称、角色、性格、内置知识）。
- **SystemManifest**: 动态聚合所有已注册的技能（Skills）和核心动作（Actions）。
- **RAG Enhancement**: 当内置知识不足以回答时，触发深度知识库检索。

### 4.2 身份自举层次
1. **静态层**: 配置文件中定义的 `Name`, `Role`, `Personality`。
2. **动态层**: 实时汇报的 `Skills` 清单，告知 AI 当前可调用的工具。
3. **知识层**: 挂载的 RAG 知识库，提供“如何使用 [功能]”的深度文档。

---

## 5. 进阶：Agentic RAG (RAG 2.0)
系统现已升级 RAG 2.0，具备更强的逻辑推理与关联能力，通过 AI 的自我迭代优化检索质量。

### 5.1 核心特性
- **查询改写 (Query Refinement)**：AI 会将原始用户提问改写为更适合向量搜索的关键词，提升召回率。
- **自我反思 (Self-Reflection)**：检索出的内容会经过 AI 的二次评估，剔除无关干扰信息。
- **自省模式**：如果找不到确切证据，机器人会诚实回答“找不到提到这点”，而不是编造答案。
- **知识图谱漫游**：自动识别文档里的“人物、公司、技术、地点”并建立跨文档关联。

---

## 6. 数字员工工具接口规范 (Tooling Spec)
为了解决 AI “幻觉”导致的高风险操作问题，我们建立了一套完整的工具分级与审计体系。

### 6.1 风险等级定义 (Risk Levels)
- **Low (低风险)**：只读、无副作用的操作（如检索知识库）。自动执行。
- **Medium (中风险)**：有限副作用的操作（如发送消息）。自动执行并审计。
- **High (高风险)**：影响系统状态的关键操作（如修改数据库）。**必须经过人工审批**。

### 6.2 审计与拦截
所有工具调用都会实时记录到 `ToolAuditLogs` 表中。高风险调用会被 `DigitalEmployeeToolFilter` 拦截并挂起，直到人工审批通过。

---

## 7. 实现详情与维护
- **数据模型**: [model.go](../../BotMatrix/common/rag/model.go) 定义了 `KnowledgeDoc` 和 `KnowledgeChunk`。
- **知识库实现**: [pg_knowledge.go](../../BotNexus/internal/rag/pg_knowledge.go) 实现了基于 pgvector 的存储与搜索。
- **能力注入**: [capabilities.go](../../BotNexus/tasks/capabilities.go) 负责将身份与 RAG 提示詞注入 System Prompt。
- **文档同步**: 运行 `Indexer` 工具可自动将最新的开发文档灌入向量库。

---
*Last Updated: 2026-01-13*

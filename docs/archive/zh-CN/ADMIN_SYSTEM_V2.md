# 超级群管系统 V2 (Admin System)

超级群管系统已从主程序逻辑中剥离，正式插件化。它提供了全方位的群组自动化管理能力，包括成员控制、群组配置和全局名单管理。

## 核心特性
- **插件化架构**：独立于主程序运行，支持动态加载和配置。
- **双重名单机制**：支持本地群黑名单与全局数据库黑名单。
- **权限分级**：区分群主、群管理员、全局管理员和超级管理员。
- **自动化拦截**：集成中间件，自动踢出黑名单成员。

## 指令列表

### 1. 基础管理 (需要群管理权限)
- `踢 @用户`：将指定成员移出群聊。
- `禁言 @用户 [分钟]`：禁言指定成员（默认10分钟）。
- `取消禁言 @用户`：解除成员禁言。
- `设置头衔 @用户 [头衔]`：设置成员在群内的专属头衔。

### 2. 自动化策略
- `被踢拉黑 [开启/关闭]`：成员被管理员移除后是否自动加入黑名单。
- `退群拉黑 [开启/关闭]`：成员主动退群后是否自动加入黑名单。
- `敏感词系统 [开启/关闭]`：是否开启群内敏感词告警拦截逻辑。
- `改名提示 [开启/关闭/提示词]`：群员修改名片时的提示设置。

### 4. 高级治理策略
通过“设置”或“开启”指令，可以针对特定违规行为配置组合惩罚。
- **治理项目**：刷屏、脏话、广告、图片、网址、推荐群、推荐好友、合并转发。
- **惩罚动作**：撤回、警告、禁言、扣分、踢出、拉黑（可组合）。
- **指令格式**：`设置 [项目] [惩罚动作]` 或 `开启 [项目] [惩罚动作]`。
- **示例**：
    - `设置 广告 撤回禁言`（发现广告则撤回消息并禁言）
    - `设置 推荐群 撤回拉黑`（分享群名片则撤回并拉黑）

---

## 核心治理逻辑详解

为了方便用户理解，以下是各项高级功能的判定逻辑说明：

### 1. 广告拦截逻辑 (AD Filter)
系统通过以下维度综合判定是否为广告：
- **网址检测**：消息中包含非官方白名单的 URL 链接。
- **号码识别**：消息中包含非本群成员、非机器人的 QQ 号码或群号。
- **信任度检查**：
    - 如果发言者进群时间短（少于3天）。
    - 且消息行数多（超过3行）或字符长度长（超过18字）。
    - 且命中预定义的广告关键词（如：加好友咨询、进群领取等）。
- **判定结果**：满足上述组合条件即判定为广告。

### 2. 刷屏治理逻辑 (Spam Protection)
- **频率监控**：系统会记录每个用户短时间内的发言频率。
- **阶梯惩罚**：
    - **前几次**：系统发出“请勿刷屏”的警告。
    - **超限后**：根据设置执行撤回、禁言（时长由群配置决定）或踢出。
    - **严重违规**：若连续刷屏超过 20 次，将自动列入官方全局黑名单。

### 3. 特殊内容治理
- **推荐群/好友**：识别 QQ 原生的“推荐联系人”和“推荐群”卡片。
- **合并转发**：识别聊天记录的合并转发内容，防止利用该功能进行广告轰炸或传播违规信息。
- **脏话拦截**：匹配内置的高强度脏话词库，支持自动撤回并警告。

### 4. 敏感词词库管理
支持管理员自定义词库，不同词库触发不同的默认行为：
- `撤回词`：仅撤回，不进行额外惩罚。
- `禁言词`：撤回并禁言（时长根据群设置）。
- `警告词`：撤回并增加一次系统警告次数。
- `拉黑词`：直接撤回并永久拉黑。
- **操作指令**：`[类型]词 + [关键词]`（添加），`[类型]词 - [关键词]`（移除）。

---

## 技术实现

### 数据模型
- **Blacklist**: 存储全局黑名单信息。
- **GlobalAdmin**: 存储具有全局管理权限的用户 ID。

### 拦截机制
- **BlacklistMiddleware**: 在消息管道的最前端进行检查，一旦发现黑名单用户，立即拦截请求并执行踢出动作（如果在群聊中）。
- **BuiltinCommandMiddleware**: 自动识别管理指令并分发给插件系统，避免与旧版内置指令冲突。

## 开发指南
如需扩展管理功能，请在 `AdminService.cs` 中增加相应的指令处理逻辑，并在 `BotPlugin` 特性的 `Intents` 中注册相关关键字。

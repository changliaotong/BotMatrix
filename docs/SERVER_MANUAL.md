# 服务端使用手册 (Server Manual)

本文档详细介绍了 Python 服务端（OneBot Gateway）的功能、配置、插件指令及运维操作。

---

## 1. 系统概述

本服务端核心是一个 **OneBot 协议网关**，它负责：
1.  **连接管理**：维护与 C# 客户端 (WeChat/QQ) 的 WebSocket 连接。
2.  **消息路由**：将接收到的消息分发给插件系统和 C# 业务端。
3.  **服务插件**：提供系统监控、日志记录、广播通知等服务级功能。
4.  **Web 界面**：提供二维码登录、实时日志和状态监控看板。

---

## 2. Web 控制台

服务端启动后，内置了一个轻量级 Web 服务器。

- **访问地址**: `http://服务器IP:3001` (端口默认为 3001，可在 config.json 修改)
- **主要功能**:
    - **首页 (Dashboard)**:
        - 实时显示 CPU / 内存使用率图表。
        - 显示网关连接数、系统运行时间、消息吞吐量。
        - 实时滚动日志窗口。
    - **登录页 (/login)**:
        - 当机器人掉线需要重新扫码时，可直接访问此页面获取二维码。
        - 页面会自动刷新检测登录状态。

---

## 3. 服务端插件指令

服务端内置了一套管理指令，**仅限管理员使用**。指令必须以 `#` 开头。

### 3.1 权限验证
管理员权限通过以下两种方式验证（满足任一即可）：
1.  **配置文件**: `config.json` 中的 `admins` 列表包含用户的 WXID。
2.  **数据库**: 数据库 `User` 表中登记了用户的 WXID，且该用户在 `Member` 表中被绑定为机器人的 `AdminId`。

### 3.2 指令列表

| 模块 | 指令 | 参数示例 | 功能说明 |
| :--- | :--- | :--- | :--- |
| **系统监控** | `#status` | 无 | 查看服务器 CPU、内存占用、运行时间及网关连接数。 |
| **系统维护** | `#reload` | 无 | 热重载所有插件代码（无需重启服务）。 |
| | `#gc` | 无 | 手动触发 Python 垃圾回收，释放内存。 |
| **通知广播** | `#broadcast` | `#broadcast 今晚维护` | 向过去 3 天内活跃的所有群组发送系统广播消息。 |
| **数据库** | `#db_status` | 无 | 查看 `ChatLog`、`User`、`Member` 表的数据行数统计。 |
| | `#db_clean` | `#db_clean 30` | 清理指定天数（如 30 天）前的聊天记录，释放空间。 |
| **API 调试** | `#api` | `#api {"action": "send_msg", ...}` | 发送原始 OneBot JSON 指令，用于测试底层接口。 |
| **帮助** | `#help` | 无 | 显示帮助菜单。 |

---

## 4. 数据库功能

服务端集成了数据库日志功能，需要 SQL Server 支持。

### 4.1 自动日志 (db_logger)
- 所有接收到的消息（私聊/群聊）会自动写入 `ChatLog` 表。
- **注意**: 若 `ChatLog` 表不存在，日志功能将静默失效。

### 4.2 权限表结构
若要启用数据库鉴权，请确保数据库中存在以下表结构（建表脚本位于 `create_user_table.sql`）：

- **[User] 表**: 存储管理员信息
    - `Id`: 唯一标识
    - `WxId`: 管理员微信ID (用于匹配发送者)
- **[Member] 表**: 存储机器人信息
    - `BotUin` / `UserName`: 机器人标识
    - `AdminId`: 关联到 [User].Id

---

## 5. 配置文件说明 (config.json)

```json
{
    "admins": [
        "wxid_xxxxxx"  // 超级管理员列表 (最高权限)
    ],
    "network": {
        "ws_server": {
            "port": 3001,           // 服务监听端口
            "heartbeat_interval": 5000, // 心跳间隔 (毫秒)
            "force_push_event": true    // 强制推送事件给 C# 端
        }
    },
    "bots": [
        // 多平台机器人配置 (WeChat, WxWork, DingTalk, etc.)
    ]
}
```

---

## 6. 常见问题与运维

### 6.1 快速部署与更新

项目提供了一键部署脚本 `scripts/deploy.py`，支持以下模式：

- **标准部署** (重建所有容器):
  ```bash
  python scripts/deploy.py
  ```

- **快速部署** (仅更新代码并重启，不重建镜像):
  适用于仅修改了 Python 代码 (如 `web_ui.py`, `driver.py`) 的情况，速度更快且无需 sudo 权限(如果 Docker 权限已配置)。
  ```bash
  python scripts/deploy.py --fast
  ```

### 6.2 机器人掉线处理
1.  访问 Web 控制台 `http://IP:5000/login`。
2.  查看是否有二维码。
3.  若无二维码，尝试在群里发送 `#reload` 指令，或在服务器执行 `docker restart botmatrix-worker-wx`。

### 6.3 数据库连接失败
- 检查 `config.json` 中的数据库连接字符串。
- 确保 SQL Server 允许远程连接，且防火墙已放行 1433 端口。

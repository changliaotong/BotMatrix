# BotNexus AI 任务系统技术规格文档

本文档描述了 BotNexus 系统中通过 AI 意图识别进行任务编排的核心机制、安全策略及风控体系。

## 1. 核心流程 (Workflow)

AI 任务执行遵循 **"解析-确认-执行"** 的三段式流程，确保所有自动化操作均处于受控状态：

1.  **意图识别 (Parse)**: 用户通过自然语言（如“每天晚上禁言群123”）发出指令，系统调用 LLM 进行意图分类和参数提取。
2.  **草稿生成 (Draft)**: 解析结果暂存至 `AIDraft` 草稿箱，并返回解析摘要供用户核对。
3.  **人工确认 (Confirm)**: 用户确认无误后点击执行，系统再次进行实时权限校验，通过后下发至 `TaskManager` 调度执行。

## 2. 能力清单与风险等级 (Capabilities & Risks)

系统对所有 AI 可触发的动作进行了分级管理，以防止越权操作：

| 动作 ID | 动作名称 | 风险等级 | 准入角色 | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| `send_message` | 发送消息 | Low | 所有成员 | 常规文本下发，主要风险为刷屏 |
| `mute_group` | 全群禁言 | Medium | 群主/管理员 | 影响群内整体交流 |
| `unmute_group` | 解除禁言 | Medium | 群主/管理员 | 恢复群内交流 |
| `mute_random` | 随机禁言套餐 | Medium | 群主/管理员 | 带有娱乐性质的管理动作，涉及成员过滤 |
| `kick_member` | 踢出成员 | High | 群主/管理员 | **高危动作**，涉及用户关系切断 |
| `set_group_admin`| 设置管理员 | High | 群主 | **极高危动作**，涉及权限授予 |

## 3. 安全与风控策略 (Security & Policy)

### 3.1 角色校验 (RBAC)
- **预校验**: 在 AI 解析阶段，系统会根据 [policy.go](src/BotNexus/tasks/policy.go) 检查请求者的群角色。
- **二次校验**: 在执行阶段，系统会重新获取当前最新的角色信息，防止角色变更导致的漏洞。
- **管理员保护**: 机器人作为管理员时，无法通过 AI 指令禁言或踢出其他管理员或群主。

### 3.2 频率限制 (Rate Limiting)
系统集成了基于 Redis 的动态限流机制：
- **默认限制**: 每个群每小时最多生成 20 个 AI 任务草稿。
- **配置项**: 
    - `ai_rate_limit`: 策略名
    - `limit`: 周期内允许的最大次数
    - `window_seconds`: 统计窗口时长（秒）

### 3.3 审计与追踪
- 所有 AI 触发的任务都会在 `AIDraft` 表中记录原始输入、解析结果、执行者及其当时的角色。
- 任务执行结果将记录在 `Execution` 表中，支持全链路 TraceID 追踪。

## 4. 动态调整建议

管理员可以通过调整 `Strategy` 表中的配置来优化体验：
1.  **收紧权限**: 若发现群内 AI 指令滥用，可将 `RiskLevel` 为 `Medium` 的动作限制提升至仅群主可用。
2.  **调整限流**: 对于活跃度极高的官方群，可调高 `ai_rate_limit` 的阈值。
3.  **能力开关**: 通过 `SystemManifest` 的 `Actions` 定义，可以动态下线或上线特定 AI 能力。

---
*文档更新日期：2026-01-02*

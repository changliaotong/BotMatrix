<!--pages/logs/logs.wxml-->
<view class="container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="page-header">
    <text class="page-title">æ—¥å¿—ç®¡ç†</text>
    <view class="page-actions">
      <button class="btn btn-small {{autoRefresh ? 'btn-primary' : ''}}" bindtap="toggleAutoRefresh">
        <text class="btn-icon">{{autoRefresh ? 'â¸' : 'â–¶'}}</text>
        {{autoRefresh ? 'åœæ­¢åˆ·æ–°' : 'è‡ªåŠ¨åˆ·æ–°'}}
      </button>
      <button class="btn btn-small btn-primary" bindtap="showExportModal">
        å¯¼å‡º
      </button>
      <button class="btn btn-small btn-danger" bindtap="clearLogs">
        æ¸…ç©º
      </button>
    </view>
  </view>

  <!-- æœç´¢å’Œç­›é€‰æ  -->
  <view class="filter-bar">
    <view class="search-box">
      <input 
        class="search-input" 
        placeholder="æœç´¢æ—¥å¿—å†…å®¹ã€æœºå™¨äººID..."
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
      />
      <text class="search-icon">ğŸ”</text>
    </view>
    
    <view class="filter-controls">
      <picker 
        mode="selector" 
        range="{{levels}}"
        range-key="label"
        value="{{selectedLevelIndex}}"
        bindchange="onLevelChange"
      >
        <view class="filter-picker">
          <text>{{levels[selectedLevelIndex].label}}</text>
          <text class="picker-arrow">â–¼</text>
        </view>
      </picker>
      
      <picker 
        mode="selector" 
        range="{{bots}}"
        range-key="label"
        value="{{selectedBotIndex}}"
        bindchange="onBotChange"
      >
        <view class="filter-picker">
          <text>{{bots[selectedBotIndex].label}}</text>
          <text class="picker-arrow">â–¼</text>
        </view>
      </picker>
    </view>
  </view>

  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <view class="stats-bar" wx:if="{{filteredLogs.length > 0}}">
    <text>å…± {{filteredLogs.length}} æ¡æ—¥å¿—</text>
    <text wx:if="{{selectedLogs.length > 0}}">å·²é€‰æ‹© {{selectedLogs.length}} æ¡</text>
  </view>

  <!-- æ—¥å¿—åˆ—è¡¨ -->
  <scroll-view 
    class="logs-container" 
    scroll-y 
    enable-back-to-top
    bindscrolltolower="onReachBottom"
  >
    <view wx:if="{{loading && filteredLogs.length === 0}}" class="loading">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>

    <view wx:if="{{!loading && filteredLogs.length === 0}}" class="empty">
      <text class="empty-image">ğŸ“„</text>
      <text class="empty-text">æš‚æ— æ—¥å¿—è®°å½•</text>
      <text class="empty-desc">ç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼Œæš‚æ— æ—¥å¿—äº§ç”Ÿ</text>
    </view>

    <view wx:if="{{error}}" class="error">
      <text class="error-text">{{error}}</text>
      <button class="btn btn-primary" bindtap="refreshLogs">é‡æ–°åŠ è½½</button>
    </view>

    <!-- æ—¥å¿—é¡¹åˆ—è¡¨ -->
    <view class="logs-list" wx:if="{{filteredLogs.length > 0}}">
      <view 
        class="log-item {{selectedLogIds.includes(item.id) ? 'selected' : ''}}"
        wx:for="{{filteredLogs}}"
        wx:key="id"
        data-log="{{item}}"
        bindtap="onLogItemTap"
        bindlongpress="onLogItemLongPress"
      >
        <!-- é€‰æ‹©æ¡† -->
        <view class="log-select" catchtap="onLogSelect">
          <view class="checkbox {{selectedLogIds.includes(item.id) ? 'checked' : ''}}"></view>
        </view>

        <!-- æ—¥å¿—å†…å®¹ -->
        <view class="log-content">
          <view class="log-header">
            <view class="log-time">{{item.time}}</view>
            <view class="log-level {{item.levelClass}}">
              {{item.levelText}}
            </view>
          </view>
          
          <view class="log-body">
            <view class="log-message">{{item.shortMessage}}</view>
            <view class="log-bot" wx:if="{{item.botId}}">
              <text class="bot-label">æœºå™¨äºº:</text>
              <text class="bot-id">{{item.botId}}</text>
            </view>
          </view>
          
          <view class="log-footer" wx:if="{{item.metadata}}">
            <view class="log-metadata">
              <text class="metadata-item" wx:for="{{item.metadata}}" wx:key="key" wx:for-item="meta">
                {{meta.key}}: {{meta.value}}
              </text>
            </view>
          </view>
        </view>

        <!-- æ“ä½œæŒ‰é’® -->
        <view class="log-actions">
          <button class="btn-icon" bindtap="copyLogMessage" data-log="{{item}}">
            ğŸ“‹
          </button>
        </view>
      </view>

      <!-- åŠ è½½æ›´å¤š -->
      <view wx:if="{{loading && filteredLogs.length > 0}}" class="load-more">
        <view class="loading-spinner"></view>
        <text>åŠ è½½æ›´å¤š...</text>
      </view>

      <!-- æ²¡æœ‰æ›´å¤š -->
      <view wx:if="{{!hasMore && filteredLogs.length > 0}}" class="no-more">
        <text>å·²æ˜¾ç¤ºå…¨éƒ¨æ—¥å¿—</text>
      </view>
    </view>
  </scroll-view>
</view>

<!-- å¯¼å‡ºæ¨¡æ€æ¡† -->
<view class="modal-overlay" wx:if="{{showExportModal}}" bindtap="hideExportModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">å¯¼å‡ºæ—¥å¿—</text>
      <button class="btn-close" bindtap="hideExportModal">âœ•</button>
    </view>
    
    <view class="modal-body">
      <view class="export-info">
        <text>å°†å¯¼å‡º {{selectedLogs.length > 0 ? selectedLogs.length : filteredLogs.length}} æ¡æ—¥å¿—</text>
      </view>
      
      <view class="export-format">
        <text class="format-label">å¯¼å‡ºæ ¼å¼:</text>
        <radio-group class="format-options" bindchange="onExportFormatChange">
          <label class="format-option">
            <radio value="json" checked="{{exportFormat === 'json'}}" />
            <text>JSON æ ¼å¼</text>
          </label>
          <label class="format-option">
            <radio value="csv" checked="{{exportFormat === 'csv'}}" />
            <text>CSV æ ¼å¼</text>
          </label>
          <label class="format-option">
            <radio value="txt" checked="{{exportFormat === 'txt'}}" />
            <text>æ–‡æœ¬æ ¼å¼</text>
          </label>
        </radio-group>
      </view>
    </view>
    
    <view class="modal-footer">
      <button class="btn btn-default" bindtap="hideExportModal">å–æ¶ˆ</button>
      <button class="btn btn-primary" bindtap="exportLogs">å¯¼å‡º</button>
    </view>
  </view>
</view>
version: '3.8'

services:
  # 1. Go 管理平台服务 (Manager)
  bot-manager:
    build: 
      context: ./BotNexus
    container_name: botmatrix-manager
    restart: always
    ports:
      - "${WEB_PORT:-5000}:5000"  # WebUI
      - "${WS_PORT:-3002}:3001"  # WebSocket Gateway
    volumes:
      - ./BotNexus/stats.json:/app/stats.json
    environment:
      - TZ=Asia/Shanghai
      - REDIS_ADDR=192.168.0.126:6379
      - REDIS_PWD=redis_zsYik8

  # Old Python Manager (Deprecated)
  # bot-manager-py:
  #   build: .
  #   container_name: wxbot-manager-py
  #   ...

  # 2. 微信机器人 Worker
  wxbot-worker:
    build: 
      context: ./WxBot
    container_name: botmatrix-worker-wx
    restart: always
    depends_on:
      - bot-manager
    volumes:
      - ./WxBot/temp:/app/temp # 保存登录session和二维码
    environment:
      - TZ=Asia/Shanghai
      - MANAGER_URL=ws://bot-manager:3001
      - BOT_SELF_ID=1098299491 # 替换为您的机器人ID
    command: ["python", "driver.py"]

  # napcat:
  #   image: docker.io/mlikiowa/napcat-docker:latest
  #   container_name: napcat
  #   restart: always
  #   environment:
  #     - ACCOUNT=  # 填入你的QQ号
  #     - WSR_ENABLE=true
  #     # 注意：如果使用 host 模式，这里需要填宿主机 IP 或 127.0.0.1 加映射端口
  #     # 假设 wxbot 映射到了 3111
  #     - WS_URLS=["ws://127.0.0.1:3111"] 
  #   volumes:
  #     - ./napcat/config:/app/napcat/config
  #     - ./napcat/logs:/app/napcat/logs
  #   # NapCat 登录通常需要 host 模式
  #   network_mode: "host"

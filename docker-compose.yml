version: '3.8'

services:
  # 1. BotNexus: Go-based Central Management Platform
  bot-manager:
    build: 
      context: ./BotNexus
    container_name: botmatrix-manager
    restart: always
    pid: host
    ports:
      - "5000:5000"  # Web Dashboard / API
      - "3005:3001"  # WebSocket for Internal/External Communication
    volumes:
      - ./BotNexus/stats.json:/app/stats.json
    environment:
      - TZ=Asia/Shanghai
      - REDIS_ADDR=${REDIS_ADDR:-192.168.0.126:6379}
      - REDIS_PWD=${REDIS_PWD:-redis_zsYik8}

  # 2. WxBot: WeChat Robot Worker
  wxbot:
    build: 
      context: ./WxBot
    container_name: wxbot
    restart: always
    ports:
      - "5001:5001" # WebUI for QR Code Login
      - "3111:3001" # WebSocket for C# Client (Direct Connection)
    depends_on:
      - bot-manager
    volumes:
      - ./WxBot:/app # Map source code for hot-reloading
      - ./WxBot/temp:/app/temp # Session files and QR codes
    environment:
      - TZ=Asia/Shanghai
      - MANAGER_URL=ws://bot-manager:3001
      - BOT_SELF_ID=${BOT_SELF_ID:-1098299491}
    command: ["python", "onebot.py"]


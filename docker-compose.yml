version: '3.8'

services:
  # 1. BotNexus: Go-based Central Management Platform
  bot-manager:
    build: 
      context: ./BotNexus
    container_name: botmatrix-manager
    restart: always
    pid: host
    ports:
      - "5000:5000"  # Web Dashboard / API
      - "3005:3001"  # WebSocket for Internal/External Communication
    volumes:
      - ./BotNexus/stats.json:/app/stats.json
    environment:
      - TZ=Asia/Shanghai
      - REDIS_ADDR=${REDIS_ADDR:-192.168.0.126:6379}
      - REDIS_PWD=${REDIS_PWD:-redis_zsYik8}

  # 2. TencentBot: Tencent Official QQ Bot Worker
  tencent-bot:
    build:
      context: ./TencentBot
    container_name: tencent-bot
    restart: always
    depends_on:
      - bot-manager
    volumes:
      - ./TencentBot/config.json:/app/config.json
    environment:
      - TZ=Asia/Shanghai
      - NEXUS_ADDR=ws://192.168.0.167:3005
      - TENCENT_SANDBOX=true
      # Configuration is loaded from config.json

  # 3. WxBot: WeChat Robot Worker
  wxbot:
    build: 
      context: ./WxBot
    container_name: wxbot
    restart: always
    ports:
      - "5001:5001" # WebUI for QR Code Login
      - "3111:3001" # WebSocket for C# Client (Direct Connection)
    depends_on:
      - bot-manager
    volumes:
      - ./WxBot:/app # Map source code for hot-reloading
      - ./WxBot/temp:/app/temp # Session files and QR codes
    environment:
      - TZ=Asia/Shanghai
      - MANAGER_URL=ws://bot-manager:3001
      - BOT_SELF_ID=${BOT_SELF_ID:-1098299491}
    command: ["python", "onebot.py"]

  # 3. DingTalkBot: DingTalk Webhook Worker
  # dingtalk-bot:
  #   build:
  #     context: ./DingTalkBot
  #   container_name: dingtalk-bot
  #   restart: always
  #   depends_on:
  #     - bot-manager
  #   volumes:
  #     - ./DingTalkBot/config.json:/app/config.json
  #   environment:
  #     - TZ=Asia/Shanghai
  #     - NEXUS_ADDR=ws://bot-manager:3005
  #     # - DINGTALK_TOKEN=your_token_here
  #     # - DINGTALK_SECRET=your_secret_here

networks:

version: '3.8'

services:
  # Redis for distributed session and pub/sub
  redis:
    image: redis:7-alpine
    container_name: bm-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - bm-network

  # PostgreSQL for persistence
  db:
    image: postgres:15-alpine
    container_name: bm-db
    environment:
      POSTGRES_USER: botmatrix
      POSTGRES_PASSWORD: password123
      POSTGRES_DB: botmatrix
    ports:
      - "5432:5432"
    volumes:
      - db_data:/var/lib/postgresql/data
    networks:
      - bm-network

  # BotNexus (The Center)
  nexus:
    build:
      context: .
      dockerfile: src/BotNexus/Dockerfile
    container_name: bm-nexus
    environment:
      - BM_REDIS_ADDR=redis:6379
      - BM_DB_DSN=host=db user=botmatrix password=password123 dbname=botmatrix port=5432 sslmode=disable
    ports:
      - "8000:8000"
    depends_on:
      - redis
      - db
    volumes:
      - ./plugins:/app/plugins
    networks:
      - bm-network

  # BotWorker (Stateless Worker Cluster)
  worker:
    build:
      context: .
      dockerfile: src/BotWorker/Dockerfile
    environment:
      - BM_REDIS_ADDR=redis:6379
      - BM_NEXUS_ADDR=http://nexus:8000
    depends_on:
      - redis
      - nexus
    volumes:
      - ./src/DiscordBot/config.json:/app/config.json
    environment:
      - TZ=Asia/Shanghai
      - NEXUS_ADDR=ws://bot-nexus:3001

  # 8. SlackBot: Slack Enterprise Worker
  slack-bot:
    build:
      context: ./src/SlackBot
    container_name: btsl
    restart: always
    depends_on:
      - bot-nexus
    volumes:
      - ./src/SlackBot/config.json:/app/config.json
    environment:
      - TZ=Asia/Shanghai
      - NEXUS_ADDR=ws://bot-nexus:3001

  # 9. KookBot: Kook Community Worker
  kook-bot:
    build:
      context: ./src/KookBot
    container_name: btkk
    restart: always
    depends_on:
      - bot-nexus
    volumes:
      - ./src/KookBot/config.json:/app/config.json
    environment:
      - TZ=Asia/Shanghai
      - NEXUS_ADDR=ws://bot-nexus:3001

  # 10. EmailBot: Email Integration Worker
  email-bot:
    build:
      context: ./src/EmailBot
    container_name: btem
    restart: always
    depends_on:
      - bot-nexus
    volumes:
      - ./src/EmailBot/config.json:/app/config.json
    environment:
      - TZ=Asia/Shanghai
      - NEXUS_ADDR=ws://bot-nexus:3001

  # 11. WeComBot: Enterprise WeChat Worker
  wecom-bot:
    build:
      context: ./src/WeComBot
    container_name: btwm
    restart: always
    ports:
      - "5002:8001" # Expose callback port
    depends_on:
      - bot-nexus
    volumes:
      - ./src/WeComBot/config.json:/app/config.json
    environment:
      - TZ=Asia/Shanghai
      - NEXUS_ADDR=ws://bot-nexus:3001

  # 12. NapCat: Personal QQ Worker (OneBot 11)
  # napcat:
  #   image: napneko/napcat:latest
  #   container_name: napcat
  #   restart: always
  #   ports:
  #     - "6099:6099" # WebUI
  #   depends_on:
  #     - bot-manager
  #   volumes:
  #     - ./NapCat/config:/app/napcat/config
  #     - ./NapCat/qq:/app/.config/QQ
  #   environment:
  #     - TZ=Asia/Shanghai
  #     - ACCOUNT= # Optional: Fill in your QQ number for auto-login if previously logged in
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 1G

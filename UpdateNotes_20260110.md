# 更新日志 - 2026-01-10

## 核心改进

### 1. 权限系统优化
- **SelfRole 识别**: 优先使用消息事件中的 `SelfRole` 进行权限校验，解决了数据库状态滞后导致的权限识别不准问题。
- **群主识别修复**: 修正了头衔功能中对群主身份的识别逻辑，确保机器人作为群主或管理员时能正确执行操作。
- **BotMessageMapper 增强**: 在消息映射阶段预置 `SelfRole` 和 `SelfId`，减少后续逻辑的数据库查询。

### 2. 积分系统完善
- **三级存储映射**:
  - **本群积分**: 存储于 `groupmember` 表。
  - **本机积分**: 存储于 `friend` 表。
  - **通用积分**: 存储于 `user` 表（默认）。
- **动态切换**: 根据群开启状态和机器人本机设置自动切换积分来源。
- **占位符保护**: 保留了 `{{积分类型}}` 和 `{{积分}}` 占位符，由后续批量替换程序处理，避免了直接注入导致的逻辑耦合。

### 3. 成语/接龙功能重构
- **全异步化**: 对 `Chengyu.cs`、`JielongMessage.cs` 和 `Jielong.cs` 进行了全面的 `async/await` 重构，消除了同步 SQL 调用导致的潜在死锁。
- **超时逻辑优化**: 设置 `LastChengyuDate` 为当前时间，修复了接龙游戏因时间戳未更新导致的误判超时。
- **MetaData 增强**: 在 `MetaData.cs` 中添加了 `GetRandomAsync` 异步方法。

### 4. 外部插件支持 (ProcessPlugin)
- **标准流通信**: 实现了基于 `stdin`/`stdout` 的本地外部插件通信机制，不再依赖远程调用。
- **异常处理**: 增加了 400 错误处理逻辑，当插件通信失败时会提示用户并尝试重启插件进程。

## Bug 修复与稳定性增强
- **UserAchievements 插入修复**: 改进了 `MetaData.cs` 中的主键排除逻辑，解决了 `UserAchievements` 插入时因 `Guid` 为 NULL 导致的数据库错误。
- **编译错误解决**:
  - 修复了 `BotMessage` 缺失 `InGame()` 方法的问题。
  - 修复了 `Chengyu` 缺失 `GetFanChaRes` 方法的问题。
  - 修复了 `GroupInfo` 缺失同步包装方法（`GetGroupOwner` 等）的问题。
  - 解决了重复定义异步方法的编译冲突。
- **终端环境适配**: 适配了 PowerShell 环境下的文件搜索和命令执行。

## 待办事项
- [ ] 验证 GitLab 提交后的自动化流水线。
- [ ] 在实际运行环境中测试本地外部插件的响应速度。
